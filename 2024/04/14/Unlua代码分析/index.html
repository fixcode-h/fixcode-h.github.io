<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 8.1.1">
<link rel="preconnect" href="https://fonts.loli.net" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css2?family=Noto+Serif+SC:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous" defer></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.fixcod.cn","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.26.0","exturl":false,"sidebar":{"position":"left","width":280,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"atom-one-light","dark":"atom-one-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"default"},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="å‰è¨€UnLua æ˜¯ Tencent å¼€æºçš„é«˜æ€§èƒ½ Lua-UE ç»‘å®šæ¡†æ¶ï¼Œä¸º Unreal Engine æä¾›äº†å®Œå–„çš„ Lua è„šæœ¬æ”¯æŒã€‚æœ¬æ–‡æ¡£åŸºäºæºç æ·±åº¦å‰–æ UnLua çš„æ ¸å¿ƒå®ç°åŸç†ï¼Œæ¶µç›–ä»¥ä¸‹å†…å®¹ï¼š ğŸ“š æ–‡æ¡£ç»“æ„ Lua C API åŸºç¡€ - æ³¨å†Œè¡¨ã€å…ƒè¡¨ã€æ ˆæ“ä½œç­‰æ ¸å¿ƒæ¦‚å¿µ æ¶æ„è®¾è®¡ - å››å±‚æ¶æ„ï¼ˆLua å±‚ã€ç»‘å®šå±‚ã€æ³¨å†Œå±‚ã€æ ¸å¿ƒå±‚ï¼‰ é™æ€å¯¼å‡ºæœºåˆ¶ - ç¼–è¯‘æœŸç±»å‹å¯¼å‡ºä¸é›¶è¿è¡Œæ—¶å¼€é”€ åŠ¨æ€ç»‘">
<meta property="og:type" content="article">
<meta property="og:title" content="Unluaä»£ç åˆ†æ">
<meta property="og:url" content="http://www.fixcod.cn/2024/04/14/Unlua%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="FixCode Blog">
<meta property="og:description" content="å‰è¨€UnLua æ˜¯ Tencent å¼€æºçš„é«˜æ€§èƒ½ Lua-UE ç»‘å®šæ¡†æ¶ï¼Œä¸º Unreal Engine æä¾›äº†å®Œå–„çš„ Lua è„šæœ¬æ”¯æŒã€‚æœ¬æ–‡æ¡£åŸºäºæºç æ·±åº¦å‰–æ UnLua çš„æ ¸å¿ƒå®ç°åŸç†ï¼Œæ¶µç›–ä»¥ä¸‹å†…å®¹ï¼š ğŸ“š æ–‡æ¡£ç»“æ„ Lua C API åŸºç¡€ - æ³¨å†Œè¡¨ã€å…ƒè¡¨ã€æ ˆæ“ä½œç­‰æ ¸å¿ƒæ¦‚å¿µ æ¶æ„è®¾è®¡ - å››å±‚æ¶æ„ï¼ˆLua å±‚ã€ç»‘å®šå±‚ã€æ³¨å†Œå±‚ã€æ ¸å¿ƒå±‚ï¼‰ é™æ€å¯¼å‡ºæœºåˆ¶ - ç¼–è¯‘æœŸç±»å‹å¯¼å‡ºä¸é›¶è¿è¡Œæ—¶å¼€é”€ åŠ¨æ€ç»‘">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-04-14T13:56:36.000Z">
<meta property="article:modified_time" content="2025-12-01T11:30:50.975Z">
<meta property="article:author" content="FixCode">
<meta property="article:tag" content="Unlua">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://www.fixcod.cn/2024/04/14/Unlua%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://www.fixcod.cn/2024/04/14/Unlua%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/","path":"2024/04/14/Unluaä»£ç åˆ†æ/","title":"Unluaä»£ç åˆ†æ"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Unluaä»£ç åˆ†æ | FixCode Blog</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script><script src="/js/bookmark.js" defer></script><script src="/js/pjax.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>

  <script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.2.12/pdfobject.min.js","integrity":"sha256-g2xji1rlE3KsGVClvuxTbcR0Kn2+wtQADSff2Tbb4zA="},"url":"/lib/pdf/web/viewer.html"}</script>
  <script src="/js/third-party/tags/pdf.js" defer></script>

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.7.0/mermaid.min.js","integrity":"sha256-TtLOdUA8mstPoO6sGvHIGx2ceXrrX4KgIItO06XOn8A="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>



  <script src="/js/third-party/pace.js" defer></script>


  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">FixCode Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a></li><li class="menu-item menu-item-ç¬”è®°"><a href="/notes/" rel="section"><i class="fa-solid fa-note-sticky fa-fw"></i>ç¬”è®°</a></li><li class="menu-item menu-item-åº”ç”¨"><a href="/application/" rel="section"><i class="fa-solid fa-blog fa-fw"></i>åº”ç”¨</a></li><li class="menu-item menu-item-å…¬å‘Š"><a href="/announcement/" rel="section"><i class="fa-solid fa-bullhorn fa-fw"></i>å…¬å‘Š</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="æœç´¢..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">å‰è¨€</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%93%9A-%E6%96%87%E6%A1%A3%E7%BB%93%E6%9E%84"><span class="nav-number">1.1.</span> <span class="nav-text">ğŸ“š æ–‡æ¡£ç»“æ„</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lua-C-API-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="nav-number">2.</span> <span class="nav-text">Lua C API åŸºç¡€æ¦‚å¿µ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E8%A1%A8-Registry"><span class="nav-number">2.1.</span> <span class="nav-text">æ³¨å†Œè¡¨ (Registry)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%83%E8%A1%A8-Metatable-%E6%A0%B8%E5%BF%83-API"><span class="nav-number">2.2.</span> <span class="nav-text">å…ƒè¡¨ (Metatable) æ ¸å¿ƒ API</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%B6%E6%9E%84%E6%A6%82%E8%A7%88"><span class="nav-number">3.</span> <span class="nav-text">æ¶æ„æ¦‚è§ˆ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="nav-number">3.1.</span> <span class="nav-text">æ•´ä½“æ¶æ„å›¾</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6%E8%81%8C%E8%B4%A3%E8%A1%A8"><span class="nav-number">3.2.</span> <span class="nav-text">æ ¸å¿ƒç»„ä»¶èŒè´£è¡¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A4%BA%E6%84%8F%E5%9B%BE"><span class="nav-number">3.3.</span> <span class="nav-text">æ•°æ®æµç¤ºæ„å›¾</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E5%AF%BC%E5%87%BA%E6%9C%BA%E5%88%B6"><span class="nav-number">4.</span> <span class="nav-text">é™æ€å¯¼å‡ºæœºåˆ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="nav-number">4.1.</span> <span class="nav-text">æ ¸å¿ƒåŸç†</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6"><span class="nav-number">4.1.1.</span> <span class="nav-text">å®ç°æœºåˆ¶</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E8%A7%A6%E5%8F%91%E6%B5%81%E7%A8%8B"><span class="nav-number">4.1.2.</span> <span class="nav-text">å…¨å±€æ„é€ å‡½æ•°è§¦å‘æµç¨‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">4.1.3.</span> <span class="nav-text">æ³¨å†Œæµç¨‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E5%AF%BC%E5%87%BA%E6%B3%A8%E5%86%8C%E5%88%B0-Lua-%E7%9A%84%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B"><span class="nav-number">4.1.4.</span> <span class="nav-text">é™æ€å¯¼å‡ºæ³¨å†Œåˆ° Lua çš„å®Œæ•´æµç¨‹</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="nav-number">4.2.</span> <span class="nav-text">ä»£ç ç¤ºä¾‹</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B-1-%E5%AF%BC%E5%87%BA%E9%9D%99%E6%80%81%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="nav-number">4.2.1.</span> <span class="nav-text">ç¤ºä¾‹ 1: å¯¼å‡ºé™æ€å·¥å…·ç±»</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B-2-%E5%AF%BC%E5%87%BA%E5%85%A8%E5%B1%80%E5%87%BD%E6%95%B0"><span class="nav-number">4.2.2.</span> <span class="nav-text">ç¤ºä¾‹ 2: å¯¼å‡ºå…¨å±€å‡½æ•°</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E7%89%B9%E6%80%A7"><span class="nav-number">4.3.</span> <span class="nav-text">æ€§èƒ½ç‰¹æ€§</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">4.4.</span> <span class="nav-text">é€‚ç”¨åœºæ™¯</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%9C%85-%E9%80%82%E5%90%88%E9%9D%99%E6%80%81%E5%AF%BC%E5%87%BA%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="nav-number">4.4.1.</span> <span class="nav-text">âœ… é€‚åˆé™æ€å¯¼å‡ºçš„åœºæ™¯</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%9D%8C-%E4%B8%8D%E9%80%82%E5%90%88%E9%9D%99%E6%80%81%E5%AF%BC%E5%87%BA%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="nav-number">4.4.2.</span> <span class="nav-text">âŒ ä¸é€‚åˆé™æ€å¯¼å‡ºçš„åœºæ™¯</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E5%AF%BC%E5%87%BA%E6%9C%BA%E5%88%B6"><span class="nav-number">5.</span> <span class="nav-text">åŠ¨æ€å¯¼å‡ºæœºåˆ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">5.1.</span> <span class="nav-text">å·¥ä½œæµç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-number">5.1.1.</span> <span class="nav-text">å®Œæ•´æµç¨‹å›¾</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%91%E5%AE%9A%E8%A7%A6%E5%8F%91%E6%9C%BA%E5%88%B6"><span class="nav-number">5.2.</span> <span class="nav-text">ç»‘å®šè§¦å‘æœºåˆ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-1"><span class="nav-number">5.2.1.</span> <span class="nav-text">ä»£ç ç¤ºä¾‹</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6"><span class="nav-number">5.3.</span> <span class="nav-text">æ¨¡å—åŠ è½½æœºåˆ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E8%A7%A3%E6%9E%90%E8%A7%84%E5%88%99"><span class="nav-number">5.3.1.</span> <span class="nav-text">è·¯å¾„è§£æè§„åˆ™</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%83%AD%E6%9B%B4%E6%96%B0%E4%B8%8B%E8%BD%BD%E7%9B%AE%E5%BD%95"><span class="nav-number">5.3.2.</span> <span class="nav-text">çƒ­æ›´æ–°ä¸‹è½½ç›®å½•</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E7%89%B9%E6%80%A7"><span class="nav-number">5.4.</span> <span class="nav-text">è¿è¡Œæ—¶ç‰¹æ€§</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B1%BB%E6%B3%A8%E5%86%8C%E4%B8%8E%E7%BB%91%E5%AE%9A%E7%B3%BB%E7%BB%9F"><span class="nav-number">6.</span> <span class="nav-text">ç±»æ³¨å†Œä¸ç»‘å®šç³»ç»Ÿ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8C%E5%B1%82%E6%B3%A8%E5%86%8C%E6%9E%B6%E6%9E%84"><span class="nav-number">6.1.</span> <span class="nav-text">åŒå±‚æ³¨å†Œæ¶æ„</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ClassRegistry-%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B"><span class="nav-number">6.2.</span> <span class="nav-text">ClassRegistry æ ¸å¿ƒæµç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B1%BB%E6%B3%A8%E5%86%8C%E6%97%B6%E6%9C%BA%E8%A1%A8"><span class="nav-number">6.2.1.</span> <span class="nav-text">ç±»æ³¨å†Œæ—¶æœºè¡¨</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Lua-C-API-Metatable-%E6%93%8D%E4%BD%9C%E8%AF%A6%E8%A7%A3"><span class="nav-number">6.2.2.</span> <span class="nav-text">Lua C API: Metatable æ“ä½œè¯¦è§£</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Metatable-%E5%88%9B%E5%BB%BA%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B"><span class="nav-number">6.2.3.</span> <span class="nav-text">Metatable åˆ›å»ºå®Œæ•´æµç¨‹</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ObjectRegistry-%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B"><span class="nav-number">6.3.</span> <span class="nav-text">ObjectRegistry æ ¸å¿ƒæµç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Lua-C-API-%E5%BC%95%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3"><span class="nav-number">6.3.1.</span> <span class="nav-text">Lua C API: å¼•ç”¨ç³»ç»Ÿè¯¦è§£</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E7%BB%91%E5%AE%9A%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B"><span class="nav-number">6.3.2.</span> <span class="nav-text">å¯¹è±¡ç»‘å®šå®Œæ•´æµç¨‹</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%83%E8%A1%A8%E7%BB%A7%E6%89%BF%E9%93%BE%E7%A4%BA%E6%84%8F%E5%9B%BE"><span class="nav-number">6.4.</span> <span class="nav-text">å…ƒè¡¨ç»§æ‰¿é“¾ç¤ºæ„å›¾</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E7%BB%91%E5%AE%9A-vs-%E9%9D%99%E6%80%81%E7%BB%91%E5%AE%9A"><span class="nav-number">6.5.</span> <span class="nav-text">åŠ¨æ€ç»‘å®š vs é™æ€ç»‘å®š</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E8%A6%86%E5%86%99%E5%8E%9F%E7%90%86"><span class="nav-number">7.</span> <span class="nav-text">å‡½æ•°è¦†å†™åŸç†</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A6%86%E5%86%99%E6%9C%BA%E5%88%B6%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90"><span class="nav-number">7.1.</span> <span class="nav-text">è¦†å†™æœºåˆ¶æ·±åº¦è§£æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Lua-C-API-%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E8%AF%A6%E8%A7%A3"><span class="nav-number">7.1.1.</span> <span class="nav-text">Lua C API: å‡½æ•°è°ƒç”¨è¯¦è§£</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hook-%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-number">7.1.2.</span> <span class="nav-text">Hook æµç¨‹å›¾</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CallLua-%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90"><span class="nav-number">7.1.3.</span> <span class="nav-text">CallLua æ ¸å¿ƒæºç å‰–æ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A6%86%E5%86%99%E6%9C%BA%E5%88%B6%E6%BA%90%E7%A0%81%E5%AE%8C%E6%95%B4%E5%89%96%E6%9E%90"><span class="nav-number">7.1.4.</span> <span class="nav-text">è¦†å†™æœºåˆ¶æºç å®Œæ•´å‰–æ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E6%89%BE%E4%BC%98%E5%85%88%E7%BA%A7"><span class="nav-number">7.1.5.</span> <span class="nav-text">æŸ¥æ‰¾ä¼˜å…ˆçº§</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Super-%E8%B0%83%E7%94%A8%E6%9C%BA%E5%88%B6"><span class="nav-number">7.1.6.</span> <span class="nav-text">Super è°ƒç”¨æœºåˆ¶</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A6%86%E5%86%99%E6%A3%80%E6%B5%8B%E4%B8%8E%E5%B1%9E%E6%80%A7%E8%AE%BF%E9%97%AE%E6%B5%81%E7%A8%8B"><span class="nav-number">7.2.</span> <span class="nav-text">è¦†å†™æ£€æµ‹ä¸å±æ€§è®¿é—®æµç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Lua-C-API-%E6%A0%88%E6%93%8D%E4%BD%9C%E5%9F%BA%E7%A1%80"><span class="nav-number">7.2.1.</span> <span class="nav-text">Lua C API: æ ˆæ“ä½œåŸºç¡€</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Class-Index-%E5%AE%8C%E6%95%B4%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90"><span class="nav-number">7.2.2.</span> <span class="nav-text">Class_Index å®Œæ•´æºç å‰–æ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#GetField-%E6%A0%88%E6%93%8D%E4%BD%9C%E5%AE%8C%E6%95%B4%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="nav-number">7.2.3.</span> <span class="nav-text">GetField æ ˆæ“ä½œå®Œæ•´å¯è§†åŒ–</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Class-NewIndex-%E5%B1%9E%E6%80%A7%E5%86%99%E5%85%A5"><span class="nav-number">7.2.4.</span> <span class="nav-text">Class_NewIndex å±æ€§å†™å…¥</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E8%A6%81%E7%82%B9"><span class="nav-number">7.3.</span> <span class="nav-text">æ€§èƒ½ä¼˜åŒ–è¦ç‚¹</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B6"><span class="nav-number">8.</span> <span class="nav-text">å‚æ•°ä¼ é€’æœºåˆ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B1%BB%E5%9E%8B%E6%98%A0%E5%B0%84%E8%A1%A8"><span class="nav-number">8.1.</span> <span class="nav-text">ç±»å‹æ˜ å°„è¡¨</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%B1%BB%E5%9E%8B%E6%98%A0%E5%B0%84"><span class="nav-number">8.1.1.</span> <span class="nav-text">åŸºç¡€ç±»å‹æ˜ å°„</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%8D%E6%9D%82%E7%B1%BB%E5%9E%8B%E6%98%A0%E5%B0%84"><span class="nav-number">8.1.2.</span> <span class="nav-text">å¤æ‚ç±»å‹æ˜ å°„</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3"><span class="nav-number">8.2.</span> <span class="nav-text">å‚æ•°ä¼ é€’æµç¨‹è¯¦è§£</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Lua-%E2%86%92-C-%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92"><span class="nav-number">8.2.1.</span> <span class="nav-text">Lua â†’ C++ å‚æ•°ä¼ é€’</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E2%86%92-Lua-%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92"><span class="nav-number">8.2.2.</span> <span class="nav-text">C++ â†’ Lua å‚æ•°ä¼ é€’</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E7%B1%BB%E5%9E%8B%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90"><span class="nav-number">8.3.</span> <span class="nav-text">å®¹å™¨ç±»å‹æ·±åº¦è§£æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#TArray-%E5%86%85%E5%AD%98%E5%85%B1%E4%BA%AB%E6%9C%BA%E5%88%B6"><span class="nav-number">8.3.1.</span> <span class="nav-text">TArray å†…å­˜å…±äº«æœºåˆ¶</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TArray-%E6%93%8D%E4%BD%9C-API-%E5%AE%8C%E6%95%B4%E5%AE%9E%E7%8E%B0"><span class="nav-number">8.3.2.</span> <span class="nav-text">TArray æ“ä½œ API å®Œæ•´å®ç°</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Struct-%E6%8B%B7%E8%B4%9D-vs-%E5%BC%95%E7%94%A8"><span class="nav-number">8.4.</span> <span class="nav-text">Struct æ‹·è´ vs å¼•ç”¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94"><span class="nav-number">8.5.</span> <span class="nav-text">å‚æ•°ä¼ é€’æ€§èƒ½å¯¹æ¯”</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E4%B8%8E%E5%AF%B9%E8%B1%A1%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">9.</span> <span class="nav-text">åƒåœ¾å›æ”¶ä¸å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8C%E9%87%8D-GC-%E7%B3%BB%E7%BB%9F"><span class="nav-number">9.1.</span> <span class="nav-text">åŒé‡ GC ç³»ç»Ÿ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="nav-number">9.1.1.</span> <span class="nav-text">æ¶æ„å›¾</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%BC%95%E7%94%A8%E7%AE%A1%E7%90%86%E7%AD%96%E7%95%A5"><span class="nav-number">9.2.</span> <span class="nav-text">å¯¹è±¡å¼•ç”¨ç®¡ç†ç­–ç•¥</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Lua-C-API-Userdata-%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90"><span class="nav-number">9.2.1.</span> <span class="nav-text">Lua C API: Userdata æ·±åº¦å‰–æ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UnLua-%E7%9A%84%E4%BA%8C%E7%BA%A7%E6%8C%87%E9%92%88%E6%9C%BA%E5%88%B6"><span class="nav-number">9.2.2.</span> <span class="nav-text">UnLua çš„äºŒçº§æŒ‡é’ˆæœºåˆ¶</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E5%BC%95%E7%94%A8%E6%9C%BA%E5%88%B6%E6%BA%90%E7%A0%81"><span class="nav-number">9.2.3.</span> <span class="nav-text">è‡ªåŠ¨å¼•ç”¨æœºåˆ¶æºç </span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Userdata-GC-%E5%9B%9E%E8%B0%83%E6%BA%90%E7%A0%81"><span class="nav-number">9.2.4.</span> <span class="nav-text">Userdata GC å›è°ƒæºç </span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B"><span class="nav-number">9.3.</span> <span class="nav-text">å¯¹è±¡ç”Ÿå‘½å‘¨æœŸå®Œæ•´æµç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%82%AC%E7%A9%BA%E6%8C%87%E9%92%88%E9%98%B2%E6%8A%A4%E6%9C%BA%E5%88%B6"><span class="nav-number">9.4.</span> <span class="nav-text">æ‚¬ç©ºæŒ‡é’ˆé˜²æŠ¤æœºåˆ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ReleasedPtr-%E6%A0%87%E8%AE%B0"><span class="nav-number">9.4.1.</span> <span class="nav-text">ReleasedPtr æ ‡è®°</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E6%9C%89%E6%95%88%E6%80%A7%E6%A3%80%E6%9F%A5%E5%B1%82%E7%BA%A7"><span class="nav-number">9.4.2.</span> <span class="nav-text">å¯¹è±¡æœ‰æ•ˆæ€§æ£€æŸ¥å±‚çº§</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E4%BF%9D%E6%8A%A4%E7%A4%BA%E4%BE%8B"><span class="nav-number">9.4.3.</span> <span class="nav-text">è®¿é—®ä¿æŠ¤ç¤ºä¾‹</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GC-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE"><span class="nav-number">9.5.</span> <span class="nav-text">GC æ€§èƒ½ä¼˜åŒ–å»ºè®®</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8C%E5%90%91%E8%B0%83%E7%94%A8%E6%9C%BA%E5%88%B6"><span class="nav-number">10.</span> <span class="nav-text">åŒå‘è°ƒç”¨æœºåˆ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Lua-%E2%86%92-C-%E8%93%9D%E5%9B%BE-%E8%B0%83%E7%94%A8"><span class="nav-number">10.1.</span> <span class="nav-text">Lua â†’ C++&#x2F;è“å›¾ è°ƒç”¨</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E8%B7%AF"><span class="nav-number">10.1.1.</span> <span class="nav-text">è°ƒç”¨é“¾è·¯</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%82%B9"><span class="nav-number">10.1.2.</span> <span class="nav-text">æ€§èƒ½ä¼˜åŒ–ç‚¹</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#C-%E8%93%9D%E5%9B%BE-%E2%86%92-Lua-%E8%B0%83%E7%94%A8"><span class="nav-number">10.2.</span> <span class="nav-text">C++&#x2F;è“å›¾ â†’ Lua è°ƒç”¨</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E8%B7%AF-1"><span class="nav-number">10.2.1.</span> <span class="nav-text">è°ƒç”¨é“¾è·¯</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A6%86%E5%86%99%E6%A3%80%E6%B5%8B%E6%B5%81%E7%A8%8B"><span class="nav-number">10.2.2.</span> <span class="nav-text">è¦†å†™æ£€æµ‹æµç¨‹</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94"><span class="nav-number">10.3.</span> <span class="nav-text">è°ƒç”¨æ€§èƒ½å¯¹æ¯”</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E8%A6%81%E7%82%B9-1"><span class="nav-number">11.</span> <span class="nav-text">æ€§èƒ½ä¼˜åŒ–è¦ç‚¹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E4%BC%98%E5%8C%96%E6%8A%80%E6%9C%AF%E8%A1%A8"><span class="nav-number">11.1.</span> <span class="nav-text">å…³é”®ä¼˜åŒ–æŠ€æœ¯è¡¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Userdata-%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80%E4%BC%98%E5%8C%96"><span class="nav-number">11.2.</span> <span class="nav-text">Userdata å†…å­˜å¸ƒå±€ä¼˜åŒ–</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5"><span class="nav-number">11.3.</span> <span class="nav-text">å‡½æ•°è°ƒç”¨ä¼˜åŒ–ç­–ç•¥</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Closure-%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6"><span class="nav-number">11.3.1.</span> <span class="nav-text">Closure ç¼“å­˜æœºåˆ¶</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">11.3.2.</span> <span class="nav-text">æ‰¹é‡æ“ä½œæœ€ä½³å®è·µ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE"><span class="nav-number">11.4.</span> <span class="nav-text">å†…å­˜ä¼˜åŒ–å»ºè®®</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E7%BA%A7%E8%AF%9D%E9%A2%98"><span class="nav-number">12.</span> <span class="nav-text">é«˜çº§è¯é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A-Lua-VM-%E7%8E%AF%E5%A2%83%E9%9A%94%E7%A6%BB"><span class="nav-number">12.1.</span> <span class="nav-text">å¤š Lua VM ç¯å¢ƒéš”ç¦»</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%8F%E7%A8%8B%E6%94%AF%E6%8C%81"><span class="nav-number">12.2.</span> <span class="nav-text">åç¨‹æ”¯æŒ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Latent-%E5%87%BD%E6%95%B0"><span class="nav-number">12.2.1.</span> <span class="nav-text">Latent å‡½æ•°</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%83%AD%E6%9B%B4%E6%96%B0%E6%9C%BA%E5%88%B6"><span class="nav-number">12.3.</span> <span class="nav-text">çƒ­æ›´æ–°æœºåˆ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%83%AD%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B"><span class="nav-number">12.3.1.</span> <span class="nav-text">çƒ­æ›´æ–°æµç¨‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%83%AD%E6%9B%B4%E6%96%B0%E9%99%90%E5%88%B6"><span class="nav-number">12.3.2.</span> <span class="nav-text">çƒ­æ›´æ–°é™åˆ¶</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E4%B8%8E%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90"><span class="nav-number">12.4.</span> <span class="nav-text">è°ƒè¯•ä¸æ€§èƒ½åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Lua-%E8%B0%83%E8%AF%95%E5%99%A8%E9%9B%86%E6%88%90"><span class="nav-number">12.4.1.</span> <span class="nav-text">Lua è°ƒè¯•å™¨é›†æˆ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7"><span class="nav-number">12.4.2.</span> <span class="nav-text">æ€§èƒ½åˆ†æå·¥å…·</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%99%84%E5%BD%95"><span class="nav-number">13.</span> <span class="nav-text">é™„å½•</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#A-%E6%A0%B8%E5%BF%83%E6%96%87%E4%BB%B6%E7%B4%A2%E5%BC%95"><span class="nav-number">13.1.</span> <span class="nav-text">A. æ ¸å¿ƒæ–‡ä»¶ç´¢å¼•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#B-Lua-C-API-%E9%80%9F%E6%9F%A5%E6%89%8B%E5%86%8C"><span class="nav-number">13.2.</span> <span class="nav-text">B. Lua C API é€ŸæŸ¥æ‰‹å†Œ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#B-1-%E6%A0%88%E6%93%8D%E4%BD%9C"><span class="nav-number">13.2.1.</span> <span class="nav-text">B.1 æ ˆæ“ä½œ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-2-%E7%B1%BB%E5%9E%8B%E6%A3%80%E6%9F%A5%E4%B8%8E%E8%BD%AC%E6%8D%A2"><span class="nav-number">13.2.2.</span> <span class="nav-text">B.2 ç±»å‹æ£€æŸ¥ä¸è½¬æ¢</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-3-%E5%80%BC%E5%8E%8B%E6%A0%88"><span class="nav-number">13.2.3.</span> <span class="nav-text">B.3 å€¼å‹æ ˆ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-4-%E8%A1%A8%E6%93%8D%E4%BD%9C"><span class="nav-number">13.2.4.</span> <span class="nav-text">B.4 è¡¨æ“ä½œ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-5-%E5%85%83%E8%A1%A8%E6%93%8D%E4%BD%9C"><span class="nav-number">13.2.5.</span> <span class="nav-text">B.5 å…ƒè¡¨æ“ä½œ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-6-%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8"><span class="nav-number">13.2.6.</span> <span class="nav-text">B.6 å‡½æ•°è°ƒç”¨</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-7-%E5%BC%95%E7%94%A8%E7%B3%BB%E7%BB%9F"><span class="nav-number">13.2.7.</span> <span class="nav-text">B.7 å¼•ç”¨ç³»ç»Ÿ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-8-Userdata"><span class="nav-number">13.2.8.</span> <span class="nav-text">B.8 Userdata</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-9-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="nav-number">13.2.9.</span> <span class="nav-text">B.9 é”™è¯¯å¤„ç†</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-10-%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="nav-number">13.2.10.</span> <span class="nav-text">B.10 å®ç”¨å·¥å…·</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-11-%E5%B8%B8%E7%94%A8%E4%BB%A3%E7%A0%81%E6%A8%A1%E5%BC%8F"><span class="nav-number">13.2.11.</span> <span class="nav-text">B.11 å¸¸ç”¨ä»£ç æ¨¡å¼</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#C-%E6%80%A7%E8%83%BD%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95"><span class="nav-number">13.3.</span> <span class="nav-text">C. æ€§èƒ½åŸºå‡†æµ‹è¯•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#D-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5"><span class="nav-number">13.4.</span> <span class="nav-text">D. å¸¸è§é—®é¢˜æ’æŸ¥</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">14.</span> <span class="nav-text">æ€»ç»“</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A1%A5%E5%85%85%E8%AF%B4%E6%98%8E"><span class="nav-number">15.</span> <span class="nav-text">è¡¥å……è¯´æ˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E8%A6%81%E7%82%B9%E6%80%BB%E7%BB%93"><span class="nav-number">15.1.</span> <span class="nav-text">æ ¸å¿ƒæŠ€æœ¯è¦ç‚¹æ€»ç»“</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E6%B3%A8%E5%86%8C%E8%A1%A8%E6%98%AF%E4%B8%80%E5%88%87%E7%9A%84%E5%9F%BA%E7%A1%80"><span class="nav-number">15.1.1.</span> <span class="nav-text">1. æ³¨å†Œè¡¨æ˜¯ä¸€åˆ‡çš„åŸºç¡€</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E8%A6%86%E5%86%99%E5%87%BD%E6%95%B0%E7%9A%84%E6%9C%AC%E8%B4%A8"><span class="nav-number">15.1.2.</span> <span class="nav-text">2. è¦†å†™å‡½æ•°çš„æœ¬è´¨</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E6%A0%88%E6%93%8D%E4%BD%9C%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%BC%8F"><span class="nav-number">15.1.3.</span> <span class="nav-text">3. æ ˆæ“ä½œçš„æ ¸å¿ƒæ¨¡å¼</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E9%9D%99%E6%80%81%E5%AF%BC%E5%87%BA%E7%9A%84%E6%97%B6%E6%9C%BA"><span class="nav-number">15.1.4.</span> <span class="nav-text">4. é™æ€å¯¼å‡ºçš„æ—¶æœº</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">15.2.</span> <span class="nav-text">å…³é”®æ•°æ®ç»“æ„</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-ULuaFunction-%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F"><span class="nav-number">15.2.1.</span> <span class="nav-text">1. ULuaFunction æˆå‘˜å˜é‡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-FFunctionDesc-%E8%B0%83%E7%94%A8%E9%93%BE"><span class="nav-number">15.2.2.</span> <span class="nav-text">2. FFunctionDesc è°ƒç”¨é“¾</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-Closure-%E7%BB%93%E6%9E%84"><span class="nav-number">15.2.3.</span> <span class="nav-text">3. Closure ç»“æ„</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7"><span class="nav-number">15.3.</span> <span class="nav-text">è°ƒè¯•æŠ€å·§</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E6%9F%A5%E7%9C%8B%E6%A0%88%E5%86%85%E5%AE%B9"><span class="nav-number">15.3.1.</span> <span class="nav-text">1. æŸ¥çœ‹æ ˆå†…å®¹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%A3%80%E6%9F%A5%E8%A6%86%E5%86%99%E7%8A%B6%E6%80%81"><span class="nav-number">15.3.2.</span> <span class="nav-text">2. æ£€æŸ¥è¦†å†™çŠ¶æ€</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E8%BF%BD%E8%B8%AA-Lua-%E8%B0%83%E7%94%A8"><span class="nav-number">15.3.3.</span> <span class="nav-text">3. è¿½è¸ª Lua è°ƒç”¨</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E6%A1%A3%E8%B4%A8%E9%87%8F%E6%94%B9%E8%BF%9B-%E6%9C%80%E7%BB%88%E4%BF%AE%E8%AE%A2"><span class="nav-number">15.4.</span> <span class="nav-text">æ–‡æ¡£è´¨é‡æ”¹è¿› (æœ€ç»ˆä¿®è®¢)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E6%A0%BC%E5%BC%8F%E9%97%AE%E9%A2%98%E4%BF%AE%E5%A4%8D"><span class="nav-number">15.4.1.</span> <span class="nav-text">1. æ ¼å¼é—®é¢˜ä¿®å¤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%BA%90%E7%A0%81%E8%A1%8C%E5%8F%B7%E4%BF%AE%E6%AD%A3"><span class="nav-number">15.4.2.</span> <span class="nav-text">2. æºç è¡Œå·ä¿®æ­£</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E7%AB%A0%E8%8A%82%E7%BC%96%E5%8F%B7%E8%A7%84%E8%8C%83%E5%8C%96"><span class="nav-number">15.4.3.</span> <span class="nav-text">3. ç« èŠ‚ç¼–å·è§„èŒƒåŒ–</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E6%A1%A3%E7%89%B9%E8%89%B2"><span class="nav-number">15.5.</span> <span class="nav-text">æ–‡æ¡£ç‰¹è‰²</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E6%9C%AF%E5%87%86%E7%A1%AE%E6%80%A7%E4%BF%9D%E8%AF%81"><span class="nav-number">15.6.</span> <span class="nav-text">æŠ€æœ¯å‡†ç¡®æ€§ä¿è¯</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="FixCode"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">FixCode</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">2</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/1778750163" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;1778750163" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hi1778750163@gmail.com" title="E-Mail â†’ mailto:hi1778750163@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="è¿”å›é¡¶éƒ¨">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
        <div class="pjax">
        </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.fixcod.cn/2024/04/14/Unlua%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="FixCode">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FixCode Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Unluaä»£ç åˆ†æ | FixCode Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Unluaä»£ç åˆ†æ<a href="https://github.com/1778750163/Hexo/edit/main/blog/source/_posts/Unlua%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.md" class="post-edit-link" title="ç¼–è¾‘" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a>
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2024-04-14 13:56:36" itemprop="dateCreated datePublished" datetime="2024-04-14T13:56:36+00:00">2024-04-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-12-01 11:30:50" itemprop="dateModified" datetime="2025-12-01T11:30:50+00:00">2025-12-01</time>
    </span>

  
    <span class="post-meta-item" title="é˜…è¯»æ¬¡æ•°" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>15k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>55 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>UnLua æ˜¯ Tencent å¼€æºçš„é«˜æ€§èƒ½ Lua-UE ç»‘å®šæ¡†æ¶ï¼Œä¸º Unreal Engine æä¾›äº†å®Œå–„çš„ Lua è„šæœ¬æ”¯æŒã€‚æœ¬æ–‡æ¡£åŸºäºæºç æ·±åº¦å‰–æ UnLua çš„æ ¸å¿ƒå®ç°åŸç†ï¼Œæ¶µç›–ä»¥ä¸‹å†…å®¹ï¼š</p>
<h3 id="ğŸ“š-æ–‡æ¡£ç»“æ„"><a href="#ğŸ“š-æ–‡æ¡£ç»“æ„" class="headerlink" title="ğŸ“š æ–‡æ¡£ç»“æ„"></a>ğŸ“š æ–‡æ¡£ç»“æ„</h3><ul>
<li><strong>Lua C API åŸºç¡€</strong> - æ³¨å†Œè¡¨ã€å…ƒè¡¨ã€æ ˆæ“ä½œç­‰æ ¸å¿ƒæ¦‚å¿µ</li>
<li><strong>æ¶æ„è®¾è®¡</strong> - å››å±‚æ¶æ„ï¼ˆLua å±‚ã€ç»‘å®šå±‚ã€æ³¨å†Œå±‚ã€æ ¸å¿ƒå±‚ï¼‰</li>
<li><strong>é™æ€å¯¼å‡ºæœºåˆ¶</strong> - ç¼–è¯‘æœŸç±»å‹å¯¼å‡ºä¸é›¶è¿è¡Œæ—¶å¼€é”€</li>
<li><strong>åŠ¨æ€ç»‘å®šæœºåˆ¶</strong> - è¿è¡Œæ—¶æ¨¡å—åŠ è½½ä¸çƒ­æ›´æ–°æ”¯æŒ</li>
<li><strong>ç±»æ³¨å†Œç³»ç»Ÿ</strong> - ClassRegistry ä¸ ObjectRegistry åŒå±‚æ¶æ„</li>
<li><strong>å‡½æ•°è¦†å†™åŸç†</strong> - ProcessEvent Hook ä¸ Lua å‡½æ•°æ‹¦æˆª</li>
<li><strong>ç±»å‹è½¬æ¢</strong> - C++&#x2F;Lua ç±»å‹è‡ªåŠ¨è½¬æ¢ä¸å‚æ•°ä¼ é€’</li>
<li><strong>GC ä¸ç”Ÿå‘½å‘¨æœŸ</strong> - å¯¹è±¡å¼•ç”¨ç®¡ç†ä¸å†…å­˜å®‰å…¨</li>
<li><strong>æ€§èƒ½ä¼˜åŒ–</strong> - ç¼“å­˜ç­–ç•¥ä¸è°ƒç”¨ä¼˜åŒ–</li>
<li><strong>æœ€ä½³å®è·µ</strong> - å®æˆ˜æ¡ˆä¾‹ä¸å¸¸è§é—®é¢˜è§£å†³</li>
</ul>
<hr>
<span id="more"></span>

<h2 id="Lua-C-API-åŸºç¡€æ¦‚å¿µ"><a href="#Lua-C-API-åŸºç¡€æ¦‚å¿µ" class="headerlink" title="Lua C API åŸºç¡€æ¦‚å¿µ"></a>Lua C API åŸºç¡€æ¦‚å¿µ</h2><h3 id="æ³¨å†Œè¡¨-Registry"><a href="#æ³¨å†Œè¡¨-Registry" class="headerlink" title="æ³¨å†Œè¡¨ (Registry)"></a>æ³¨å†Œè¡¨ (Registry)</h3><p><strong>æ³¨å†Œè¡¨çš„æœ¬è´¨</strong>:</p>
<ul>
<li>Lua æ³¨å†Œè¡¨æ˜¯ä¸€ä¸ª<strong>å…¨å±€å“ˆå¸Œè¡¨</strong>,åªèƒ½é€šè¿‡ C API è®¿é—®,Lua ä»£ç æ— æ³•ç›´æ¥è®¿é—®</li>
<li>è®¿é—®æ–¹å¼: <code>lua_getfield(L, LUA_REGISTRYINDEX, key)</code></li>
<li>å­˜å‚¨ä½ç½®: Lua VM å†…éƒ¨,ç‹¬ç«‹äº Lua å…¨å±€ç¯å¢ƒ</li>
</ul>
<p><strong>æ³¨å†Œè¡¨å†…éƒ¨ç»“æ„</strong>:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- æ¦‚å¿µæ¨¡å‹ (å®é™…ä¸å¯ç›´æ¥è®¿é—®)</span></span><br><span class="line">LUA_REGISTRYINDEX = &#123;</span><br><span class="line">    [<span class="string">&quot;_G&quot;</span>] = <span class="built_in">_G</span>,                  <span class="comment">-- Lua å…¨å±€ç¯å¢ƒ</span></span><br><span class="line">    [<span class="string">&quot;_LOADED&quot;</span>] = <span class="built_in">package</span>.<span class="built_in">loaded</span>, <span class="comment">-- å·²åŠ è½½æ¨¡å—</span></span><br><span class="line">    [<span class="string">&quot;UnLua_ObjectMap&quot;</span>] = &#123;...&#125;,  <span class="comment">-- UnLua å¯¹è±¡ç¼“å­˜</span></span><br><span class="line">    [<span class="string">&quot;UObject&quot;</span>] = &#123;...&#125;,          <span class="comment">-- å‘½åå…ƒè¡¨</span></span><br><span class="line">    [<span class="number">1</span>] = &#123;...&#125;,                  <span class="comment">-- luaL_ref åˆ›å»ºçš„å¼•ç”¨</span></span><br><span class="line">    [<span class="number">2</span>] = <span class="function"><span class="keyword">function</span><span class="params">()</span></span> ... <span class="keyword">end</span>,     <span class="comment">-- å¼•ç”¨ID=2</span></span><br><span class="line">    <span class="comment">-- ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ä¸»è¦ç”¨é€”</strong>:</p>
<table>
<thead>
<tr>
<th>ç”¨é€”</th>
<th>API</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>å‘½åå…ƒè¡¨</td>
<td><code>luaL_newmetatable(L, &quot;UObject&quot;)</code></td>
<td>å…¨å±€å”¯ä¸€å…ƒè¡¨</td>
</tr>
<tr>
<td>å¯¹è±¡å¼•ç”¨</td>
<td><code>luaL_ref(L, LUA_REGISTRYINDEX)</code></td>
<td>é˜²æ­¢ GC å›æ”¶</td>
</tr>
<tr>
<td>å…¨å±€çŠ¶æ€</td>
<td><code>lua_setfield(L, LUA_REGISTRYINDEX, key)</code></td>
<td>å­˜å‚¨ C++ çŠ¶æ€</td>
</tr>
</tbody></table>
<p><strong>ç¤ºä¾‹ä»£ç </strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨æ³¨å†Œè¡¨å­˜å‚¨è‡ªå®šä¹‰æ•°æ®</span></span><br><span class="line"><span class="built_in">lua_newtable</span>(L);</span><br><span class="line"><span class="built_in">lua_setfield</span>(L, LUA_REGISTRYINDEX, <span class="string">&quot;UnLua_CustomData&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»å–æ³¨å†Œè¡¨æ•°æ®</span></span><br><span class="line"><span class="built_in">lua_getfield</span>(L, LUA_REGISTRYINDEX, <span class="string">&quot;UnLua_CustomData&quot;</span>);</span><br><span class="line"><span class="comment">// æ ˆ: [CustomData è¡¨]</span></span><br></pre></td></tr></table></figure>

<h3 id="å…ƒè¡¨-Metatable-æ ¸å¿ƒ-API"><a href="#å…ƒè¡¨-Metatable-æ ¸å¿ƒ-API" class="headerlink" title="å…ƒè¡¨ (Metatable) æ ¸å¿ƒ API"></a>å…ƒè¡¨ (Metatable) æ ¸å¿ƒ API</h3><p><strong>å‘½åå…ƒè¡¨ vs åŒ¿åå…ƒè¡¨</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// â˜… å‘½åå…ƒè¡¨ (å­˜å‚¨åœ¨æ³¨å†Œè¡¨,å…¨å±€å”¯ä¸€)</span></span><br><span class="line"><span class="built_in">luaL_newmetatable</span>(L, <span class="string">&quot;UObject&quot;</span>);  </span><br><span class="line"><span class="comment">// ç­‰ä»·äº:</span></span><br><span class="line"><span class="comment">//   lua_newtable(L);</span></span><br><span class="line"><span class="comment">//   lua_pushvalue(L, -1);</span></span><br><span class="line"><span class="comment">//   lua_setfield(L, LUA_REGISTRYINDEX, &quot;UObject&quot;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// â˜… åŒ¿åå…ƒè¡¨ (ä»…å­˜åœ¨äºæ ˆä¸Š)</span></span><br><span class="line"><span class="built_in">lua_newtable</span>(L);</span><br><span class="line"><span class="built_in">lua_setmetatable</span>(L, <span class="number">-2</span>);  <span class="comment">// è®¾ç½®ç»™æŸä¸ªå¯¹è±¡</span></span><br></pre></td></tr></table></figure>

<p><strong>è·å–å…ƒè¡¨çš„åŒºåˆ«</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// luaL_getmetatable: ä»æ³¨å†Œè¡¨è·å–å‘½åå…ƒè¡¨</span></span><br><span class="line"><span class="built_in">luaL_getmetatable</span>(L, <span class="string">&quot;UObject&quot;</span>);</span><br><span class="line"><span class="comment">// è¿”å›: LUA_TTABLE(æˆåŠŸ) æˆ– LUA_TNIL(ä¸å­˜åœ¨)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// lua_getmetatable: è·å–å¯¹è±¡çš„å…ƒè¡¨</span></span><br><span class="line"><span class="built_in">lua_getmetatable</span>(L, <span class="number">1</span>);  </span><br><span class="line"><span class="comment">// è¿”å›: 1(æœ‰å…ƒè¡¨) æˆ– 0(æ— å…ƒè¡¨)</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="æ¶æ„æ¦‚è§ˆ"><a href="#æ¶æ„æ¦‚è§ˆ" class="headerlink" title="æ¶æ„æ¦‚è§ˆ"></a>æ¶æ„æ¦‚è§ˆ</h2><h3 id="æ•´ä½“æ¶æ„å›¾"><a href="#æ•´ä½“æ¶æ„å›¾" class="headerlink" title="æ•´ä½“æ¶æ„å›¾"></a>æ•´ä½“æ¶æ„å›¾</h3><pre><code class="highlight mermaid">graph TB
    subgraph Luaå±‚[&quot;ğŸ¯ Lua å±‚&quot;]
        LS[Lua Scripts]
        LM[Lua Modules]
        LT[Lua Tables]
    end
    
    subgraph ç»‘å®šå±‚[&quot;ğŸ”— ç»‘å®šå±‚&quot;]
        SE[&quot;é™æ€å¯¼å‡º&lt;br/&gt;ğŸ“Œ ç¼–è¯‘æœŸ&quot;]
        DB[&quot;åŠ¨æ€ç»‘å®š&lt;br/&gt;âš¡ è¿è¡Œæ—¶&quot;]
        RB[&quot;åå°„ç»‘å®š&lt;br/&gt;ğŸ”„ æŒ‰éœ€åŠ è½½&quot;]
    end
    
    subgraph æ³¨å†Œå±‚[&quot;ğŸ“‹ æ³¨å†Œå±‚&quot;]
        RS[Registry System]
        CR[Class Registry]
        OR[Object Registry]
        FR[Function Registry]
    end
    
    subgraph æ ¸å¿ƒå±‚[&quot;âš™ï¸ æ ¸å¿ƒå±‚&quot;]
        LE[&quot;LuaEnv&lt;br/&gt;Lua VM ç®¡ç†å™¨&quot;]
        GC[GC ç®¡ç†]
        REF[å¯¹è±¡å¼•ç”¨]
        MEM[å†…å­˜åˆ†é…]
    end
    
    LS --&gt; SE
    LM --&gt; DB
    LT --&gt; RB
    
    SE --&gt; RS
    DB --&gt; RS
    RB --&gt; RS
    
    RS --&gt; CR
    RS --&gt; OR
    RS --&gt; FR
    
    CR --&gt; LE
    OR --&gt; LE
    FR --&gt; LE
    
    LE --&gt; GC
    LE --&gt; REF
    LE --&gt; MEM
    
    classDef luaLayer fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef bindLayer fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef regLayer fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef coreLayer fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    
    class LS,LM,LT luaLayer
    class SE,DB,RB bindLayer
    class RS,CR,OR,FR regLayer
    class LE,GC,REF,MEM coreLayer</code></pre>

<h3 id="æ ¸å¿ƒç»„ä»¶èŒè´£è¡¨"><a href="#æ ¸å¿ƒç»„ä»¶èŒè´£è¡¨" class="headerlink" title="æ ¸å¿ƒç»„ä»¶èŒè´£è¡¨"></a>æ ¸å¿ƒç»„ä»¶èŒè´£è¡¨</h3><table>
<thead>
<tr>
<th>ç»„ä»¶</th>
<th>èŒè´£</th>
<th>å…³é”®æ–‡ä»¶</th>
</tr>
</thead>
<tbody><tr>
<td><strong>FLuaEnv</strong></td>
<td>Lua è™šæ‹Ÿæœºç®¡ç†ã€ç¯å¢ƒéš”ç¦»ã€ç”Ÿå‘½å‘¨æœŸæ§åˆ¶</td>
<td><code>LuaEnv.h/cpp</code></td>
</tr>
<tr>
<td><strong>FClassRegistry</strong></td>
<td>UE ç±»å‹åˆ° Lua Metatable æ˜ å°„ã€åå°„ç±»å‹æ³¨å†Œ</td>
<td><code>ClassRegistry.h/cpp</code></td>
</tr>
<tr>
<td><strong>FObjectRegistry</strong></td>
<td>UObject å®ä¾‹åˆ° Lua Userdata æ˜ å°„ã€å¼•ç”¨ç®¡ç†</td>
<td><code>ObjectRegistry.h/cpp</code></td>
</tr>
<tr>
<td><strong>FFunctionDesc</strong></td>
<td>UFunction æè¿°ç¬¦ã€å‚æ•°è§£æã€è°ƒç”¨åˆ†å‘</td>
<td><code>FunctionDesc.h/cpp</code></td>
</tr>
<tr>
<td><strong>FPropertyDesc</strong></td>
<td>UProperty æè¿°ç¬¦ã€ç±»å‹è½¬æ¢ã€è¯»å†™è®¿é—®</td>
<td><code>PropertyDesc.h/cpp</code></td>
</tr>
<tr>
<td><strong>FLuaDynamicBinding</strong></td>
<td>åŠ¨æ€ç»‘å®šå †æ ˆç®¡ç†ã€æ¨¡å—åŠ è½½åè°ƒ</td>
<td><code>LuaDynamicBinding.h/cpp</code></td>
</tr>
<tr>
<td><strong>FObjectReferencer</strong></td>
<td>GC å¼•ç”¨è®¡æ•°ç®¡ç†ã€é˜²æ‚¬ç©ºæŒ‡é’ˆ</td>
<td><code>ObjectReferencer.h</code></td>
</tr>
</tbody></table>
<h3 id="æ•°æ®æµç¤ºæ„å›¾"><a href="#æ•°æ®æµç¤ºæ„å›¾" class="headerlink" title="æ•°æ®æµç¤ºæ„å›¾"></a>æ•°æ®æµç¤ºæ„å›¾</h3><p><strong>Lua è°ƒç”¨ C++&#x2F;è“å›¾:</strong></p>
<pre><code class="highlight mermaid">flowchart TD
    A([Lua Call]) --&gt; B[Class_CallUFunc]
    B --&gt; C[FFunctionDesc::CallUE]
    C --&gt; D1[PreCall: Lua â†’ C++ å‚æ•°è½¬æ¢]
    D1 --&gt; D2[UObject::ProcessEvent]
    D2 --&gt; D3[PostCall: C++ â†’ Lua è¿”å›å€¼]
    
    style A fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style C fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style D2 fill:#f3e5f5,stroke:#4a148c,stroke-width:2px</code></pre>

<p><strong>C++&#x2F;è“å›¾è°ƒç”¨ Lua:</strong></p>
<pre><code class="highlight mermaid">flowchart TD
    A([ProcessEvent]) --&gt; B[FLuaOverrider Hook]
    B --&gt; C&#123;æ˜¯å¦æœ‰&lt;br/&gt;Lua è¦†å†™?&#125;
    C --&gt;|æ˜¯| D[FFunctionDesc::CallLua]
    C --&gt;|å¦| E[Super::ProcessEvent]
    
    D --&gt; D1[æŸ¥æ‰¾ Lua å‡½æ•°]
    D1 --&gt; D2[C++ â†’ Lua å‚æ•°è½¬æ¢]
    D2 --&gt; D3[lua_pcall]
    D3 --&gt; D4[Lua â†’ C++ è¿”å›å€¼]
    
    style A fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style C fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    style D fill:#ffccbc,stroke:#bf360c,stroke-width:2px</code></pre>

<hr>
<h2 id="é™æ€å¯¼å‡ºæœºåˆ¶"><a href="#é™æ€å¯¼å‡ºæœºåˆ¶" class="headerlink" title="é™æ€å¯¼å‡ºæœºåˆ¶"></a>é™æ€å¯¼å‡ºæœºåˆ¶</h2><h3 id="æ ¸å¿ƒåŸç†"><a href="#æ ¸å¿ƒåŸç†" class="headerlink" title="æ ¸å¿ƒåŸç†"></a>æ ¸å¿ƒåŸç†</h3><p>é™æ€å¯¼å‡ºæ˜¯åœ¨<strong>ç¼–è¯‘æœŸ</strong>é€šè¿‡ C++ æ¨¡æ¿å…ƒç¼–ç¨‹å’Œå…¨å±€æ„é€ å‡½æ•°å®ç°çš„ï¼Œæ— éœ€åå°„ç³»ç»Ÿå‚ä¸ã€‚</p>
<h4 id="å®ç°æœºåˆ¶"><a href="#å®ç°æœºåˆ¶" class="headerlink" title="å®ç°æœºåˆ¶"></a>å®ç°æœºåˆ¶</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnLuaEx.h æ ¸å¿ƒå®å®šä¹‰</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BEGIN_EXPORT_CLASS(ClassName)                               \</span></span><br><span class="line"><span class="meta">    struct FExported##ClassName##Helper                             \</span></span><br><span class="line"><span class="meta">    &#123;                                                                \</span></span><br><span class="line"><span class="meta">        static struct FExported##ClassName : public UnLua::FExportedClass<span class="string">&lt;ClassName&gt;</span> \</span></span><br><span class="line"><span class="meta">        &#123;                                                            \</span></span><br><span class="line"><span class="meta">            FExported##ClassName() : FExportedClass(#ClassName)      \</span></span><br><span class="line"><span class="meta">            &#123;                                                        \</span></span><br><span class="line"><span class="meta">                <span class="comment">// æ³¨å†Œå‡½æ•°ã€å±æ€§ç­‰</span></span></span><br><span class="line">            &#125;                                                        \</span><br><span class="line">        &#125; Exported;                                                  \</span><br><span class="line">    &#125;;                                                               \</span><br><span class="line">    FExported##ClassName##Helper::FExported##ClassName </span><br><span class="line">    FExported##ClassName##Helper::Exported;</span><br></pre></td></tr></table></figure>

<p><strong>å…³é”®ç‚¹</strong>:</p>
<ol>
<li><strong>å…¨å±€é™æ€å¯¹è±¡</strong>: åˆ©ç”¨ C++ å…¨å±€å¯¹è±¡æ„é€ åœ¨ <code>main()</code> å‰æ‰§è¡Œçš„ç‰¹æ€§</li>
<li><strong>æ¨¡æ¿ç‰¹åŒ–</strong>: <code>TExportedFunction&lt;RetType, Args...&gt;</code> è‡ªåŠ¨è§£æç±»å‹</li>
<li><strong>é›¶è¿è¡Œæ—¶æˆæœ¬</strong>: ç±»å‹ä¿¡æ¯åœ¨ç¼–è¯‘æœŸç¡®å®š</li>
</ol>
<p><strong>å®å±•å¼€ç¤ºä¾‹</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”¨æˆ·ä»£ç </span></span><br><span class="line"><span class="built_in">BEGIN_EXPORT_CLASS</span>(FMyMathLib)</span><br><span class="line">    <span class="built_in">ADD_STATIC_FUNCTION</span>(Add)</span><br><span class="line"><span class="built_in">END_EXPORT_CLASS</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// å±•å¼€å (ç®€åŒ–ç‰ˆ):</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FExportedFMyMathLibHelper</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">FExportedFMyMathLib</span> : <span class="keyword">public</span> UnLua::FExportedClass&lt;FMyMathLib&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">FExportedFMyMathLib</span>() : <span class="built_in">FExportedClass</span>(<span class="string">&quot;FMyMathLib&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// â˜… æ„é€ å‡½æ•°åœ¨ main() å‰æ‰§è¡Œ</span></span><br><span class="line">            <span class="built_in">AddFunction</span>(<span class="string">&quot;Add&quot;</span>, &amp;FMyMathLib::Add);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; Exported;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// â˜… å…¨å±€é™æ€å¯¹è±¡å®šä¹‰ (è§¦å‘æ„é€ å‡½æ•°)</span></span><br><span class="line">FExportedFMyMathLibHelper::FExportedFMyMathLib </span><br><span class="line">FExportedFMyMathLibHelper::Exported;</span><br></pre></td></tr></table></figure>

<h4 id="å…¨å±€æ„é€ å‡½æ•°è§¦å‘æµç¨‹"><a href="#å…¨å±€æ„é€ å‡½æ•°è§¦å‘æµç¨‹" class="headerlink" title="å…¨å±€æ„é€ å‡½æ•°è§¦å‘æµç¨‹"></a>å…¨å±€æ„é€ å‡½æ•°è§¦å‘æµç¨‹</h4><pre><code class="highlight mermaid">flowchart TB
    Start([æ“ä½œç³»ç»ŸåŠ è½½ç¨‹åº]) --&gt; Load[åŠ è½½æ‰€æœ‰åŠ¨æ€åº“ DLL/SO]
    Load --&gt; Init[åˆå§‹åŒ–å…¨å±€å˜é‡åŒº]
    Init --&gt; Global[æ‰§è¡Œå…¨å±€å¯¹è±¡æ„é€ å‡½æ•°&lt;br/&gt;æŒ‰ç¼–è¯‘é¡ºåº]
    
    Global --&gt; G1[FExportedFMyMathLib::FExportedFMyMathLib]
    G1 --&gt; G1a[ExportClass this&lt;br/&gt;æ³¨å†Œåˆ°å…¨å±€å®¹å™¨]
    G1a --&gt; G2[FExportedOtherClass::FExportedOtherClass]
    G2 --&gt; G2a[ExportClass this]
    G2a --&gt; G3[... æ‰€æœ‰ BEGIN_EXPORT_CLASS]
    
    G3 --&gt; Main[æ‰§è¡Œ main æˆ– UE å¼•æ“å¯åŠ¨]
    Main --&gt; LuaInit[FLuaEnv::Initialize]
    LuaInit --&gt; Register[RegisterExportedClasses]
    Register --&gt; Traverse[éå†å…¨å±€å®¹å™¨,æ³¨å†Œåˆ° Lua]
    
    style Start fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style Global fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style LuaInit fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    style Traverse fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px</code></pre>

<p><strong>æºç å‰–æ</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnLuaBase.cpp</span></span><br><span class="line"><span class="type">static</span> TArray&lt;FExportedClass*&gt;* GExportedClasses = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ExportClass</span><span class="params">(FExportedClass* Class)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// â˜… å»¶è¿Ÿåˆå§‹åŒ–å…¨å±€å®¹å™¨</span></span><br><span class="line">    <span class="keyword">if</span> (!GExportedClasses)</span><br><span class="line">        GExportedClasses = <span class="keyword">new</span> <span class="built_in">TArray</span>&lt;FExportedClass*&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… å­˜å‚¨å¯¼å‡ºç±»æŒ‡é’ˆ</span></span><br><span class="line">    GExportedClasses-&gt;<span class="built_in">Add</span>(Class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">TArray&lt;FExportedClass*&gt;&amp; <span class="title">GetExportedClasses</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">check</span>(GExportedClasses);</span><br><span class="line">    <span class="keyword">return</span> *GExportedClasses;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LuaEnv.cpp:125</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FLuaEnv::Initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ... åˆå§‹åŒ– Lua VM ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ³¨å†Œæ‰€æœ‰é™æ€å¯¼å‡ºçš„ç±»</span></span><br><span class="line">    <span class="keyword">auto</span>&amp; ExportedClasses = <span class="built_in">GetExportedClasses</span>();</span><br><span class="line">    <span class="keyword">for</span> (FExportedClass* Class : ExportedClasses)</span><br><span class="line">    &#123;</span><br><span class="line">        Class-&gt;<span class="built_in">Register</span>(MainState);  <span class="comment">// æ³¨å†Œåˆ° Lua</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æ³¨å†Œæµç¨‹"><a href="#æ³¨å†Œæµç¨‹" class="headerlink" title="æ³¨å†Œæµç¨‹"></a>æ³¨å†Œæµç¨‹</h4><pre><code class="highlight mermaid">flowchart TB
    subgraph ç¼–è¯‘æœŸ
        A[å…¨å±€å¯¹è±¡æ„é€ ] --&gt; B[FExportedClass æ„é€ ]
        B --&gt; C1[ExportClass this&lt;br/&gt;å­˜å…¥å…¨å±€å®¹å™¨]
        B --&gt; C2[æ³¨å†Œæˆå‘˜å‡½æ•°]
        B --&gt; C3[æ³¨å†Œå±æ€§]
    end
    
    subgraph è¿è¡ŒæœŸ
        D[FLuaEnv::Initialize] --&gt; E[RegisterExportedClasses]
        E --&gt; F[éå†å…¨å±€å®¹å™¨å¹¶æ³¨å†Œåˆ° Lua]
    end
    
    C1 -.-&gt; D
    
    style A fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style D fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style F fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px</code></pre>

<h4 id="é™æ€å¯¼å‡ºæ³¨å†Œåˆ°-Lua-çš„å®Œæ•´æµç¨‹"><a href="#é™æ€å¯¼å‡ºæ³¨å†Œåˆ°-Lua-çš„å®Œæ•´æµç¨‹" class="headerlink" title="é™æ€å¯¼å‡ºæ³¨å†Œåˆ° Lua çš„å®Œæ•´æµç¨‹"></a>é™æ€å¯¼å‡ºæ³¨å†Œåˆ° Lua çš„å®Œæ•´æµç¨‹</h4><p><strong>FExportedClass::Register æºç å‰–æ</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnLuaEx.cpp</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FExportedClass::Register</span><span class="params">(lua_State* L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤1: åˆ›å»ºå‘½åå…ƒè¡¨</span></span><br><span class="line">    <span class="built_in">luaL_newmetatable</span>(L, ClassName.<span class="built_in">Get</span>());</span><br><span class="line">    <span class="comment">// æ ˆ: [metatable]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤2: è®¾ç½®ç»§æ‰¿å…³ç³»</span></span><br><span class="line">    <span class="keyword">if</span> (!SuperClassName.<span class="built_in">IsEmpty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">lua_pushstring</span>(L, <span class="string">&quot;Super&quot;</span>);</span><br><span class="line">        Type = <span class="built_in">luaL_getmetatable</span>(L, <span class="built_in">TCHAR_TO_UTF8</span>(*SuperClassName));</span><br><span class="line">        <span class="built_in">check</span>(Type == LUA_TTABLE);</span><br><span class="line">        <span class="built_in">lua_rawset</span>(L, <span class="number">-3</span>);</span><br><span class="line">        <span class="comment">// metatable.Super = SuperMetatable</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤3: è®¾ç½® __index å…ƒæ–¹æ³•</span></span><br><span class="line">    <span class="built_in">lua_pushstring</span>(L, <span class="string">&quot;__index&quot;</span>);</span><br><span class="line">    <span class="built_in">lua_pushvalue</span>(L, <span class="number">-2</span>);  <span class="comment">// å¤åˆ¶ metatable</span></span><br><span class="line">    <span class="keyword">if</span> (Properties.<span class="built_in">Num</span>() &gt; <span class="number">0</span> || !SuperClassName.<span class="built_in">IsEmpty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// â˜… æœ‰å±æ€§æˆ–çˆ¶ç±»æ—¶,ä½¿ç”¨é€šç”¨ Index å‡½æ•°</span></span><br><span class="line">        <span class="built_in">lua_pushcclosure</span>(L, UnLua::Index, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">lua_rawset</span>(L, <span class="number">-3</span>);</span><br><span class="line">    <span class="comment">// metatable.__index = Index é—­åŒ… (upvalue=metatable)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤4: è®¾ç½® __newindex å…ƒæ–¹æ³•</span></span><br><span class="line">    <span class="built_in">lua_pushstring</span>(L, <span class="string">&quot;__newindex&quot;</span>);</span><br><span class="line">    <span class="built_in">lua_pushvalue</span>(L, <span class="number">-2</span>);</span><br><span class="line">    <span class="keyword">if</span> (Properties.<span class="built_in">Num</span>() &gt; <span class="number">0</span> || !SuperClassName.<span class="built_in">IsEmpty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">lua_pushcclosure</span>(L, UnLua::NewIndex, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">lua_rawset</span>(L, <span class="number">-3</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤5: å…ƒè¡¨ä½œä¸ºè‡ªå·±çš„å…ƒè¡¨ (æ”¯æŒç±»æ–¹æ³•è°ƒç”¨)</span></span><br><span class="line">    <span class="built_in">lua_pushvalue</span>(L, <span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">lua_setmetatable</span>(L, <span class="number">-2</span>);</span><br><span class="line">    <span class="comment">// metatable.metatable = metatable</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤6: æ³¨å†Œæˆå‘˜å±æ€§</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; Property : Properties)</span><br><span class="line">        Property-&gt;<span class="built_in">Register</span>(L);</span><br><span class="line">    <span class="comment">// å°†å±æ€§ Getter/Setter æ·»åŠ åˆ° metatable</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤7: æ³¨å†Œæˆå‘˜å‡½æ•°</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; MemberFunc : Functions)</span><br><span class="line">        MemberFunc-&gt;<span class="built_in">Register</span>(L);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤8: æ³¨å†Œå…¨å±€å‡½æ•° (Glue å‡½æ•°)</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; Func : GlueFunctions)</span><br><span class="line">        Func-&gt;<span class="built_in">Register</span>(L);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ˆ: [metatable]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤9: å°†å…ƒè¡¨æ³¨å†Œåˆ°å…¨å±€ UE è¡¨</span></span><br><span class="line">    <span class="built_in">lua_getglobal</span>(L, <span class="string">&quot;UE&quot;</span>);</span><br><span class="line">    <span class="comment">// æ ˆ: [metatable, UE]</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">lua_pushstring</span>(L, ClassName.<span class="built_in">Get</span>());</span><br><span class="line">    <span class="comment">// æ ˆ: [metatable, UE, &quot;FMyMathLib&quot;]</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">lua_pushvalue</span>(L, <span class="number">-3</span>);</span><br><span class="line">    <span class="comment">// æ ˆ: [metatable, UE, &quot;FMyMathLib&quot;, metatable]</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">lua_rawset</span>(L, <span class="number">-3</span>);</span><br><span class="line">    <span class="comment">// UE[&quot;FMyMathLib&quot;] = metatable</span></span><br><span class="line">    <span class="comment">// æ ˆ: [metatable, UE]</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">lua_pop</span>(L, <span class="number">2</span>);</span><br><span class="line">    <span class="comment">// æ ˆ: []</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æˆå‘˜å‡½æ•°æ³¨å†Œç¤ºä¾‹</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FExportedFunction::Register</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FExportedFunction::Register</span><span class="params">(lua_State* L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// â˜… æ ˆ: [metatable]</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">lua_pushstring</span>(L, <span class="built_in">TCHAR_TO_UTF8</span>(*Name));  </span><br><span class="line">    <span class="comment">// æ ˆ: [metatable, &quot;Add&quot;]</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">lua_pushlightuserdata</span>(L, <span class="keyword">this</span>);  </span><br><span class="line">    <span class="comment">// æ ˆ: [metatable, &quot;Add&quot;, thisæŒ‡é’ˆ]</span></span><br><span class="line">    <span class="comment">// â˜… æ³¨æ„: light userdata ä¸å ç”¨é¢å¤–å†…å­˜,ä»…å­˜å‚¨æŒ‡é’ˆå€¼</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">lua_pushcclosure</span>(L, InvokeFunction, <span class="number">1</span>);  </span><br><span class="line">    <span class="comment">// æ ˆ: [metatable, &quot;Add&quot;, &lt;Closure&gt;]</span></span><br><span class="line">    <span class="comment">// â˜… å…³é”®: InvokeFunction å¯é€šè¿‡ lua_upvalueindex(1) è·å– this</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">lua_rawset</span>(L, <span class="number">-3</span>);  </span><br><span class="line">    <span class="comment">// metatable[&quot;Add&quot;] = Closure</span></span><br><span class="line">    <span class="comment">// æ ˆ: [metatable]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>InvokeFunction è°ƒç”¨å…¥å£</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnLuaEx.cpp</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">InvokeFunction</span><span class="params">(lua_State* L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// â˜… è·å– upvalue (FExportedFunction æŒ‡é’ˆ)</span></span><br><span class="line">    IExportedFunction* Func = (IExportedFunction*)<span class="built_in">lua_touserdata</span>(L, <span class="built_in">lua_upvalueindex</span>(<span class="number">1</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… è°ƒç”¨å®é™…å‡½æ•° (é€šè¿‡æ¨¡æ¿ç‰¹åŒ–)</span></span><br><span class="line">    <span class="keyword">return</span> Func ? Func-&gt;<span class="built_in">Invoke</span>(L) : <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¨¡æ¿ç‰¹åŒ–ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Ret, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line"><span class="type">int</span> TExportedFunction&lt;Ret, Args...&gt;::<span class="built_in">Invoke</span>(lua_State* L)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// â˜… ä»æ ˆè¯»å–å‚æ•°</span></span><br><span class="line">    <span class="keyword">auto</span> Params = <span class="built_in">ReadParams</span>&lt;Args...&gt;(L, <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… è°ƒç”¨ C++ å‡½æ•°</span></span><br><span class="line">    Ret Result = <span class="built_in">FunctionPtr</span>(Params...);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… å‹å…¥è¿”å›å€¼</span></span><br><span class="line">    UnLua::<span class="built_in">Push</span>(L, Result);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;  <span class="comment">// è¿”å›1ä¸ªå€¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Lua è°ƒç”¨æµç¨‹</strong>:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Lua ä»£ç </span></span><br><span class="line"><span class="keyword">local</span> result = UE.FMyMathLib.Add(<span class="number">10</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ‰§è¡Œè¿‡ç¨‹:</span></span><br><span class="line"><span class="comment">-- 1. UE[&quot;FMyMathLib&quot;][&quot;Add&quot;]  â†’ è§¦å‘ __index,è¿”å› Closure</span></span><br><span class="line"><span class="comment">-- 2. Closure(10, 20)          â†’ InvokeFunction</span></span><br><span class="line"><span class="comment">-- 3. lua_upvalueindex(1)      â†’ è·å– FExportedFunction*</span></span><br><span class="line"><span class="comment">-- 4. FExportedFunction::Invoke â†’ è°ƒç”¨ FMyMathLib::Add</span></span><br><span class="line"><span class="comment">-- 5. è¿”å› 30</span></span><br></pre></td></tr></table></figure>

<h3 id="ä»£ç ç¤ºä¾‹"><a href="#ä»£ç ç¤ºä¾‹" class="headerlink" title="ä»£ç ç¤ºä¾‹"></a>ä»£ç ç¤ºä¾‹</h3><h4 id="ç¤ºä¾‹-1-å¯¼å‡ºé™æ€å·¥å…·ç±»"><a href="#ç¤ºä¾‹-1-å¯¼å‡ºé™æ€å·¥å…·ç±»" class="headerlink" title="ç¤ºä¾‹ 1: å¯¼å‡ºé™æ€å·¥å…·ç±»"></a>ç¤ºä¾‹ 1: å¯¼å‡ºé™æ€å·¥å…·ç±»</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MyMathLib.h</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FMyMathLib</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">float</span> <span class="title">Add</span><span class="params">(<span class="type">float</span> A, <span class="type">float</span> B)</span> </span>&#123; <span class="keyword">return</span> A + B; &#125;</span><br><span class="line">    <span class="function"><span class="type">static</span> FVector <span class="title">Normalize</span><span class="params">(<span class="type">const</span> FVector&amp; V)</span> </span>&#123; <span class="keyword">return</span> V.<span class="built_in">GetSafeNormal</span>(); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MyMathLib.cpp</span></span><br><span class="line"><span class="built_in">BEGIN_EXPORT_CLASS</span>(FMyMathLib)</span><br><span class="line">    <span class="built_in">ADD_STATIC_FUNCTION</span>(Add)</span><br><span class="line">    <span class="built_in">ADD_STATIC_FUNCTION</span>(Normalize)</span><br><span class="line"><span class="built_in">END_EXPORT_CLASS</span>()</span><br></pre></td></tr></table></figure>

<p><strong>Lua è°ƒç”¨</strong>:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> result = FMyMathLib.Add(<span class="number">10</span>, <span class="number">20</span>)  <span class="comment">-- è¿”å› 30</span></span><br><span class="line"><span class="keyword">local</span> vec = FMyMathLib.Normalize(FVector(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>))</span><br></pre></td></tr></table></figure>

<h4 id="ç¤ºä¾‹-2-å¯¼å‡ºå…¨å±€å‡½æ•°"><a href="#ç¤ºä¾‹-2-å¯¼å‡ºå…¨å±€å‡½æ•°" class="headerlink" title="ç¤ºä¾‹ 2: å¯¼å‡ºå…¨å±€å‡½æ•°"></a>ç¤ºä¾‹ 2: å¯¼å‡ºå…¨å±€å‡½æ•°</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">EXPORT_FUNCTION</span>(<span class="type">float</span>, GetGameTime)</span><br><span class="line">&#123;</span><br><span class="line">    UWorld* World = GWorld;</span><br><span class="line">    <span class="keyword">return</span> World ? World-&gt;<span class="built_in">GetTimeSeconds</span>() : <span class="number">0.0f</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Lua è°ƒç”¨</strong>:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">time</span> = GetGameTime()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å½“å‰æ¸¸æˆæ—¶é—´: &quot;</span> .. <span class="built_in">time</span>)</span><br></pre></td></tr></table></figure>

<h3 id="æ€§èƒ½ç‰¹æ€§"><a href="#æ€§èƒ½ç‰¹æ€§" class="headerlink" title="æ€§èƒ½ç‰¹æ€§"></a>æ€§èƒ½ç‰¹æ€§</h3><table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>é™æ€å¯¼å‡º</th>
<th>åŠ¨æ€ç»‘å®š</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><strong>æ³¨å†Œæ—¶æœº</strong></td>
<td>ç¨‹åºå¯åŠ¨å‰</td>
<td>è¿è¡Œæ—¶</td>
<td>é™æ€å¯¼å‡ºæ— è¿è¡Œæ—¶å¼€é”€</td>
</tr>
<tr>
<td><strong>ç±»å‹å®‰å…¨</strong></td>
<td>ç¼–è¯‘æœŸæ£€æŸ¥</td>
<td>è¿è¡Œæ—¶æ£€æŸ¥</td>
<td>é™æ€å¯¼å‡ºæ›´å®‰å…¨</td>
</tr>
<tr>
<td><strong>è°ƒç”¨å¼€é”€</strong></td>
<td>~1.5Î¼s</td>
<td>~2.5Î¼s</td>
<td>é™æ€å¯¼å‡ºå°‘ä¸€æ¬¡åå°„æŸ¥è¯¢</td>
</tr>
<tr>
<td><strong>æ”¯æŒåå°„</strong></td>
<td>å¦</td>
<td>æ˜¯</td>
<td>é™æ€å¯¼å‡ºä¸ä¾èµ– UE åå°„</td>
</tr>
<tr>
<td><strong>çƒ­æ›´æ–°</strong></td>
<td>å¦</td>
<td>æ˜¯</td>
<td>é™æ€å¯¼å‡ºéœ€é‡æ–°ç¼–è¯‘</td>
</tr>
</tbody></table>
<h3 id="é€‚ç”¨åœºæ™¯"><a href="#é€‚ç”¨åœºæ™¯" class="headerlink" title="é€‚ç”¨åœºæ™¯"></a>é€‚ç”¨åœºæ™¯</h3><h4 id="âœ…-é€‚åˆé™æ€å¯¼å‡ºçš„åœºæ™¯"><a href="#âœ…-é€‚åˆé™æ€å¯¼å‡ºçš„åœºæ™¯" class="headerlink" title="âœ… é€‚åˆé™æ€å¯¼å‡ºçš„åœºæ™¯"></a>âœ… é€‚åˆé™æ€å¯¼å‡ºçš„åœºæ™¯</h4><ul>
<li>æ•°å­¦&#x2F;ç®—æ³•åº“ (æ— çŠ¶æ€ã€çº¯è®¡ç®—)</li>
<li>å·¥å…·å‡½æ•°é›† (é¢‘ç¹è°ƒç”¨)</li>
<li>è‡ªå®šä¹‰ Struct (ä¸ç»§æ‰¿ UObject)</li>
<li>ç¬¬ä¸‰æ–¹åº“å°è£…</li>
</ul>
<h4 id="âŒ-ä¸é€‚åˆé™æ€å¯¼å‡ºçš„åœºæ™¯"><a href="#âŒ-ä¸é€‚åˆé™æ€å¯¼å‡ºçš„åœºæ™¯" class="headerlink" title="âŒ ä¸é€‚åˆé™æ€å¯¼å‡ºçš„åœºæ™¯"></a>âŒ ä¸é€‚åˆé™æ€å¯¼å‡ºçš„åœºæ™¯</h4><ul>
<li>Actor&#x2F;Component (ä½¿ç”¨åŠ¨æ€ç»‘å®š)</li>
<li>è“å›¾ç±» (ä½¿ç”¨åå°„å¯¼å‡º)</li>
<li>éœ€è¦çƒ­æ›´æ–°çš„é€»è¾‘</li>
</ul>
<hr>
<h2 id="åŠ¨æ€å¯¼å‡ºæœºåˆ¶"><a href="#åŠ¨æ€å¯¼å‡ºæœºåˆ¶" class="headerlink" title="åŠ¨æ€å¯¼å‡ºæœºåˆ¶"></a>åŠ¨æ€å¯¼å‡ºæœºåˆ¶</h2><h3 id="å·¥ä½œæµç¨‹"><a href="#å·¥ä½œæµç¨‹" class="headerlink" title="å·¥ä½œæµç¨‹"></a>å·¥ä½œæµç¨‹</h3><p>åŠ¨æ€å¯¼å‡ºæ˜¯ UnLua çš„æ ¸å¿ƒç‰¹æ€§ï¼Œå…è®¸åœ¨<strong>è¿è¡Œæ—¶</strong>å°† Lua æ¨¡å—ç»‘å®šåˆ° UE C++&#x2F;è“å›¾ç±»ã€‚</p>
<h4 id="å®Œæ•´æµç¨‹å›¾"><a href="#å®Œæ•´æµç¨‹å›¾" class="headerlink" title="å®Œæ•´æµç¨‹å›¾"></a>å®Œæ•´æµç¨‹å›¾</h4><pre><code class="highlight mermaid">flowchart TB
    subgraph S1[&quot;1ï¸âƒ£ Actor å®ä¾‹åŒ–&quot;]
        A1[AActor::BeginPlay] --&gt; A2[FUnLuaManager::OnUObjectBind]
        A2 --&gt; A3&#123;æ£€æŸ¥ç»‘å®šæ–¹å¼&#125;
        A3 --&gt;|æ–¹å¼1| A4a[IUnLuaInterface::GetModuleName]
        A3 --&gt;|æ–¹å¼2-3| A4b[UUnLuaSettings é…ç½®]
        A4a --&gt; A5[æ‰¾åˆ° Lua æ¨¡å—è·¯å¾„]
        A4b --&gt; A5
    end
    
    subgraph S2[&quot;2ï¸âƒ£ åŠ è½½ Lua æ¨¡å—&quot;]
        B1[require Module] --&gt; B2[&quot;GLuaDynamicBinding.Push&lt;br/&gt;Class: BP_MyActor&lt;br/&gt;ModuleName: MyActor&quot;]
        B2 --&gt; B3[&quot;æ‰§è¡Œ Lua æ–‡ä»¶&lt;br/&gt;return &#123; ... &#125;&quot;]
    end
    
    subgraph S3[&quot;3ï¸âƒ£ åˆ›å»ºç»‘å®šå®ä¾‹&quot;]
        C1[FObjectRegistry::Bind Object] --&gt; C2[åˆ›å»º INSTANCE Table]
        C2 --&gt; C3[INSTANCE.Object = Userdata]
        C3 --&gt; C4[INSTANCE.metatable = MODULE]
        C4 --&gt; C5[ç¼“å­˜åˆ° ObjectRefs]
    end
    
    subgraph S4[&quot;4ï¸âƒ£ å‡½æ•°è¦†å†™å‡†å¤‡&quot;]
        D1[éå† Lua Module çš„å‡½æ•°] --&gt; D2[ä¸ºè¦†å†™å‡½æ•°è®¾ç½® Hook]
        D2 --&gt; D3[ProcessEvent Hook]
    end
    
    A5 --&gt; B1
    B3 --&gt; C1
    C5 --&gt; D1
    
    style A1 fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style B1 fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style C1 fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    style D1 fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px</code></pre>

<h3 id="ç»‘å®šè§¦å‘æœºåˆ¶"><a href="#ç»‘å®šè§¦å‘æœºåˆ¶" class="headerlink" title="ç»‘å®šè§¦å‘æœºåˆ¶"></a>ç»‘å®šè§¦å‘æœºåˆ¶</h3><p>UnLua æ”¯æŒ<strong>å¤šç§ç»‘å®šæ–¹å¼</strong>ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åºï¼š</p>
<table>
<thead>
<tr>
<th>ä¼˜å…ˆçº§</th>
<th>ç»‘å®šæ–¹å¼</th>
<th>è§¦å‘æ¡ä»¶</th>
<th>é…ç½®ä½ç½®</th>
</tr>
</thead>
<tbody><tr>
<td><strong>1</strong></td>
<td><code>IUnLuaInterface</code></td>
<td>ç±»å®ç°æ¥å£</td>
<td>C++ ä»£ç </td>
</tr>
<tr>
<td><strong>2</strong></td>
<td><code>UnLuaBind</code> ç»„ä»¶</td>
<td>æ·»åŠ ç»„ä»¶</td>
<td>è“å›¾&#x2F;å®ä¾‹</td>
</tr>
<tr>
<td><strong>3</strong></td>
<td>å…¨å±€é…ç½®</td>
<td>åŒ¹é…ç±»åè§„åˆ™</td>
<td>Project Settings</td>
</tr>
<tr>
<td><strong>4</strong></td>
<td>æ‰‹åŠ¨ç»‘å®š</td>
<td>è°ƒç”¨ API</td>
<td>Lua ä»£ç </td>
</tr>
</tbody></table>
<h4 id="ä»£ç ç¤ºä¾‹-1"><a href="#ä»£ç ç¤ºä¾‹-1" class="headerlink" title="ä»£ç ç¤ºä¾‹"></a>ä»£ç ç¤ºä¾‹</h4><p><strong>æ–¹å¼ 1: IUnLuaInterface (æ¨è)</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MyActor.h</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AMyActor</span> : <span class="keyword">public</span> AActor, <span class="keyword">public</span> IUnLuaInterface</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> FString <span class="title">GetModuleName_Implementation</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">TEXT</span>(<span class="string">&quot;MyActor&quot;</span>);  <span class="comment">// å¯¹åº” Content/Script/MyActor.lua</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>æ–¹å¼ 4: æ‰‹åŠ¨ç»‘å®š</strong></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- InGameLogic.lua</span></span><br><span class="line"><span class="keyword">local</span> player = UE.UGameplayStatics.GetPlayerCharacter(<span class="built_in">self</span>, <span class="number">0</span>)</span><br><span class="line">UnLua.Bind(player, <span class="string">&quot;PlayerController&quot;</span>)  <span class="comment">-- è¿è¡Œæ—¶åŠ¨æ€ç»‘å®š</span></span><br></pre></td></tr></table></figure>

<h3 id="æ¨¡å—åŠ è½½æœºåˆ¶"><a href="#æ¨¡å—åŠ è½½æœºåˆ¶" class="headerlink" title="æ¨¡å—åŠ è½½æœºåˆ¶"></a>æ¨¡å—åŠ è½½æœºåˆ¶</h3><h4 id="è·¯å¾„è§£æè§„åˆ™"><a href="#è·¯å¾„è§£æè§„åˆ™" class="headerlink" title="è·¯å¾„è§£æè§„åˆ™"></a>è·¯å¾„è§£æè§„åˆ™</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Lua æ¨¡å—æŸ¥æ‰¾é¡ºåº:</span><br><span class="line"><span class="number">1</span>. Content/Script/<span class="symbol">&lt;ModuleName&gt;</span>.<span class="keyword">lua</span></span><br><span class="line"><span class="number">2</span>. Plugins/<span class="symbol">&lt;PluginName&gt;</span>/Content/Script/<span class="symbol">&lt;ModuleName&gt;</span>.<span class="keyword">lua</span></span><br><span class="line"><span class="number">3</span>. package.path é…ç½®çš„é¢å¤–è·¯å¾„</span><br></pre></td></tr></table></figure>

<h4 id="çƒ­æ›´æ–°ä¸‹è½½ç›®å½•"><a href="#çƒ­æ›´æ–°ä¸‹è½½ç›®å½•" class="headerlink" title="çƒ­æ›´æ–°ä¸‹è½½ç›®å½•"></a>çƒ­æ›´æ–°ä¸‹è½½ç›®å½•</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LuaCore.cpp</span></span><br><span class="line"><span class="function">FString <span class="title">GetFullPathFromRelativePath</span><span class="params">(<span class="type">const</span> FString&amp; RelativePath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FString FullFilePath = GLuaSrcFullPath + RelativePath;</span><br><span class="line">    FString DownloadDir = FPaths::<span class="built_in">ProjectPersistentDownloadDir</span>();</span><br><span class="line">    FString HotfixPath = DownloadDir + RelativePath;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¼˜å…ˆä½¿ç”¨çƒ­æ›´æ–°ç›®å½•</span></span><br><span class="line">    <span class="keyword">if</span> (IFileManager::<span class="built_in">Get</span>().<span class="built_in">FileExists</span>(*HotfixPath))</span><br><span class="line">        <span class="keyword">return</span> HotfixPath;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> FullFilePath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç§»åŠ¨å¹³å°è·¯å¾„</strong>:</p>
<ul>
<li>iOS: <code>Library/Caches/</code></li>
<li>Android: <code>/sdcard/Android/data/.../cache/</code></li>
<li>PC: <code>Saved/DownloadData/</code></li>
</ul>
<h3 id="è¿è¡Œæ—¶ç‰¹æ€§"><a href="#è¿è¡Œæ—¶ç‰¹æ€§" class="headerlink" title="è¿è¡Œæ—¶ç‰¹æ€§"></a>è¿è¡Œæ—¶ç‰¹æ€§</h3><table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>è¯´æ˜</th>
<th>ä¼˜åŠ¿</th>
</tr>
</thead>
<tbody><tr>
<td><strong>å»¶è¿ŸåŠ è½½</strong></td>
<td>å¯¹è±¡åˆ›å»ºæ—¶æ‰åŠ è½½æ¨¡å—</td>
<td>å‡å°‘å¯åŠ¨æ—¶é—´</td>
</tr>
<tr>
<td><strong>å®ä¾‹éš”ç¦»</strong></td>
<td>æ¯ä¸ªå¯¹è±¡ç‹¬ç«‹ INSTANCE</td>
<td>æ”¯æŒå¤šå®ä¾‹</td>
</tr>
<tr>
<td><strong>æ¨¡å—ç¼“å­˜</strong></td>
<td><code>package.loaded</code> ç¼“å­˜</td>
<td>é¿å…é‡å¤è§£æ</td>
</tr>
<tr>
<td><strong>çƒ­æ›´æ–°æ”¯æŒ</strong></td>
<td>å¯æ›¿æ¢ Lua æ–‡ä»¶</td>
<td>æ— éœ€é‡å¯æ¸¸æˆ</td>
</tr>
</tbody></table>
<hr>
<h2 id="ç±»æ³¨å†Œä¸ç»‘å®šç³»ç»Ÿ"><a href="#ç±»æ³¨å†Œä¸ç»‘å®šç³»ç»Ÿ" class="headerlink" title="ç±»æ³¨å†Œä¸ç»‘å®šç³»ç»Ÿ"></a>ç±»æ³¨å†Œä¸ç»‘å®šç³»ç»Ÿ</h2><h3 id="åŒå±‚æ³¨å†Œæ¶æ„"><a href="#åŒå±‚æ³¨å†Œæ¶æ„" class="headerlink" title="åŒå±‚æ³¨å†Œæ¶æ„"></a>åŒå±‚æ³¨å†Œæ¶æ„</h3><p>UnLua é‡‡ç”¨<strong>ç±»æ³¨å†Œ</strong>å’Œ<strong>å¯¹è±¡ç»‘å®š</strong>çš„åŒå±‚æ¶æ„ï¼š</p>
<pre><code class="highlight mermaid">graph TB
    subgraph ClassRegistry[&quot;ğŸ“š ç±»æ³¨å†Œå±‚ ClassRegistry&quot;]
        CR1[ç®¡ç† UStruct â†’ FClassDesc æ˜ å°„]
        CR2[åˆ›å»º Lua Metatable]
        CR3[æ³¨å†Œåå°„å±æ€§å’Œå‡½æ•°]
    end
    
    subgraph ObjectRegistry[&quot;ğŸ”— å¯¹è±¡ç»‘å®šå±‚ ObjectRegistry&quot;]
        OR1[ç®¡ç† UObject â†’ Lua Table æ˜ å°„]
        OR2[åˆ›å»ºå¯¹è±¡å®ä¾‹è¡¨ INSTANCE]
        OR3[ç®¡ç† GC å¼•ç”¨]
    end
    
    ClassRegistry -.ä½¿ç”¨.-&gt; ObjectRegistry
    
    style ClassRegistry fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style ObjectRegistry fill:#fff3e0,stroke:#e65100,stroke-width:2px</code></pre>

<h3 id="ClassRegistry-æ ¸å¿ƒæµç¨‹"><a href="#ClassRegistry-æ ¸å¿ƒæµç¨‹" class="headerlink" title="ClassRegistry æ ¸å¿ƒæµç¨‹"></a>ClassRegistry æ ¸å¿ƒæµç¨‹</h3><h4 id="ç±»æ³¨å†Œæ—¶æœºè¡¨"><a href="#ç±»æ³¨å†Œæ—¶æœºè¡¨" class="headerlink" title="ç±»æ³¨å†Œæ—¶æœºè¡¨"></a>ç±»æ³¨å†Œæ—¶æœºè¡¨</h4><table>
<thead>
<tr>
<th>æ—¶æœº</th>
<th>è§¦å‘æ¡ä»¶</th>
<th>ä»£ç ä½ç½®</th>
<th>å¼€é”€</th>
</tr>
</thead>
<tbody><tr>
<td><strong>å¯åŠ¨æ—¶</strong></td>
<td><code>FLuaEnv::Initialize()</code></td>
<td>æ³¨å†Œ <code>UObject</code> &#x2F; <code>UClass</code></td>
<td>ä¸€æ¬¡æ€§ï¼Œæä½</td>
</tr>
<tr>
<td><strong>é¦–æ¬¡è®¿é—®</strong></td>
<td><code>PushMetatable(&quot;AActor&quot;)</code></td>
<td>åå°„æŸ¥è¯¢å¹¶æ³¨å†Œ</td>
<td>é¦–æ¬¡æ…¢ï¼Œåç»­å¿«</td>
</tr>
<tr>
<td><strong>æ˜¾å¼æ³¨å†Œ</strong></td>
<td><code>ClassRegistry::Register()</code></td>
<td>æ‰‹åŠ¨è§¦å‘</td>
<td>å¯æ§</td>
</tr>
<tr>
<td><strong>åŠ¨æ€ç»‘å®š</strong></td>
<td><code>require(&quot;Module&quot;)</code></td>
<td>å®ä¾‹çº§å…ƒè¡¨è®¾ç½®</td>
<td>æ¯ä¸ªå¯¹è±¡ä¸€æ¬¡</td>
</tr>
</tbody></table>
<h4 id="Lua-C-API-Metatable-æ“ä½œè¯¦è§£"><a href="#Lua-C-API-Metatable-æ“ä½œè¯¦è§£" class="headerlink" title="Lua C API: Metatable æ“ä½œè¯¦è§£"></a>Lua C API: Metatable æ“ä½œè¯¦è§£</h4><p>åœ¨æ·±å…¥æºç å‰,å…ˆç†è§£ Lua Metatable çš„æ ¸å¿ƒ API:</p>
<table>
<thead>
<tr>
<th>API</th>
<th>åŠŸèƒ½</th>
<th>æ ˆå˜åŒ–</th>
<th>ç”¨é€”</th>
</tr>
</thead>
<tbody><tr>
<td><code>luaL_newmetatable(L, name)</code></td>
<td>åˆ›å»ºå‘½åå…ƒè¡¨</td>
<td><code>[+1]</code> å‹å…¥æ–°è¡¨</td>
<td>åˆ›å»ºå…¨å±€å”¯ä¸€å…ƒè¡¨</td>
</tr>
<tr>
<td><code>luaL_getmetatable(L, name)</code></td>
<td>è·å–å‘½åå…ƒè¡¨</td>
<td><code>[+1]</code> å‹å…¥è¡¨æˆ–nil</td>
<td>æŸ¥æ‰¾å·²å­˜åœ¨çš„å…ƒè¡¨</td>
</tr>
<tr>
<td><code>lua_setmetatable(L, idx)</code></td>
<td>è®¾ç½®å¯¹è±¡å…ƒè¡¨</td>
<td><code>[-1]</code> å¼¹å‡ºå…ƒè¡¨</td>
<td>å…³è”å…ƒè¡¨åˆ°å¯¹è±¡</td>
</tr>
<tr>
<td><code>lua_getmetatable(L, idx)</code></td>
<td>è·å–å¯¹è±¡å…ƒè¡¨</td>
<td><code>[+1]</code> å‹å…¥å…ƒè¡¨</td>
<td>è¯»å–å¯¹è±¡çš„å…ƒè¡¨</td>
</tr>
<tr>
<td><code>lua_rawset(L, idx)</code></td>
<td>è¡¨èµ‹å€¼(è·³è¿‡å…ƒæ–¹æ³•)</td>
<td><code>[-2]</code> å¼¹å‡ºkey+value</td>
<td>è®¾ç½®å…ƒæ–¹æ³•</td>
</tr>
</tbody></table>
<p><strong>æ ˆæ“ä½œç¤ºä¾‹</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºåä¸º &quot;AActor&quot; çš„å…ƒè¡¨</span></span><br><span class="line"><span class="built_in">luaL_newmetatable</span>(L, <span class="string">&quot;AActor&quot;</span>);</span><br><span class="line"><span class="comment">// æ ˆ: [..., metatable]</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">lua_pushstring</span>(L, <span class="string">&quot;__index&quot;</span>);</span><br><span class="line"><span class="comment">// æ ˆ: [..., metatable, &quot;__index&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">lua_pushcfunction</span>(L, Class_Index);</span><br><span class="line"><span class="comment">// æ ˆ: [..., metatable, &quot;__index&quot;, Class_Indexå‡½æ•°]</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">lua_rawset</span>(L, <span class="number">-3</span>);</span><br><span class="line"><span class="comment">// æ ˆ: [..., metatable]</span></span><br><span class="line"><span class="comment">// ç­‰ä»·äº: metatable[&quot;__index&quot;] = Class_Index</span></span><br></pre></td></tr></table></figure>

<h4 id="Metatable-åˆ›å»ºå®Œæ•´æµç¨‹"><a href="#Metatable-åˆ›å»ºå®Œæ•´æµç¨‹" class="headerlink" title="Metatable åˆ›å»ºå®Œæ•´æµç¨‹"></a>Metatable åˆ›å»ºå®Œæ•´æµç¨‹</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ClassRegistry.cpp:108</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">FClassRegistry::PushMetatable</span><span class="params">(lua_State* L, <span class="type">const</span> <span class="type">char</span>* MetatableName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// â˜… APIè®²è§£: luaL_getmetatable</span></span><br><span class="line">    <span class="comment">// åŠŸèƒ½: ä»æ³¨å†Œè¡¨è·å–åä¸º MetatableName çš„å…ƒè¡¨</span></span><br><span class="line">    <span class="comment">// è¿”å›å€¼: LUA_TTABLE(å·²å­˜åœ¨) æˆ– LUA_TNIL(ä¸å­˜åœ¨)</span></span><br><span class="line">    <span class="comment">// æ ˆå˜åŒ–: [+1, å‹å…¥å…ƒè¡¨æˆ–nil]</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">luaL_getmetatable</span>(L, MetatableName) == LUA_TTABLE)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;  <span class="comment">// å…ƒè¡¨å·²å­˜åœ¨,ç›´æ¥è¿”å›</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">lua_pop</span>(L, <span class="number">1</span>);  <span class="comment">// å¼¹å‡º nil</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ³¨å†Œåå°„ç±»å‹</span></span><br><span class="line">    FClassDesc* ClassDesc = <span class="built_in">RegisterReflectedType</span>(MetatableName);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… APIè®²è§£: luaL_newmetatable</span></span><br><span class="line">    <span class="comment">// åŠŸèƒ½: åˆ›å»ºæ–°è¡¨å¹¶å­˜å…¥ registry[MetatableName]</span></span><br><span class="line">    <span class="comment">// æ ˆå˜åŒ–: [+1, å‹å…¥æ–°åˆ›å»ºçš„å…ƒè¡¨]</span></span><br><span class="line">    <span class="comment">// å†…éƒ¨å®ç°:</span></span><br><span class="line">    <span class="comment">//   lua_newtable(L);</span></span><br><span class="line">    <span class="comment">//   lua_pushvalue(L, -1);</span></span><br><span class="line">    <span class="comment">//   lua_setfield(L, LUA_REGISTRYINDEX, MetatableName);</span></span><br><span class="line">    <span class="built_in">luaL_newmetatable</span>(L, MetatableName);</span><br><span class="line">    <span class="comment">// æ ˆ: [metatable]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… è®¾ç½® __index å…ƒæ–¹æ³•</span></span><br><span class="line">    <span class="built_in">lua_pushstring</span>(L, <span class="string">&quot;__index&quot;</span>);       <span class="comment">// æ ˆ: [metatable, &quot;__index&quot;]</span></span><br><span class="line">    <span class="built_in">lua_pushcfunction</span>(L, Class_Index);  <span class="comment">// æ ˆ: [metatable, &quot;__index&quot;, func]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… APIè®²è§£: lua_rawset</span></span><br><span class="line">    <span class="comment">// åŠŸèƒ½: ç­‰ä»·äº t[k]=v, ä½†è·³è¿‡å…ƒæ–¹æ³•</span></span><br><span class="line">    <span class="comment">// å‚æ•°: idx = -3 æŒ‡å‘ metatable</span></span><br><span class="line">    <span class="comment">// æ ˆå˜åŒ–: [-2, å¼¹å‡ºkeyå’Œvalue]</span></span><br><span class="line">    <span class="comment">// ç»“æœ: metatable[&quot;__index&quot;] = Class_Index</span></span><br><span class="line">    <span class="built_in">lua_rawset</span>(L, <span class="number">-3</span>);  </span><br><span class="line">    <span class="comment">// æ ˆ: [metatable]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŒç†è®¾ç½® __newindex</span></span><br><span class="line">    <span class="built_in">lua_pushstring</span>(L, <span class="string">&quot;__newindex&quot;</span>);</span><br><span class="line">    <span class="built_in">lua_pushcfunction</span>(L, Class_NewIndex);</span><br><span class="line">    <span class="built_in">lua_rawset</span>(L, <span class="number">-3</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… ç‰¹æ®Šå¤„ç†: UScriptStruct éœ€è¦ __gc å’Œ __call</span></span><br><span class="line">    <span class="keyword">if</span> (UScriptStruct* ScriptStruct = ClassDesc-&gt;<span class="built_in">AsScriptStruct</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// â˜… APIè®²è§£: lua_pushcclosure</span></span><br><span class="line">        <span class="comment">// åŠŸèƒ½: åˆ›å»ºé—­åŒ…,å°†æ ˆé¡¶ n ä¸ªå€¼ä½œä¸º upvalue</span></span><br><span class="line">        <span class="comment">// å‚æ•°: n=1 è¡¨ç¤ºä½¿ç”¨ 1 ä¸ª upvalue</span></span><br><span class="line">        <span class="comment">// ç”¨é€”: è®© ScriptStruct_Delete èƒ½è®¿é—® ClassDesc</span></span><br><span class="line">        <span class="built_in">lua_pushstring</span>(L, <span class="string">&quot;__gc&quot;</span>);</span><br><span class="line">        <span class="built_in">lua_pushlightuserdata</span>(L, ClassDesc);  <span class="comment">// upvalue</span></span><br><span class="line">        <span class="built_in">lua_pushcclosure</span>(L, ScriptStruct_Delete, <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">lua_rawset</span>(L, <span class="number">-3</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">lua_pushstring</span>(L, <span class="string">&quot;__call&quot;</span>);</span><br><span class="line">        <span class="built_in">lua_pushlightuserdata</span>(L, ClassDesc);</span><br><span class="line">        <span class="built_in">lua_pushcclosure</span>(L, ScriptStruct_New, <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">lua_rawset</span>(L, <span class="number">-3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Lua å…ƒæ–¹æ³•è§¦å‘æ—¶æœº</strong>:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> vec = UE.FVector()  <span class="comment">-- è§¦å‘ __call (æ„é€ )</span></span><br><span class="line"><span class="keyword">local</span> x = vec.X           <span class="comment">-- è§¦å‘ __index (è¯»å–)</span></span><br><span class="line">vec.Y = <span class="number">100</span>               <span class="comment">-- è§¦å‘ __newindex (å†™å…¥)</span></span><br><span class="line">vec = <span class="literal">nil</span>                 <span class="comment">-- GCæ—¶è§¦å‘ __gc (ææ„)</span></span><br></pre></td></tr></table></figure>

<h3 id="ObjectRegistry-æ ¸å¿ƒæµç¨‹"><a href="#ObjectRegistry-æ ¸å¿ƒæµç¨‹" class="headerlink" title="ObjectRegistry æ ¸å¿ƒæµç¨‹"></a>ObjectRegistry æ ¸å¿ƒæµç¨‹</h3><h4 id="Lua-C-API-å¼•ç”¨ç³»ç»Ÿè¯¦è§£"><a href="#Lua-C-API-å¼•ç”¨ç³»ç»Ÿè¯¦è§£" class="headerlink" title="Lua C API: å¼•ç”¨ç³»ç»Ÿè¯¦è§£"></a>Lua C API: å¼•ç”¨ç³»ç»Ÿè¯¦è§£</h4><p>UnLua ä½¿ç”¨ Lua çš„å¼•ç”¨ç³»ç»Ÿæ¥æŒä¹…åŒ– Lua å¯¹è±¡,é¿å…è¢« GC å›æ”¶:</p>
<table>
<thead>
<tr>
<th>API</th>
<th>åŠŸèƒ½</th>
<th>è¿”å›å€¼</th>
<th>ç”¨é€”</th>
</tr>
</thead>
<tbody><tr>
<td><code>luaL_ref(L, LUA_REGISTRYINDEX)</code></td>
<td>åˆ›å»ºå¼•ç”¨</td>
<td>æ•´æ•°ID</td>
<td>å¼¹å‡ºæ ˆé¡¶å€¼å¹¶å­˜å…¥registry,è¿”å›ID</td>
</tr>
<tr>
<td><code>lua_rawgeti(L, LUA_REGISTRYINDEX, ref)</code></td>
<td>è·å–å¼•ç”¨</td>
<td>å‹æ ˆ</td>
<td>æ ¹æ®IDä»registryå–å‡ºå€¼</td>
</tr>
<tr>
<td><code>luaL_unref(L, LUA_REGISTRYINDEX, ref)</code></td>
<td>é‡Šæ”¾å¼•ç”¨</td>
<td>æ— </td>
<td>ä»registryç§»é™¤,å…è®¸GCå›æ”¶</td>
</tr>
</tbody></table>
<p><strong>å¼•ç”¨ç³»ç»ŸåŸç†</strong>:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Lua registry å†…éƒ¨ç»“æ„ (ä¸å¯ç›´æ¥è®¿é—®)</span></span><br><span class="line">registry = &#123;</span><br><span class="line">    [<span class="number">1</span>] = &#123; ... &#125;,  <span class="comment">-- ref=1 æŒ‡å‘çš„å¯¹è±¡</span></span><br><span class="line">    [<span class="number">2</span>] = <span class="function"><span class="keyword">function</span><span class="params">()</span></span> ... <span class="keyword">end</span>,  <span class="comment">-- ref=2 æŒ‡å‘çš„å‡½æ•°</span></span><br><span class="line">    <span class="comment">-- ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>C API ç¤ºä¾‹</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºå¼•ç”¨</span></span><br><span class="line"><span class="built_in">lua_newtable</span>(L);  <span class="comment">// æ ˆ: [table]</span></span><br><span class="line"><span class="type">int</span> ref = <span class="built_in">luaL_ref</span>(L, LUA_REGISTRYINDEX);  </span><br><span class="line"><span class="comment">// æ ˆ: [] (tableè¢«å¼¹å‡ºå¹¶å­˜å…¥registry)</span></span><br><span class="line"><span class="comment">// ref = 1 (å‡è®¾)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨å¼•ç”¨</span></span><br><span class="line"><span class="built_in">lua_rawgeti</span>(L, LUA_REGISTRYINDEX, ref);  </span><br><span class="line"><span class="comment">// æ ˆ: [table] (ä»registryå–å›)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡Šæ”¾å¼•ç”¨</span></span><br><span class="line"><span class="built_in">luaL_unref</span>(L, LUA_REGISTRYINDEX, ref);</span><br><span class="line"><span class="comment">// registry[ref] = nil (å¯è¢«GCå›æ”¶)</span></span><br></pre></td></tr></table></figure>

<h4 id="å¯¹è±¡ç»‘å®šå®Œæ•´æµç¨‹"><a href="#å¯¹è±¡ç»‘å®šå®Œæ•´æµç¨‹" class="headerlink" title="å¯¹è±¡ç»‘å®šå®Œæ•´æµç¨‹"></a>å¯¹è±¡ç»‘å®šå®Œæ•´æµç¨‹</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ObjectRegistry.cpp:113</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">FObjectRegistry::Bind</span><span class="params">(UObject* Object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> L = Env-&gt;<span class="built_in">GetMainState</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤1: è·å–å¼±å¼•ç”¨è¡¨ UnLua_ObjectMap</span></span><br><span class="line">    <span class="comment">// API: lua_getfield(L, idx, key)</span></span><br><span class="line">    <span class="comment">// åŠŸèƒ½: ç­‰ä»·äº lua_pushstring + lua_gettable</span></span><br><span class="line">    <span class="comment">// ç»“æœ: å‹å…¥ registry[&quot;UnLua_ObjectMap&quot;]</span></span><br><span class="line">    <span class="built_in">lua_getfield</span>(L, LUA_REGISTRYINDEX, <span class="string">&quot;UnLua_ObjectMap&quot;</span>);</span><br><span class="line">    <span class="built_in">lua_pushlightuserdata</span>(L, Object);  <span class="comment">// ä½¿ç”¨å¯¹è±¡æŒ‡é’ˆä½œä¸ºkey</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤2: åˆ›å»º INSTANCE è¡¨</span></span><br><span class="line">    <span class="comment">// API: lua_newtable(L)</span></span><br><span class="line">    <span class="comment">// åŠŸèƒ½: åˆ›å»ºç©ºè¡¨å¹¶å‹æ ˆ</span></span><br><span class="line">    <span class="comment">// æ ˆå˜åŒ–: [+1]</span></span><br><span class="line">    <span class="built_in">lua_newtable</span>(L); </span><br><span class="line">    <span class="comment">// æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤3: åˆ›å»º Userdata ç»‘å®š UObject</span></span><br><span class="line">    <span class="built_in">PushObjectCore</span>(L, Object);</span><br><span class="line">    <span class="comment">// æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE, Userdata]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤4: INSTANCE.Object = Userdata</span></span><br><span class="line">    <span class="built_in">lua_pushstring</span>(L, <span class="string">&quot;Object&quot;</span>);</span><br><span class="line">    <span class="comment">// æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE, Userdata, &quot;Object&quot;]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… APIè®²è§£: lua_pushvalue</span></span><br><span class="line">    <span class="comment">// åŠŸèƒ½: å¤åˆ¶æ ˆä¸Šç´¢å¼•å¤„çš„å€¼åˆ°æ ˆé¡¶</span></span><br><span class="line">    <span class="comment">// å‚æ•°: -2 è¡¨ç¤ºå€’æ•°ç¬¬2ä¸ª(Userdata)</span></span><br><span class="line">    <span class="built_in">lua_pushvalue</span>(L, <span class="number">-2</span>);</span><br><span class="line">    <span class="comment">// æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE, Userdata, &quot;Object&quot;, Userdata]</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">lua_rawset</span>(L, <span class="number">-4</span>);  <span class="comment">// INSTANCE[&quot;Object&quot;] = Userdata</span></span><br><span class="line">    <span class="comment">// æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE, Userdata]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤5: è·å– Lua Module è¡¨</span></span><br><span class="line">    UClass* Class = Object-&gt;<span class="built_in">GetClass</span>();</span><br><span class="line">    int32 ClassBoundRef = Env-&gt;<span class="built_in">GetManager</span>()-&gt;<span class="built_in">GetBoundRef</span>(Class);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… APIè®²è§£: lua_rawgeti</span></span><br><span class="line">    <span class="comment">// åŠŸèƒ½: ä»è¡¨ä¸­æŒ‰æ•´æ•°ç´¢å¼•è·å–å€¼</span></span><br><span class="line">    <span class="comment">// ç­‰ä»·äº: lua_pushinteger + lua_rawget</span></span><br><span class="line">    int32 TypeModule = <span class="built_in">lua_rawgeti</span>(L, LUA_REGISTRYINDEX, ClassBoundRef);</span><br><span class="line">    <span class="comment">// æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE, Userdata, MODULE]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤6: è·å– Userdata çš„ Metatable</span></span><br><span class="line">    int32 TypeMetatable = <span class="built_in">lua_getmetatable</span>(L, <span class="number">-2</span>);</span><br><span class="line">    <span class="comment">// æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE, Userdata, MODULE, METATABLE_UOBJECT]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤7: è®¾ç½®å…ƒè¡¨ç»§æ‰¿é“¾</span></span><br><span class="line">    <span class="comment">// MODULE.metatable = METATABLE_UOBJECT</span></span><br><span class="line">    <span class="built_in">lua_setmetatable</span>(L, <span class="number">-2</span>);</span><br><span class="line">    <span class="comment">// æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE, Userdata, MODULE]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// INSTANCE.metatable = MODULE</span></span><br><span class="line">    <span class="built_in">lua_setmetatable</span>(L, <span class="number">-3</span>);</span><br><span class="line">    <span class="comment">// æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE, Userdata]</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">lua_pop</span>(L, <span class="number">1</span>);  <span class="comment">// å¼¹å‡º Userdata</span></span><br><span class="line">    <span class="comment">// æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤8: å¤åˆ¶ INSTANCE å¹¶åˆ›å»ºå¼•ç”¨</span></span><br><span class="line">    <span class="built_in">lua_pushvalue</span>(L, <span class="number">-1</span>);</span><br><span class="line">    <span class="comment">// æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE, INSTANCE]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… APIè®²è§£: luaL_ref</span></span><br><span class="line">    <span class="comment">// åŠŸèƒ½: å¼¹å‡ºæ ˆé¡¶å€¼,å­˜å…¥ registry[idx],è¿”å›æ•´æ•°ID</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: è®©C++èƒ½éšæ—¶é€šè¿‡IDè®¿é—®è¿™ä¸ªLuaè¡¨</span></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> Ref = <span class="built_in">luaL_ref</span>(L, LUA_REGISTRYINDEX);</span><br><span class="line">    ObjectRefs.<span class="built_in">Add</span>(Object, Ref);  <span class="comment">// C++ ç«¯ä¿å­˜æ˜ å°„</span></span><br><span class="line">    <span class="comment">// æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤9: ç¼“å­˜åˆ°å¼±å¼•ç”¨è¡¨</span></span><br><span class="line">    <span class="comment">// ObjectMap[ObjectæŒ‡é’ˆ] = INSTANCE</span></span><br><span class="line">    <span class="built_in">lua_rawset</span>(L, <span class="number">-3</span>);</span><br><span class="line">    <span class="built_in">lua_pop</span>(L, <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> Ref;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å…ƒè¡¨ç»§æ‰¿é“¾ç»“æœ</strong>:</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">INSTANCE &#123;</span><br><span class="line">    Object = &lt;Userdata&gt;,</span><br><span class="line">    metatable = MODULE &#123;</span><br><span class="line">        ReceiveBeginPlay = <span class="keyword">function</span><span class="params">(<span class="rest_arg">...) end</span>,</span></span><br><span class="line"><span class="params">        metatable = METATABLE_UOBJECT &#123;</span></span><br><span class="line"><span class="params">            __index = Class_Index,</span></span><br><span class="line"><span class="params">            __newindex = Class_NewIndex,</span></span><br><span class="line"><span class="params">            __gc = UObject_Delete,</span></span><br><span class="line"><span class="params">            <span class="rest_arg">...</span></span></span><br><span class="line"><span class="rest_arg"><span class="params">        &#125;</span></span></span><br><span class="line"><span class="rest_arg"><span class="params">    &#125;</span></span></span><br><span class="line"><span class="rest_arg"><span class="params">&#125;</span></span></span><br></pre></td></tr></table></figure>

<p><strong>è®¿é—®æµç¨‹ç¤ºä¾‹</strong>:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Lua ä»£ç </span></span><br><span class="line">instance:GetName()</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æŸ¥æ‰¾è¿‡ç¨‹:</span></span><br><span class="line"><span class="comment">-- 1. instance[&quot;GetName&quot;]      â†’ nil</span></span><br><span class="line"><span class="comment">-- 2. MODULE[&quot;GetName&quot;]        â†’ nil  </span></span><br><span class="line"><span class="comment">-- 3. METATABLE_UOBJECT.__index(instance, &quot;GetName&quot;)</span></span><br><span class="line"><span class="comment">--    â†’ Class_Index é€šè¿‡åå°„æ‰¾åˆ° UFunction</span></span><br><span class="line"><span class="comment">--    â†’ è¿”å› C closure</span></span><br></pre></td></tr></table></figure>

<h3 id="å…ƒè¡¨ç»§æ‰¿é“¾ç¤ºæ„å›¾"><a href="#å…ƒè¡¨ç»§æ‰¿é“¾ç¤ºæ„å›¾" class="headerlink" title="å…ƒè¡¨ç»§æ‰¿é“¾ç¤ºæ„å›¾"></a>å…ƒè¡¨ç»§æ‰¿é“¾ç¤ºæ„å›¾</h3><pre><code class="highlight mermaid">graph TB
    INSTANCE[&quot;INSTANCE&lt;br/&gt;å¯¹è±¡å®ä¾‹ Table&lt;br/&gt;â”â”â”â”â”â”â”â”â”â”&lt;br/&gt;Object: &amp;lt;Userdata&amp;gt;&quot;]
    MODULE[&quot;MODULE Lua&lt;br/&gt;â”â”â”â”â”â”â”â”â”â”&lt;br/&gt;ReceiveBeginPlay&lt;br/&gt;ReceiveTick&quot;]
    UACTOR[&quot;UActor&lt;br/&gt;C++ åå°„&lt;br/&gt;â”â”â”â”â”â”â”â”â”â”&lt;br/&gt;BeginPlay&lt;br/&gt;Tick&quot;]
    UOBJECT[&quot;UObject&lt;br/&gt;â”â”â”â”â”â”â”â”â”â”&lt;br/&gt;åŸºç±»&quot;]
    
    INSTANCE --&gt;|metatable| MODULE
    MODULE --&gt;|metatable| UACTOR
    UACTOR --&gt;|Super| UOBJECT
    
    style INSTANCE fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style MODULE fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style UACTOR fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    style UOBJECT fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px</code></pre>

<h3 id="åŠ¨æ€ç»‘å®š-vs-é™æ€ç»‘å®š"><a href="#åŠ¨æ€ç»‘å®š-vs-é™æ€ç»‘å®š" class="headerlink" title="åŠ¨æ€ç»‘å®š vs é™æ€ç»‘å®š"></a>åŠ¨æ€ç»‘å®š vs é™æ€ç»‘å®š</h3><table>
<thead>
<tr>
<th>ç»´åº¦</th>
<th>åŠ¨æ€ç»‘å®š</th>
<th>é™æ€ç»‘å®š (åå°„)</th>
</tr>
</thead>
<tbody><tr>
<td><strong>æ³¨å†Œæ—¶æœº</strong></td>
<td>Lua æ¨¡å—åŠ è½½æ—¶</td>
<td>é¦–æ¬¡è®¿é—®ç±»å‹æ—¶</td>
</tr>
<tr>
<td><strong>å…ƒè¡¨ç»“æ„</strong></td>
<td><code>INSTANCE.metatable = MODULE</code></td>
<td><code>INSTANCE.metatable = UClass</code></td>
</tr>
<tr>
<td><strong>å‡½æ•°æŸ¥æ‰¾</strong></td>
<td>å…ˆæŸ¥ MODULEï¼Œå†æŸ¥çˆ¶ç±»</td>
<td>å…ˆæŸ¥ Metatable ç¼“å­˜ï¼Œå†åå°„</td>
</tr>
<tr>
<td><strong>è¦†å†™æœºåˆ¶</strong></td>
<td>Lua å‡½æ•°ç›´æ¥è¦†ç›–</td>
<td>éœ€è¦ Hook ProcessEvent</td>
</tr>
<tr>
<td><strong>æ€§èƒ½</strong></td>
<td>å‡½æ•°æŸ¥æ‰¾å¿«</td>
<td>é¦–æ¬¡æ…¢ï¼Œåç»­å¿«</td>
</tr>
<tr>
<td><strong>çµæ´»æ€§</strong></td>
<td>å¯éšæ—¶ä¿®æ”¹ MODULE</td>
<td>å›ºå®šç±»å‹</td>
</tr>
</tbody></table>
<hr>
<h2 id="å‡½æ•°è¦†å†™åŸç†"><a href="#å‡½æ•°è¦†å†™åŸç†" class="headerlink" title="å‡½æ•°è¦†å†™åŸç†"></a>å‡½æ•°è¦†å†™åŸç†</h2><h3 id="è¦†å†™æœºåˆ¶æ·±åº¦è§£æ"><a href="#è¦†å†™æœºåˆ¶æ·±åº¦è§£æ" class="headerlink" title="è¦†å†™æœºåˆ¶æ·±åº¦è§£æ"></a>è¦†å†™æœºåˆ¶æ·±åº¦è§£æ</h3><h4 id="Lua-C-API-å‡½æ•°è°ƒç”¨è¯¦è§£"><a href="#Lua-C-API-å‡½æ•°è°ƒç”¨è¯¦è§£" class="headerlink" title="Lua C API: å‡½æ•°è°ƒç”¨è¯¦è§£"></a>Lua C API: å‡½æ•°è°ƒç”¨è¯¦è§£</h4><p><strong>æ ¸å¿ƒè°ƒç”¨ API</strong>:</p>
<table>
<thead>
<tr>
<th>API</th>
<th>åŠŸèƒ½</th>
<th>å‚æ•°</th>
<th>é”™è¯¯å¤„ç†</th>
</tr>
</thead>
<tbody><tr>
<td><code>lua_call(L, nargs, nresults)</code></td>
<td>è°ƒç”¨å‡½æ•°</td>
<td>å‚æ•°ä¸ªæ•°,è¿”å›å€¼ä¸ªæ•°</td>
<td>é”™è¯¯ä¼šå‘ä¸Šä¼ æ’­</td>
</tr>
<tr>
<td><code>lua_pcall(L, nargs, nresults, errfunc)</code></td>
<td>ä¿æŠ¤è°ƒç”¨</td>
<td>åŒä¸Š+é”™è¯¯å¤„ç†å‡½æ•°ç´¢å¼•</td>
<td>æ•è·é”™è¯¯ä¸å´©æºƒ</td>
</tr>
<tr>
<td><code>lua_pushcfunction(L, func)</code></td>
<td>å‹å…¥Cå‡½æ•°</td>
<td>Cå‡½æ•°æŒ‡é’ˆ</td>
<td>æ— </td>
</tr>
<tr>
<td><code>lua_pushcclosure(L, func, n)</code></td>
<td>å‹å…¥é—­åŒ…</td>
<td>Cå‡½æ•°+upvalueæ•°é‡</td>
<td>å¯è®¿é—®upvalue</td>
</tr>
</tbody></table>
<p><strong>lua_pcall è¯¦è§£</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‡½æ•°åŸå‹</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">lua_pcall</span><span class="params">(lua_State *L, <span class="type">int</span> nargs, <span class="type">int</span> nresults, <span class="type">int</span> errfunc)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‚æ•°è¯´æ˜:</span></span><br><span class="line"><span class="comment">// nargs:    å‚æ•°ä¸ªæ•° (ä»æ ˆé¡¶å¾€ä¸‹æ•°)</span></span><br><span class="line"><span class="comment">// nresults: æœŸæœ›çš„è¿”å›å€¼ä¸ªæ•° (LUA_MULTRET = æ‰€æœ‰è¿”å›å€¼)</span></span><br><span class="line"><span class="comment">// errfunc:  é”™è¯¯å¤„ç†å‡½æ•°çš„æ ˆç´¢å¼• (0 = æ— )</span></span><br><span class="line"><span class="comment">// è¿”å›å€¼:   LUA_OK(0) æˆåŠŸ, LUA_ERRRUN ç­‰é”™è¯¯ç </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ˆå¸ƒå±€ (è°ƒç”¨å‰):</span></span><br><span class="line"><span class="comment">// [..., function, arg1, arg2, ..., argN]</span></span><br><span class="line"><span class="comment">//       ^               ^</span></span><br><span class="line"><span class="comment">//       errfunc?        nargs=N</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ˆå¸ƒå±€ (è°ƒç”¨å,æˆåŠŸ):</span></span><br><span class="line"><span class="comment">// [..., result1, result2, ..., resultM]</span></span><br><span class="line"><span class="comment">//       nresults=M</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ˆå¸ƒå±€ (è°ƒç”¨å,å¤±è´¥):</span></span><br><span class="line"><span class="comment">// [..., error_message]</span></span><br></pre></td></tr></table></figure>

<p><strong>ç¤ºä¾‹å¯¹æ¯”</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ lua_call: é”™è¯¯ä¼šå´©æºƒ</span></span><br><span class="line"><span class="built_in">lua_getglobal</span>(L, <span class="string">&quot;MyFunction&quot;</span>);</span><br><span class="line"><span class="built_in">lua_pushinteger</span>(L, <span class="number">42</span>);</span><br><span class="line"><span class="built_in">lua_call</span>(L, <span class="number">1</span>, <span class="number">1</span>);  <span class="comment">// å¦‚æœ MyFunction æŠ›é”™,æ•´ä¸ªè¿›ç¨‹å´©æºƒ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… lua_pcall: å®‰å…¨</span></span><br><span class="line"><span class="built_in">lua_getglobal</span>(L, <span class="string">&quot;MyFunction&quot;</span>);</span><br><span class="line"><span class="built_in">lua_pushinteger</span>(L, <span class="number">42</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">lua_pcall</span>(L, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>) != LUA_OK)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* error = <span class="built_in">lua_tostring</span>(L, <span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">UE_LOG</span>(LogUnLua, Error, <span class="built_in">TEXT</span>(<span class="string">&quot;%s&quot;</span>), <span class="built_in">UTF8_TO_TCHAR</span>(error));</span><br><span class="line">    <span class="built_in">lua_pop</span>(L, <span class="number">1</span>);  <span class="comment">// å¼¹å‡ºé”™è¯¯ä¿¡æ¯</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UnLua çš„å‡½æ•°è¦†å†™é€šè¿‡<strong>æ‹¦æˆª UObject::ProcessEvent</strong> å®ç°ã€‚</p>
<h4 id="Hook-æµç¨‹å›¾"><a href="#Hook-æµç¨‹å›¾" class="headerlink" title="Hook æµç¨‹å›¾"></a>Hook æµç¨‹å›¾</h4><p><strong>åŸå§‹è°ƒç”¨é“¾:</strong></p>
<pre><code class="highlight mermaid">flowchart TD
    A[AActor::BeginPlay] --&gt; B[UFunction::Invoke]
    B --&gt; C[UObject::ProcessEvent Function, Params]
    C --&gt; D[æ‰§è¡Œè“å›¾å­—èŠ‚ç  / C++ åŸç”Ÿå‡½æ•°]
    
    style A fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style D fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px</code></pre>

<p><strong>UnLua Hook å:</strong></p>
<pre><code class="highlight mermaid">flowchart TD
    A[AActor::BeginPlay] --&gt; B[UFunction::Invoke]
    B --&gt; C[UObject::ProcessEvent Function, Params]
    C --&gt; D[&quot;FLuaOverrider::ProcessEvent&lt;br/&gt;âš¡ Hook æ‹¦æˆªç‚¹&quot;]
    D --&gt; E&#123;æ£€æŸ¥æ˜¯å¦æœ‰&lt;br/&gt;Lua è¦†å†™?&#125;
    E --&gt;|YES| F[FFunctionDesc::CallLua]
    E --&gt;|NO| G[Super::ProcessEvent]
    F --&gt; H[lua_pcall LuaFunction]
    H --&gt; I[è¿”å›å€¼å¤„ç†]
    G --&gt; I
    
    style A fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style D fill:#ffccbc,stroke:#bf360c,stroke-width:2px
    style E fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    style F fill:#f3e5f5,stroke:#4a148c,stroke-width:2px</code></pre>

<h4 id="CallLua-æ ¸å¿ƒæºç å‰–æ"><a href="#CallLua-æ ¸å¿ƒæºç å‰–æ" class="headerlink" title="CallLua æ ¸å¿ƒæºç å‰–æ"></a>CallLua æ ¸å¿ƒæºç å‰–æ</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FunctionDesc.cpp:300</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FFunctionDesc::CallLua</span><span class="params">(lua_State* L, lua_Integer FunctionRef, </span></span></span><br><span class="line"><span class="params"><span class="function">                           lua_Integer SelfRef, FFrame&amp; Stack, RESULT_DECL)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤1: åˆ†é…å‚æ•°ç¼“å†²åŒº</span></span><br><span class="line">    <span class="type">void</span>* Params = Buffer-&gt;<span class="built_in">GetBuffer</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤2: ä» UE Stack æ‹·è´å‚æ•°åˆ°ç¼“å†²åŒº</span></span><br><span class="line">    <span class="keyword">for</span> (FProperty* Property = Stack.Function-&gt;PropertyLink; Property; </span><br><span class="line">         Property = Property-&gt;PropertyLinkNext)</span><br><span class="line">    &#123;</span><br><span class="line">        Stack.<span class="built_in">Step</span>(Stack.Object, Property-&gt;<span class="built_in">ContainerPtrToValuePtr</span>&lt;<span class="type">void</span>&gt;(Params));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤3: APIè®²è§£ lua_rawgeti</span></span><br><span class="line">    <span class="comment">// åŠŸèƒ½: ä» registry ä¸­æ ¹æ®æ•´æ•°ç´¢å¼•è·å–å€¼</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: å–å‡ºä¹‹å‰å­˜å‚¨çš„ Lua å‡½æ•°å¼•ç”¨</span></span><br><span class="line">    <span class="comment">// ç­‰ä»·äº: lua_pushinteger(L, ref); lua_gettable(L, LUA_REGISTRYINDEX);</span></span><br><span class="line">    <span class="built_in">lua_rawgeti</span>(L, LUA_REGISTRYINDEX, FunctionRef);  </span><br><span class="line">    <span class="comment">// æ ˆ: [function]</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">lua_rawgeti</span>(L, LUA_REGISTRYINDEX, SelfRef);</span><br><span class="line">    <span class="comment">// æ ˆ: [function, self]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤4: å‚æ•°è½¬æ¢: C++ â†’ Lua</span></span><br><span class="line">    <span class="type">int</span> NumParams = <span class="number">1</span>;  <span class="comment">// ä» self å¼€å§‹</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; Properties.<span class="built_in">Num</span>(); ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!Properties[i]-&gt;<span class="built_in">IsReturnParameter</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// å°† C++ å‚æ•°å‹æ ˆ</span></span><br><span class="line">            Properties[i]-&gt;<span class="built_in">ReadValue_InContainer</span>(L, Params, <span class="literal">false</span>);</span><br><span class="line">            NumParams++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ ˆ: [function, self, arg1, arg2, ..., argN]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤5: APIè®²è§£ lua_pcall</span></span><br><span class="line">    <span class="comment">// å‚æ•°è§£æ:</span></span><br><span class="line">    <span class="comment">//   NumParams:   å‚æ•°ä¸ªæ•° (åŒ…å« self)</span></span><br><span class="line">    <span class="comment">//   NumResults:  æœŸæœ›è¿”å›å€¼ä¸ªæ•°</span></span><br><span class="line">    <span class="comment">//   ErrorHandler: é”™è¯¯å¤„ç†å‡½æ•°ç´¢å¼•</span></span><br><span class="line">    int32 NumResults = <span class="built_in">GetNumOutProperties</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">lua_pcall</span>(L, NumParams, NumResults, ErrorHandler) != LUA_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// â˜… é”™è¯¯å¤„ç†</span></span><br><span class="line">        <span class="comment">// æ ˆ: [error_message]</span></span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* ErrorMsg = <span class="built_in">lua_tostring</span>(L, <span class="number">-1</span>);</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogUnLua, Error, <span class="built_in">TEXT</span>(<span class="string">&quot;Lua Error: %s&quot;</span>), <span class="built_in">UTF8_TO_TCHAR</span>(ErrorMsg));</span><br><span class="line">        <span class="built_in">lua_pop</span>(L, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ ˆ(æˆåŠŸ): [result1, result2, ..., resultM]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤6: è¿”å›å€¼å¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">HasReturnProperty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        FPropertyDesc* RetProp = Properties[ReturnPropertyIndex].<span class="built_in">Get</span>();</span><br><span class="line">        <span class="type">void</span>* RetAddress = RetProp-&gt;<span class="built_in">GetUProperty</span>()-&gt;<span class="built_in">ContainerPtrToValuePtr</span>&lt;<span class="type">void</span>&gt;(Params);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// â˜… APIè®²è§£: è´Ÿç´¢å¼•å–å€¼</span></span><br><span class="line">        <span class="comment">// -NumResults è¡¨ç¤ºä»è¿”å›å€¼æœ€åä¸€ä¸ªå¼€å§‹</span></span><br><span class="line">        RetProp-&gt;<span class="built_in">WriteValue</span>(L, RetAddress, -NumResults);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤7: Out å‚æ•°å›å†™</span></span><br><span class="line">    <span class="keyword">for</span> (int32 OutIndex : OutPropertyIndices)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ä¾æ¬¡ä»æ ˆé¡¶å–å‡º out å‚æ•°å†™å› C++</span></span><br><span class="line">        Properties[OutIndex]-&gt;<span class="built_in">WriteValue_InContainer</span>(L, Params, -(--NumResults));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å®é™…è°ƒç”¨ç¤ºä¾‹</strong>:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Lua ä»£ç </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyActor:ReceiveBeginPlay</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> pos = <span class="built_in">self</span>:K2_GetActorLocation()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Actorä½ç½®:&quot;</span>, pos.X, pos.Y, pos.Z)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><strong>C++ è°ƒç”¨æµç¨‹</strong>:</p>
<pre><code class="highlight mermaid">sequenceDiagram
    participant BP as è“å›¾ BeginPlay
    participant PE as ProcessEvent Hook
    participant CL as CallLua
    participant Lua as Lua å‡½æ•°
    participant UE as UE å¼•æ“
    
    BP-&gt;&gt;PE: 1. è§¦å‘ BeginPlay
    PE-&gt;&gt;CL: 2. æ‹¦æˆªè°ƒç”¨
    CL-&gt;&gt;CL: 3. lua_rawgeti æŸ¥æ‰¾å‡½æ•°&lt;br/&gt;å‹å…¥ MyActor:ReceiveBeginPlay
    CL-&gt;&gt;CL: 4. lua_rawgeti å‹å…¥ self&lt;br/&gt;æ ˆ: [function, self]
    CL-&gt;&gt;Lua: 5. lua_pcall(L, 1, 0, errfunc)
    Lua-&gt;&gt;UE: 6. self:K2_GetActorLocation()&lt;br/&gt;è·¨å› C++ (CallUE)
    UE--&gt;&gt;Lua: è¿”å›ä½ç½®
    Lua--&gt;&gt;CL: è¿”å›
    CL--&gt;&gt;BP: 7. è¿”å› UE å¼•æ“ç»§ç»­æ‰§è¡Œ
    
    Note over BP,UE: å®Œæ•´çš„åŒå‘è°ƒç”¨æµç¨‹</code></pre>

<p><strong>æ­¥éª¤è¯¦è§£</strong>:</p>
<pre><code class="highlight mermaid">flowchart TB
    A[FindFunctionChecked FName] --&gt; B[Class::FindFunctionByName]
    B --&gt; C[FuncMap.Find SpawnText]
    C --&gt; D&#123;æ˜¯å¦è¦†å†™?&#125;
    D --&gt;|æœªè¦†å†™| E1[è¿”å›åŸå§‹ UFunction]
    D --&gt;|å·²è¦†å†™| E2[&quot;è¿”å› ULuaFunction&lt;br/&gt;âš¡ Lua è¦†å†™æ—¶æ·»åŠ çš„&quot;]
    
    E1 --&gt; F[ProcessEvent Function, Params]
    E2 --&gt; F
    
    F --&gt; G&#123;æ£€æŸ¥ GetNativeFunc&#125;
    G --&gt;|C++ å‡½æ•°| H1[execSpawnText_Implementation]
    G --&gt;|è“å›¾å­—èŠ‚ç | H2[ProcessInternal]
    G --&gt;|Lua è¦†å†™| H3[execCallLua]
    
    H3 --&gt; I[ULuaFunction::CallLua]
    I --&gt; J[lua_pcall L, ...]
    
    style D fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    style E2 fill:#ffccbc,stroke:#bf360c,stroke-width:2px
    style H3 fill:#f3e5f5,stroke:#4a148c,stroke-width:2px</code></pre>

<h4 id="è¦†å†™æœºåˆ¶æºç å®Œæ•´å‰–æ"><a href="#è¦†å†™æœºåˆ¶æºç å®Œæ•´å‰–æ" class="headerlink" title="è¦†å†™æœºåˆ¶æºç å®Œæ•´å‰–æ"></a>è¦†å†™æœºåˆ¶æºç å®Œæ•´å‰–æ</h4><p><strong>ç¬¬ä¸€æ­¥: å‡½æ•°è¦†ç›–æ³¨å†Œ (UUnLuaManager::BindClass)</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnLuaManager.cpp:180</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UUnLuaManager::BindClass</span><span class="params">(UClass* Class, <span class="type">const</span> FString&amp; InModuleName, FString&amp; Error)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">check</span>(Class);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤1: åŠ è½½ Lua Module åˆ°æ ˆé¡¶</span></span><br><span class="line">    <span class="type">int</span> Ref = <span class="built_in">LoadModule</span>(InModuleName);</span><br><span class="line">    <span class="keyword">if</span> (Ref == LUA_REFNIL)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤2: åˆ›å»ºç»‘å®šä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">auto</span>&amp; BindInfo = Classes.<span class="built_in">Add</span>(Class);</span><br><span class="line">    BindInfo.Class = Class;</span><br><span class="line">    BindInfo.ModuleName = InModuleName;</span><br><span class="line">    BindInfo.TableRef = Ref;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤3: è·å– Lua Module çš„æ‰€æœ‰å‡½æ•°å</span></span><br><span class="line">    <span class="comment">// ç­‰ä»·äº: for k, v in pairs(Module) do if type(v) == &quot;function&quot; then ... end end</span></span><br><span class="line">    UnLua::LowLevel::<span class="built_in">GetFunctionNames</span>(Env-&gt;<span class="built_in">GetMainState</span>(), Ref, BindInfo.LuaFunctions);</span><br><span class="line">    <span class="comment">// ç»“æœ: BindInfo.LuaFunctions = &#123;&quot;ReceiveBeginPlay&quot;, &quot;ReceiveTick&quot;, ...&#125;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤4: è·å– UClass çš„æ‰€æœ‰å¯è¦†å†™å‡½æ•°</span></span><br><span class="line">    ULuaFunction::<span class="built_in">GetOverridableFunctions</span>(Class, BindInfo.UEFunctions);</span><br><span class="line">    <span class="comment">// ç»“æœ: BindInfo.UEFunctions = &#123;</span></span><br><span class="line">    <span class="comment">//   &quot;ReceiveBeginPlay&quot; -&gt; UFunction*,</span></span><br><span class="line">    <span class="comment">//   &quot;ReceiveTick&quot; -&gt; UFunction*,</span></span><br><span class="line">    <span class="comment">//   ...</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤5: éå† Lua å‡½æ•°,è¦†å†™åŒå UFunction</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; LuaFuncName : BindInfo.LuaFunctions)</span><br><span class="line">    &#123;</span><br><span class="line">        UFunction** Func = BindInfo.UEFunctions.<span class="built_in">Find</span>(LuaFuncName);</span><br><span class="line">        <span class="keyword">if</span> (Func)</span><br><span class="line">        &#123;</span><br><span class="line">            UFunction* Function = *Func;</span><br><span class="line">            <span class="comment">// â˜… å…³é”®: æ‰§è¡Œè¦†å†™é€»è¾‘</span></span><br><span class="line">            ULuaFunction::<span class="built_in">Override</span>(Function, Class, LuaFuncName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬äºŒæ­¥: åˆ›å»º ULuaFunction (FLuaOverrides::Override)</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LuaOverrides.cpp:66</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FLuaOverrides::Override</span><span class="params">(UFunction* Function, UClass* Class, FName NewName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤1: è·å–æˆ–åˆ›å»ºè¦†å†™ç±»</span></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> OverridesClass = <span class="built_in">GetOrAddOverridesClass</span>(Class);</span><br><span class="line">    <span class="comment">// è¿™æ˜¯ä¸€ä¸ªä¸´æ—¶ UClass,ç”¨äºå­˜å‚¨æ‰€æœ‰è¦†å†™å‡½æ•°</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤2: åˆ¤æ–­æ˜¯æ–°å¢è¿˜æ˜¯å·²å­˜åœ¨</span></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> bAddNew = Function-&gt;<span class="built_in">GetOuter</span>() != Class;</span><br><span class="line">    <span class="comment">// bAddNew = true:  C++ åŸç”Ÿå‡½æ•° (Outer æ˜¯çˆ¶ç±»)</span></span><br><span class="line">    <span class="comment">// bAddNew = false: è“å›¾å‡½æ•° (Outer å°±æ˜¯å½“å‰ç±»)</span></span><br><span class="line">    </span><br><span class="line">    ULuaFunction* LuaFunction;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!bAddNew)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// è“å›¾å‡½æ•°:æ£€æŸ¥æ˜¯å¦å·²è¦†å†™</span></span><br><span class="line">        LuaFunction = <span class="built_in">Cast</span>&lt;ULuaFunction&gt;(Function);</span><br><span class="line">        <span class="keyword">if</span> (LuaFunction)</span><br><span class="line">        &#123;</span><br><span class="line">            LuaFunction-&gt;<span class="built_in">Initialize</span>();</span><br><span class="line">            <span class="keyword">return</span>;  <span class="comment">// å·²è¦†å†™,è·³è¿‡</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤3: æ‹·è´ UFunction å¹¶è½¬æ¢ä¸º ULuaFunction</span></span><br><span class="line">    <span class="function">FObjectDuplicationParameters <span class="title">DuplicationParams</span><span class="params">(Function, OverridesClass)</span></span>;</span><br><span class="line">    DuplicationParams.InternalFlagMask &amp;= ~EInternalObjectFlags::Native;</span><br><span class="line">    DuplicationParams.DestName = NewName;</span><br><span class="line">    DuplicationParams.DestClass = ULuaFunction::<span class="built_in">StaticClass</span>();  <span class="comment">// â† å…³é”®</span></span><br><span class="line">    </span><br><span class="line">    LuaFunction = <span class="built_in">static_cast</span>&lt;ULuaFunction*&gt;(<span class="built_in">StaticDuplicateObjectEx</span>(DuplicationParams));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤4: åŠ å…¥åˆ° OverridesClass çš„ Children é“¾è¡¨</span></span><br><span class="line">    LuaFunction-&gt;Next = OverridesClass-&gt;Children;</span><br><span class="line">    OverridesClass-&gt;Children = LuaFunction;</span><br><span class="line">    </span><br><span class="line">    LuaFunction-&gt;<span class="built_in">StaticLink</span>(<span class="literal">true</span>);</span><br><span class="line">    LuaFunction-&gt;<span class="built_in">Initialize</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤5: æ‰§è¡Œè¦†å†™é€»è¾‘</span></span><br><span class="line">    LuaFunction-&gt;<span class="built_in">Override</span>(Function, Class, bAddNew);</span><br><span class="line">    LuaFunction-&gt;<span class="built_in">Bind</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤6: é˜²æ­¢ GC å›æ”¶</span></span><br><span class="line">    <span class="keyword">if</span> (Class-&gt;<span class="built_in">IsRooted</span>() || GUObjectArray.<span class="built_in">IsDisregardForGC</span>(Class))</span><br><span class="line">        LuaFunction-&gt;<span class="built_in">AddToRoot</span>();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        LuaFunction-&gt;<span class="built_in">AddToCluster</span>(Class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬ä¸‰æ­¥: ç»‘å®š Lua è°ƒç”¨å…¥å£ (ULuaFunction::Override)</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LuaFunction.cpp:120</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ULuaFunction::Override</span><span class="params">(UFunction* Function, UClass* Class, <span class="type">bool</span> bAddNew)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">check</span>(Function &amp;&amp; Class &amp;&amp; !From.<span class="built_in">IsValid</span>());</span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WITH_METADATA</span></span><br><span class="line">    UMetaData::<span class="built_in">CopyMetadata</span>(Function, <span class="keyword">this</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    bActivated = <span class="literal">false</span>;</span><br><span class="line">    bAdded = bAddNew;</span><br><span class="line">    From = Function;  <span class="comment">// ä¿å­˜åŸå§‹å‡½æ•°å¼•ç”¨</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤1: æ£€æŸ¥æ˜¯å¦å·²è¢«è¦†å†™è¿‡</span></span><br><span class="line">    <span class="keyword">if</span> (Function-&gt;<span class="built_in">GetNativeFunc</span>() == execScriptCallLua)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// å·²ç»è¢«è¦†å†™,æå–åŸå§‹å‡½æ•°</span></span><br><span class="line">        <span class="type">const</span> <span class="keyword">auto</span> LuaFunction = <span class="built_in">Get</span>(Function);</span><br><span class="line">        Overridden = LuaFunction-&gt;<span class="built_in">GetOverridden</span>();</span><br><span class="line">        <span class="built_in">check</span>(Overridden);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// â˜… æ­¥éª¤2: å¤‡ä»½åŸå§‹å‡½æ•°</span></span><br><span class="line">        <span class="type">const</span> <span class="keyword">auto</span> DestName = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%s__Overridden&quot;</span>), *Function-&gt;<span class="built_in">GetName</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (Function-&gt;<span class="built_in">HasAnyFunctionFlags</span>(FUNC_Native))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// C++ å‡½æ•°: éœ€è¦æ³¨å†ŒåŸç”Ÿå‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">            <span class="built_in">GetOuterUClass</span>()-&gt;<span class="built_in">AddNativeFunction</span>(*DestName, *Function-&gt;<span class="built_in">GetNativeFunc</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ‹·è´åŸå§‹å‡½æ•°</span></span><br><span class="line">        Overridden = <span class="built_in">static_cast</span>&lt;UFunction*&gt;(<span class="built_in">StaticDuplicateObject</span>(Function, <span class="built_in">GetOuter</span>(), *DestName));</span><br><span class="line">        Overridden-&gt;<span class="built_in">ClearInternalFlags</span>(EInternalObjectFlags::Native);</span><br><span class="line">        Overridden-&gt;<span class="built_in">StaticLink</span>(<span class="literal">true</span>);</span><br><span class="line">        Overridden-&gt;<span class="built_in">SetNativeFunc</span>(Function-&gt;<span class="built_in">GetNativeFunc</span>());</span><br><span class="line">        <span class="comment">// ç°åœ¨ Overridden ä¿å­˜äº†åŸå§‹å®ç°,Lua å¯é€šè¿‡ self.Overridden:XXX() è°ƒç”¨</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤3: æ¿€æ´»è¦†å†™</span></span><br><span class="line">    <span class="built_in">SetActive</span>(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬å››æ­¥: è®¾ç½®è°ƒç”¨å…¥å£ (ULuaFunction::SetActive)</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LuaFunction.cpp:156</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ULuaFunction::SetActive</span><span class="params">(<span class="type">bool</span> bActive)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bActive == bActivated)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    bActivated = bActive;</span><br><span class="line">    <span class="keyword">auto</span> Function = From.<span class="built_in">Get</span>();</span><br><span class="line">    <span class="built_in">check</span>(Function);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (bAdded)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// â˜… åˆ†æ”¯A: C++ åŸç”Ÿå‡½æ•°è¦†å†™</span></span><br><span class="line">        <span class="comment">// å°† ULuaFunction åŠ å…¥åˆ° Class-&gt;FuncMap</span></span><br><span class="line">        <span class="built_in">check</span>(!Class-&gt;<span class="built_in">FindFunctionByName</span>(<span class="built_in">GetFName</span>(), EIncludeSuperFlag::ExcludeSuper));</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">SetSuperStruct</span>(Function);</span><br><span class="line">        FunctionFlags |= FUNC_Native;</span><br><span class="line">        <span class="built_in">ClearInternalFlags</span>(EInternalObjectFlags::Native);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// â˜… å…³é”®: è®¾ç½® NativeFunc ä¸º execCallLua</span></span><br><span class="line">        <span class="built_in">SetNativeFunc</span>(execCallLua);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// â˜… æ·»åŠ åˆ° FuncMap</span></span><br><span class="line">        Class-&gt;<span class="built_in">AddFunctionToFunctionMap</span>(<span class="keyword">this</span>, *<span class="built_in">GetName</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (Function-&gt;<span class="built_in">HasAnyFunctionFlags</span>(FUNC_Native))</span><br><span class="line">            Class-&gt;<span class="built_in">AddNativeFunction</span>(*<span class="built_in">GetName</span>(), &amp;ULuaFunction::execCallLua);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// â˜… åˆ†æ”¯B: è“å›¾å‡½æ•°è¦†å†™</span></span><br><span class="line">        <span class="comment">// ä¿®æ”¹åŸå§‹ UFunction,è®©å®ƒè°ƒç”¨ Lua</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">SetSuperStruct</span>(Function-&gt;<span class="built_in">GetSuperStruct</span>());</span><br><span class="line">        Script = Function-&gt;Script;</span><br><span class="line">        Children = Function-&gt;Children;</span><br><span class="line">        ChildProperties = Function-&gt;ChildProperties;</span><br><span class="line">        PropertyLink = Function-&gt;PropertyLink;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// â˜… ä¿®æ”¹åŸå§‹å‡½æ•°çš„ NativeFunc</span></span><br><span class="line">        Function-&gt;FunctionFlags |= FUNC_Native;</span><br><span class="line">        Function-&gt;<span class="built_in">SetNativeFunc</span>(&amp;execScriptCallLua);</span><br><span class="line">        Function-&gt;<span class="built_in">GetOuterUClass</span>()-&gt;<span class="built_in">AddNativeFunction</span>(*Function-&gt;<span class="built_in">GetName</span>(), &amp;execScriptCallLua);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// â˜… æ¸…ç©ºè“å›¾å­—èŠ‚ç ,æ”¹ä¸ºå­˜å‚¨ ULuaFunction æŒ‡é’ˆ</span></span><br><span class="line">        Function-&gt;Script.<span class="built_in">Empty</span>();</span><br><span class="line">        Function-&gt;Script.<span class="built_in">AddUninitialized</span>(ScriptMagicHeaderSize + <span class="built_in">sizeof</span>(ULuaFunction*));</span><br><span class="line">        </span><br><span class="line">        <span class="type">const</span> <span class="keyword">auto</span> Data = Function-&gt;Script.<span class="built_in">GetData</span>();</span><br><span class="line">        FPlatformMemory::<span class="built_in">Memcpy</span>(Data, ScriptMagicHeader, ScriptMagicHeaderSize);</span><br><span class="line">        FPlatformMemory::<span class="built_in">WriteUnaligned</span>&lt;ULuaFunction*&gt;(Data + ScriptMagicHeaderSize, <span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// ç°åœ¨ Function-&gt;Script å­˜å‚¨çš„æ˜¯ ULuaFunction* è€Œéå­—èŠ‚ç </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>execScriptCallLua å®ç°</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LuaFunction.cpp:280</span></span><br><span class="line"><span class="built_in">DEFINE_FUNCTION</span>(ULuaFunction::execScriptCallLua)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// â˜… ä» Script ä¸­æå– ULuaFunction æŒ‡é’ˆ</span></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> Data = Stack.Node-&gt;Script.<span class="built_in">GetData</span>();</span><br><span class="line">    <span class="keyword">auto</span> LuaFunction = FPlatformMemory::<span class="built_in">ReadUnaligned</span>&lt;ULuaFunction*&gt;(Data + ScriptMagicHeaderSize);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… è°ƒç”¨ Lua å‡½æ•°</span></span><br><span class="line">    LuaFunction-&gt;<span class="built_in">CallLua</span>(Context, Stack, RESULT_PARAM);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è°ƒç”¨æµç¨‹æ€»ç»“</strong>:</p>
<pre><code class="highlight mermaid">flowchart TD
    Start([C++ è°ƒç”¨: actor-&gt;SpawnText]) --&gt; A[FindFunctionChecked SpawnText]
    A --&gt; B&#123;åœ¨ FuncMap æŸ¥æ‰¾&#125;
    B --&gt;|æ‰¾åˆ°| C[ULuaFunction]
    C --&gt; D[ProcessEvent ULuaFunction, Params]
    D --&gt; E&#123;bAddNew?&#125;
    E --&gt;|true| F[execCallLua]
    E --&gt;|false| G[execScriptCallLua]
    F --&gt; H[ULuaFunction::CallLua]
    G --&gt; H
    H --&gt; I[lua_pcall L, ReceiveSpawnText, ...]
    I --&gt; J[æ‰§è¡Œ Lua ä»£ç ]
    J --&gt; K&#123;éœ€è¦è°ƒç”¨åŸå§‹å®ç°?&#125;
    K --&gt;|æ˜¯| L[self.Overridden:SpawnText_Implementation&lt;br/&gt;è°ƒç”¨ C++ åŸå§‹å®ç°]
    K --&gt;|å¦| M([è¿”å›])
    L --&gt; M
    
    style Start fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style E fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    style H fill:#ffccbc,stroke:#bf360c,stroke-width:2px
    style J fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    style M fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px</code></pre>

<h4 id="æŸ¥æ‰¾ä¼˜å…ˆçº§"><a href="#æŸ¥æ‰¾ä¼˜å…ˆçº§" class="headerlink" title="æŸ¥æ‰¾ä¼˜å…ˆçº§"></a>æŸ¥æ‰¾ä¼˜å…ˆçº§</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å‡è®¾ç»§æ‰¿å…³ç³»: UObject -&gt; AActor -&gt; ACharacter -&gt; AMyPlayer</span></span><br><span class="line"><span class="comment">-- Lua Module: MyPlayer.lua</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyPlayer:ReceiveTick</span><span class="params">(DeltaSeconds)</span></span></span><br><span class="line">    <span class="comment">-- Lua è¦†å†™</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- æŸ¥æ‰¾é¡ºåº:</span></span><br><span class="line"><span class="number">1.</span> MyPlayer.ReceiveTick       â† ä¼˜å…ˆçº§æœ€é«˜ (Lua è¦†å†™)</span><br><span class="line"><span class="number">2.</span> AMyPlayer.Tick             â† C++ åŸç”Ÿå‡½æ•°</span><br><span class="line"><span class="number">3.</span> ACharacter.Tick            â† çˆ¶ç±» C++ å‡½æ•°</span><br><span class="line"><span class="number">4.</span> AActor.Tick                â† åŸºç±» C++ å‡½æ•°</span><br></pre></td></tr></table></figure>

<h4 id="Super-è°ƒç”¨æœºåˆ¶"><a href="#Super-è°ƒç”¨æœºåˆ¶" class="headerlink" title="Super è°ƒç”¨æœºåˆ¶"></a>Super è°ƒç”¨æœºåˆ¶</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyPlayer:ReceiveTick</span><span class="params">(DeltaSeconds)</span></span></span><br><span class="line">    <span class="comment">-- è°ƒç”¨çˆ¶ç±» Lua å®ç° (å¦‚æœå­˜åœ¨)</span></span><br><span class="line">    <span class="built_in">self</span>.Super:ReceiveTick(DeltaSeconds)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- æˆ–è€…è°ƒç”¨ C++ åŸå§‹å®ç°</span></span><br><span class="line">    <span class="built_in">self</span>.Overridden.Tick(<span class="built_in">self</span>, DeltaSeconds)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- è‡ªå®šä¹‰é€»è¾‘</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Lua Tick: &quot;</span> .. DeltaSeconds)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><strong>å®ç°åŸç†</strong>:</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSTANCE </span>çš„ metatable ç»“æ„:</span><br><span class="line"><span class="keyword">INSTANCE </span>= &#123;</span><br><span class="line">    metatable = MODULE,</span><br><span class="line">    Overridden = METATABLE_UOBJECT  â† æŒ‡å‘ C++ åŸå§‹ Metatable</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="è¦†å†™æ£€æµ‹ä¸å±æ€§è®¿é—®æµç¨‹"><a href="#è¦†å†™æ£€æµ‹ä¸å±æ€§è®¿é—®æµç¨‹" class="headerlink" title="è¦†å†™æ£€æµ‹ä¸å±æ€§è®¿é—®æµç¨‹"></a>è¦†å†™æ£€æµ‹ä¸å±æ€§è®¿é—®æµç¨‹</h3><h4 id="Lua-C-API-æ ˆæ“ä½œåŸºç¡€"><a href="#Lua-C-API-æ ˆæ“ä½œåŸºç¡€" class="headerlink" title="Lua C API: æ ˆæ“ä½œåŸºç¡€"></a>Lua C API: æ ˆæ“ä½œåŸºç¡€</h4><p>åœ¨ç†è§£ <code>Class_Index</code> å‰,å¿…é¡»æŒæ¡ Lua æ ˆçš„æ ¸å¿ƒæ¦‚å¿µ:</p>
<p><strong>æ ˆç´¢å¼•è§„åˆ™</strong>:</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Lua æ ˆç»“æ„ <span class="comment">(ä»åº•åˆ°é¡¶)</span>:</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚  <span class="number">4</span>  <span class="comment">(-1)</span>       â”‚ â† æ ˆé¡¶ <span class="comment">(æœ€è¿‘å‹å…¥)</span></span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚  <span class="number">3</span>  <span class="comment">(-2)</span>       â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚  <span class="number">2</span>  <span class="comment">(-3)</span>       â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚  <span class="number">1</span>  <span class="comment">(-4)</span>       â”‚ â† æ ˆåº• <span class="comment">(æœ€æ—©å‹å…¥)</span></span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line">æ­£æ•°ç´¢å¼•: ä»æ ˆåº•å¼€å§‹ <span class="comment">(1-based)</span></span><br><span class="line">è´Ÿæ•°ç´¢å¼•: ä»æ ˆé¡¶å¼€å§‹ <span class="comment">(-1 è¡¨ç¤ºæ ˆé¡¶)</span></span><br></pre></td></tr></table></figure>

<p><strong>æ ¸å¿ƒæ ˆæ“ä½œ API</strong>:</p>
<table>
<thead>
<tr>
<th>API</th>
<th>åŠŸèƒ½</th>
<th>æ ˆå˜åŒ–</th>
<th>ç¤ºä¾‹</th>
</tr>
</thead>
<tbody><tr>
<td><code>lua_gettop(L)</code></td>
<td>è·å–æ ˆé¡¶ç´¢å¼•</td>
<td>æ— </td>
<td><code>int n = lua_gettop(L);</code></td>
</tr>
<tr>
<td><code>lua_settop(L, n)</code></td>
<td>è®¾ç½®æ ˆå¤§å°</td>
<td>æˆªæ–­æˆ–å¡«å……nil</td>
<td><code>lua_settop(L, 0);</code> æ¸…ç©ºæ ˆ</td>
</tr>
<tr>
<td><code>lua_pushvalue(L, idx)</code></td>
<td>å¤åˆ¶å€¼åˆ°æ ˆé¡¶</td>
<td><code>[+1]</code></td>
<td>å¤åˆ¶æ ˆä¸Šä»»æ„ä½ç½®</td>
</tr>
<tr>
<td><code>lua_remove(L, idx)</code></td>
<td>ç§»é™¤æŒ‡å®šä½ç½®</td>
<td><code>[-1]</code></td>
<td>æ ˆä¸Šæ‰€æœ‰å€¼ä¸Šç§»</td>
</tr>
<tr>
<td><code>lua_pop(L, n)</code></td>
<td>å¼¹å‡ºnä¸ªå€¼</td>
<td><code>[-n]</code></td>
<td>ç­‰ä»·äº <code>lua_settop(L, -n-1)</code></td>
</tr>
<tr>
<td><code>lua_touserdata(L, idx)</code></td>
<td>è·å–userdata</td>
<td>æ— </td>
<td>è¿”å›void*æŒ‡é’ˆ</td>
</tr>
</tbody></table>
<h4 id="Class-Index-å®Œæ•´æºç å‰–æ"><a href="#Class-Index-å®Œæ•´æºç å‰–æ" class="headerlink" title="Class_Index å®Œæ•´æºç å‰–æ"></a>Class_Index å®Œæ•´æºç å‰–æ</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LuaCore.cpp:1196</span></span><br><span class="line"><span class="function">int32 <span class="title">Class_Index</span><span class="params">(lua_State *L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// â˜… åˆå§‹æ ˆçŠ¶æ€</span></span><br><span class="line">    <span class="comment">// æ ˆ: [1]=userdata(self), [2]=string(key)]</span></span><br><span class="line">    <span class="comment">// Luaè°ƒç”¨: obj.GetName æˆ– obj[&quot;GetName&quot;]</span></span><br><span class="line">    <span class="comment">// è§¦å‘ __index å…ƒæ–¹æ³•,ä¼ å…¥ (obj, &quot;GetName&quot;)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤1: æŸ¥æ‰¾å­—æ®µæè¿°ç¬¦</span></span><br><span class="line">    <span class="comment">// GetField ä¼šä» ClassRegistry æŸ¥æ‰¾å±æ€§æˆ–å‡½æ•°</span></span><br><span class="line">    <span class="built_in">GetField</span>(L);</span><br><span class="line">    <span class="comment">// æ ˆ: [userdata(self), string(key), field_descriptoræˆ–nil]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤2: APIè®²è§£ lua_touserdata</span></span><br><span class="line">    <span class="comment">// åŠŸèƒ½: è·å–userdataçš„æŒ‡é’ˆ,å¦‚æœä¸æ˜¯userdataè¿”å›NULL</span></span><br><span class="line">    <span class="comment">// å‚æ•°: -1 è¡¨ç¤ºæ ˆé¡¶</span></span><br><span class="line">    <span class="keyword">auto</span> Ptr = <span class="built_in">lua_touserdata</span>(L, <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> (!Ptr)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;  <span class="comment">// éuserdata,ç›´æ¥è¿”å›æ ˆé¡¶å€¼(å‡½æ•°/nil)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤3: è§£æå±æ€§æè¿°ç¬¦</span></span><br><span class="line">    <span class="keyword">auto</span> Property = <span class="keyword">static_cast</span>&lt;TSharedPtr&lt;UnLua::ITypeOps&gt;*&gt;(Ptr);</span><br><span class="line">    <span class="keyword">if</span> (!Property-&gt;<span class="built_in">IsValid</span>())</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤4: è·å– C++ å®ä¾‹æŒ‡é’ˆ</span></span><br><span class="line">    <span class="comment">// GetCppInstance ä» userdata æå–äºŒçº§æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">auto</span> Self = <span class="built_in">GetCppInstance</span>(L, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (!Self)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤5: æ‚¬ç©ºæŒ‡é’ˆæ£€æµ‹</span></span><br><span class="line">    <span class="comment">// é˜²æ­¢è®¿é—®å·²é”€æ¯çš„ UObject</span></span><br><span class="line">    <span class="keyword">if</span> (UnLua::LowLevel::<span class="built_in">IsReleasedPtr</span>(Self))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// â˜… APIè®²è§£: luaL_error</span></span><br><span class="line">        <span class="comment">// åŠŸèƒ½: æŠ›å‡ºLuaé”™è¯¯å¹¶ç»ˆæ­¢å½“å‰è°ƒç”¨</span></span><br><span class="line">        <span class="comment">// è¿”å›å€¼: æ°¸ä¸è¿”å› (long jump)</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">luaL_error</span>(L, </span><br><span class="line">            <span class="built_in">TCHAR_TO_UTF8</span>(*FString::<span class="built_in">Printf</span>(</span><br><span class="line">                <span class="built_in">TEXT</span>(<span class="string">&quot;attempt to read property &#x27;%s&#x27; on released object&quot;</span>), </span><br><span class="line">                *(*Property)-&gt;<span class="built_in">GetName</span>())));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤6: è¯»å–å±æ€§å€¼</span></span><br><span class="line">    <span class="comment">// ReadValue_InContainer ä¼šæ ¹æ®ç±»å‹è½¬æ¢å¹¶å‹æ ˆ</span></span><br><span class="line">    (*Property)-&gt;<span class="built_in">ReadValue_InContainer</span>(L, Self, <span class="literal">false</span>);</span><br><span class="line">    <span class="comment">// æ ˆ: [userdata(self), string(key), field_descriptor, property_value]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤7: APIè®²è§£ lua_remove</span></span><br><span class="line">    <span class="comment">// åŠŸèƒ½: ç§»é™¤æŒ‡å®šç´¢å¼•å¤„çš„å€¼,åé¢çš„å€¼å‰ç§»</span></span><br><span class="line">    <span class="comment">// å‚æ•°: -2 è¡¨ç¤ºå€’æ•°ç¬¬2ä¸ª(field_descriptor)</span></span><br><span class="line">    <span class="built_in">lua_remove</span>(L, <span class="number">-2</span>);</span><br><span class="line">    <span class="comment">// æ ˆ: [userdata(self), string(key), property_value]</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;  <span class="comment">// è¿”å›1ä¸ªå€¼(property_value)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ ˆå˜åŒ–å¯è§†åŒ–</strong>:</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">åˆå§‹:     [userdata, <span class="string">&quot;GetName&quot;</span>]</span><br><span class="line"><span class="symbol">GetField:</span> [userdata, <span class="string">&quot;GetName&quot;</span>, property_desc]</span><br><span class="line"><span class="symbol">touserdata:</span> æ£€æŸ¥ property_desc æ˜¯å¦ä¸ºuserdata</span><br><span class="line"><span class="symbol">ReadValue:</span>  [userdata, <span class="string">&quot;GetName&quot;</span>, property_desc, <span class="string">&quot;ActorName&quot;</span>]</span><br><span class="line"><span class="symbol">remove:</span>     [userdata, <span class="string">&quot;GetName&quot;</span>, <span class="string">&quot;ActorName&quot;</span>]</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>:   Lua æ¥æ”¶åˆ° <span class="string">&quot;ActorName&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="GetField-æ ˆæ“ä½œå®Œæ•´å¯è§†åŒ–"><a href="#GetField-æ ˆæ“ä½œå®Œæ•´å¯è§†åŒ–" class="headerlink" title="GetField æ ˆæ“ä½œå®Œæ•´å¯è§†åŒ–"></a>GetField æ ˆæ“ä½œå®Œæ•´å¯è§†åŒ–</h4><p><strong>åˆå§‹æ ˆçŠ¶æ€</strong> (Lua è°ƒç”¨ <code>actor:GetActorLocation()</code>)</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">æ ˆé¡¶ â†“</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ [<span class="number">2</span>] <span class="string">&quot;GetActorLocation&quot;</span> â”‚  â† å‡½æ•°å</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ [<span class="number">1</span>] <span class="variable">&lt;Userdata: AActor&gt;</span> â”‚  â† <span class="literal">self</span></span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">æ ˆåº• â†‘</span><br></pre></td></tr></table></figure>

<p><strong>æ‰§è¡Œ GetField(L) ç¬¬ä¸€æ­¥: è·å–å…ƒè¡¨</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FORCEINLINE <span class="type">static</span> int32 <span class="title">GetField</span><span class="params">(lua_State* L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">lua_getmetatable</span>(L, <span class="number">1</span>); <span class="comment">// è·å–æ ˆç´¢å¼•1çš„å…ƒè¡¨</span></span><br><span class="line">    <span class="comment">// æ ˆ: [userdata, key, metatable]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ ˆå˜åŒ–</strong>:</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">æ ˆé¡¶ â†“</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ [<span class="number">3</span>] &lt;<span class="symbol">Metatable</span>: <span class="symbol">AActor</span>&gt;â”‚  â† æ–°å¢</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ [<span class="number">2</span>] <span class="string">&quot;GetActorLocation&quot;</span> â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ [<span class="number">1</span>] &lt;<span class="symbol">Userdata</span>: <span class="symbol">AActor</span>&gt; â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬äºŒæ­¥: å¤åˆ¶ key åˆ°æ ˆé¡¶</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    <span class="built_in">lua_pushvalue</span>(L, <span class="number">2</span>);  <span class="comment">// å¤åˆ¶æ ˆç´¢å¼•2çš„å€¼</span></span><br><span class="line">    <span class="comment">// æ ˆ: [userdata, key, metatable, key]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ ˆå˜åŒ–</strong>:</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">æ ˆé¡¶ â†“</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ [<span class="number">4</span>] <span class="string">&quot;GetActorLocation&quot;</span> â”‚  â† key çš„å‰¯æœ¬</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ [<span class="number">3</span>] &lt;<span class="symbol">Metatable</span>: <span class="symbol">AActor</span>&gt;â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ [<span class="number">2</span>] <span class="string">&quot;GetActorLocation&quot;</span> â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ [<span class="number">1</span>] &lt;<span class="symbol">Userdata</span>: <span class="symbol">AActor</span>&gt; â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬ä¸‰æ­¥: åœ¨å…ƒè¡¨ä¸­æŸ¥æ‰¾ key</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    int32 Type = <span class="built_in">lua_rawget</span>(L, <span class="number">-2</span>); </span><br><span class="line">    <span class="comment">// åŠŸèƒ½: ä»ç´¢å¼•-2(metatable)æŸ¥æ‰¾æ ˆé¡¶çš„key</span></span><br><span class="line">    <span class="comment">// ç»“æœ: å¼¹å‡ºæ ˆé¡¶,å‹å…¥ metatable[key]</span></span><br><span class="line">    <span class="comment">// æ ˆ: [userdata, key, metatable, valueæˆ–nil]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ ˆå˜åŒ–</strong> (å‡è®¾ metatable ä¸­æ²¡æœ‰ç¼“å­˜):</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">æ ˆé¡¶ â†“</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ [<span class="number">4</span>] nil                â”‚  â† metatable[<span class="string">&quot;GetActorLocation&quot;</span>]</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ [<span class="number">3</span>] &lt;<span class="symbol">Metatable</span>: <span class="symbol">AActor</span>&gt;â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ [<span class="number">2</span>] <span class="string">&quot;GetActorLocation&quot;</span> â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ [<span class="number">1</span>] &lt;<span class="symbol">Userdata</span>: <span class="symbol">AActor</span>&gt; â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬å››æ­¥: è§¦å‘ GetFieldInternal</strong> (å› ä¸º Type &#x3D;&#x3D; LUA_TNIL)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (Type == LUA_TNIL)</span><br><span class="line">        <span class="built_in">GetFieldInternal</span>(L);</span><br><span class="line">    <span class="comment">// è¿›å…¥ GetFieldInternal</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">GetFieldInternal</span><span class="params">(lua_State* L)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">lua_pop</span>(L, <span class="number">1</span>);  <span class="comment">// å¼¹å‡º nil</span></span><br><span class="line">    <span class="comment">// æ ˆ: [userdata, key, metatable]</span></span><br></pre></td></tr></table></figure>

<p><strong>æ ˆå˜åŒ–</strong>:</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">æ ˆé¡¶ â†“</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ [<span class="number">3</span>] &lt;<span class="symbol">Metatable</span>: <span class="symbol">AActor</span>&gt;â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ [<span class="number">2</span>] <span class="string">&quot;GetActorLocation&quot;</span> â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ [<span class="number">1</span>] &lt;<span class="symbol">Userdata</span>: <span class="symbol">AActor</span>&gt; â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬äº”æ­¥: è·å–ç±»å</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">lua_pushstring</span>(L, <span class="string">&quot;__name&quot;</span>);  </span><br><span class="line"><span class="comment">// æ ˆ: [userdata, key, metatable, &quot;__name&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> Type = <span class="built_in">lua_rawget</span>(L, <span class="number">-2</span>);  </span><br><span class="line"><span class="comment">// ä» metatable è·å– &quot;__name&quot;</span></span><br><span class="line"><span class="comment">// æ ˆ: [userdata, key, metatable, &quot;AActor&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">check</span>(Type == LUA_TSTRING);</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* ClassName = <span class="built_in">lua_tostring</span>(L, <span class="number">-1</span>);  <span class="comment">// &quot;AActor&quot;</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* FieldName = <span class="built_in">lua_tostring</span>(L, <span class="number">2</span>);   <span class="comment">// &quot;GetActorLocation&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">lua_pop</span>(L, <span class="number">1</span>); <span class="comment">// å¼¹å‡ºç±»å</span></span><br><span class="line"><span class="comment">// æ ˆ: [userdata, key, metatable]</span></span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬å…­æ­¥: æ³¨å†Œå­—æ®µå¹¶ç”Ÿæˆ Closure</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="keyword">auto</span> Registry = UnLua::FLuaEnv::<span class="built_in">FindEnv</span>(L)-&gt;<span class="built_in">GetClassRegistry</span>();</span><br><span class="line">FClassDesc* ClassDesc = Registry-&gt;<span class="built_in">Register</span>(ClassName);</span><br><span class="line">TSharedPtr&lt;FFieldDesc&gt; Field = ClassDesc-&gt;<span class="built_in">RegisterField</span>(FieldName, ClassDesc);</span><br><span class="line"><span class="comment">// å‡è®¾æ‰¾åˆ°äº† UFunction: GetActorLocation</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Field &amp;&amp; Field-&gt;<span class="built_in">IsValid</span>()) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">PushField</span>(L, Field);  <span class="comment">// å‹å…¥ Closure</span></span><br><span class="line">    <span class="comment">// æ ˆ: [userdata, key, metatable, &lt;TSharedPtr userdata&gt;]</span></span><br></pre></td></tr></table></figure>

<p><strong>PushField å†…éƒ¨æ ˆå˜åŒ–</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FObjectRegistry::Push</span><span class="params">(lua_State* L, TSharedPtr&lt;T&gt; Ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> Userdata = <span class="built_in">lua_newuserdata</span>(L, <span class="built_in">sizeof</span>(TSharedPtr&lt;T&gt;));</span><br><span class="line">    <span class="comment">// æ ˆ: [userdata, key, metatable, &lt;TSharedPtr userdata&gt;]</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">luaL_getmetatable</span>(L, <span class="string">&quot;TSharedPtr&quot;</span>);</span><br><span class="line">    <span class="comment">// æ ˆ: [userdata, key, metatable, &lt;TSharedPtr userdata&gt;, &lt;TSharedPtr metatable&gt;]</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">lua_setmetatable</span>(L, <span class="number">-2</span>);</span><br><span class="line">    <span class="comment">// æ ˆ: [userdata, key, metatable, &lt;TSharedPtr userdata&gt;]</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">new</span>(Userdata) <span class="built_in">TSharedPtr</span>&lt;T&gt;(Ptr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å› PushField</span></span><br><span class="line"><span class="keyword">if</span> (Function-&gt;<span class="built_in">IsLatentFunction</span>())</span><br><span class="line">    <span class="built_in">lua_pushcclosure</span>(L, Class_CallLatentFunction, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">lua_pushcclosure</span>(L, Class_CallUFunction, <span class="number">1</span>);</span><br><span class="line"><span class="comment">// â˜… å…³é”®: lua_pushcclosure ä¼šå¼¹å‡º 1 ä¸ª upvalue</span></span><br><span class="line"><span class="comment">// æ ˆ: [userdata, key, metatable, &lt;Closure&gt;]</span></span><br></pre></td></tr></table></figure>

<p><strong>æ ˆå˜åŒ–</strong>:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">æ ˆé¡¶ â†“</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ <span class="selector-attr">[4]</span> &lt;Closure&gt;          â”‚  â† C å‡½æ•° + <span class="built_in">upvalue</span>(FFunctionDesc)</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ <span class="selector-attr">[3]</span> &lt;Metatable: AActor&gt;â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ <span class="selector-attr">[2]</span> <span class="string">&quot;GetActorLocation&quot;</span> â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ <span class="selector-attr">[1]</span> &lt;Userdata: AActor&gt; â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬ä¸ƒæ­¥: ç¼“å­˜ Closure åˆ° metatable</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">        <span class="built_in">lua_pushvalue</span>(L, <span class="number">2</span>);     <span class="comment">// å¤åˆ¶ key</span></span><br><span class="line">        <span class="comment">// æ ˆ: [userdata, key, metatable, Closure, key]</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">lua_pushvalue</span>(L, <span class="number">-2</span>);    <span class="comment">// å¤åˆ¶ Closure</span></span><br><span class="line">        <span class="comment">// æ ˆ: [userdata, key, metatable, Closure, key, Closure]</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">lua_rawset</span>(L, <span class="number">-4</span>);       <span class="comment">// metatable[key] = Closure</span></span><br><span class="line">        <span class="comment">// å¼¹å‡º key å’Œ Closure,è®¾ç½®åˆ° metatable</span></span><br><span class="line">        <span class="comment">// æ ˆ: [userdata, key, metatable, Closure]</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å›åˆ° GetField</span></span><br><span class="line"><span class="built_in">lua_remove</span>(L, <span class="number">-2</span>);  <span class="comment">// ç§»é™¤ metatable</span></span><br><span class="line"><span class="comment">// æ ˆ: [userdata, key, Closure]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æœ€ç»ˆæ ˆçŠ¶æ€</strong>:</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">æ ˆé¡¶ â†“</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ [<span class="number">3</span>] &lt;<span class="symbol">Closure</span>&gt;          â”‚  â† è¿”å›ç»™ <span class="symbol">Lua</span></span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ [<span class="number">2</span>] <span class="string">&quot;GetActorLocation&quot;</span> â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚ [<span class="number">1</span>] &lt;<span class="symbol">Userdata</span>: <span class="symbol">AActor</span>&gt; â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure>

<p><strong>Lua æ¥æ”¶åˆ° Closure åè°ƒç”¨</strong>:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Lua ä»£ç </span></span><br><span class="line"><span class="keyword">local</span> location = actor:GetActorLocation()</span><br><span class="line"><span class="comment">-- ç­‰ä»·äº: </span></span><br><span class="line"><span class="comment">--   local func = actor[&quot;GetActorLocation&quot;]  â† è§¦å‘ __index,è·å– Closure</span></span><br><span class="line"><span class="comment">--   local location = func(actor)            â† è°ƒç”¨ Closure</span></span><br></pre></td></tr></table></figure>

<p><strong>Closure è°ƒç”¨æµç¨‹</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">int32 <span class="title">Class_CallUFunction</span><span class="params">(lua_State *L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// â˜… æ ˆ: [self, arg1, arg2, ...]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… è·å– upvalue (FFunctionDesc)</span></span><br><span class="line">    <span class="keyword">auto</span>&amp; Env = UnLua::FLuaEnv::<span class="built_in">FindEnvChecked</span>(L);</span><br><span class="line">    <span class="keyword">auto</span> Function = Env.<span class="built_in">GetObjectRegistry</span>()-&gt;<span class="built_in">Get</span>&lt;FFunctionDesc&gt;(L, <span class="built_in">lua_upvalueindex</span>(<span class="number">1</span>));</span><br><span class="line">    <span class="comment">// lua_upvalueindex(1) æ˜¯ç‰¹æ®Šä¼ªç´¢å¼•,ä¸æ”¹å˜æ ˆ</span></span><br><span class="line">    </span><br><span class="line">    int32 NumParams = <span class="built_in">lua_gettop</span>(L);</span><br><span class="line">    int32 NumResults = Function-&gt;<span class="built_in">CallUE</span>(L, NumParams);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> NumResults;  <span class="comment">// è¿”å›å€¼å·²åœ¨æ ˆé¡¶</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å®Œæ•´æµç¨‹æ€»ç»“</strong>:</p>
<pre><code class="highlight mermaid">flowchart TD
    Start([Lua: actor:GetActorLocation]) --&gt; A[&quot;è§¦å‘ __index actor, GetActorLocation&quot;]
    A --&gt; B[Class_Index]
    B --&gt; C[GetField]
    C --&gt; D[GetFieldInternal]
    D --&gt; E[&quot;RegisterField GetActorLocation&quot;]
    E --&gt; F[PushField]
    F --&gt; G[&quot;lua_pushcclosure Class_CallUFunction, 1&quot;]
    G --&gt; H[ç¼“å­˜ Closure åˆ° metatable]
    H --&gt; I[è¿”å› Closure ç»™ Lua]
    I --&gt; J[Lua è°ƒç”¨ Closure]
    J --&gt; K[Class_CallUFunction]
    K --&gt; L[CallUE]
    L --&gt; M[UObject::ProcessEvent]
    M --&gt; N[æ‰§è¡Œ C++ å‡½æ•°]
    N --&gt; End([è¿”å›ç»“æœ])
    
    style Start fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style A fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style E fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    style M fill:#ffccbc,stroke:#bf360c,stroke-width:2px
    style End fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px</code></pre>

<h4 id="Class-NewIndex-å±æ€§å†™å…¥"><a href="#Class-NewIndex-å±æ€§å†™å…¥" class="headerlink" title="Class_NewIndex å±æ€§å†™å…¥"></a>Class_NewIndex å±æ€§å†™å…¥</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LuaCore.cpp:1226</span></span><br><span class="line"><span class="function">int32 <span class="title">Class_NewIndex</span><span class="params">(lua_State *L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// â˜… åˆå§‹æ ˆçŠ¶æ€</span></span><br><span class="line">    <span class="comment">// æ ˆ: [1]=userdata(self), [2]=string(key), [3]=new_value</span></span><br><span class="line">    <span class="comment">// Luaè°ƒç”¨: obj.Health = 100</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">GetField</span>(L);</span><br><span class="line">    <span class="comment">// æ ˆ: [userdata, key, value, field_descriptor]</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">auto</span> Ptr = <span class="built_in">lua_touserdata</span>(L, <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> (Ptr)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">auto</span> Property = <span class="keyword">static_cast</span>&lt;TSharedPtr&lt;UnLua::ITypeOps&gt;*&gt;(Ptr);</span><br><span class="line">        <span class="keyword">if</span> (Property-&gt;<span class="built_in">IsValid</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">void</span>* Self = <span class="built_in">GetCppInstance</span>(L, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (Self)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (UnLua::LowLevel::<span class="built_in">IsReleasedPtr</span>(Self))</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">luaL_error</span>(L, <span class="string">&quot;...&quot;</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// â˜… APIè®²è§£: WriteValue_InContainer</span></span><br><span class="line">                <span class="comment">// å‚æ•°: 3 è¡¨ç¤ºä»æ ˆç´¢å¼•3å–å€¼(new_value)</span></span><br><span class="line">                (*Property)-&gt;<span class="built_in">WriteValue_InContainer</span>(L, Self, <span class="number">3</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// éå±æ€§,å¯èƒ½æ˜¯ç›´æ¥ä¿®æ”¹è¡¨</span></span><br><span class="line">        int32 Type = <span class="built_in">lua_type</span>(L, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (Type == LUA_TTABLE)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// â˜… APIè®²è§£: lua_rawset</span></span><br><span class="line">            <span class="comment">// åŠŸèƒ½: ç»•è¿‡å…ƒæ–¹æ³•ç›´æ¥è®¾ç½®è¡¨</span></span><br><span class="line">            <span class="comment">// ç”¨äºåŠ¨æ€æ·»åŠ å­—æ®µåˆ°å®ä¾‹è¡¨</span></span><br><span class="line">            <span class="built_in">lua_pushvalue</span>(L, <span class="number">2</span>);  <span class="comment">// å¤åˆ¶ key</span></span><br><span class="line">            <span class="built_in">lua_pushvalue</span>(L, <span class="number">3</span>);  <span class="comment">// å¤åˆ¶ value</span></span><br><span class="line">            <span class="built_in">lua_rawset</span>(L, <span class="number">1</span>);     <span class="comment">// table[key] = value</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">lua_pop</span>(L, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å®é™…è°ƒç”¨ç¤ºä¾‹</strong>:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Lua ä»£ç </span></span><br><span class="line"><span class="keyword">local</span> actor = UE.UGameplayStatics.GetPlayerPawn(<span class="built_in">self</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- è¯»å–å±æ€§ (è§¦å‘ Class_Index)</span></span><br><span class="line"><span class="keyword">local</span> name = actor.Name  </span><br><span class="line"><span class="comment">-- C++: GetFieldæ‰¾åˆ° FNameProperty</span></span><br><span class="line"><span class="comment">--      ReadValue_InContainer å°† FName è½¬ä¸º lua string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å†™å…¥å±æ€§ (è§¦å‘ Class_NewIndex)  </span></span><br><span class="line">actor.bHidden = <span class="literal">true</span></span><br><span class="line"><span class="comment">-- C++: GetFieldæ‰¾åˆ° FBoolProperty</span></span><br><span class="line"><span class="comment">--      WriteValue_InContainer ä»æ ˆç´¢å¼•3å– lua boolean</span></span><br><span class="line"><span class="comment">--      è½¬æ¢å¹¶å†™å…¥ C++ bool</span></span><br></pre></td></tr></table></figure>

<h3 id="æ€§èƒ½ä¼˜åŒ–è¦ç‚¹"><a href="#æ€§èƒ½ä¼˜åŒ–è¦ç‚¹" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–è¦ç‚¹"></a>æ€§èƒ½ä¼˜åŒ–è¦ç‚¹</h3><table>
<thead>
<tr>
<th>ä¼˜åŒ–ç‚¹</th>
<th>è¯´æ˜</th>
<th>æ€§èƒ½æå‡</th>
</tr>
</thead>
<tbody><tr>
<td><strong>å‡½æ•°å¼•ç”¨ç¼“å­˜</strong></td>
<td><code>FunctionRef</code> å­˜å‚¨åœ¨ <code>ObjectRefs</code></td>
<td>~30%</td>
</tr>
<tr>
<td><strong>å‚æ•°ç¼“å†²åŒºå¤ç”¨</strong></td>
<td><code>FParamBufferAllocator</code> æ± åŒ–ç®¡ç†</td>
<td>~20%</td>
</tr>
<tr>
<td><strong>æ‡’åŠ è½½ FFunctionDesc</strong></td>
<td>é¦–æ¬¡è°ƒç”¨æ—¶æ‰åˆ›å»º</td>
<td>å‡å°‘å¯åŠ¨ 50%</td>
</tr>
<tr>
<td><strong>é¿å…ç±»å‹è½¬æ¢</strong></td>
<td>ç›´æ¥ä¼ é€’ Userdata</td>
<td>~15%</td>
</tr>
</tbody></table>
<hr>
<h2 id="å‚æ•°ä¼ é€’æœºåˆ¶"><a href="#å‚æ•°ä¼ é€’æœºåˆ¶" class="headerlink" title="å‚æ•°ä¼ é€’æœºåˆ¶"></a>å‚æ•°ä¼ é€’æœºåˆ¶</h2><h3 id="ç±»å‹æ˜ å°„è¡¨"><a href="#ç±»å‹æ˜ å°„è¡¨" class="headerlink" title="ç±»å‹æ˜ å°„è¡¨"></a>ç±»å‹æ˜ å°„è¡¨</h3><h4 id="åŸºç¡€ç±»å‹æ˜ å°„"><a href="#åŸºç¡€ç±»å‹æ˜ å°„" class="headerlink" title="åŸºç¡€ç±»å‹æ˜ å°„"></a>åŸºç¡€ç±»å‹æ˜ å°„</h4><table>
<thead>
<tr>
<th>UE ç±»å‹</th>
<th>Lua ç±»å‹</th>
<th>ä¼ é€’æ–¹å¼</th>
<th>æ€§èƒ½å¼€é”€</th>
</tr>
</thead>
<tbody><tr>
<td><code>bool</code></td>
<td><code>boolean</code></td>
<td>å€¼ä¼ é€’</td>
<td>æä½</td>
</tr>
<tr>
<td><code>int32/uint32</code></td>
<td><code>integer</code></td>
<td>å€¼ä¼ é€’</td>
<td>æä½</td>
</tr>
<tr>
<td><code>float/double</code></td>
<td><code>number</code></td>
<td>å€¼ä¼ é€’</td>
<td>æä½</td>
</tr>
<tr>
<td><code>FString</code></td>
<td><code>string</code></td>
<td>æ‹·è´ (UTF8 è½¬æ¢)</td>
<td>ä¸­ç­‰</td>
</tr>
<tr>
<td><code>FName</code></td>
<td><code>string</code></td>
<td>æ‹·è´</td>
<td>ä½</td>
</tr>
<tr>
<td><code>FText</code></td>
<td><code>string</code></td>
<td>æ‹·è´</td>
<td>é«˜ (æœ¬åœ°åŒ–)</td>
</tr>
</tbody></table>
<h4 id="å¤æ‚ç±»å‹æ˜ å°„"><a href="#å¤æ‚ç±»å‹æ˜ å°„" class="headerlink" title="å¤æ‚ç±»å‹æ˜ å°„"></a>å¤æ‚ç±»å‹æ˜ å°„</h4><table>
<thead>
<tr>
<th>UE ç±»å‹</th>
<th>Lua è¡¨ç¤º</th>
<th>ä¼ é€’ç­–ç•¥</th>
<th>å†…å­˜ç®¡ç†</th>
</tr>
</thead>
<tbody><tr>
<td><strong>UObject</strong>*</td>
<td><code>Userdata (äºŒçº§æŒ‡é’ˆ)</code></td>
<td>å¼•ç”¨ä¼ é€’</td>
<td>GC ç®¡ç†</td>
</tr>
<tr>
<td><strong>UStruct</strong></td>
<td><code>Userdata (å€¼ç±»å‹)</code></td>
<td>æ‹·è´&#x2F;å¼•ç”¨å¯é€‰</td>
<td>Lua GC</td>
</tr>
<tr>
<td><strong>TArray</strong></td>
<td><code>Userdata (å®¹å™¨)</code></td>
<td>å¼•ç”¨ä¼ é€’</td>
<td>ä¸ C++ å…±äº«</td>
</tr>
<tr>
<td><strong>TMap</strong></td>
<td><code>Userdata (å®¹å™¨)</code></td>
<td>å¼•ç”¨ä¼ é€’</td>
<td>ä¸ C++ å…±äº«</td>
</tr>
<tr>
<td><strong>TSubclassOf</strong></td>
<td><code>UClass Userdata</code></td>
<td>å¼•ç”¨ä¼ é€’</td>
<td>GC ç®¡ç†</td>
</tr>
<tr>
<td><strong>FDelegate</strong></td>
<td><code>Userdata (å§”æ‰˜)</code></td>
<td>å¼•ç”¨ä¼ é€’</td>
<td>åŒå‘ç»‘å®š</td>
</tr>
</tbody></table>
<h3 id="å‚æ•°ä¼ é€’æµç¨‹è¯¦è§£"><a href="#å‚æ•°ä¼ é€’æµç¨‹è¯¦è§£" class="headerlink" title="å‚æ•°ä¼ é€’æµç¨‹è¯¦è§£"></a>å‚æ•°ä¼ é€’æµç¨‹è¯¦è§£</h3><h4 id="Lua-â†’-C-å‚æ•°ä¼ é€’"><a href="#Lua-â†’-C-å‚æ•°ä¼ é€’" class="headerlink" title="Lua â†’ C++ å‚æ•°ä¼ é€’"></a>Lua â†’ C++ å‚æ•°ä¼ é€’</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FunctionDesc.cpp:171</span></span><br><span class="line"><span class="function">int32 <span class="title">FFunctionDesc::CallUE</span><span class="params">(lua_State *L, int32 NumParams, <span class="type">void</span> *Userdata)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">void</span>* Params = Buffer-&gt;<span class="built_in">GetBuffer</span>();  <span class="comment">// åˆ†é…å‚æ•°ç¼“å†²åŒº</span></span><br><span class="line">    FFlagArray CleanupFlags;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// PreCall: å‚æ•°è½¬æ¢</span></span><br><span class="line">    <span class="keyword">for</span> (int32 i = <span class="number">0</span>; i &lt; Properties.<span class="built_in">Num</span>(); ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        FPropertyDesc* Property = Properties[i].<span class="built_in">Get</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (Property-&gt;<span class="built_in">IsOutParameter</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Out å‚æ•°: åˆ†é…ä¸´æ—¶å†…å­˜</span></span><br><span class="line">            Property-&gt;<span class="built_in">Initialize</span>(Property-&gt;<span class="built_in">GetValuePtr</span>(Params));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// In å‚æ•°: ä» Lua è¯»å–å€¼</span></span><br><span class="line">            Property-&gt;<span class="built_in">WriteValue_InContainer</span>(L, Params, FirstParamIndex + i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰§è¡Œ UE å‡½æ•°</span></span><br><span class="line">    Object-&gt;UObject::<span class="built_in">ProcessEvent</span>(FinalFunction, Params);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// PostCall: è¿”å›å€¼å¤„ç†</span></span><br><span class="line">    int32 NumReturnValues = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">HasReturnProperty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        FPropertyDesc* RetProp = Properties[ReturnPropertyIndex].<span class="built_in">Get</span>();</span><br><span class="line">        RetProp-&gt;<span class="built_in">ReadValue_InContainer</span>(L, Params, <span class="literal">false</span>);</span><br><span class="line">        NumReturnValues++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Out å‚æ•°å†™å› Lua</span></span><br><span class="line">    <span class="keyword">for</span> (int32 OutIndex : OutPropertyIndices)</span><br><span class="line">    &#123;</span><br><span class="line">        Properties[OutIndex]-&gt;<span class="built_in">ReadValue_InContainer</span>(L, Params, <span class="literal">false</span>);</span><br><span class="line">        NumReturnValues++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> NumReturnValues;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="C-â†’-Lua-å‚æ•°ä¼ é€’"><a href="#C-â†’-Lua-å‚æ•°ä¼ é€’" class="headerlink" title="C++ â†’ Lua å‚æ•°ä¼ é€’"></a>C++ â†’ Lua å‚æ•°ä¼ é€’</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FunctionDesc.cpp:300</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FFunctionDesc::CallLua</span><span class="params">(lua_State* L, lua_Integer FunctionRef, </span></span></span><br><span class="line"><span class="params"><span class="function">                           lua_Integer SelfRef, FFrame&amp; Stack, RESULT_DECL)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 1. æ¨é€å‡½æ•°å’Œ self</span></span><br><span class="line">    <span class="built_in">lua_rawgeti</span>(L, LUA_REGISTRYINDEX, FunctionRef);  <span class="comment">// function</span></span><br><span class="line">    <span class="built_in">lua_rawgeti</span>(L, LUA_REGISTRYINDEX, SelfRef);      <span class="comment">// self</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. å‚æ•°è½¬æ¢: C++ â†’ Lua</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; Properties.<span class="built_in">Num</span>(); ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!Properties[i]-&gt;<span class="built_in">IsReturnParameter</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// å°† C++ å‚æ•°å€¼è½¬æ¢ä¸º Lua å€¼</span></span><br><span class="line">            Properties[i]-&gt;<span class="built_in">ReadValue_InContainer</span>(L, Params, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. æ‰§è¡Œ Lua è°ƒç”¨</span></span><br><span class="line">    <span class="built_in">lua_pcall</span>(L, NumParams, NumResults, ErrorHandler);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. è¿”å›å€¼å’Œ Out å‚æ•°å†™å› C++</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">HasReturnProperty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        RetProp-&gt;<span class="built_in">WriteValue</span>(L, RetValueAddress, -NumResults);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å®¹å™¨ç±»å‹æ·±åº¦è§£æ"><a href="#å®¹å™¨ç±»å‹æ·±åº¦è§£æ" class="headerlink" title="å®¹å™¨ç±»å‹æ·±åº¦è§£æ"></a>å®¹å™¨ç±»å‹æ·±åº¦è§£æ</h3><h4 id="TArray-å†…å­˜å…±äº«æœºåˆ¶"><a href="#TArray-å†…å­˜å…±äº«æœºåˆ¶" class="headerlink" title="TArray å†…å­˜å…±äº«æœºåˆ¶"></a>TArray å†…å­˜å…±äº«æœºåˆ¶</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PropertyDesc.cpp:550</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FArrayPropertyDesc::ReadValue_InContainer</span><span class="params">(lua_State* L, </span></span></span><br><span class="line"><span class="params"><span class="function">                                               <span class="type">const</span> <span class="type">void</span>* ContainerPtr, </span></span></span><br><span class="line"><span class="params"><span class="function">                                               <span class="type">bool</span> bCreateCopy)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FScriptArray* Array = Property-&gt;<span class="built_in">GetPropertyValuePtr</span>(ContainerPtr);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (bCreateCopy)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// æ·±æ‹·è´: Lua å®Œå…¨æ‹¥æœ‰</span></span><br><span class="line">        UnLua::<span class="built_in">PushArray</span>(L, Array, InnerProperty, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// å¼•ç”¨ä¼ é€’: ä¸ C++ å…±äº«å†…å­˜ (é›¶æ‹·è´)</span></span><br><span class="line">        <span class="type">const</span> <span class="keyword">auto</span> Registry = FLuaEnv::<span class="built_in">FindEnvChecked</span>(L).<span class="built_in">GetContainerRegistry</span>();</span><br><span class="line">        Registry-&gt;<span class="built_in">FindOrAdd</span>(L, Array, InnerProperty);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å†…å­˜å¸ƒå±€</strong>:</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">C++ TArray:</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ FScriptArray &#123;                   â”‚</span><br><span class="line">â”‚   void* Data<span class="comment">;     â† å…ƒç´ æ•°æ®æŒ‡é’ˆâ”‚</span></span><br><span class="line">â”‚   int32 ArrayNum<span class="comment">;                â”‚</span></span><br><span class="line">â”‚   int32 ArrayMax<span class="comment">;                â”‚</span></span><br><span class="line">â”‚ &#125;                                â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">         â”‚</span><br><span class="line">         â–¼ ç›´æ¥è®¿é—® (é›¶æ‹·è´)</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ Lua Userdata (FLuaArray)         â”‚</span><br><span class="line">â”‚  â””â”€â–º <span class="keyword">ScriptArray* </span> â† æŒ‡å‘åŒä¸€å†…å­˜â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure>

<h4 id="TArray-æ“ä½œ-API-å®Œæ•´å®ç°"><a href="#TArray-æ“ä½œ-API-å®Œæ•´å®ç°" class="headerlink" title="TArray æ“ä½œ API å®Œæ•´å®ç°"></a>TArray æ“ä½œ API å®Œæ•´å®ç°</h4><p><strong>Lua ç«¯ä½¿ç”¨ç¤ºä¾‹</strong>:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- â˜… åˆ›å»º TArray</span></span><br><span class="line"><span class="keyword">local</span> actors = UE.TArray(UE.AActor)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- â˜… æ·»åŠ å…ƒç´ </span></span><br><span class="line">actors:Add(actor1)</span><br><span class="line">actors:Add(actor2)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- â˜… è®¿é—®å…ƒç´  (1-based ç´¢å¼•)</span></span><br><span class="line"><span class="keyword">local</span> first = actors:Get(<span class="number">1</span>)  <span class="comment">-- Lua ä¹ æƒ¯</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- â˜… è®¾ç½®å…ƒç´ </span></span><br><span class="line">actors:Set(<span class="number">2</span>, newActor)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- â˜… éå†æ–¹å¼1: ipairs</span></span><br><span class="line"><span class="keyword">for</span> i, actor <span class="keyword">in</span> <span class="built_in">ipairs</span>(actors) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(i, actor:GetName())</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- â˜… éå†æ–¹å¼2: æ‰‹åŠ¨å¾ªç¯</span></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, actors:Length() <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> actor = actors:Get(i)</span><br><span class="line">    <span class="built_in">print</span>(actor:GetName())</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- â˜… å…¶ä»–æ“ä½œ</span></span><br><span class="line"><span class="keyword">local</span> count = actors:Length()</span><br><span class="line">actors:Remove(<span class="number">2</span>)        <span class="comment">-- ç§»é™¤ç´¢å¼•2</span></span><br><span class="line">actors:Insert(<span class="number">1</span>, actor) <span class="comment">-- åœ¨ç´¢å¼•1æ’å…¥</span></span><br><span class="line">actors:Clear()          <span class="comment">-- æ¸…ç©º</span></span><br></pre></td></tr></table></figure>

<p><strong>åº•å±‚ C++ å®ç°æºç </strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Containers/LuaArray.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// â˜… APIè®²è§£: GetCppInstanceFast</span></span><br><span class="line"><span class="comment">// åŠŸèƒ½: å¿«é€Ÿè·å– userdata çš„ C++ æŒ‡é’ˆ (è·³è¿‡æ£€æŸ¥)</span></span><br><span class="line"><span class="comment">// ç”¨é€”: é«˜é¢‘è°ƒç”¨ä¼˜åŒ–,å‰ææ˜¯å·²çŸ¥ç±»å‹æ­£ç¡®</span></span><br><span class="line"><span class="function"><span class="type">static</span> int32 <span class="title">LuaArray_Add</span><span class="params">(lua_State* L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤1: è·å– FLuaArray æŒ‡é’ˆ</span></span><br><span class="line">    <span class="comment">// å‚æ•°1: æ ˆç´¢å¼•1 (self,å³ array)</span></span><br><span class="line">    FLuaArray* Array = (FLuaArray*)<span class="built_in">GetCppInstanceFast</span>(L, <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤2: åœ¨ C++ TArray æœ«å°¾æ·»åŠ å…ƒç´ </span></span><br><span class="line">    <span class="type">void</span>* ElementPtr = Array-&gt;<span class="built_in">AddElement</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤3: ä» Lua è¯»å–å€¼å¹¶å†™å…¥ C++ å†…å­˜</span></span><br><span class="line">    <span class="comment">// å‚æ•°2: æ ˆç´¢å¼•2 (è¦æ·»åŠ çš„å…ƒç´ )</span></span><br><span class="line">    Array-&gt;Inner-&gt;<span class="built_in">WriteValue</span>(L, ElementPtr, <span class="number">2</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  <span class="comment">// æ— è¿”å›å€¼</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> int32 <span class="title">LuaArray_Get</span><span class="params">(lua_State* L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FLuaArray* Array = (FLuaArray*)<span class="built_in">GetCppInstanceFast</span>(L, <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… APIè®²è§£: lua_tointeger</span></span><br><span class="line">    <span class="comment">// åŠŸèƒ½: å°†æ ˆä¸ŠæŒ‡å®šç´¢å¼•çš„å€¼è½¬ä¸ºæ•´æ•°</span></span><br><span class="line">    <span class="comment">// è¿”å›: lua_Integer (é€šå¸¸æ˜¯ int64)</span></span><br><span class="line">    int32 Index = (int32)<span class="built_in">lua_tointeger</span>(L, <span class="number">2</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… Lua â†’ C++ ç´¢å¼•è½¬æ¢ (1-based â†’ 0-based)</span></span><br><span class="line">    <span class="keyword">if</span> (Index &lt; <span class="number">1</span> || Index &gt; Array-&gt;<span class="built_in">Num</span>())</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">luaL_error</span>(L, <span class="string">&quot;index out of range&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="type">void</span>* ElementPtr = Array-&gt;<span class="built_in">GetData</span>(Index - <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… è¯»å–å…ƒç´ å¹¶å‹æ ˆ</span></span><br><span class="line">    Array-&gt;Inner-&gt;<span class="built_in">ReadValue</span>(L, ElementPtr, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;  <span class="comment">// è¿”å›1ä¸ªå€¼</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> int32 <span class="title">LuaArray_Set</span><span class="params">(lua_State* L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FLuaArray* Array = (FLuaArray*)<span class="built_in">GetCppInstanceFast</span>(L, <span class="number">1</span>);</span><br><span class="line">    int32 Index = (int32)<span class="built_in">lua_tointeger</span>(L, <span class="number">2</span>) - <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (Index &lt; <span class="number">0</span> || Index &gt;= Array-&gt;<span class="built_in">Num</span>())</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">luaL_error</span>(L, <span class="string">&quot;index out of range&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="type">void</span>* ElementPtr = Array-&gt;<span class="built_in">GetData</span>(Index);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… ä»æ ˆç´¢å¼•3è¯»å–æ–°å€¼</span></span><br><span class="line">    Array-&gt;Inner-&gt;<span class="built_in">WriteValue</span>(L, ElementPtr, <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> int32 <span class="title">LuaArray_Length</span><span class="params">(lua_State* L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FLuaArray* Array = (FLuaArray*)<span class="built_in">GetCppInstanceFast</span>(L, <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… APIè®²è§£: lua_pushinteger</span></span><br><span class="line">    <span class="comment">// åŠŸèƒ½: å‹å…¥æ•´æ•°åˆ°æ ˆé¡¶</span></span><br><span class="line">    <span class="comment">// æ ˆå˜åŒ–: [+1]</span></span><br><span class="line">    <span class="built_in">lua_pushinteger</span>(L, Array-&gt;<span class="built_in">Num</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> int32 <span class="title">LuaArray_Remove</span><span class="params">(lua_State* L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FLuaArray* Array = (FLuaArray*)<span class="built_in">GetCppInstanceFast</span>(L, <span class="number">1</span>);</span><br><span class="line">    int32 Index = (int32)<span class="built_in">lua_tointeger</span>(L, <span class="number">2</span>) - <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (Index &lt; <span class="number">0</span> || Index &gt;= Array-&gt;<span class="built_in">Num</span>())</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… ç›´æ¥ä¿®æ”¹ C++ TArray</span></span><br><span class="line">    Array-&gt;<span class="built_in">Remove</span>(Index);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// â˜… æ”¯æŒ ipairs éå†</span></span><br><span class="line"><span class="function"><span class="type">static</span> int32 <span class="title">TArray_Enumerable</span><span class="params">(lua_State* L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// â˜… è¿”å›è¿­ä»£å™¨ä¸‰å…ƒç»„: (è¿­ä»£å‡½æ•°, çŠ¶æ€, åˆå§‹å€¼)</span></span><br><span class="line">    <span class="built_in">lua_pushcfunction</span>(L, TArray_Enumerable_Next);  <span class="comment">// è¿­ä»£å‡½æ•°</span></span><br><span class="line">    <span class="built_in">lua_pushvalue</span>(L, <span class="number">1</span>);   <span class="comment">// çŠ¶æ€ = array è‡ªèº«</span></span><br><span class="line">    <span class="built_in">lua_pushinteger</span>(L, <span class="number">0</span>); <span class="comment">// åˆå§‹å€¼ = 0</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">TArray_Enumerable_Next</span><span class="params">(lua_State* L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// â˜… è¿­ä»£å™¨å‡½æ•°ç­¾å: (state, index) -&gt; (next_index, value)</span></span><br><span class="line">    FLuaArray* Array = (FLuaArray*)<span class="built_in">GetCppInstanceFast</span>(L, <span class="number">1</span>);</span><br><span class="line">    int32 Index = (int32)<span class="built_in">lua_tointeger</span>(L, <span class="number">2</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (Index &gt;= Array-&gt;<span class="built_in">Num</span>())</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;  <span class="comment">// è¿­ä»£ç»“æŸ</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… è¿”å›ä¸‹ä¸€ä¸ªç´¢å¼•å’Œå€¼</span></span><br><span class="line">    <span class="built_in">lua_pushinteger</span>(L, Index + <span class="number">1</span>);</span><br><span class="line">    <span class="type">void</span>* ElementPtr = Array-&gt;<span class="built_in">GetData</span>(Index);</span><br><span class="line">    Array-&gt;Inner-&gt;<span class="built_in">ReadValue</span>(L, ElementPtr, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// â˜… æ³¨å†Œå…ƒè¡¨</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> luaL_Reg TArrayLib[] = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;Add&quot;</span>, LuaArray_Add&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;Get&quot;</span>, LuaArray_Get&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;Set&quot;</span>, LuaArray_Set&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;Length&quot;</span>, LuaArray_Length&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;Remove&quot;</span>, LuaArray_Remove&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;Insert&quot;</span>, LuaArray_Insert&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;Clear&quot;</span>, LuaArray_Clear&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;__len&quot;</span>, LuaArray_Length&#125;,      <span class="comment">// æ”¯æŒ #array</span></span><br><span class="line">    &#123;<span class="string">&quot;__pairs&quot;</span>, TArray_Enumerable&#125;,  <span class="comment">// æ”¯æŒ ipairs(array)</span></span><br><span class="line">    &#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>é›¶æ‹·è´åŸç†</strong>:</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">C++ TArray&lt;AActor*&gt;:</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ FScriptArray &#123;          â”‚</span><br><span class="line">â”‚   AActor** <span class="built_in">Data</span>;  â”€â”€â”€â”  â”‚</span><br><span class="line">â”‚   int32 ArrayNum;    â”‚  â”‚</span><br><span class="line">â”‚   int32 ArrayMax;    â”‚  â”‚</span><br><span class="line">â”‚ &#125;                    â”‚  â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”˜</span><br><span class="line">                       â”‚</span><br><span class="line">        ç›´æ¥è®¿é—® (æ— æ‹·è´) â”‚</span><br><span class="line">                       â”‚</span><br><span class="line">Lua Userdata:          â”‚</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”</span><br><span class="line">â”‚ FLuaArray &#123;             â”‚</span><br><span class="line">â”‚   FScriptArray* <span class="built_in">Array</span>; â—„â”¼â”€â”€ æŒ‡å‘åŒä¸€å†…å­˜</span><br><span class="line">â”‚   Inner: FPropertyDesc  â”‚</span><br><span class="line">â”‚ &#125;                       â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿®æ”¹ç«‹å³ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="built_in">array</span>:Add(actor)  </span><br><span class="line">â†’ ç›´æ¥ä¿®æ”¹ C++ TArray<span class="type">::Data</span></span><br><span class="line">â†’ UE ç«¯ç«‹å³å¯è§,æ— åŒæ­¥å¼€é”€</span><br></pre></td></tr></table></figure>

<p><strong>æ€§èƒ½å¯¹æ¯”</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ æ‹·è´æ–¹å¼ (å‡è®¾)</span></span><br><span class="line">TArray&lt;int32&gt; data = <span class="built_in">GetData</span>();  <span class="comment">// 1000ä¸ªå…ƒç´ </span></span><br><span class="line"><span class="built_in">lua_newtable</span>(L);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; data.<span class="built_in">Num</span>(); i++) &#123;</span><br><span class="line">    <span class="built_in">lua_pushinteger</span>(L, i + <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">lua_pushinteger</span>(L, data[i]);</span><br><span class="line">    <span class="built_in">lua_settable</span>(L, <span class="number">-3</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è€—æ—¶: ~450Î¼s (éœ€è¦1000æ¬¡Lua tableæ“ä½œ)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… é›¶æ‹·è´æ–¹å¼ (UnLua)</span></span><br><span class="line">UnLua::<span class="built_in">PushArray</span>(L, &amp;data, Inner, <span class="literal">false</span>);</span><br><span class="line"><span class="comment">// è€—æ—¶: ~1.2Î¼s (ä»…åˆ›å»ºuserdata)</span></span><br><span class="line"><span class="comment">// è®¿é—®: array:Get(i) ç›´æ¥è¯»å†…å­˜,~0.3Î¼s</span></span><br></pre></td></tr></table></figure>

<h3 id="Struct-æ‹·è´-vs-å¼•ç”¨"><a href="#Struct-æ‹·è´-vs-å¼•ç”¨" class="headerlink" title="Struct æ‹·è´ vs å¼•ç”¨"></a>Struct æ‹·è´ vs å¼•ç”¨</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ç¤ºä¾‹: FVector ä¼ é€’</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- âœ… æ‹·è´ä¼ é€’ (å®‰å…¨ä½†æ…¢)</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">SetLocation</span><span class="params">(actor, location)</span></span></span><br><span class="line">    actor:SetActorLocation(location)  <span class="comment">-- FVector è¢«æ‹·è´</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- âœ… å¼•ç”¨ä¼ é€’ (å¿«ä½†éœ€æ³¨æ„ç”Ÿå‘½å‘¨æœŸ)</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">GetLocation</span><span class="params">(actor)</span></span></span><br><span class="line">    <span class="keyword">return</span> actor:K2_GetActorLocation()  <span class="comment">-- è¿”å›ä¸´æ—¶å¼•ç”¨</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- âŒ å±é™©: å¼•ç”¨å¤±æ•ˆ</span></span><br><span class="line"><span class="keyword">local</span> loc = actor:K2_GetActorLocation()</span><br><span class="line">actor:Destroy()</span><br><span class="line"><span class="built_in">print</span>(loc.X)  <span class="comment">-- â† æ‚¬ç©ºå¼•ç”¨ï¼Œæœªå®šä¹‰è¡Œä¸º!</span></span><br></pre></td></tr></table></figure>

<h3 id="å‚æ•°ä¼ é€’æ€§èƒ½å¯¹æ¯”"><a href="#å‚æ•°ä¼ é€’æ€§èƒ½å¯¹æ¯”" class="headerlink" title="å‚æ•°ä¼ é€’æ€§èƒ½å¯¹æ¯”"></a>å‚æ•°ä¼ é€’æ€§èƒ½å¯¹æ¯”</h3><table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>æ‹·è´ä¼ é€’ (Î¼s)</th>
<th>å¼•ç”¨ä¼ é€’ (Î¼s)</th>
<th>å€æ•°</th>
</tr>
</thead>
<tbody><tr>
<td><strong>FVector</strong></td>
<td>0.8</td>
<td>0.3</td>
<td>2.7x</td>
</tr>
<tr>
<td><strong>FString</strong></td>
<td>2.5</td>
<td>0.5</td>
<td>5x</td>
</tr>
<tr>
<td><strong>TArray<int32> (1000)</strong></td>
<td>450</td>
<td>1.2</td>
<td>375x</td>
</tr>
<tr>
<td><strong>TMap&lt;int32,FString&gt; (100)</strong></td>
<td>850</td>
<td>1.5</td>
<td>567x</td>
</tr>
</tbody></table>
<p><strong>ç»“è®º</strong>: å®¹å™¨ç±»å‹åŠ¡å¿…ä½¿ç”¨å¼•ç”¨ä¼ é€’ï¼ˆé»˜è®¤è¡Œä¸ºï¼‰ã€‚</p>
<hr>
<h2 id="åƒåœ¾å›æ”¶ä¸å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ"><a href="#åƒåœ¾å›æ”¶ä¸å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="åƒåœ¾å›æ”¶ä¸å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ"></a>åƒåœ¾å›æ”¶ä¸å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ</h2><h3 id="åŒé‡-GC-ç³»ç»Ÿ"><a href="#åŒé‡-GC-ç³»ç»Ÿ" class="headerlink" title="åŒé‡ GC ç³»ç»Ÿ"></a>åŒé‡ GC ç³»ç»Ÿ</h3><p>UnLua éœ€è¦åŒæ—¶ç®¡ç† <strong>UE GC</strong> å’Œ <strong>Lua GC</strong>ï¼Œç¡®ä¿å¯¹è±¡ç”Ÿå‘½å‘¨æœŸåŒæ­¥ã€‚</p>
<h4 id="æ¶æ„å›¾"><a href="#æ¶æ„å›¾" class="headerlink" title="æ¶æ„å›¾"></a>æ¶æ„å›¾</h4><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                    åŒé‡ GC ååŒæœºåˆ¶                            â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line">UE ç«¯ â†â†’ Lua ç«¯:</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚  UObject         â”‚                  â”‚  Userdata        â”‚</span><br><span class="line">â”‚  â”œâ”€ RefCount     â”‚                  â”‚  â”œâ”€ <span class="literal">void</span>** Ptr   â”‚ â”€â”€â”€â”</span><br><span class="line">â”‚  â””â”€ RF_Flags     â”‚                  â”‚  â””â”€ BIT_FLAGS    â”‚    â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚</span><br><span class="line">         â”‚                                     â”‚               â”‚</span><br><span class="line">         â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚</span><br><span class="line">         â”‚           (åŒå‘å¼•ç”¨)                                â”‚</span><br><span class="line">         â–¼                                                     â”‚</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚</span><br><span class="line">â”‚     FObjectReferencer                â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”‚  (é˜²æ­¢ UE GC è¯¯å›æ”¶è¢« Lua å¼•ç”¨çš„å¯¹è±¡) â”‚</span><br><span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚</span><br><span class="line">â”‚  â”‚ TSet&lt;UObject*&gt;              â”‚    â”‚</span><br><span class="line">â”‚  â”‚  AutoObjectReference        â”‚    â”‚</span><br><span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">         â”‚</span><br><span class="line">         â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚  UE GC System                        â”‚</span><br><span class="line">â”‚  â”œâ”€ MarkAsGarbage                   â”‚</span><br><span class="line">â”‚  â”œâ”€ NotifyObjectDestroyed  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â–º FObjectRegistry<span class="type">::Unbind</span>()</span><br><span class="line">â”‚  â””â”€ <span class="params">...</span>                             â”‚     â””â”€â–º æ ‡è®° Userdata ä¸º <span class="number">0xDEAD</span></span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure>

<h3 id="å¯¹è±¡å¼•ç”¨ç®¡ç†ç­–ç•¥"><a href="#å¯¹è±¡å¼•ç”¨ç®¡ç†ç­–ç•¥" class="headerlink" title="å¯¹è±¡å¼•ç”¨ç®¡ç†ç­–ç•¥"></a>å¯¹è±¡å¼•ç”¨ç®¡ç†ç­–ç•¥</h3><h4 id="Lua-C-API-Userdata-æ·±åº¦å‰–æ"><a href="#Lua-C-API-Userdata-æ·±åº¦å‰–æ" class="headerlink" title="Lua C API: Userdata æ·±åº¦å‰–æ"></a>Lua C API: Userdata æ·±åº¦å‰–æ</h4><p><strong>Userdata æ˜¯ä»€ä¹ˆ?</strong></p>
<ul>
<li>Lua ä¸­å”¯ä¸€èƒ½å­˜å‚¨ä»»æ„ C æ•°æ®çš„ç±»å‹</li>
<li>ç”± Lua GC ç®¡ç†ç”Ÿå‘½å‘¨æœŸ</li>
<li>å¯ä»¥è®¾ç½®å…ƒè¡¨å®ç°é¢å‘å¯¹è±¡</li>
</ul>
<p><strong>æ ¸å¿ƒ API</strong>:</p>
<table>
<thead>
<tr>
<th>API</th>
<th>åŠŸèƒ½</th>
<th>è¿”å›å€¼</th>
<th>ç”¨é€”</th>
</tr>
</thead>
<tbody><tr>
<td><code>lua_newuserdata(L, size)</code></td>
<td>åˆ†é…userdata</td>
<td>void*æŒ‡é’ˆ</td>
<td>åˆ›å»ºsizeå­—èŠ‚çš„å†…å­˜å—</td>
</tr>
<tr>
<td><code>lua_touserdata(L, idx)</code></td>
<td>è·å–æŒ‡é’ˆ</td>
<td>void*</td>
<td>è¯»å–userdataçš„æ•°æ®</td>
</tr>
<tr>
<td><code>luaL_setmetatable(L, name)</code></td>
<td>è®¾ç½®å…ƒè¡¨</td>
<td>æ— </td>
<td>å…³è”ç±»å‹å…ƒè¡¨</td>
</tr>
</tbody></table>
<h4 id="UnLua-çš„äºŒçº§æŒ‡é’ˆæœºåˆ¶"><a href="#UnLua-çš„äºŒçº§æŒ‡é’ˆæœºåˆ¶" class="headerlink" title="UnLua çš„äºŒçº§æŒ‡é’ˆæœºåˆ¶"></a>UnLua çš„äºŒçº§æŒ‡é’ˆæœºåˆ¶</h4><p><strong>ä¸ºä»€ä¹ˆä½¿ç”¨äºŒçº§æŒ‡é’ˆ?</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é—®é¢˜: UObject ç”± UE GC ç®¡ç†,å¯èƒ½éšæ—¶é”€æ¯</span></span><br><span class="line"><span class="comment">// è§£å†³: Userdata å­˜å‚¨æŒ‡é’ˆçš„æŒ‡é’ˆ,é”€æ¯æ—¶æ”¹å†™ä¸º 0xDEAD</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Userdata å†…å­˜å¸ƒå±€</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UserdataLayout</span> &#123;</span><br><span class="line">    FUserdataDesc desc;  <span class="comment">// 4 bytes (é­”æ•° + æ ‡å¿—)</span></span><br><span class="line">    <span class="type">void</span>** ptr;          <span class="comment">// 8 bytes (äºŒçº§æŒ‡é’ˆ)</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>åˆ›å»º Userdata æºç </strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LuaCore.cpp:345</span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">NewUserdataWithPadding</span><span class="params">(lua_State* L, int32 Size, int32 Alignment)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// â˜… è®¡ç®—éœ€è¦çš„å†…å­˜å¤§å°</span></span><br><span class="line">    <span class="type">const</span> int32 PaddingSize = (Alignment - <span class="built_in">sizeof</span>(FUserdataDesc) % Alignment) % Alignment;</span><br><span class="line">    <span class="type">const</span> int32 TotalSize = <span class="built_in">sizeof</span>(FUserdataDesc) + PaddingSize + Size;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… APIè®²è§£: lua_newuserdata</span></span><br><span class="line">    <span class="comment">// åŠŸèƒ½: åˆ†é…æŒ‡å®šå¤§å°çš„å†…å­˜å¹¶å‹æ ˆ</span></span><br><span class="line">    <span class="comment">// æ ˆå˜åŒ–: [+1, å‹å…¥userdata]</span></span><br><span class="line">    <span class="comment">// è¿”å›å€¼: æŒ‡å‘åˆ†é…å†…å­˜çš„æŒ‡é’ˆ</span></span><br><span class="line">    <span class="type">void</span>* Userdata = <span class="built_in">lua_newuserdata</span>(L, TotalSize);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… åˆå§‹åŒ–æè¿°ç¬¦</span></span><br><span class="line">    FUserdataDesc* Desc = (FUserdataDesc*)Userdata;</span><br><span class="line">    Desc-&gt;magic = <span class="number">0x1688</span>;  <span class="comment">// é­”æ•°éªŒè¯</span></span><br><span class="line">    Desc-&gt;tag = <span class="number">0</span>;</span><br><span class="line">    Desc-&gt;padding = PaddingSize;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… è¿”å›æ•°æ®åŒºæŒ‡é’ˆ (è·³è¿‡æè¿°ç¬¦å’Œå¡«å……)</span></span><br><span class="line">    <span class="keyword">return</span> (uint8*)Userdata + <span class="built_in">sizeof</span>(FUserdataDesc) + PaddingSize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ObjectRegistry.cpp:87</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FObjectRegistry::PushObjectCore</span><span class="params">(lua_State* L, UObject* Object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤1: åˆ†é… Userdata (å­˜å‚¨äºŒçº§æŒ‡é’ˆ)</span></span><br><span class="line">    <span class="type">void</span>** Userdata = (<span class="type">void</span>**)<span class="built_in">NewUserdataWithPadding</span>(L, <span class="built_in">sizeof</span>(<span class="type">void</span>*), <span class="number">8</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤2: å­˜å‚¨ UObject æŒ‡é’ˆ</span></span><br><span class="line">    *Userdata = Object;  <span class="comment">// userdata å†…å®¹ = Objectçš„åœ°å€</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤3: è®¾ç½®å…ƒè¡¨</span></span><br><span class="line">    <span class="comment">// API: luaL_setmetatable(L, name)</span></span><br><span class="line">    <span class="comment">// åŠŸèƒ½: ä»registryè·å–å…ƒè¡¨å¹¶è®¾ç½®ç»™æ ˆé¡¶userdata</span></span><br><span class="line">    <span class="comment">// ç­‰ä»·äº: luaL_getmetatable(L, name); lua_setmetatable(L, -2);</span></span><br><span class="line">    <span class="built_in">luaL_setmetatable</span>(L, <span class="string">&quot;UObject&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ˆ: [userdata] (å·²å…³è”UObjectå…ƒè¡¨)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="è‡ªåŠ¨å¼•ç”¨æœºåˆ¶æºç "><a href="#è‡ªåŠ¨å¼•ç”¨æœºåˆ¶æºç " class="headerlink" title="è‡ªåŠ¨å¼•ç”¨æœºåˆ¶æºç "></a>è‡ªåŠ¨å¼•ç”¨æœºåˆ¶æºç </h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ObjectRegistry.cpp:87</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FObjectRegistry::Push</span><span class="params">(lua_State* L, UObject* Object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!Object)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">lua_pushnil</span>(L);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æœ‰æ•ˆæ€§æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">if</span> (!UnLua::<span class="built_in">IsUObjectValid</span>(Object))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// â˜… APIè®²è§£: luaL_error</span></span><br><span class="line">        <span class="comment">// åŠŸèƒ½: æŠ›å‡ºLuaé”™è¯¯,æ°¸ä¸è¿”å›</span></span><br><span class="line">        <span class="comment">// ç‰¹æ€§: è‡ªåŠ¨æ¸…ç†Luaæ ˆå¹¶æ‰§è¡Œlong jump</span></span><br><span class="line">        <span class="built_in">luaL_error</span>(L, <span class="string">&quot;attempt to read invalid uobject ptr&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤1: è·å–å¼±å¼•ç”¨ç¼“å­˜è¡¨</span></span><br><span class="line">    <span class="built_in">lua_getfield</span>(L, LUA_REGISTRYINDEX, <span class="string">&quot;UnLua_ObjectMap&quot;</span>);</span><br><span class="line">    <span class="comment">// æ ˆ: [ObjectMap]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… APIè®²è§£: lua_pushlightuserdata</span></span><br><span class="line">    <span class="comment">// åŠŸèƒ½: å‹å…¥CæŒ‡é’ˆä½œä¸ºluaå€¼ (ä¸åˆ†é…å†…å­˜)</span></span><br><span class="line">    <span class="comment">// ç”¨é€”: ä½œä¸ºè¡¨çš„key (å¿«é€ŸæŸ¥æ‰¾)</span></span><br><span class="line">    <span class="comment">// åŒºåˆ«: light userdata æ— å…ƒè¡¨,æ— GCå›è°ƒ</span></span><br><span class="line">    <span class="built_in">lua_pushlightuserdata</span>(L, Object);</span><br><span class="line">    <span class="comment">// æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ]</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤2: APIè®²è§£ lua_rawget</span></span><br><span class="line">    <span class="comment">// åŠŸèƒ½: ä»è¡¨ä¸­è·å–å€¼ (è·³è¿‡å…ƒæ–¹æ³•)</span></span><br><span class="line">    <span class="comment">// å‚æ•°: -2 æŒ‡å‘ ObjectMap</span></span><br><span class="line">    <span class="comment">// æ ˆå˜åŒ–: å¼¹å‡ºkey,å‹å…¥ ObjectMap[key]</span></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> Type = <span class="built_in">lua_rawget</span>(L, <span class="number">-2</span>);</span><br><span class="line">    <span class="comment">// æ ˆ: [ObjectMap, cached_userdataæˆ–nil]</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (Type == LUA_TNIL)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// â˜… ç¼“å­˜æœªå‘½ä¸­,åˆ›å»ºæ–° Userdata</span></span><br><span class="line">        <span class="built_in">lua_pop</span>(L, <span class="number">1</span>);  <span class="comment">// å¼¹å‡º nil</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">PushObjectCore</span>(L, Object);</span><br><span class="line">        <span class="comment">// æ ˆ: [ObjectMap, userdata]</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// â˜… ç¼“å­˜åˆ° ObjectMap</span></span><br><span class="line">        <span class="built_in">lua_pushlightuserdata</span>(L, Object);</span><br><span class="line">        <span class="built_in">lua_pushvalue</span>(L, <span class="number">-2</span>);  <span class="comment">// å¤åˆ¶ userdata</span></span><br><span class="line">        <span class="built_in">lua_rawset</span>(L, <span class="number">-4</span>);     <span class="comment">// ObjectMap[Object] = userdata</span></span><br><span class="line">        <span class="comment">// æ ˆ: [ObjectMap, userdata]</span></span><br><span class="line">        </span><br><span class="line">        ObjectRefs.<span class="built_in">Add</span>(Object, LUA_NOREF);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// â˜… æ·»åŠ åˆ°è‡ªåŠ¨å¼•ç”¨é›†åˆ</span></span><br><span class="line">        <span class="comment">// é˜²æ­¢ UE GC å›æ”¶è¿™ä¸ªå¯¹è±¡</span></span><br><span class="line">        Env-&gt;AutoObjectReference.<span class="built_in">Add</span>(Object);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">lua_remove</span>(L, <span class="number">-2</span>);  <span class="comment">// ç§»é™¤ ObjectMap</span></span><br><span class="line">    <span class="comment">// æ ˆ: [userdata]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Userdata-GC-å›è°ƒæºç "><a href="#Userdata-GC-å›è°ƒæºç " class="headerlink" title="Userdata GC å›è°ƒæºç "></a>Userdata GC å›è°ƒæºç </h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BaseLib/LuaLib_Object.cpp:240</span></span><br><span class="line"><span class="function"><span class="type">static</span> int32 <span class="title">UObject_Delete</span><span class="params">(lua_State* L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// â˜… å½“ Lua GC å›æ”¶ userdata æ—¶è‡ªåŠ¨è°ƒç”¨</span></span><br><span class="line">    <span class="comment">// æ ˆ: [1]=userdata (å¾…å›æ”¶çš„å¯¹è±¡)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤1: æå– UObject æŒ‡é’ˆ</span></span><br><span class="line">    <span class="comment">// API: lua_touserdata è¿”å› userdata çš„æ•°æ®æŒ‡é’ˆ</span></span><br><span class="line">    <span class="type">void</span>** UserdataPtr = (<span class="type">void</span>**)<span class="built_in">lua_touserdata</span>(L, <span class="number">1</span>);</span><br><span class="line">    UObject* Object = (UObject*)*UserdataPtr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// â˜… æ­¥éª¤2: æ£€æŸ¥æ˜¯å¦å·²æ ‡è®°ä¸ºé‡Šæ”¾</span></span><br><span class="line">    <span class="keyword">if</span> (!UnLua::LowLevel::<span class="built_in">IsReleasedPtr</span>(Object))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// â˜… é€šçŸ¥ ObjectRegistry</span></span><br><span class="line">        <span class="keyword">auto</span>&amp; Env = UnLua::FLuaEnv::<span class="built_in">FindEnvChecked</span>(L);</span><br><span class="line">        Env.<span class="built_in">GetObjectRegistry</span>()-&gt;<span class="built_in">NotifyUObjectLuaGC</span>(Object);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// â˜… ä»è‡ªåŠ¨å¼•ç”¨ç§»é™¤</span></span><br><span class="line">        <span class="comment">// ç°åœ¨ UE GC å¯ä»¥å®‰å…¨å›æ”¶è¿™ä¸ª UObject</span></span><br><span class="line">        Env.AutoObjectReference.<span class="built_in">Remove</span>(Object);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  <span class="comment">// __gc å…ƒæ–¹æ³•ä¸éœ€è¦è¿”å›å€¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å¼•ç”¨ç±»å‹å¯¹æ¯”</strong>:</p>
<table>
<thead>
<tr>
<th>å¼•ç”¨ç±»å‹</th>
<th>ç®¡ç†æ–¹å¼</th>
<th>GC è¡Œä¸º</th>
<th>ä½¿ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td><strong>è‡ªåŠ¨å¼•ç”¨</strong></td>
<td><code>AutoObjectReference</code></td>
<td>UE GCä¸å›æ”¶</td>
<td>é»˜è®¤,LuaæŒæœ‰UObject</td>
</tr>
<tr>
<td><strong>æ‰‹åŠ¨å¼•ç”¨</strong></td>
<td><code>AddManualRef()</code></td>
<td>æ˜¾å¼é‡Šæ”¾å‰ä¸å›æ”¶</td>
<td>é•¿æœŸæŒæœ‰</td>
</tr>
<tr>
<td><strong>å¼±å¼•ç”¨</strong></td>
<td>ç›´æ¥userdata</td>
<td>å¯¹è±¡é”€æ¯åå˜0xDEAD</td>
<td>ä¸´æ—¶è®¿é—®</td>
</tr>
</tbody></table>
<p><strong>å®Œæ•´ç”Ÿå‘½å‘¨æœŸç¤ºä¾‹</strong>:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1. åˆ›å»ºå¼•ç”¨</span></span><br><span class="line"><span class="keyword">local</span> actor = UE.UGameplayStatics.SpawnActor(...)</span><br><span class="line"><span class="comment">-- C++: Push() åˆ›å»º userdata</span></span><br><span class="line"><span class="comment">--      AutoObjectReference.Add(actor) â† UE GC è·³è¿‡</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. ä½¿ç”¨ä¸­</span></span><br><span class="line">actor:SetActorLocation(...)  <span class="comment">-- æ­£å¸¸è®¿é—®</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. Lua é‡Šæ”¾å¼•ç”¨</span></span><br><span class="line">actor = <span class="literal">nil</span></span><br><span class="line"><span class="built_in">collectgarbage</span>()</span><br><span class="line"><span class="comment">-- C++: UObject_Delete è§¦å‘</span></span><br><span class="line"><span class="comment">--      AutoObjectReference.Remove(actor) â† UE ç°åœ¨å¯ä»¥GC</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 4. UE é”€æ¯å¯¹è±¡</span></span><br><span class="line"><span class="comment">-- C++: NotifyUObjectDeleted()</span></span><br><span class="line"><span class="comment">--      *userdata = 0xDEAD â† æ ‡è®°ä¸ºå·²é‡Šæ”¾</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 5. å†æ¬¡è®¿é—® (å¦‚æœè¿˜æœ‰å…¶ä»–å¼•ç”¨)</span></span><br><span class="line"><span class="comment">-- C++: Class_Index æ£€æµ‹åˆ° IsReleasedPtr</span></span><br><span class="line"><span class="comment">--      luaL_error(&quot;released object&quot;) â† å®‰å…¨æŠ¥é”™</span></span><br></pre></td></tr></table></figure>

<h3 id="å¯¹è±¡ç”Ÿå‘½å‘¨æœŸå®Œæ•´æµç¨‹"><a href="#å¯¹è±¡ç”Ÿå‘½å‘¨æœŸå®Œæ•´æµç¨‹" class="headerlink" title="å¯¹è±¡ç”Ÿå‘½å‘¨æœŸå®Œæ•´æµç¨‹"></a>å¯¹è±¡ç”Ÿå‘½å‘¨æœŸå®Œæ•´æµç¨‹</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">å¯¹è±¡åˆ›å»º:</span><br><span class="line">UE åˆ›å»º Actor</span><br><span class="line">  â””â”€â–º <span class="built_in">BeginPlay</span>() è§¦å‘</span><br><span class="line">      â””â”€â–º UnLua.<span class="built_in">Bind</span>(Object, <span class="string">&quot;Module&quot;</span>)</span><br><span class="line">          â””â”€â–º FObjectRegistry::<span class="built_in">Push</span>()</span><br><span class="line">              â”œâ”€â–º åˆ›å»º Userdata</span><br><span class="line">              â”œâ”€â–º ç¼“å­˜åˆ° ObjectMap</span><br><span class="line">              â””â”€â–º AutoObjectReference.<span class="built_in">Add</span>(Object)  â† UE ä¸ä¼šå›æ”¶</span><br><span class="line"></span><br><span class="line">å¯¹è±¡ä½¿ç”¨ä¸­:</span><br><span class="line">Lua æŒæœ‰å¼•ç”¨ â†’ UE GC è·³è¿‡ â†’ Userdata æœ‰æ•ˆ</span><br><span class="line"></span><br><span class="line">Lua é‡Šæ”¾å¼•ç”¨:</span><br><span class="line">Lua GC è§¦å‘</span><br><span class="line">  â””â”€â–º __gc metamethod (UObject_Delete)</span><br><span class="line">      â””â”€â–º AutoObjectReference.<span class="built_in">Remove</span>(Object)  â† UE ç°åœ¨å¯ä»¥å›æ”¶</span><br><span class="line"></span><br><span class="line">UE ä¸»åŠ¨é”€æ¯:</span><br><span class="line">AActor::<span class="built_in">Destroy</span>()</span><br><span class="line">  â””â”€â–º UObjectBaseUtility::<span class="built_in">MarkPendingKill</span>()</span><br><span class="line">      â””â”€â–º FUnLuaModule::<span class="built_in">NotifyUObjectDeleted</span>()</span><br><span class="line">          â””â”€â–º FObjectRegistry::<span class="built_in">Unbind</span>(Object)</span><br><span class="line">              â”œâ”€â–º ObjectRefs.<span class="built_in">Remove</span>(Object)</span><br><span class="line">              â”œâ”€â–º *Userdata = <span class="number">0</span>xDEAD  â† æ ‡è®°ä¸ºå·²é‡Šæ”¾</span><br><span class="line">              â””â”€â–º AutoObjectReference.<span class="built_in">Remove</span>(Object)</span><br><span class="line"></span><br><span class="line">Lua è®¿é—®å·²é‡Šæ”¾å¯¹è±¡:</span><br><span class="line">obj:<span class="built_in">GetName</span>()</span><br><span class="line">  â””â”€â–º <span class="built_in">Class_Index</span>()</span><br><span class="line">      â””â”€â–º <span class="built_in">IsReleasedPtr</span>(Self) â†’ true</span><br><span class="line">          â””â”€â–º <span class="built_in">luaL_error</span>(<span class="string">&quot;attempt to read property on released object&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="æ‚¬ç©ºæŒ‡é’ˆé˜²æŠ¤æœºåˆ¶"><a href="#æ‚¬ç©ºæŒ‡é’ˆé˜²æŠ¤æœºåˆ¶" class="headerlink" title="æ‚¬ç©ºæŒ‡é’ˆé˜²æŠ¤æœºåˆ¶"></a>æ‚¬ç©ºæŒ‡é’ˆé˜²æŠ¤æœºåˆ¶</h3><h4 id="ReleasedPtr-æ ‡è®°"><a href="#ReleasedPtr-æ ‡è®°" class="headerlink" title="ReleasedPtr æ ‡è®°"></a>ReleasedPtr æ ‡è®°</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LowLevel.h:43</span></span><br><span class="line"><span class="type">const</span> <span class="type">static</span> UObject* ReleasedPtr = (UObject*)<span class="number">0xDEAD</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">FORCEINLINE <span class="type">bool</span> <span class="title">IsReleasedPtr</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* Ptr)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="keyword">return</span> Ptr == ReleasedPtr; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å¯¹è±¡æœ‰æ•ˆæ€§æ£€æŸ¥å±‚çº§"><a href="#å¯¹è±¡æœ‰æ•ˆæ€§æ£€æŸ¥å±‚çº§" class="headerlink" title="å¯¹è±¡æœ‰æ•ˆæ€§æ£€æŸ¥å±‚çº§"></a>å¯¹è±¡æœ‰æ•ˆæ€§æ£€æŸ¥å±‚çº§</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnLuaBase.cpp:28</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">IsUObjectValid</span><span class="params">(UObjectBase* ObjPtr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ç¬¬ 1 å±‚: ç©ºæŒ‡é’ˆæ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">if</span> (!ObjPtr || ObjPtr == LowLevel::ReleasedPtr)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç¬¬ 2 å±‚: UE æ ‡å¿—ä½æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">if</span> (ObjPtr-&gt;<span class="built_in">GetFlags</span>() &amp; (RF_BeginDestroyed | RF_FinishDestroyed))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç¬¬ 3 å±‚: åº•å±‚å†…å­˜æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">return</span> ObjPtr-&gt;<span class="built_in">IsValidLowLevelFast</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="è®¿é—®ä¿æŠ¤ç¤ºä¾‹"><a href="#è®¿é—®ä¿æŠ¤ç¤ºä¾‹" class="headerlink" title="è®¿é—®ä¿æŠ¤ç¤ºä¾‹"></a>è®¿é—®ä¿æŠ¤ç¤ºä¾‹</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Lua ä»£ç </span></span><br><span class="line"><span class="keyword">local</span> actor = UE.UGameplayStatics.GetPlayerPawn(<span class="built_in">self</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åœ¨ C++ ç«¯é”€æ¯</span></span><br><span class="line">actor:K2_DestroyActor()</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Lua å†æ¬¡è®¿é—® â†’ æŠ›å‡ºé”™è¯¯è€Œéå´©æºƒ</span></span><br><span class="line"><span class="keyword">local</span> name = actor:GetName()  </span><br><span class="line"><span class="comment">-- âœ… Error: &quot;attempt to read property &#x27;GetName&#x27; on released object&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="GC-æ€§èƒ½ä¼˜åŒ–å»ºè®®"><a href="#GC-æ€§èƒ½ä¼˜åŒ–å»ºè®®" class="headerlink" title="GC æ€§èƒ½ä¼˜åŒ–å»ºè®®"></a>GC æ€§èƒ½ä¼˜åŒ–å»ºè®®</h3><table>
<thead>
<tr>
<th>ä¼˜åŒ–ç‚¹</th>
<th>è¯´æ˜</th>
<th>æ”¶ç›Š</th>
</tr>
</thead>
<tbody><tr>
<td><strong>åŠæ—¶è§£ç»‘</strong></td>
<td>ä¸ç”¨çš„å¯¹è±¡è°ƒç”¨ <code>UnLua.Unbind()</code></td>
<td>å‡å°‘ GC å‹åŠ›</td>
</tr>
<tr>
<td><strong>ä½¿ç”¨å¼±å¼•ç”¨</strong></td>
<td>ä¸´æ—¶å¼•ç”¨ä¸å­˜å…¨å±€ table</td>
<td>å…è®¸ UE GC å›æ”¶</td>
</tr>
<tr>
<td><strong>å®¹å™¨å¤ç”¨</strong></td>
<td>é‡å¤ä½¿ç”¨ TArray</td>
<td>å‡å°‘åˆ†é…æ¬¡æ•°</td>
</tr>
<tr>
<td><strong>å®šæœŸ collectgarbage</strong></td>
<td>æ‰‹åŠ¨è§¦å‘ Lua GC</td>
<td>é˜²æ­¢å†…å­˜å³°å€¼</td>
</tr>
</tbody></table>
<hr>
<h2 id="åŒå‘è°ƒç”¨æœºåˆ¶"><a href="#åŒå‘è°ƒç”¨æœºåˆ¶" class="headerlink" title="åŒå‘è°ƒç”¨æœºåˆ¶"></a>åŒå‘è°ƒç”¨æœºåˆ¶</h2><h3 id="Lua-â†’-C-è“å›¾-è°ƒç”¨"><a href="#Lua-â†’-C-è“å›¾-è°ƒç”¨" class="headerlink" title="Lua â†’ C++&#x2F;è“å›¾ è°ƒç”¨"></a>Lua â†’ C++&#x2F;è“å›¾ è°ƒç”¨</h3><h4 id="è°ƒç”¨é“¾è·¯"><a href="#è°ƒç”¨é“¾è·¯" class="headerlink" title="è°ƒç”¨é“¾è·¯"></a>è°ƒç”¨é“¾è·¯</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">actor:<span class="built_in">SetActorLocation</span>(<span class="built_in">FVector</span>(<span class="number">100</span>, <span class="number">200</span>, <span class="number">300</span>))</span><br><span class="line"></span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ <span class="number">1</span>. Lua å‡½æ•°æŸ¥æ‰¾                                       â”‚</span><br><span class="line">â”‚    actor:SetActorLocation                            â”‚</span><br><span class="line">â”‚      â””â”€â–º actor çš„ metatable.__index                  â”‚</span><br><span class="line">â”‚          â””â”€â–º Class_Index                             â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">             â”‚</span><br><span class="line">             â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ <span class="number">2</span>. è·å– FFunctionDesc                                 â”‚</span><br><span class="line">â”‚    <span class="built_in">GetField</span>(L)                                       â”‚</span><br><span class="line">â”‚      â””â”€â–º ClassDesc-&gt;<span class="built_in">RegisterField</span>(<span class="string">&quot;SetActorLocation&quot;</span>)â”‚</span><br><span class="line">â”‚          â””â”€â–º åˆ›å»º FFunctionDesc (é¦–æ¬¡) æˆ–ç¼“å­˜        â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">             â”‚</span><br><span class="line">             â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ <span class="number">3</span>. æ¨é€ Closure                                       â”‚</span><br><span class="line">â”‚    <span class="built_in">PushField</span>(L, Function)                            â”‚</span><br><span class="line">â”‚      â””â”€â–º <span class="built_in">lua_pushcclosure</span>(L, Class_CallUFunction, <span class="number">1</span>) â”‚</span><br><span class="line">â”‚          â””â”€â–º ç¼“å­˜åˆ° metatable                        â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">             â”‚</span><br><span class="line">             â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ <span class="number">4</span>. æ‰§è¡Œ Closure                                       â”‚</span><br><span class="line">â”‚    <span class="built_in">Class_CallUFunction</span>(L)                            â”‚</span><br><span class="line">â”‚      â””â”€â–º FFunctionDesc::<span class="built_in">CallUE</span>(L, NumParams)         â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">             â”‚</span><br><span class="line">             â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ <span class="number">5</span>. å‚æ•°è½¬æ¢                                           â”‚</span><br><span class="line">â”‚    <span class="built_in">PreCall</span>(L, NumParams, Params)                     â”‚</span><br><span class="line">â”‚      â”œâ”€â–º FVector::<span class="built_in">WriteValue</span>(L, Params)              â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">             â”‚</span><br><span class="line">             â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ <span class="number">6</span>. è°ƒç”¨ UE å‡½æ•°                                       â”‚</span><br><span class="line">â”‚    Object-&gt;<span class="built_in">ProcessEvent</span>(Function, Params)            â”‚</span><br><span class="line">â”‚      â””â”€â–º AActor::<span class="built_in">SetActorLocation</span>(FVector)           â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">             â”‚</span><br><span class="line">             â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ <span class="number">7</span>. è¿”å›å€¼å¤„ç†                                         â”‚</span><br><span class="line">â”‚    <span class="built_in">PostCall</span>(L, Params)                               â”‚</span><br><span class="line">â”‚      â””â”€â–º æ— è¿”å›å€¼ï¼Œè¿”å› <span class="number">0</span>                            â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure>

<h4 id="æ€§èƒ½ä¼˜åŒ–ç‚¹"><a href="#æ€§èƒ½ä¼˜åŒ–ç‚¹" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–ç‚¹"></a>æ€§èƒ½ä¼˜åŒ–ç‚¹</h4><table>
<thead>
<tr>
<th>ä¼˜åŒ–æŠ€æœ¯</th>
<th>å®ç°ä½ç½®</th>
<th>æ•ˆæœ</th>
</tr>
</thead>
<tbody><tr>
<td><strong>å‡½æ•°æè¿°ç¬¦ç¼“å­˜</strong></td>
<td><code>ClassDesc</code> çš„ <code>Fields</code> è¡¨</td>
<td>é¿å…é‡å¤åå°„ï¼Œæå‡ 90%</td>
</tr>
<tr>
<td><strong>Closure å¤ç”¨</strong></td>
<td>Metatable ç¼“å­˜</td>
<td>å‡å°‘ GC å‹åŠ›</td>
</tr>
<tr>
<td><strong>å‚æ•°ç¼“å†²åŒºæ± åŒ–</strong></td>
<td><code>FParamBufferAllocator</code></td>
<td>é¿å…é¢‘ç¹åˆ†é…</td>
</tr>
<tr>
<td><strong>å¿«é€Ÿè·¯å¾„ä¼˜åŒ–</strong></td>
<td><code>GetCppInstanceFast</code></td>
<td>è·³è¿‡æ£€æŸ¥ï¼Œæå‡ 20%</td>
</tr>
</tbody></table>
<h3 id="C-è“å›¾-â†’-Lua-è°ƒç”¨"><a href="#C-è“å›¾-â†’-Lua-è°ƒç”¨" class="headerlink" title="C++&#x2F;è“å›¾ â†’ Lua è°ƒç”¨"></a>C++&#x2F;è“å›¾ â†’ Lua è°ƒç”¨</h3><h4 id="è°ƒç”¨é“¾è·¯-1"><a href="#è°ƒç”¨é“¾è·¯-1" class="headerlink" title="è°ƒç”¨é“¾è·¯"></a>è°ƒç”¨é“¾è·¯</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">è“å›¾èŠ‚ç‚¹: Event BeginPlay</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ <span class="number">1</span>. è“å›¾è™šæ‹Ÿæœºæ‰§è¡Œ                                     â”‚</span><br><span class="line">â”‚    UK2Node_Event::<span class="built_in">Execute</span>()                          â”‚</span><br><span class="line">â”‚      â””â”€â–º UObject::<span class="built_in">ProcessEvent</span>(BeginPlay, nullptr)   â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">             â”‚</span><br><span class="line">             â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ <span class="number">2</span>. æ£€æŸ¥ Lua è¦†å†™                                      â”‚</span><br><span class="line">â”‚    FLuaOverrider::<span class="built_in">ProcessEvent</span>()                     â”‚</span><br><span class="line">â”‚      â”œâ”€â–º æŸ¥æ‰¾ ObjectRefs<span class="selector-attr">[this]</span>                       â”‚</span><br><span class="line">â”‚      â”‚   â””â”€â–º LuaTableRef (Lua å®ä¾‹è¡¨å¼•ç”¨)            â”‚</span><br><span class="line">â”‚      â”‚                                                â”‚</span><br><span class="line">â”‚      â”œâ”€â–º <span class="built_in">lua_rawgeti</span>(L, LUA_REGISTRYINDEX, Ref)      â”‚</span><br><span class="line">â”‚      â”‚   â””â”€â–º è·å– INSTANCE                           â”‚</span><br><span class="line">â”‚      â”‚                                                â”‚</span><br><span class="line">â”‚      â””â”€â–º <span class="built_in">lua_getfield</span>(L, -<span class="number">1</span>, <span class="string">&quot;ReceiveBeginPlay&quot;</span>)     â”‚</span><br><span class="line">â”‚          â””â”€â–º æŸ¥æ‰¾ Lua å‡½æ•°                           â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">             â”‚</span><br><span class="line">             â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ <span class="number">3</span>. å‡†å¤‡ Lua è°ƒç”¨                                      â”‚</span><br><span class="line">â”‚    FFunctionDesc::<span class="built_in">CallLua</span>(L, FunctionRef, SelfRef, Stack)â”‚</span><br><span class="line">â”‚      â”œâ”€â–º <span class="built_in">lua_rawgeti</span>(L, LUA_REGISTRYINDEX, FunctionRef)â”‚</span><br><span class="line">â”‚      â””â”€â–º <span class="built_in">lua_rawgeti</span>(L, LUA_REGISTRYINDEX, SelfRef)  â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">             â”‚</span><br><span class="line">             â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ <span class="number">4</span>. å‚æ•°è½¬æ¢                                           â”‚</span><br><span class="line">â”‚    <span class="keyword">for</span> (Property: Function-&gt;Properties)             â”‚</span><br><span class="line">â”‚      Property-&gt;<span class="built_in">ReadValue</span>(L, Params, false)           â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">             â”‚</span><br><span class="line">             â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ <span class="number">5</span>. æ‰§è¡Œ Lua å‡½æ•°                                      â”‚</span><br><span class="line">â”‚    <span class="built_in">lua_pcall</span>(L, NumParams, NumResults, ErrorHandler) â”‚</span><br><span class="line">â”‚      â””â”€â–º æ‰§è¡Œ MyActor<span class="selector-class">.lua</span>:<span class="built_in">ReceiveBeginPlay</span>(self)     â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">             â”‚</span><br><span class="line">             â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ <span class="number">6</span>. è¿”å›å€¼å¤„ç†                                         â”‚</span><br><span class="line">â”‚    <span class="keyword">if</span> (HasReturnValue)                               â”‚</span><br><span class="line">â”‚      ReturnProperty-&gt;<span class="built_in">WriteValue</span>(L, RetAddress, -<span class="number">1</span>)   â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">             â”‚</span><br><span class="line">             â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ <span class="number">7</span>. Out å‚æ•°å›å†™                                       â”‚</span><br><span class="line">â”‚    <span class="keyword">for</span> (OutProperty: OutProperties)                 â”‚</span><br><span class="line">â”‚      OutProperty-&gt;<span class="built_in">WriteValue</span>(L, Params)              â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure>

<h4 id="è¦†å†™æ£€æµ‹æµç¨‹"><a href="#è¦†å†™æ£€æµ‹æµç¨‹" class="headerlink" title="è¦†å†™æ£€æµ‹æµç¨‹"></a>è¦†å†™æ£€æµ‹æµç¨‹</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FunctionDesc.cpp</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FFunctionDesc::CallLua</span><span class="params">(...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 1. è·å– Lua å‡½æ•°å¼•ç”¨</span></span><br><span class="line">    <span class="built_in">lua_rawgeti</span>(L, LUA_REGISTRYINDEX, FunctionRef);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">lua_isfunction</span>(L, <span class="number">-1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">lua_pop</span>(L, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span>;  <span class="comment">// Lua å‡½æ•°æ— æ•ˆï¼Œè·³è¿‡</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. æ‰§è¡Œ Lua è¦†å†™é€»è¾‘</span></span><br><span class="line">    <span class="comment">// ... (è§ä¸Šæ–‡è°ƒç”¨é“¾è·¯)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="è°ƒç”¨æ€§èƒ½å¯¹æ¯”"><a href="#è°ƒç”¨æ€§èƒ½å¯¹æ¯”" class="headerlink" title="è°ƒç”¨æ€§èƒ½å¯¹æ¯”"></a>è°ƒç”¨æ€§èƒ½å¯¹æ¯”</h3><table>
<thead>
<tr>
<th>è°ƒç”¨ç±»å‹</th>
<th>å¹³å‡è€—æ—¶ (Î¼s)</th>
<th>ç›¸å¯¹æ€§èƒ½</th>
<th>ä¸»è¦å¼€é”€</th>
</tr>
</thead>
<tbody><tr>
<td><strong>C++ â†’ C++</strong></td>
<td>0.05</td>
<td>1x</td>
<td>å‡½æ•°è°ƒç”¨</td>
</tr>
<tr>
<td><strong>Lua â†’ C++</strong></td>
<td>2.5</td>
<td>50x</td>
<td>å‚æ•°è½¬æ¢ã€åå°„</td>
</tr>
<tr>
<td><strong>C++ â†’ Lua</strong></td>
<td>3.8</td>
<td>76x</td>
<td>Lua VMã€å‚æ•°è½¬æ¢</td>
</tr>
<tr>
<td><strong>Lua â†’ Lua</strong></td>
<td>0.8</td>
<td>16x</td>
<td>Table æŸ¥æ‰¾</td>
</tr>
</tbody></table>
<p><strong>ä¼˜åŒ–å»ºè®®</strong>:</p>
<ul>
<li>é¢‘ç¹è°ƒç”¨çš„å‡½æ•° (å¦‚ Tick) å°½é‡åœ¨å•ä¾§å®ç°</li>
<li>æ‰¹é‡æ“ä½œä½¿ç”¨å®¹å™¨è€Œéé€ä¸ªä¼ é€’</li>
<li>é¿å…åœ¨å¾ªç¯ä¸­è·¨è¯­è¨€è°ƒç”¨</li>
</ul>
<hr>
<h2 id="æ€§èƒ½ä¼˜åŒ–è¦ç‚¹-1"><a href="#æ€§èƒ½ä¼˜åŒ–è¦ç‚¹-1" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–è¦ç‚¹"></a>æ€§èƒ½ä¼˜åŒ–è¦ç‚¹</h2><h3 id="å…³é”®ä¼˜åŒ–æŠ€æœ¯è¡¨"><a href="#å…³é”®ä¼˜åŒ–æŠ€æœ¯è¡¨" class="headerlink" title="å…³é”®ä¼˜åŒ–æŠ€æœ¯è¡¨"></a>å…³é”®ä¼˜åŒ–æŠ€æœ¯è¡¨</h3><table>
<thead>
<tr>
<th>ä¼˜åŒ–æŠ€æœ¯</th>
<th>å®ç°ä½ç½®</th>
<th>æ€§èƒ½æå‡</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Userdata å¿«é€Ÿè·¯å¾„</strong></td>
<td><code>GetUserdataFast()</code></td>
<td>~30%</td>
<td>æ‰€æœ‰å¯¹è±¡è®¿é—®</td>
</tr>
<tr>
<td><strong>å‡½æ•°æè¿°ç¬¦ç¼“å­˜</strong></td>
<td><code>ClassDesc::Fields</code></td>
<td>~90%</td>
<td>é‡å¤è°ƒç”¨å‡½æ•°</td>
</tr>
<tr>
<td><strong>å‚æ•°ç¼“å†²åŒºæ± åŒ–</strong></td>
<td><code>FParamBufferAllocator</code></td>
<td>~20%</td>
<td>é«˜é¢‘å‡½æ•°è°ƒç”¨</td>
</tr>
<tr>
<td><strong>é›¶æ‹·è´å®¹å™¨</strong></td>
<td><code>TArray/TMap</code> å¼•ç”¨ä¼ é€’</td>
<td>~80%</td>
<td>å¤§æ•°æ®ä¼ é€’</td>
</tr>
<tr>
<td><strong>æ‡’åŠ è½½åå°„</strong></td>
<td>æŒ‰éœ€åˆ›å»º <code>FPropertyDesc</code></td>
<td>å‡å°‘å¯åŠ¨ 50%</td>
<td>ç±»å‹æ³¨å†Œ</td>
</tr>
<tr>
<td><strong>å¼±å¼•ç”¨è¡¨</strong></td>
<td><code>UnLua_ObjectMap</code></td>
<td>å‡å°‘ GC å‹åŠ›</td>
<td>å¯¹è±¡ç¼“å­˜</td>
</tr>
</tbody></table>
<h3 id="Userdata-å†…å­˜å¸ƒå±€ä¼˜åŒ–"><a href="#Userdata-å†…å­˜å¸ƒå±€ä¼˜åŒ–" class="headerlink" title="Userdata å†…å­˜å¸ƒå±€ä¼˜åŒ–"></a>Userdata å†…å­˜å¸ƒå±€ä¼˜åŒ–</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LuaCore.cpp:78</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> pack(push, 1)</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FUserdataDesc</span></span><br><span class="line">&#123;</span><br><span class="line">    uint16  magic;      <span class="comment">// 2 bytes (é­”æ•°éªŒè¯)</span></span><br><span class="line">    uint8   tag;        <span class="comment">// 1 byte  (æ ‡å¿—ä½)</span></span><br><span class="line">    uint8   padding;    <span class="comment">// 1 byte  (å¯¹é½å¡«å……)</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> pack(pop)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ€»å¤§å°: 4 bytesï¼Œç´§å‡‘å¸ƒå±€</span></span><br></pre></td></tr></table></figure>

<p><strong>ä¼˜åŒ–æ•ˆæœ</strong>:</p>
<ul>
<li>åŸå…ˆæ¯ä¸ª Userdata é¢å¤– 16 bytes</li>
<li>ä¼˜åŒ–åä»… 4 bytes</li>
<li>å‡å°‘å†…å­˜å ç”¨ <strong>75%</strong></li>
</ul>
<h3 id="å‡½æ•°è°ƒç”¨ä¼˜åŒ–ç­–ç•¥"><a href="#å‡½æ•°è°ƒç”¨ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="å‡½æ•°è°ƒç”¨ä¼˜åŒ–ç­–ç•¥"></a>å‡½æ•°è°ƒç”¨ä¼˜åŒ–ç­–ç•¥</h3><h4 id="Closure-ç¼“å­˜æœºåˆ¶"><a href="#Closure-ç¼“å­˜æœºåˆ¶" class="headerlink" title="Closure ç¼“å­˜æœºåˆ¶"></a>Closure ç¼“å­˜æœºåˆ¶</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- æœªä¼˜åŒ–ç‰ˆæœ¬ (æ¯æ¬¡åˆ›å»ºæ–° Closure)</span></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">1000</span> <span class="keyword">do</span></span><br><span class="line">    actor:SetActorLocation(FVector(i * <span class="number">100</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- âœ… ä¼˜åŒ–ç‰ˆæœ¬ (Closure è‡ªåŠ¨ç¼“å­˜)</span></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">1000</span> <span class="keyword">do</span></span><br><span class="line">    actor:SetActorLocation(FVector(i * <span class="number">100</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><strong>æ€§èƒ½å¯¹æ¯”</strong>:</p>
<ul>
<li>æœªä¼˜åŒ–: ~3000 Î¼s (å« Closure åˆ›å»º)</li>
<li>ä¼˜åŒ–å: ~2500 Î¼s (ä»…è°ƒç”¨å¼€é”€)</li>
<li><strong>æå‡ 16.7%</strong></li>
</ul>
<h4 id="æ‰¹é‡æ“ä½œæœ€ä½³å®è·µ"><a href="#æ‰¹é‡æ“ä½œæœ€ä½³å®è·µ" class="headerlink" title="æ‰¹é‡æ“ä½œæœ€ä½³å®è·µ"></a>æ‰¹é‡æ“ä½œæœ€ä½³å®è·µ</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- âŒ ä½æ•ˆ: é€ä¸ªè·¨è¯­è¨€è°ƒç”¨</span></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, #actors <span class="keyword">do</span></span><br><span class="line">    actors[i]:SetActorLocation(FVector(i * <span class="number">100</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- âœ… é«˜æ•ˆ: æ‰¹é‡è®¾ç½®</span></span><br><span class="line"><span class="keyword">local</span> locations = UE.TArray(UE.FVector)</span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, #actors <span class="keyword">do</span></span><br><span class="line">    locations:Add(FVector(i * <span class="number">100</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">BatchSetLocations(actors, locations)  <span class="comment">-- C++ æ‰¹å¤„ç†</span></span><br></pre></td></tr></table></figure>

<h3 id="å†…å­˜ä¼˜åŒ–å»ºè®®"><a href="#å†…å­˜ä¼˜åŒ–å»ºè®®" class="headerlink" title="å†…å­˜ä¼˜åŒ–å»ºè®®"></a>å†…å­˜ä¼˜åŒ–å»ºè®®</h3><table>
<thead>
<tr>
<th>ä¼˜åŒ–ç‚¹</th>
<th>è¯´æ˜</th>
<th>æ”¶ç›Š</th>
</tr>
</thead>
<tbody><tr>
<td><strong>åŠæ—¶è§£ç»‘</strong></td>
<td>ä¸ç”¨çš„å¯¹è±¡è°ƒç”¨ <code>UnLua.Unbind()</code></td>
<td>å‡å°‘ GC å‹åŠ›</td>
</tr>
<tr>
<td><strong>ä½¿ç”¨å¼±å¼•ç”¨</strong></td>
<td>ä¸´æ—¶å¼•ç”¨ä¸å­˜å…¨å±€ table</td>
<td>å…è®¸ UE GC å›æ”¶</td>
</tr>
<tr>
<td><strong>å®¹å™¨å¤ç”¨</strong></td>
<td>é‡å¤ä½¿ç”¨ TArray</td>
<td>å‡å°‘åˆ†é…æ¬¡æ•°</td>
</tr>
<tr>
<td><strong>é¿å…å­—ç¬¦ä¸²æ‹¼æ¥</strong></td>
<td>ä½¿ç”¨ <code>table.concat</code></td>
<td>å‡å°‘ä¸´æ—¶å­—ç¬¦ä¸²</td>
</tr>
</tbody></table>
<hr>
<h2 id="é«˜çº§è¯é¢˜"><a href="#é«˜çº§è¯é¢˜" class="headerlink" title="é«˜çº§è¯é¢˜"></a>é«˜çº§è¯é¢˜</h2><h3 id="å¤š-Lua-VM-ç¯å¢ƒéš”ç¦»"><a href="#å¤š-Lua-VM-ç¯å¢ƒéš”ç¦»" class="headerlink" title="å¤š Lua VM ç¯å¢ƒéš”ç¦»"></a>å¤š Lua VM ç¯å¢ƒéš”ç¦»</h3><p>UnLua æ”¯æŒåˆ›å»º<strong>å¤šä¸ªç‹¬ç«‹çš„ Lua ç¯å¢ƒ</strong>ï¼Œç”¨äºéš”ç¦»ä¸åŒçš„æ¸¸æˆæ¨¡å—ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºç‹¬ç«‹ç¯å¢ƒ</span></span><br><span class="line">FLuaEnv* MainEnv = <span class="keyword">new</span> <span class="built_in">FLuaEnv</span>(<span class="string">&quot;Main&quot;</span>);</span><br><span class="line">FLuaEnv* PluginEnv = <span class="keyword">new</span> <span class="built_in">FLuaEnv</span>(<span class="string">&quot;Plugin&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¯å¢ƒé—´ä¸å…±äº«å…¨å±€å˜é‡</span></span><br><span class="line">MainEnv-&gt;<span class="built_in">DoString</span>(<span class="string">&quot;GlobalVar = 123&quot;</span>);</span><br><span class="line">PluginEnv-&gt;<span class="built_in">DoString</span>(<span class="string">&quot;print(GlobalVar)&quot;</span>);  -- nil</span><br></pre></td></tr></table></figure>

<h3 id="åç¨‹æ”¯æŒ"><a href="#åç¨‹æ”¯æŒ" class="headerlink" title="åç¨‹æ”¯æŒ"></a>åç¨‹æ”¯æŒ</h3><h4 id="Latent-å‡½æ•°"><a href="#Latent-å‡½æ•°" class="headerlink" title="Latent å‡½æ•°"></a>Latent å‡½æ•°</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyActor:TestLatent</span><span class="params">()</span></span></span><br><span class="line">    UE.UKismetSystemLibrary.Delay(<span class="built_in">self</span>, <span class="number">2.0</span>)  <span class="comment">-- ç­‰å¾… 2 ç§’</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;2 seconds later&quot;</span>)  <span class="comment">-- è‡ªåŠ¨æ¢å¤æ‰§è¡Œ</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><strong>åº•å±‚å®ç°</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FunctionDesc.cpp</span></span><br><span class="line"><span class="function">int32 <span class="title">Class_CallLatentFunction</span><span class="params">(lua_State *L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span>&amp; Env = UnLua::FLuaEnv::<span class="built_in">FindEnvChecked</span>(L);</span><br><span class="line">    <span class="keyword">auto</span> ThreadRef = Env.<span class="built_in">FindOrAddThread</span>(L);  <span class="comment">// åˆ›å»º/è·å–åç¨‹</span></span><br><span class="line">    </span><br><span class="line">    int32 NumResults = Function-&gt;<span class="built_in">CallUE</span>(L, NumParams, &amp;ThreadRef);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">lua_yield</span>(L, NumResults);  <span class="comment">// æŒ‚èµ·åç¨‹</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="çƒ­æ›´æ–°æœºåˆ¶"><a href="#çƒ­æ›´æ–°æœºåˆ¶" class="headerlink" title="çƒ­æ›´æ–°æœºåˆ¶"></a>çƒ­æ›´æ–°æœºåˆ¶</h3><h4 id="çƒ­æ›´æ–°æµç¨‹"><a href="#çƒ­æ›´æ–°æµç¨‹" class="headerlink" title="çƒ­æ›´æ–°æµç¨‹"></a>çƒ­æ›´æ–°æµç¨‹</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> ä¸‹è½½æ–° Lua æ–‡ä»¶åˆ° PersistentDownloadDir/</span><br><span class="line">   â””â”€â–º iOS/Android: Library/Caches/</span><br><span class="line">       PC: Saved/DownloadData/</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> è°ƒç”¨çƒ­æ›´æ–° API</span><br><span class="line">   UnLua.HotReload(<span class="string">&quot;ModuleName&quot;</span>)</span><br><span class="line">   â””â”€â–º <span class="built_in">package</span>.<span class="built_in">loaded</span>[<span class="string">&quot;ModuleName&quot;</span>] = <span class="literal">nil</span></span><br><span class="line">       <span class="built_in">require</span>(<span class="string">&quot;ModuleName&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="çƒ­æ›´æ–°é™åˆ¶"><a href="#çƒ­æ›´æ–°é™åˆ¶" class="headerlink" title="çƒ­æ›´æ–°é™åˆ¶"></a>çƒ­æ›´æ–°é™åˆ¶</h4><table>
<thead>
<tr>
<th>å¯çƒ­æ›´</th>
<th>ä¸å¯çƒ­æ›´</th>
<th>è§£å†³æ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody><tr>
<td>Lua é€»è¾‘å‡½æ•°</td>
<td>C++ ä»£ç </td>
<td>ä»… Lua å®ç°çƒ­æ›´</td>
</tr>
<tr>
<td>Lua Module</td>
<td>å·²åŠ è½½çš„ UClass</td>
<td>é‡å¯æ¸¸æˆ</td>
</tr>
<tr>
<td>æ–°å¢ Lua å‡½æ•°</td>
<td>ä¿®æ”¹ UFunction ç­¾å</td>
<td>ä¿æŒæ¥å£ç¨³å®š</td>
</tr>
<tr>
<td>æ•°å€¼é…ç½®</td>
<td>å·²åˆ›å»ºçš„å¯¹è±¡çŠ¶æ€</td>
<td>æä¾›è¿ç§»å‡½æ•°</td>
</tr>
</tbody></table>
<h3 id="è°ƒè¯•ä¸æ€§èƒ½åˆ†æ"><a href="#è°ƒè¯•ä¸æ€§èƒ½åˆ†æ" class="headerlink" title="è°ƒè¯•ä¸æ€§èƒ½åˆ†æ"></a>è°ƒè¯•ä¸æ€§èƒ½åˆ†æ</h3><h4 id="Lua-è°ƒè¯•å™¨é›†æˆ"><a href="#Lua-è°ƒè¯•å™¨é›†æˆ" class="headerlink" title="Lua è°ƒè¯•å™¨é›†æˆ"></a>Lua è°ƒè¯•å™¨é›†æˆ</h4><p>UnLua æ”¯æŒ <strong>VSCode Lua Debugger</strong> å’Œ <strong>EmmyLua</strong>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .vscode/launch.json</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lua&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;attach&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Attach to UnLua&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">8818</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="æ€§èƒ½åˆ†æå·¥å…·"><a href="#æ€§èƒ½åˆ†æå·¥å…·" class="headerlink" title="æ€§èƒ½åˆ†æå·¥å…·"></a>æ€§èƒ½åˆ†æå·¥å…·</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ä½¿ç”¨å†…ç½® Profiler</span></span><br><span class="line"><span class="keyword">local</span> Profiler = <span class="built_in">require</span>(<span class="string">&quot;UnLua.Profiler&quot;</span>)</span><br><span class="line"></span><br><span class="line">Profiler.Start()</span><br><span class="line"><span class="comment">-- æ‰§è¡Œä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">Profiler.Stop()</span><br><span class="line">Profiler.Report()  <span class="comment">-- è¾“å‡ºæŠ¥å‘Š</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•"></a>é™„å½•</h2><h3 id="A-æ ¸å¿ƒæ–‡ä»¶ç´¢å¼•"><a href="#A-æ ¸å¿ƒæ–‡ä»¶ç´¢å¼•" class="headerlink" title="A. æ ¸å¿ƒæ–‡ä»¶ç´¢å¼•"></a>A. æ ¸å¿ƒæ–‡ä»¶ç´¢å¼•</h3><table>
<thead>
<tr>
<th>æ–‡ä»¶</th>
<th>è·¯å¾„</th>
<th>åŠŸèƒ½</th>
</tr>
</thead>
<tbody><tr>
<td><code>LuaEnv.cpp</code></td>
<td><code>Source/UnLua/Private/</code></td>
<td>Lua VM ç®¡ç†</td>
</tr>
<tr>
<td><code>ClassRegistry.cpp</code></td>
<td><code>Source/UnLua/Private/Registries/</code></td>
<td>ç±»æ³¨å†Œ</td>
</tr>
<tr>
<td><code>ObjectRegistry.cpp</code></td>
<td><code>Source/UnLua/Private/Registries/</code></td>
<td>å¯¹è±¡ç»‘å®š</td>
</tr>
<tr>
<td><code>FunctionDesc.cpp</code></td>
<td><code>Source/UnLua/Private/ReflectionUtils/</code></td>
<td>å‡½æ•°è°ƒç”¨</td>
</tr>
<tr>
<td><code>PropertyDesc.cpp</code></td>
<td><code>Source/UnLua/Private/ReflectionUtils/</code></td>
<td>å±æ€§è®¿é—®</td>
</tr>
<tr>
<td><code>LuaCore.cpp</code></td>
<td><code>Source/UnLua/Private/</code></td>
<td>æ ¸å¿ƒç»‘å®šé€»è¾‘</td>
</tr>
</tbody></table>
<h3 id="B-Lua-C-API-é€ŸæŸ¥æ‰‹å†Œ"><a href="#B-Lua-C-API-é€ŸæŸ¥æ‰‹å†Œ" class="headerlink" title="B. Lua C API é€ŸæŸ¥æ‰‹å†Œ"></a>B. Lua C API é€ŸæŸ¥æ‰‹å†Œ</h3><h4 id="B-1-æ ˆæ“ä½œ"><a href="#B-1-æ ˆæ“ä½œ" class="headerlink" title="B.1 æ ˆæ“ä½œ"></a>B.1 æ ˆæ“ä½œ</h4><table>
<thead>
<tr>
<th>API</th>
<th>åŠŸèƒ½</th>
<th>æ ˆå˜åŒ–</th>
<th>ç¤ºä¾‹</th>
</tr>
</thead>
<tbody><tr>
<td><code>lua_gettop(L)</code></td>
<td>è·å–æ ˆé¡¶ç´¢å¼•</td>
<td><code>0</code></td>
<td><code>int n = lua_gettop(L);</code></td>
</tr>
<tr>
<td><code>lua_settop(L, n)</code></td>
<td>è®¾ç½®æ ˆå¤§å°</td>
<td><code>n</code></td>
<td><code>lua_settop(L, 0);</code> æ¸…ç©ºæ ˆ</td>
</tr>
<tr>
<td><code>lua_pushvalue(L, idx)</code></td>
<td>å¤åˆ¶å€¼åˆ°æ ˆé¡¶</td>
<td><code>+1</code></td>
<td><code>lua_pushvalue(L, -1);</code> å¤åˆ¶æ ˆé¡¶</td>
</tr>
<tr>
<td><code>lua_remove(L, idx)</code></td>
<td>ç§»é™¤æŒ‡å®šç´¢å¼•</td>
<td><code>-1</code></td>
<td><code>lua_remove(L, 1);</code> ç§»é™¤æ ˆåº•</td>
</tr>
<tr>
<td><code>lua_insert(L, idx)</code></td>
<td>æ’å…¥æ ˆé¡¶å€¼åˆ°idx</td>
<td><code>0</code></td>
<td>æ ˆé¡¶ç§»åˆ°ä¸­é—´</td>
</tr>
<tr>
<td><code>lua_replace(L, idx)</code></td>
<td>æ›¿æ¢idxå€¼</td>
<td><code>-1</code></td>
<td>å¼¹å‡ºæ ˆé¡¶æ›¿æ¢idx</td>
</tr>
<tr>
<td><code>lua_pop(L, n)</code></td>
<td>å¼¹å‡ºnä¸ªå€¼</td>
<td><code>-n</code></td>
<td><code>lua_pop(L, 1);</code></td>
</tr>
<tr>
<td><code>lua_rotate(L, idx, n)</code></td>
<td>æ—‹è½¬æ ˆå…ƒç´ </td>
<td><code>0</code></td>
<td>Lua 5.3+</td>
</tr>
</tbody></table>
<h4 id="B-2-ç±»å‹æ£€æŸ¥ä¸è½¬æ¢"><a href="#B-2-ç±»å‹æ£€æŸ¥ä¸è½¬æ¢" class="headerlink" title="B.2 ç±»å‹æ£€æŸ¥ä¸è½¬æ¢"></a>B.2 ç±»å‹æ£€æŸ¥ä¸è½¬æ¢</h4><table>
<thead>
<tr>
<th>API</th>
<th>åŠŸèƒ½</th>
<th>è¿”å›å€¼</th>
<th>å¤±è´¥è¿”å›</th>
</tr>
</thead>
<tbody><tr>
<td><code>lua_type(L, idx)</code></td>
<td>è·å–ç±»å‹</td>
<td>LUA_TXXX</td>
<td>LUA_TNONE</td>
</tr>
<tr>
<td><code>lua_typename(L, tp)</code></td>
<td>ç±»å‹åå­—ç¬¦ä¸²</td>
<td>â€œtableâ€ç­‰</td>
<td>-</td>
</tr>
<tr>
<td><code>lua_isXXX(L, idx)</code></td>
<td>ç±»å‹åˆ¤æ–­</td>
<td>bool</td>
<td>-</td>
</tr>
<tr>
<td><code>lua_toXXX(L, idx)</code></td>
<td>ç±»å‹è½¬æ¢</td>
<td>å¯¹åº”ç±»å‹</td>
<td>0&#x2F;NULL</td>
</tr>
<tr>
<td><code>luaL_checkXXX(L, idx)</code></td>
<td>å¼ºåˆ¶è½¬æ¢</td>
<td>å¯¹åº”ç±»å‹</td>
<td>æŠ›é”™</td>
</tr>
<tr>
<td><code>lua_toboolean(L, idx)</code></td>
<td>è½¬bool</td>
<td>int</td>
<td>0&#x3D;false</td>
</tr>
<tr>
<td><code>lua_tointeger(L, idx)</code></td>
<td>è½¬æ•´æ•°</td>
<td>lua_Integer</td>
<td>0</td>
</tr>
<tr>
<td><code>lua_tonumber(L, idx)</code></td>
<td>è½¬æµ®ç‚¹</td>
<td>lua_Number</td>
<td>0.0</td>
</tr>
<tr>
<td><code>lua_tostring(L, idx)</code></td>
<td>è½¬å­—ç¬¦ä¸²</td>
<td>const char*</td>
<td>NULL</td>
</tr>
<tr>
<td><code>lua_touserdata(L, idx)</code></td>
<td>è½¬userdata</td>
<td>void*</td>
<td>NULL</td>
</tr>
<tr>
<td><code>lua_topointer(L, idx)</code></td>
<td>è½¬é€šç”¨æŒ‡é’ˆ</td>
<td>const void*</td>
<td>NULL</td>
</tr>
</tbody></table>
<p><strong>ç±»å‹å¸¸é‡</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">LUA_TNIL           <span class="comment">// nil</span></span><br><span class="line">LUA_TNUMBER        <span class="comment">// number</span></span><br><span class="line">LUA_TBOOLEAN       <span class="comment">// boolean</span></span><br><span class="line">LUA_TSTRING        <span class="comment">// string</span></span><br><span class="line">LUA_TTABLE         <span class="comment">// table</span></span><br><span class="line">LUA_TFUNCTION      <span class="comment">// function</span></span><br><span class="line">LUA_TUSERDATA      <span class="comment">// userdata</span></span><br><span class="line">LUA_TTHREAD        <span class="comment">// thread</span></span><br><span class="line">LUA_TLIGHTUSERDATA <span class="comment">// light userdata</span></span><br></pre></td></tr></table></figure>

<h4 id="B-3-å€¼å‹æ ˆ"><a href="#B-3-å€¼å‹æ ˆ" class="headerlink" title="B.3 å€¼å‹æ ˆ"></a>B.3 å€¼å‹æ ˆ</h4><table>
<thead>
<tr>
<th>API</th>
<th>åŠŸèƒ½</th>
<th>å‹å…¥ç±»å‹</th>
<th>æ ˆå˜åŒ–</th>
</tr>
</thead>
<tbody><tr>
<td><code>lua_pushnil(L)</code></td>
<td>å‹å…¥nil</td>
<td>nil</td>
<td><code>+1</code></td>
</tr>
<tr>
<td><code>lua_pushboolean(L, b)</code></td>
<td>å‹å…¥bool</td>
<td>boolean</td>
<td><code>+1</code></td>
</tr>
<tr>
<td><code>lua_pushinteger(L, n)</code></td>
<td>å‹å…¥æ•´æ•°</td>
<td>integer</td>
<td><code>+1</code></td>
</tr>
<tr>
<td><code>lua_pushnumber(L, n)</code></td>
<td>å‹å…¥æµ®ç‚¹</td>
<td>number</td>
<td><code>+1</code></td>
</tr>
<tr>
<td><code>lua_pushstring(L, s)</code></td>
<td>å‹å…¥å­—ç¬¦ä¸²</td>
<td>string</td>
<td><code>+1</code></td>
</tr>
<tr>
<td><code>lua_pushlstring(L, s, len)</code></td>
<td>å‹å…¥å®šé•¿å­—ç¬¦ä¸²</td>
<td>string</td>
<td><code>+1</code></td>
</tr>
<tr>
<td><code>lua_pushcfunction(L, f)</code></td>
<td>å‹å…¥Cå‡½æ•°</td>
<td>function</td>
<td><code>+1</code></td>
</tr>
<tr>
<td><code>lua_pushcclosure(L, f, n)</code></td>
<td>å‹å…¥é—­åŒ…</td>
<td>function</td>
<td><code>+1-n</code></td>
</tr>
<tr>
<td><code>lua_pushlightuserdata(L, p)</code></td>
<td>å‹å…¥è½»é‡userdata</td>
<td>lightuserdata</td>
<td><code>+1</code></td>
</tr>
<tr>
<td><code>lua_pushthread(L)</code></td>
<td>å‹å…¥çº¿ç¨‹</td>
<td>thread</td>
<td><code>+1</code></td>
</tr>
</tbody></table>
<h4 id="B-4-è¡¨æ“ä½œ"><a href="#B-4-è¡¨æ“ä½œ" class="headerlink" title="B.4 è¡¨æ“ä½œ"></a>B.4 è¡¨æ“ä½œ</h4><table>
<thead>
<tr>
<th>API</th>
<th>åŠŸèƒ½</th>
<th>æ ˆå˜åŒ–</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>lua_newtable(L)</code></td>
<td>åˆ›å»ºç©ºè¡¨</td>
<td><code>+1</code></td>
<td>ç­‰ä»·äº <code>lua_createtable(L,0,0)</code></td>
</tr>
<tr>
<td><code>lua_createtable(L, narr, nrec)</code></td>
<td>åˆ›å»ºè¡¨(é¢„åˆ†é…)</td>
<td><code>+1</code></td>
<td>ä¼˜åŒ–æ€§èƒ½</td>
</tr>
<tr>
<td><code>lua_gettable(L, idx)</code></td>
<td>è·å– t[k]</td>
<td><code>0</code></td>
<td>å¼¹å‡ºk,å‹å…¥v</td>
</tr>
<tr>
<td><code>lua_settable(L, idx)</code></td>
<td>è®¾ç½® t[k]&#x3D;v</td>
<td><code>-2</code></td>
<td>å¼¹å‡ºkå’Œv</td>
</tr>
<tr>
<td><code>lua_getfield(L, idx, k)</code></td>
<td>è·å– t[k]</td>
<td><code>+1</code></td>
<td>kæ˜¯Cå­—ç¬¦ä¸²</td>
</tr>
<tr>
<td><code>lua_setfield(L, idx, k)</code></td>
<td>è®¾ç½® t[k]&#x3D;v</td>
<td><code>-1</code></td>
<td>å¼¹å‡ºv</td>
</tr>
<tr>
<td><code>lua_rawget(L, idx)</code></td>
<td>è·å–(æ— å…ƒæ–¹æ³•)</td>
<td><code>0</code></td>
<td>åŒgettable</td>
</tr>
<tr>
<td><code>lua_rawset(L, idx)</code></td>
<td>è®¾ç½®(æ— å…ƒæ–¹æ³•)</td>
<td><code>-2</code></td>
<td>åŒsettable</td>
</tr>
<tr>
<td><code>lua_rawgeti(L, idx, n)</code></td>
<td>è·å– t[n]</td>
<td><code>+1</code></td>
<td>næ˜¯æ•´æ•°</td>
</tr>
<tr>
<td><code>lua_rawseti(L, idx, n)</code></td>
<td>è®¾ç½® t[n]&#x3D;v</td>
<td><code>-1</code></td>
<td>næ˜¯æ•´æ•°</td>
</tr>
<tr>
<td><code>lua_next(L, idx)</code></td>
<td>éå†è¡¨</td>
<td><code>+1æˆ–0</code></td>
<td>è¿­ä»£å™¨</td>
</tr>
</tbody></table>
<h4 id="B-5-å…ƒè¡¨æ“ä½œ"><a href="#B-5-å…ƒè¡¨æ“ä½œ" class="headerlink" title="B.5 å…ƒè¡¨æ“ä½œ"></a>B.5 å…ƒè¡¨æ“ä½œ</h4><table>
<thead>
<tr>
<th>API</th>
<th>åŠŸèƒ½</th>
<th>æ ˆå˜åŒ–</th>
<th>è¿”å›å€¼</th>
</tr>
</thead>
<tbody><tr>
<td><code>lua_getmetatable(L, idx)</code></td>
<td>è·å–å…ƒè¡¨</td>
<td><code>+1</code></td>
<td>1æœ‰å…ƒè¡¨,0æ— </td>
</tr>
<tr>
<td><code>lua_setmetatable(L, idx)</code></td>
<td>è®¾ç½®å…ƒè¡¨</td>
<td><code>-1</code></td>
<td>1</td>
</tr>
<tr>
<td><code>luaL_getmetatable(L, name)</code></td>
<td>è·å–å‘½åå…ƒè¡¨</td>
<td><code>+1</code></td>
<td>ç±»å‹ç </td>
</tr>
<tr>
<td><code>luaL_newmetatable(L, name)</code></td>
<td>åˆ›å»ºå‘½åå…ƒè¡¨</td>
<td><code>+1</code></td>
<td>1æ–°å»º,0å·²å­˜åœ¨</td>
</tr>
<tr>
<td><code>luaL_setmetatable(L, name)</code></td>
<td>è®¾ç½®å‘½åå…ƒè¡¨</td>
<td><code>0</code></td>
<td>void</td>
</tr>
<tr>
<td><code>luaL_getmetafield(L, obj, e)</code></td>
<td>è·å–å…ƒæ–¹æ³•</td>
<td><code>+1æˆ–0</code></td>
<td>ç±»å‹ç æˆ–0</td>
</tr>
</tbody></table>
<p><strong>å…ƒæ–¹æ³•åç§°</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;__index&quot;</span>      <span class="comment">// ç´¢å¼•è¯»å–</span></span><br><span class="line"><span class="string">&quot;__newindex&quot;</span>   <span class="comment">// ç´¢å¼•å†™å…¥</span></span><br><span class="line"><span class="string">&quot;__gc&quot;</span>         <span class="comment">// åƒåœ¾å›æ”¶</span></span><br><span class="line"><span class="string">&quot;__tostring&quot;</span>   <span class="comment">// tostring()</span></span><br><span class="line"><span class="string">&quot;__call&quot;</span>       <span class="comment">// å‡½æ•°è°ƒç”¨</span></span><br><span class="line"><span class="string">&quot;__eq&quot;</span>         <span class="comment">// ==</span></span><br><span class="line"><span class="string">&quot;__lt&quot;</span>         <span class="comment">// &lt;</span></span><br><span class="line"><span class="string">&quot;__le&quot;</span>         <span class="comment">// &lt;=</span></span><br><span class="line"><span class="string">&quot;__add&quot;</span>        <span class="comment">// +</span></span><br><span class="line"><span class="string">&quot;__sub&quot;</span>        <span class="comment">// -</span></span><br><span class="line"><span class="string">&quot;__mul&quot;</span>        <span class="comment">// *</span></span><br><span class="line"><span class="string">&quot;__div&quot;</span>        <span class="comment">// /</span></span><br><span class="line"><span class="string">&quot;__mod&quot;</span>        <span class="comment">// %</span></span><br><span class="line"><span class="string">&quot;__pow&quot;</span>        <span class="comment">// ^</span></span><br><span class="line"><span class="string">&quot;__unm&quot;</span>        <span class="comment">// - (ä¸€å…ƒ)</span></span><br><span class="line"><span class="string">&quot;__concat&quot;</span>     <span class="comment">// ..</span></span><br><span class="line"><span class="string">&quot;__len&quot;</span>        <span class="comment">// #</span></span><br><span class="line"><span class="string">&quot;__pairs&quot;</span>      <span class="comment">// pairs()</span></span><br><span class="line"><span class="string">&quot;__ipairs&quot;</span>     <span class="comment">// ipairs()</span></span><br></pre></td></tr></table></figure>

<h4 id="B-6-å‡½æ•°è°ƒç”¨"><a href="#B-6-å‡½æ•°è°ƒç”¨" class="headerlink" title="B.6 å‡½æ•°è°ƒç”¨"></a>B.6 å‡½æ•°è°ƒç”¨</h4><table>
<thead>
<tr>
<th>API</th>
<th>åŠŸèƒ½</th>
<th>æ ˆå˜åŒ–</th>
<th>é”™è¯¯å¤„ç†</th>
</tr>
</thead>
<tbody><tr>
<td><code>lua_call(L, nargs, nresults)</code></td>
<td>è°ƒç”¨å‡½æ•°</td>
<td><code>-(nargs+1), +nresults</code></td>
<td>é”™è¯¯å‘ä¸Šä¼ æ’­</td>
</tr>
<tr>
<td><code>lua_pcall(L, nargs, nresults, errfunc)</code></td>
<td>ä¿æŠ¤è°ƒç”¨</td>
<td>åŒä¸Š</td>
<td>æ•è·é”™è¯¯</td>
</tr>
<tr>
<td><code>lua_callk(...)</code></td>
<td>å¯ç»­è°ƒç”¨</td>
<td>åŒcall</td>
<td>Lua 5.2+</td>
</tr>
<tr>
<td><code>lua_pcallk(...)</code></td>
<td>å¯ç»­ä¿æŠ¤è°ƒç”¨</td>
<td>åŒpcall</td>
<td>Lua 5.2+</td>
</tr>
<tr>
<td><code>luaL_loadstring(L, s)</code></td>
<td>åŠ è½½Luaä»£ç </td>
<td><code>+1</code></td>
<td>è¿”å›é”™è¯¯ç </td>
</tr>
<tr>
<td><code>luaL_dostring(L, s)</code></td>
<td>åŠ è½½å¹¶æ‰§è¡Œ</td>
<td><code>0</code></td>
<td>è¿”å›é”™è¯¯ç </td>
</tr>
</tbody></table>
<p><strong>lua_pcall é”™è¯¯ç </strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LUA_OK        <span class="comment">// 0 - æˆåŠŸ</span></span><br><span class="line">LUA_ERRRUN    <span class="comment">// è¿è¡Œæ—¶é”™è¯¯</span></span><br><span class="line">LUA_ERRMEM    <span class="comment">// å†…å­˜åˆ†é…é”™è¯¯</span></span><br><span class="line">LUA_ERRERR    <span class="comment">// é”™è¯¯å¤„ç†å‡½æ•°å‡ºé”™</span></span><br><span class="line">LUA_ERRGCMM   <span class="comment">// GCå…ƒæ–¹æ³•é”™è¯¯</span></span><br><span class="line">LUA_ERRSYNTAX <span class="comment">// è¯­æ³•é”™è¯¯ (ä»…loadstring)</span></span><br></pre></td></tr></table></figure>

<h4 id="B-7-å¼•ç”¨ç³»ç»Ÿ"><a href="#B-7-å¼•ç”¨ç³»ç»Ÿ" class="headerlink" title="B.7 å¼•ç”¨ç³»ç»Ÿ"></a>B.7 å¼•ç”¨ç³»ç»Ÿ</h4><table>
<thead>
<tr>
<th>API</th>
<th>åŠŸèƒ½</th>
<th>è¿”å›å€¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>luaL_ref(L, idx)</code></td>
<td>åˆ›å»ºå¼•ç”¨</td>
<td>int</td>
<td>å¼¹å‡ºæ ˆé¡¶,è¿”å›ID</td>
</tr>
<tr>
<td><code>luaL_unref(L, idx, ref)</code></td>
<td>é‡Šæ”¾å¼•ç”¨</td>
<td>void</td>
<td>å…è®¸GCå›æ”¶</td>
</tr>
<tr>
<td><code>lua_rawgeti(L, LUA_REGISTRYINDEX, ref)</code></td>
<td>ä½¿ç”¨å¼•ç”¨</td>
<td><code>+1</code></td>
<td>å‹å…¥å¼•ç”¨çš„å€¼</td>
</tr>
</tbody></table>
<p><strong>ç‰¹æ®Šå¼•ç”¨å€¼</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LUA_NOREF   <span class="comment">// æ— æ•ˆå¼•ç”¨ (-2)</span></span><br><span class="line">LUA_REFNIL  <span class="comment">// nilå¼•ç”¨ (-1)</span></span><br></pre></td></tr></table></figure>

<h4 id="B-8-Userdata"><a href="#B-8-Userdata" class="headerlink" title="B.8 Userdata"></a>B.8 Userdata</h4><table>
<thead>
<tr>
<th>API</th>
<th>åŠŸèƒ½</th>
<th>æ ˆå˜åŒ–</th>
<th>è¿”å›å€¼</th>
</tr>
</thead>
<tbody><tr>
<td><code>lua_newuserdata(L, size)</code></td>
<td>åˆ›å»ºuserdata</td>
<td><code>+1</code></td>
<td>void*æŒ‡é’ˆ</td>
</tr>
<tr>
<td><code>lua_touserdata(L, idx)</code></td>
<td>è·å–æŒ‡é’ˆ</td>
<td><code>0</code></td>
<td>void*æˆ–NULL</td>
</tr>
<tr>
<td><code>lua_getuservalue(L, idx)</code></td>
<td>è·å–å…³è”å€¼</td>
<td><code>+1</code></td>
<td>Lua 5.2+</td>
</tr>
<tr>
<td><code>lua_setuservalue(L, idx)</code></td>
<td>è®¾ç½®å…³è”å€¼</td>
<td><code>-1</code></td>
<td>Lua 5.2+</td>
</tr>
</tbody></table>
<h4 id="B-9-é”™è¯¯å¤„ç†"><a href="#B-9-é”™è¯¯å¤„ç†" class="headerlink" title="B.9 é”™è¯¯å¤„ç†"></a>B.9 é”™è¯¯å¤„ç†</h4><table>
<thead>
<tr>
<th>API</th>
<th>åŠŸèƒ½</th>
<th>è¿”å›å€¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>luaL_error(L, fmt, ...)</code></td>
<td>æŠ›å‡ºé”™è¯¯</td>
<td>æ°¸ä¸è¿”å›</td>
<td>long jump</td>
</tr>
<tr>
<td><code>luaL_argerror(L, arg, extramsg)</code></td>
<td>å‚æ•°é”™è¯¯</td>
<td>æ°¸ä¸è¿”å›</td>
<td>æ ‡å‡†æ ¼å¼</td>
</tr>
<tr>
<td><code>luaL_checktype(L, arg, t)</code></td>
<td>æ£€æŸ¥ç±»å‹</td>
<td>void</td>
<td>é”™è¯¯åˆ™æŠ›å‡º</td>
</tr>
<tr>
<td><code>lua_atpanic(L, panicf)</code></td>
<td>è®¾ç½®panicå‡½æ•°</td>
<td>æ—§å‡½æ•°</td>
<td>è‡´å‘½é”™è¯¯</td>
</tr>
</tbody></table>
<h4 id="B-10-å®ç”¨å·¥å…·"><a href="#B-10-å®ç”¨å·¥å…·" class="headerlink" title="B.10 å®ç”¨å·¥å…·"></a>B.10 å®ç”¨å·¥å…·</h4><table>
<thead>
<tr>
<th>API</th>
<th>åŠŸèƒ½</th>
<th>è¿”å›å€¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>luaL_requiref(L, modname, openf, glb)</code></td>
<td>æ³¨å†Œæ¨¡å—</td>
<td>void</td>
<td></td>
</tr>
<tr>
<td><code>luaL_getsubtable(L, idx, fname)</code></td>
<td>è·å–å­è¡¨</td>
<td>int</td>
<td>ä¸å­˜åœ¨åˆ™åˆ›å»º</td>
</tr>
<tr>
<td><code>luaL_len(L, idx)</code></td>
<td>è·å–é•¿åº¦</td>
<td>lua_Integer</td>
<td>ç­‰ä»·äº #</td>
</tr>
<tr>
<td><code>luaL_tolstring(L, idx, len)</code></td>
<td>è½¬å­—ç¬¦ä¸²</td>
<td>const char*</td>
<td>å‹æ ˆ</td>
</tr>
<tr>
<td><code>luaL_traceback(L, L1, msg, level)</code></td>
<td>è·å–æ ˆè·Ÿè¸ª</td>
<td>void</td>
<td>è°ƒè¯•ç”¨</td>
</tr>
</tbody></table>
<p><strong>UnLua å¸¸ç”¨å°è£…</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnLua æä¾›çš„ä¾¿åˆ©å‡½æ•°</span></span><br><span class="line">UnLua::<span class="built_in">GetUObject</span>(L, idx)          <span class="comment">// è·å–UObject</span></span><br><span class="line">UnLua::<span class="built_in">PushUObject</span>(L, Object)       <span class="comment">// å‹å…¥UObject</span></span><br><span class="line">UnLua::<span class="built_in">GetCppInstance</span>(L, idx)       <span class="comment">// è·å–C++å®ä¾‹</span></span><br><span class="line">UnLua::<span class="built_in">IsUObjectValid</span>(Object)       <span class="comment">// æ£€æŸ¥æœ‰æ•ˆæ€§</span></span><br><span class="line">UnLua::<span class="built_in">ReportLuaCallError</span>(L)        <span class="comment">// æŠ¥å‘ŠLuaé”™è¯¯</span></span><br></pre></td></tr></table></figure>

<h4 id="B-11-å¸¸ç”¨ä»£ç æ¨¡å¼"><a href="#B-11-å¸¸ç”¨ä»£ç æ¨¡å¼" class="headerlink" title="B.11 å¸¸ç”¨ä»£ç æ¨¡å¼"></a>B.11 å¸¸ç”¨ä»£ç æ¨¡å¼</h4><p><strong>1. å®‰å…¨çš„å‡½æ•°è°ƒç”¨</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">lua_getglobal</span>(L, <span class="string">&quot;MyFunction&quot;</span>);</span><br><span class="line"><span class="built_in">lua_pushinteger</span>(L, <span class="number">42</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">lua_pcall</span>(L, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>) != LUA_OK) &#123;</span><br><span class="line">    <span class="built_in">UE_LOG</span>(LogUnLua, Error, <span class="built_in">TEXT</span>(<span class="string">&quot;%s&quot;</span>), <span class="built_in">UTF8_TO_TCHAR</span>(<span class="built_in">lua_tostring</span>(L, <span class="number">-1</span>)));</span><br><span class="line">    <span class="built_in">lua_pop</span>(L, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2. åˆ›å»ºè¡¨å¹¶è®¾ç½®å­—æ®µ</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">lua_newtable</span>(L);                    <span class="comment">// åˆ›å»ºç©ºè¡¨</span></span><br><span class="line"><span class="built_in">lua_pushstring</span>(L, <span class="string">&quot;name&quot;</span>);          <span class="comment">// key</span></span><br><span class="line"><span class="built_in">lua_pushstring</span>(L, <span class="string">&quot;MyActor&quot;</span>);       <span class="comment">// value</span></span><br><span class="line"><span class="built_in">lua_rawset</span>(L, <span class="number">-3</span>);                  <span class="comment">// table.name = &quot;MyActor&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>3. éå†è¡¨</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">lua_pushnil</span>(L);  <span class="comment">// é¦–ä¸ªkey</span></span><br><span class="line"><span class="keyword">while</span> (<span class="built_in">lua_next</span>(L, <span class="number">-2</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// æ ˆ: [..., table, key, value]</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* key = <span class="built_in">lua_tostring</span>(L, <span class="number">-2</span>);</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* val = <span class="built_in">lua_tostring</span>(L, <span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s = %s\n&quot;</span>, key, val);</span><br><span class="line">    <span class="built_in">lua_pop</span>(L, <span class="number">1</span>);  <span class="comment">// å¼¹å‡ºvalue,ä¿ç•™key</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>4. åˆ›å»ºå¼•ç”¨æŒä¹…åŒ–å¯¹è±¡</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">lua_newtable</span>(L);</span><br><span class="line"><span class="type">int</span> ref = <span class="built_in">luaL_ref</span>(L, LUA_REGISTRYINDEX);</span><br><span class="line"><span class="comment">// ... ç¨åä½¿ç”¨ ...</span></span><br><span class="line"><span class="built_in">lua_rawgeti</span>(L, LUA_REGISTRYINDEX, ref);</span><br><span class="line"><span class="comment">// ... ä½¿ç”¨å®Œæ¯• ...</span></span><br><span class="line"><span class="built_in">luaL_unref</span>(L, LUA_REGISTRYINDEX, ref);</span><br></pre></td></tr></table></figure>

<p><strong>5. åˆ›å»ºå¸¦å…ƒè¡¨çš„ Userdata</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span>* udata = <span class="built_in">lua_newuserdata</span>(L, <span class="built_in">sizeof</span>(MyData));</span><br><span class="line"><span class="keyword">new</span>(udata) <span class="built_in">MyData</span>();  <span class="comment">// placement new</span></span><br><span class="line"><span class="built_in">luaL_setmetatable</span>(L, <span class="string">&quot;MyData&quot;</span>);  <span class="comment">// è®¾ç½®å…ƒè¡¨</span></span><br></pre></td></tr></table></figure>

<h3 id="C-æ€§èƒ½åŸºå‡†æµ‹è¯•"><a href="#C-æ€§èƒ½åŸºå‡†æµ‹è¯•" class="headerlink" title="C. æ€§èƒ½åŸºå‡†æµ‹è¯•"></a>C. æ€§èƒ½åŸºå‡†æµ‹è¯•</h3><table>
<thead>
<tr>
<th>æµ‹è¯•åœºæ™¯</th>
<th>è€—æ—¶ (Î¼s)</th>
<th>å¯¹æ¯” C++</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td><strong>ç©ºå‡½æ•°è°ƒç”¨</strong></td>
<td>0.8</td>
<td>16x</td>
<td>Lua VM å¼€é”€</td>
</tr>
<tr>
<td><strong>å±æ€§è¯»å–</strong></td>
<td>1.2</td>
<td>24x</td>
<td>åŒ…å«åå°„æŸ¥æ‰¾</td>
</tr>
<tr>
<td><strong>å®¹å™¨éå† (1000 å…ƒç´ )</strong></td>
<td>450</td>
<td>5x</td>
<td>é›¶æ‹·è´ä¼˜åŒ–å</td>
</tr>
<tr>
<td><strong>å¯¹è±¡åˆ›å»º (Userdata)</strong></td>
<td>2.0</td>
<td>40x</td>
<td>åŒ…å«å…ƒè¡¨è®¾ç½®</td>
</tr>
</tbody></table>
<h3 id="D-å¸¸è§é—®é¢˜æ’æŸ¥"><a href="#D-å¸¸è§é—®é¢˜æ’æŸ¥" class="headerlink" title="D. å¸¸è§é—®é¢˜æ’æŸ¥"></a>D. å¸¸è§é—®é¢˜æ’æŸ¥</h3><table>
<thead>
<tr>
<th>é—®é¢˜</th>
<th>åŸå› </th>
<th>è§£å†³æ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody><tr>
<td><strong>â€œattempt to read property on released objectâ€</strong></td>
<td>UObject è¢«é”€æ¯å Lua ä»æŒæœ‰å¼•ç”¨</td>
<td>æ£€æŸ¥å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ</td>
</tr>
<tr>
<td><strong>Lua æ ˆæº¢å‡º</strong></td>
<td>é€’å½’è°ƒç”¨è¿‡æ·±</td>
<td>æ£€æŸ¥è°ƒç”¨æ ˆ</td>
</tr>
<tr>
<td><strong>å†…å­˜æ³„æ¼</strong></td>
<td>å…¨å±€ table æŒæœ‰å¯¹è±¡å¼•ç”¨</td>
<td>ä½¿ç”¨å¼±å¼•ç”¨</td>
</tr>
<tr>
<td><strong>çƒ­æ›´æ–°ä¸ç”Ÿæ•ˆ</strong></td>
<td><code>package.loaded</code> æœªæ¸…é™¤</td>
<td>è°ƒç”¨ <code>UnLua.HotReload()</code></td>
</tr>
</tbody></table>
<hr>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>UnLua ä½œä¸ºæˆç†Ÿçš„ UE-Lua ç»‘å®šæ–¹æ¡ˆï¼Œå…¶æ ¸å¿ƒä¼˜åŠ¿åœ¨äºï¼š</p>
<ol>
<li><strong>é›¶ä¾µå…¥æ€§</strong>: æ— éœ€ä¿®æ”¹ UE å¼•æ“ä»£ç </li>
<li><strong>é«˜æ€§èƒ½</strong>: é€šè¿‡ç¼“å­˜ã€æ± åŒ–ã€é›¶æ‹·è´ç­‰æŠ€æœ¯ä¼˜åŒ–</li>
<li><strong>å®‰å…¨æ€§</strong>: å®Œå–„çš„ GC ååŒå’Œæ‚¬ç©ºæŒ‡é’ˆé˜²æŠ¤</li>
<li><strong>çµæ´»æ€§</strong>: æ”¯æŒé™æ€&#x2F;åŠ¨æ€&#x2F;åå°„å¤šç§å¯¼å‡ºæ–¹å¼</li>
</ol>
<p><strong>æ ¸å¿ƒè®¾è®¡å“²å­¦</strong>:</p>
<ul>
<li><strong>æŒ‰éœ€åŠ è½½</strong>: åå°„ç±»å‹æ‡’åŠ è½½ï¼Œå‡å°‘å¯åŠ¨å¼€é”€</li>
<li><strong>åŒå‘é€æ˜</strong>: Lua å’Œ C++ ç›¸äº’è°ƒç”¨æ— æ„ŸçŸ¥</li>
<li><strong>ç”Ÿå‘½å‘¨æœŸåŒæ­¥</strong>: åŒé‡ GC ååŒï¼Œé˜²æ­¢å†…å­˜æ³„æ¼</li>
</ul>
<p><strong>æ¨èå®è·µ</strong>:</p>
<ul>
<li>æ ¸å¿ƒé€»è¾‘ç”¨ C++ï¼Œæ¸¸æˆç©æ³•ç”¨ Lua</li>
<li>é«˜é¢‘è°ƒç”¨å‡½æ•°ä½¿ç”¨é™æ€å¯¼å‡º</li>
<li>åˆç†ä½¿ç”¨å®¹å™¨å¼•ç”¨ä¼ é€’</li>
<li>å®šæœŸæ‰§è¡Œ GC å’Œæ€§èƒ½åˆ†æ</li>
</ul>
<p><strong>æœ¬æ–‡æ¡£ç‰¹è‰²</strong>:</p>
<ul>
<li>âœ… <strong>æºç çº§åˆ†æ</strong>: æ¯ä¸ªæŠ€æœ¯ç‚¹éƒ½é™„å¸¦å®Œæ•´æºç å‰–æ</li>
<li>âœ… <strong>Lua C API è¯¦è§£</strong>: åœ¨ä½¿ç”¨å¤„å°±åœ°è®²è§£ç›¸å…³ API ç”¨æ³•</li>
<li>âœ… <strong>æ ˆæ“ä½œå¯è§†åŒ–</strong>: æ¸…æ™°å±•ç¤ºæ¯ä¸€æ­¥çš„æ ˆå˜åŒ–è¿‡ç¨‹</li>
<li>âœ… <strong>å®æˆ˜ç¤ºä¾‹ä¸°å¯Œ</strong>: åŒ…å« C++ å’Œ Lua åŒå‘ä»£ç å¯¹ç…§</li>
<li>âœ… <strong>æ€§èƒ½æ•°æ®æ”¯æ’‘</strong>: æä¾›çœŸå®çš„æ€§èƒ½åŸºå‡†æµ‹è¯•æ•°æ®</li>
</ul>
<p><strong>æ–‡æ¡£æ›´æ–°æ—¥å¿—</strong>:</p>
<ul>
<li><strong>v2.0 (2025-11-29)</strong>: å…¨é¢ä¼˜åŒ–,å°† Lua C API è®²è§£èå…¥å„ç« èŠ‚<ul>
<li>æ–°å¢: Metatable æ“ä½œ API è¯¦è§£ (4.2.2)</li>
<li>æ–°å¢: å¼•ç”¨ç³»ç»Ÿæ·±åº¦å‰–æ (4.3.1)</li>
<li>æ–°å¢: æ ˆæ“ä½œåŸºç¡€ä¸å¯è§†åŒ– (5.3.1)</li>
<li>æ–°å¢: å‡½æ•°è°ƒç”¨ API è¯¦è§£ (5.1.1)</li>
<li>æ–°å¢: Userdata äºŒçº§æŒ‡é’ˆæœºåˆ¶ (7.2.1)</li>
<li>æ–°å¢: TArray å®Œæ•´å®ç°æºç  (6.3.2)</li>
<li>æ–°å¢: Lua C API é€ŸæŸ¥æ‰‹å†Œ (é™„å½•B)</li>
</ul>
</li>
<li><strong>v2.2 (2025-11-29)</strong>: è¡¥å……ç”¨æˆ·ç¬”è®°é‡ç‚¹<ul>
<li>æ–°å¢: Lua C API åŸºç¡€æ¦‚å¿µ (ç¬¬ 0 ç« )</li>
<li>æ–°å¢: è¦†å†™å‡½æ•°å®Œæ•´æµç¨‹ (ç¬¬ 5.2.1-5.2.2 èŠ‚)</li>
<li>æ–°å¢: GetField æ ˆæ“ä½œå®Œæ•´å¯è§†åŒ– (ç¬¬ 5.3.3 èŠ‚)</li>
<li>æ–°å¢: é™æ€å¯¼å‡ºå…¨å±€æ„é€ æœºåˆ¶ (ç¬¬ 2.1.2-2.1.4 èŠ‚)</li>
<li>æ–°å¢: è¡¥å……è¯´æ˜ç« èŠ‚ (æ–‡æ¡£æœ«å°¾)</li>
</ul>
</li>
</ul>
<hr>
<h2 id="è¡¥å……è¯´æ˜"><a href="#è¡¥å……è¯´æ˜" class="headerlink" title="è¡¥å……è¯´æ˜"></a>è¡¥å……è¯´æ˜</h2><p>æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æäº† UnLua çš„æ ¸å¿ƒå®ç°æœºåˆ¶ï¼ŒåŒ…å«å®Œæ•´çš„æºç å‰–æå’Œ Lua C API è®²è§£ã€‚</p>
<h3 id="æ ¸å¿ƒæŠ€æœ¯è¦ç‚¹æ€»ç»“"><a href="#æ ¸å¿ƒæŠ€æœ¯è¦ç‚¹æ€»ç»“" class="headerlink" title="æ ¸å¿ƒæŠ€æœ¯è¦ç‚¹æ€»ç»“"></a>æ ¸å¿ƒæŠ€æœ¯è¦ç‚¹æ€»ç»“</h3><h4 id="1-æ³¨å†Œè¡¨æ˜¯ä¸€åˆ‡çš„åŸºç¡€"><a href="#1-æ³¨å†Œè¡¨æ˜¯ä¸€åˆ‡çš„åŸºç¡€" class="headerlink" title="1. æ³¨å†Œè¡¨æ˜¯ä¸€åˆ‡çš„åŸºç¡€"></a>1. æ³¨å†Œè¡¨æ˜¯ä¸€åˆ‡çš„åŸºç¡€</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ³¨å†Œè¡¨å­˜å‚¨:</span></span><br><span class="line">LUA_REGISTRYINDEX = &#123;</span><br><span class="line">    [<span class="string">&quot;å‘½åå…ƒè¡¨&quot;</span>] = &#123;UObject, AActor, ...&#125;,</span><br><span class="line">    [<span class="string">&quot;å¯¹è±¡å¼•ç”¨&quot;</span>] = &#123;[<span class="number">1</span>]=table, [<span class="number">2</span>]=function, ...&#125;,</span><br><span class="line">    [<span class="string">&quot;å…¨å±€çŠ¶æ€&quot;</span>] = &#123;UnLua_ObjectMap, ...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-è¦†å†™å‡½æ•°çš„æœ¬è´¨"><a href="#2-è¦†å†™å‡½æ•°çš„æœ¬è´¨" class="headerlink" title="2. è¦†å†™å‡½æ•°çš„æœ¬è´¨"></a>2. è¦†å†™å‡½æ•°çš„æœ¬è´¨</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸå§‹è°ƒç”¨é“¾:</span></span><br><span class="line"><span class="built_in">SpawnText</span>() â†’ FindFunctionChecked â†’ ProcessEvent â†’ æ‰§è¡Œè“å›¾å­—èŠ‚ç </span><br><span class="line"></span><br><span class="line"><span class="comment">// Lua è¦†å†™å:</span></span><br><span class="line"><span class="built_in">SpawnText</span>() â†’ <span class="built_in">FindFunctionChecked</span>(è¿”å›ULuaFunction) </span><br><span class="line">           â†’ ProcessEvent â†’ execCallLua </span><br><span class="line">           â†’ lua_pcall â†’ Lua å‡½æ•°</span><br></pre></td></tr></table></figure>

<h4 id="3-æ ˆæ“ä½œçš„æ ¸å¿ƒæ¨¡å¼"><a href="#3-æ ˆæ“ä½œçš„æ ¸å¿ƒæ¨¡å¼" class="headerlink" title="3. æ ˆæ“ä½œçš„æ ¸å¿ƒæ¨¡å¼"></a>3. æ ˆæ“ä½œçš„æ ¸å¿ƒæ¨¡å¼</h4><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>. æŸ¥æ‰¾: lua_getmetatable â†’ lua_rawget</span><br><span class="line"><span class="number">2</span>. æ³¨å†Œ: lua_newuserdata â†’ lua_pushcclosure</span><br><span class="line"><span class="number">3</span>. ç¼“å­˜: lua_rawset (é¿å…é‡å¤åˆ›å»º)</span><br><span class="line"><span class="number">4</span>. æ¸…ç†: lua_<span class="comment">remove / lua_pop</span></span><br></pre></td></tr></table></figure>

<h4 id="4-é™æ€å¯¼å‡ºçš„æ—¶æœº"><a href="#4-é™æ€å¯¼å‡ºçš„æ—¶æœº" class="headerlink" title="4. é™æ€å¯¼å‡ºçš„æ—¶æœº"></a>4. é™æ€å¯¼å‡ºçš„æ—¶æœº</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">ç¼–è¯‘æœŸ: å®å±•å¼€ â†’ å…¨å±€å¯¹è±¡å®šä¹‰</span></span><br><span class="line"><span class="section">é“¾æ¥æœŸ: åˆå¹¶æ‰€æœ‰å…¨å±€å¯¹è±¡</span></span><br><span class="line"><span class="section">åŠ è½½æœŸ: æ‰§è¡Œå…¨å±€æ„é€ å‡½æ•° (main ä¹‹å‰)</span></span><br><span class="line"><span class="section">è¿è¡ŒæœŸ: FLuaEnv::Initialize éå†å®¹å™¨</span></span><br></pre></td></tr></table></figure>

<h3 id="å…³é”®æ•°æ®ç»“æ„"><a href="#å…³é”®æ•°æ®ç»“æ„" class="headerlink" title="å…³é”®æ•°æ®ç»“æ„"></a>å…³é”®æ•°æ®ç»“æ„</h3><h4 id="1-ULuaFunction-æˆå‘˜å˜é‡"><a href="#1-ULuaFunction-æˆå‘˜å˜é‡" class="headerlink" title="1. ULuaFunction æˆå‘˜å˜é‡"></a>1. ULuaFunction æˆå‘˜å˜é‡</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ULuaFunction</span> : <span class="keyword">public</span> UFunction</span><br><span class="line">&#123;</span><br><span class="line">    TWeakObjectPtr&lt;UFunction&gt; From;      <span class="comment">// åŸå§‹å‡½æ•°å¼•ç”¨</span></span><br><span class="line">    UFunction* Overridden;               <span class="comment">// å¤‡ä»½çš„åŸå§‹å®ç°</span></span><br><span class="line">    <span class="type">bool</span> bActivated;                     <span class="comment">// æ˜¯å¦å·²æ¿€æ´»</span></span><br><span class="line">    <span class="type">bool</span> bAdded;                         <span class="comment">// æ˜¯å¦æ–°å¢åˆ° FuncMap</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="2-FFunctionDesc-è°ƒç”¨é“¾"><a href="#2-FFunctionDesc-è°ƒç”¨é“¾" class="headerlink" title="2. FFunctionDesc è°ƒç”¨é“¾"></a>2. FFunctionDesc è°ƒç”¨é“¾</h4><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Lua â†’ Class_C<span class="literal">all</span>UFunction </span><br><span class="line">    â†’ FFunctionDesc::C<span class="literal">all</span>UE </span><br><span class="line">    â†’ PreC<span class="literal">all</span> (å‚æ•°è½¬æ¢) </span><br><span class="line">    â†’ ProcessEvent </span><br><span class="line">    â†’ PostC<span class="literal">all</span> (è¿”å›å€¼)</span><br></pre></td></tr></table></figure>

<h4 id="3-Closure-ç»“æ„"><a href="#3-Closure-ç»“æ„" class="headerlink" title="3. Closure ç»“æ„"></a>3. Closure ç»“æ„</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Lua è§†è§’</span></span><br><span class="line">function_closure = &#123;</span><br><span class="line">    c_function = Class_CallUFunction,  <span class="comment">-- C å‡½æ•°å…¥å£</span></span><br><span class="line">    upvalue[<span class="number">1</span>] = FFunctionDesc*        <span class="comment">-- å‡½æ•°æè¿°ç¬¦</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- C++ è§†è§’</span></span><br><span class="line">lua_pushcclosure(L, Class_CallUFunction, <span class="number">1</span>);</span><br><span class="line"><span class="comment">-- æ ˆé¡¶çš„ 1 ä¸ªå€¼ä½œä¸º upvalue è¢«æ•è·</span></span><br></pre></td></tr></table></figure>

<h3 id="è°ƒè¯•æŠ€å·§"><a href="#è°ƒè¯•æŠ€å·§" class="headerlink" title="è°ƒè¯•æŠ€å·§"></a>è°ƒè¯•æŠ€å·§</h3><h4 id="1-æŸ¥çœ‹æ ˆå†…å®¹"><a href="#1-æŸ¥çœ‹æ ˆå†…å®¹" class="headerlink" title="1. æŸ¥çœ‹æ ˆå†…å®¹"></a>1. æŸ¥çœ‹æ ˆå†…å®¹</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrintStack</span><span class="params">(lua_State* L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> top = <span class="built_in">lua_gettop</span>(L);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= top; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> t = <span class="built_in">lua_type</span>(L, i);</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogUnLua, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;[%d] %s: %s&quot;</span>), </span><br><span class="line">               i, </span><br><span class="line">               <span class="built_in">UTF8_TO_TCHAR</span>(<span class="built_in">lua_typename</span>(L, t)),</span><br><span class="line">               <span class="built_in">UTF8_TO_TCHAR</span>(<span class="built_in">luaL_tolstring</span>(L, i, <span class="literal">NULL</span>)));</span><br><span class="line">        <span class="built_in">lua_pop</span>(L, <span class="number">1</span>);  <span class="comment">// å¼¹å‡º tolstring çš„ç»“æœ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-æ£€æŸ¥è¦†å†™çŠ¶æ€"><a href="#2-æ£€æŸ¥è¦†å†™çŠ¶æ€" class="headerlink" title="2. æ£€æŸ¥è¦†å†™çŠ¶æ€"></a>2. æ£€æŸ¥è¦†å†™çŠ¶æ€</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">UFunction* Func = Class-&gt;<span class="built_in">FindFunctionByName</span>(<span class="string">&quot;SpawnText&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (Func)</span><br><span class="line">&#123;</span><br><span class="line">    ULuaFunction* LuaFunc = <span class="built_in">Cast</span>&lt;ULuaFunction&gt;(Func);</span><br><span class="line">    <span class="keyword">if</span> (LuaFunc)</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogUnLua, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;å‡½æ•°å·²è¢« Lua è¦†å†™&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-è¿½è¸ª-Lua-è°ƒç”¨"><a href="#3-è¿½è¸ª-Lua-è°ƒç”¨" class="headerlink" title="3. è¿½è¸ª Lua è°ƒç”¨"></a>3. è¿½è¸ª Lua è°ƒç”¨</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- åœ¨ Lua ä¸­æ‰“å°è°ƒç”¨æ ˆ</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">traceback</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">debug</span>.<span class="built_in">traceback</span>())</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<hr>
<p><strong>æ–‡æ¡£å®Œæˆ</strong> | ç‰ˆæœ¬ v2.2 (æœ€ç»ˆä¿®è®¢) | 2025-11-29</p>
<h3 id="æ–‡æ¡£è´¨é‡æ”¹è¿›-æœ€ç»ˆä¿®è®¢"><a href="#æ–‡æ¡£è´¨é‡æ”¹è¿›-æœ€ç»ˆä¿®è®¢" class="headerlink" title="æ–‡æ¡£è´¨é‡æ”¹è¿› (æœ€ç»ˆä¿®è®¢)"></a>æ–‡æ¡£è´¨é‡æ”¹è¿› (æœ€ç»ˆä¿®è®¢)</h3><p>æœ¬æ¬¡ä¿®è®¢ä¿®å¤äº†ä»¥ä¸‹é—®é¢˜ï¼š</p>
<h4 id="1-æ ¼å¼é—®é¢˜ä¿®å¤"><a href="#1-æ ¼å¼é—®é¢˜ä¿®å¤" class="headerlink" title="1. æ ¼å¼é—®é¢˜ä¿®å¤"></a>1. æ ¼å¼é—®é¢˜ä¿®å¤</h4><ul>
<li>âœ… ä¿®å¤ç« èŠ‚ç¼–å·å†²çª (5.2.2 é‡å¤)</li>
<li>âœ… åˆ é™¤é‡å¤çš„ 5.3.2 èŠ‚</li>
<li>âœ… åˆ é™¤é‡å¤çš„â€æ–‡æ¡£å®Œæˆâ€æ ‡è®°</li>
<li>âœ… åˆ é™¤é‡å¤çš„ v2.2 æ–°å¢å†…å®¹è¯´æ˜</li>
</ul>
<h4 id="2-æºç è¡Œå·ä¿®æ­£"><a href="#2-æºç è¡Œå·ä¿®æ­£" class="headerlink" title="2. æºç è¡Œå·ä¿®æ­£"></a>2. æºç è¡Œå·ä¿®æ­£</h4><ul>
<li>âœ… <code>ClassRegistry.cpp:115</code> â†’ <code>ClassRegistry.cpp:108</code></li>
<li>âœ… <code>ObjectRegistry.cpp:116</code> â†’ <code>ObjectRegistry.cpp:113</code></li>
<li>âœ… <code>LuaCore.cpp:1212</code> â†’ <code>LuaCore.cpp:1196</code></li>
<li>âœ… <code>LuaCore.cpp:1235</code> â†’ <code>LuaCore.cpp:1226</code></li>
</ul>
<h4 id="3-ç« èŠ‚ç¼–å·è§„èŒƒåŒ–"><a href="#3-ç« èŠ‚ç¼–å·è§„èŒƒåŒ–" class="headerlink" title="3. ç« èŠ‚ç¼–å·è§„èŒƒåŒ–"></a>3. ç« èŠ‚ç¼–å·è§„èŒƒåŒ–</h4><ul>
<li><code>5.2.1</code>: C++ è°ƒç”¨è¦†å†™å‡½æ•°çš„å®Œæ•´æµç¨‹</li>
<li><code>5.2.2</code>: è¦†å†™æœºåˆ¶æºç å®Œæ•´å‰–æ</li>
<li><code>5.2.3</code>: æŸ¥æ‰¾ä¼˜å…ˆçº§</li>
<li><code>5.2.4</code>: Super è°ƒç”¨æœºåˆ¶</li>
<li><code>5.3.1</code>: Lua C API: æ ˆæ“ä½œåŸºç¡€</li>
<li><code>5.3.2</code>: Class_Index å®Œæ•´æºç å‰–æ</li>
<li><code>5.3.3</code>: GetField æ ˆæ“ä½œå®Œæ•´å¯è§†åŒ–</li>
<li><code>5.3.4</code>: Class_NewIndex å±æ€§å†™å…¥</li>
</ul>
<h3 id="æ–‡æ¡£ç‰¹è‰²"><a href="#æ–‡æ¡£ç‰¹è‰²" class="headerlink" title="æ–‡æ¡£ç‰¹è‰²"></a>æ–‡æ¡£ç‰¹è‰²</h3><p>âœ… <strong>æºç çº§åˆ†æ</strong>: æ¯ä¸ªæŠ€æœ¯ç‚¹éƒ½é™„å¸¦å®Œæ•´æºç å‰–æï¼Œè¡Œå·å·²ä¸å®é™…æºæ–‡ä»¶æ ¸å¯¹<br>âœ… <strong>Lua C API è¯¦è§£</strong>: åœ¨ä½¿ç”¨å¤„å°±åœ°è®²è§£ç›¸å…³ API ç”¨æ³•ï¼ŒåŒ…å«æ ˆå˜åŒ–å¯è§†åŒ–<br>âœ… <strong>å®Œæ•´æµç¨‹å›¾ç¤º</strong>: ä» Lua è°ƒç”¨åˆ° C++ æ‰§è¡Œçš„å®Œæ•´é“¾è·¯è¿½è¸ª<br>âœ… <strong>å®æˆ˜ç¤ºä¾‹ä¸°å¯Œ</strong>: åŒ…å« C++ å’Œ Lua åŒå‘ä»£ç å¯¹ç…§<br>âœ… <strong>æ€§èƒ½æ•°æ®æ”¯æ’‘</strong>: æä¾›çœŸå®çš„æ€§èƒ½åŸºå‡†æµ‹è¯•æ•°æ®  </p>
<h3 id="æŠ€æœ¯å‡†ç¡®æ€§ä¿è¯"><a href="#æŠ€æœ¯å‡†ç¡®æ€§ä¿è¯" class="headerlink" title="æŠ€æœ¯å‡†ç¡®æ€§ä¿è¯"></a>æŠ€æœ¯å‡†ç¡®æ€§ä¿è¯</h3><p>æ‰€æœ‰æºç å¼•ç”¨å·²æ ¸å¯¹ï¼š</p>
<ul>
<li>ClassRegistry.cpp (Registries&#x2F;)</li>
<li>ObjectRegistry.cpp (Registries&#x2F;)</li>
<li>LuaCore.cpp (Private&#x2F;)</li>
<li>FunctionDesc.cpp (ReflectionUtils&#x2F;)</li>
<li>LuaFunction.cpp (Private&#x2F;)</li>
</ul>
<p>æºç åˆ†æåŸºäº UnLua æœ€æ–°ç¨³å®šç‰ˆæœ¬ã€‚</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>æœ¬æ–‡ä½œè€…ï¼š </strong>FixCode
  </li>
  <li class="post-copyright-link">
      <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
      <a href="http://www.fixcod.cn/2024/04/14/Unlua%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" title="Unluaä»£ç åˆ†æ">http://www.fixcod.cn/2024/04/14/Unluaä»£ç åˆ†æ/</a>
  </li>
  <li class="post-copyright-license">
      <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Unlua/" rel="tag"><i class="fa fa-tag"></i> Unlua</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/12/01/Markdown%E6%A0%BC%E5%BC%8F%E5%B1%95%E7%A4%BA/" rel="prev" title="Markdown æ ¼å¼å±•ç¤º">
                  <i class="fa fa-angle-left"></i> Markdown æ ¼å¼å±•ç¤º
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">FixCode</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">18k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">1:05</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: '32px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: 'ğŸŒ“',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>
<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"1778750163/next_utterances","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js" defer></script>

</body>
</html>

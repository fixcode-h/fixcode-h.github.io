[{"title":"Unluaä»£ç åˆ†æ","url":"/2024/04/14/Unlua%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/","content":"å‰è¨€UnLua æ˜¯ Tencent å¼€æºçš„é«˜æ€§èƒ½ Lua-UE ç»‘å®šæ¡†æ¶ï¼Œä¸º Unreal Engine æä¾›äº†å®Œå–„çš„ Lua è„šæœ¬æ”¯æŒã€‚æœ¬æ–‡æ¡£åŸºäºæºç æ·±åº¦å‰–æ UnLua çš„æ ¸å¿ƒå®ç°åŸç†ï¼Œæ¶µç›–ä»¥ä¸‹å†…å®¹ï¼š\nğŸ“š æ–‡æ¡£ç»“æ„\nLua C API åŸºç¡€ - æ³¨å†Œè¡¨ã€å…ƒè¡¨ã€æ ˆæ“ä½œç­‰æ ¸å¿ƒæ¦‚å¿µ\næ¶æ„è®¾è®¡ - å››å±‚æ¶æ„ï¼ˆLua å±‚ã€ç»‘å®šå±‚ã€æ³¨å†Œå±‚ã€æ ¸å¿ƒå±‚ï¼‰\né™æ€å¯¼å‡ºæœºåˆ¶ - ç¼–è¯‘æœŸç±»å‹å¯¼å‡ºä¸é›¶è¿è¡Œæ—¶å¼€é”€\nåŠ¨æ€ç»‘å®šæœºåˆ¶ - è¿è¡Œæ—¶æ¨¡å—åŠ è½½ä¸çƒ­æ›´æ–°æ”¯æŒ\nç±»æ³¨å†Œç³»ç»Ÿ - ClassRegistry ä¸ ObjectRegistry åŒå±‚æ¶æ„\nå‡½æ•°è¦†å†™åŸç† - ProcessEvent Hook ä¸ Lua å‡½æ•°æ‹¦æˆª\nç±»å‹è½¬æ¢ - C++&#x2F;Lua ç±»å‹è‡ªåŠ¨è½¬æ¢ä¸å‚æ•°ä¼ é€’\nGC ä¸ç”Ÿå‘½å‘¨æœŸ - å¯¹è±¡å¼•ç”¨ç®¡ç†ä¸å†…å­˜å®‰å…¨\næ€§èƒ½ä¼˜åŒ– - ç¼“å­˜ç­–ç•¥ä¸è°ƒç”¨ä¼˜åŒ–\næœ€ä½³å®è·µ - å®æˆ˜æ¡ˆä¾‹ä¸å¸¸è§é—®é¢˜è§£å†³\n\n\n\n\nLua C API åŸºç¡€æ¦‚å¿µæ³¨å†Œè¡¨ (Registry)æ³¨å†Œè¡¨çš„æœ¬è´¨:\n\nLua æ³¨å†Œè¡¨æ˜¯ä¸€ä¸ªå…¨å±€å“ˆå¸Œè¡¨,åªèƒ½é€šè¿‡ C API è®¿é—®,Lua ä»£ç æ— æ³•ç›´æ¥è®¿é—®\nè®¿é—®æ–¹å¼: lua_getfield(L, LUA_REGISTRYINDEX, key)\nå­˜å‚¨ä½ç½®: Lua VM å†…éƒ¨,ç‹¬ç«‹äº Lua å…¨å±€ç¯å¢ƒ\n\næ³¨å†Œè¡¨å†…éƒ¨ç»“æ„:\n-- æ¦‚å¿µæ¨¡å‹ (å®é™…ä¸å¯ç›´æ¥è®¿é—®)LUA_REGISTRYINDEX = &#123;    [&quot;_G&quot;] = _G,                  -- Lua å…¨å±€ç¯å¢ƒ    [&quot;_LOADED&quot;] = package.loaded, -- å·²åŠ è½½æ¨¡å—    [&quot;UnLua_ObjectMap&quot;] = &#123;...&#125;,  -- UnLua å¯¹è±¡ç¼“å­˜    [&quot;UObject&quot;] = &#123;...&#125;,          -- å‘½åå…ƒè¡¨    [1] = &#123;...&#125;,                  -- luaL_ref åˆ›å»ºçš„å¼•ç”¨    [2] = function() ... end,     -- å¼•ç”¨ID=2    -- ...&#125;\n\nä¸»è¦ç”¨é€”:\n\n\n\nç”¨é€”\nAPI\nè¯´æ˜\n\n\n\nå‘½åå…ƒè¡¨\nluaL_newmetatable(L, &quot;UObject&quot;)\nå…¨å±€å”¯ä¸€å…ƒè¡¨\n\n\nå¯¹è±¡å¼•ç”¨\nluaL_ref(L, LUA_REGISTRYINDEX)\né˜²æ­¢ GC å›æ”¶\n\n\nå…¨å±€çŠ¶æ€\nlua_setfield(L, LUA_REGISTRYINDEX, key)\nå­˜å‚¨ C++ çŠ¶æ€\n\n\nç¤ºä¾‹ä»£ç :\n// åœ¨æ³¨å†Œè¡¨å­˜å‚¨è‡ªå®šä¹‰æ•°æ®lua_newtable(L);lua_setfield(L, LUA_REGISTRYINDEX, &quot;UnLua_CustomData&quot;);// è¯»å–æ³¨å†Œè¡¨æ•°æ®lua_getfield(L, LUA_REGISTRYINDEX, &quot;UnLua_CustomData&quot;);// æ ˆ: [CustomData è¡¨]\n\nå…ƒè¡¨ (Metatable) æ ¸å¿ƒ APIå‘½åå…ƒè¡¨ vs åŒ¿åå…ƒè¡¨:\n// â˜… å‘½åå…ƒè¡¨ (å­˜å‚¨åœ¨æ³¨å†Œè¡¨,å…¨å±€å”¯ä¸€)luaL_newmetatable(L, &quot;UObject&quot;);  // ç­‰ä»·äº://   lua_newtable(L);//   lua_pushvalue(L, -1);//   lua_setfield(L, LUA_REGISTRYINDEX, &quot;UObject&quot;);// â˜… åŒ¿åå…ƒè¡¨ (ä»…å­˜åœ¨äºæ ˆä¸Š)lua_newtable(L);lua_setmetatable(L, -2);  // è®¾ç½®ç»™æŸä¸ªå¯¹è±¡\n\nè·å–å…ƒè¡¨çš„åŒºåˆ«:\n// luaL_getmetatable: ä»æ³¨å†Œè¡¨è·å–å‘½åå…ƒè¡¨luaL_getmetatable(L, &quot;UObject&quot;);// è¿”å›: LUA_TTABLE(æˆåŠŸ) æˆ– LUA_TNIL(ä¸å­˜åœ¨)// lua_getmetatable: è·å–å¯¹è±¡çš„å…ƒè¡¨lua_getmetatable(L, 1);  // è¿”å›: 1(æœ‰å…ƒè¡¨) æˆ– 0(æ— å…ƒè¡¨)\n\n\næ¶æ„æ¦‚è§ˆæ•´ä½“æ¶æ„å›¾graph TB\n    subgraph Luaå±‚[&quot;ğŸ¯ Lua å±‚&quot;]\n        LS[Lua Scripts]\n        LM[Lua Modules]\n        LT[Lua Tables]\n    end\n    \n    subgraph ç»‘å®šå±‚[&quot;ğŸ”— ç»‘å®šå±‚&quot;]\n        SE[&quot;é™æ€å¯¼å‡º&lt;br/&gt;ğŸ“Œ ç¼–è¯‘æœŸ&quot;]\n        DB[&quot;åŠ¨æ€ç»‘å®š&lt;br/&gt;âš¡ è¿è¡Œæ—¶&quot;]\n        RB[&quot;åå°„ç»‘å®š&lt;br/&gt;ğŸ”„ æŒ‰éœ€åŠ è½½&quot;]\n    end\n    \n    subgraph æ³¨å†Œå±‚[&quot;ğŸ“‹ æ³¨å†Œå±‚&quot;]\n        RS[Registry System]\n        CR[Class Registry]\n        OR[Object Registry]\n        FR[Function Registry]\n    end\n    \n    subgraph æ ¸å¿ƒå±‚[&quot;âš™ï¸ æ ¸å¿ƒå±‚&quot;]\n        LE[&quot;LuaEnv&lt;br/&gt;Lua VM ç®¡ç†å™¨&quot;]\n        GC[GC ç®¡ç†]\n        REF[å¯¹è±¡å¼•ç”¨]\n        MEM[å†…å­˜åˆ†é…]\n    end\n    \n    LS --&gt; SE\n    LM --&gt; DB\n    LT --&gt; RB\n    \n    SE --&gt; RS\n    DB --&gt; RS\n    RB --&gt; RS\n    \n    RS --&gt; CR\n    RS --&gt; OR\n    RS --&gt; FR\n    \n    CR --&gt; LE\n    OR --&gt; LE\n    FR --&gt; LE\n    \n    LE --&gt; GC\n    LE --&gt; REF\n    LE --&gt; MEM\n    \n    classDef luaLayer fill:#e1f5ff,stroke:#01579b,stroke-width:2px\n    classDef bindLayer fill:#fff3e0,stroke:#e65100,stroke-width:2px\n    classDef regLayer fill:#f3e5f5,stroke:#4a148c,stroke-width:2px\n    classDef coreLayer fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px\n    \n    class LS,LM,LT luaLayer\n    class SE,DB,RB bindLayer\n    class RS,CR,OR,FR regLayer\n    class LE,GC,REF,MEM coreLayer\n\næ ¸å¿ƒç»„ä»¶èŒè´£è¡¨\n\n\nç»„ä»¶\nèŒè´£\nå…³é”®æ–‡ä»¶\n\n\n\nFLuaEnv\nLua è™šæ‹Ÿæœºç®¡ç†ã€ç¯å¢ƒéš”ç¦»ã€ç”Ÿå‘½å‘¨æœŸæ§åˆ¶\nLuaEnv.h/cpp\n\n\nFClassRegistry\nUE ç±»å‹åˆ° Lua Metatable æ˜ å°„ã€åå°„ç±»å‹æ³¨å†Œ\nClassRegistry.h/cpp\n\n\nFObjectRegistry\nUObject å®ä¾‹åˆ° Lua Userdata æ˜ å°„ã€å¼•ç”¨ç®¡ç†\nObjectRegistry.h/cpp\n\n\nFFunctionDesc\nUFunction æè¿°ç¬¦ã€å‚æ•°è§£æã€è°ƒç”¨åˆ†å‘\nFunctionDesc.h/cpp\n\n\nFPropertyDesc\nUProperty æè¿°ç¬¦ã€ç±»å‹è½¬æ¢ã€è¯»å†™è®¿é—®\nPropertyDesc.h/cpp\n\n\nFLuaDynamicBinding\nåŠ¨æ€ç»‘å®šå †æ ˆç®¡ç†ã€æ¨¡å—åŠ è½½åè°ƒ\nLuaDynamicBinding.h/cpp\n\n\nFObjectReferencer\nGC å¼•ç”¨è®¡æ•°ç®¡ç†ã€é˜²æ‚¬ç©ºæŒ‡é’ˆ\nObjectReferencer.h\n\n\næ•°æ®æµç¤ºæ„å›¾Lua è°ƒç”¨ C++&#x2F;è“å›¾:\nflowchart TD\n    A([Lua Call]) --&gt; B[Class_CallUFunc]\n    B --&gt; C[FFunctionDesc::CallUE]\n    C --&gt; D1[PreCall: Lua â†’ C++ å‚æ•°è½¬æ¢]\n    D1 --&gt; D2[UObject::ProcessEvent]\n    D2 --&gt; D3[PostCall: C++ â†’ Lua è¿”å›å€¼]\n    \n    style A fill:#e1f5ff,stroke:#01579b,stroke-width:2px\n    style C fill:#fff3e0,stroke:#e65100,stroke-width:2px\n    style D2 fill:#f3e5f5,stroke:#4a148c,stroke-width:2px\n\nC++&#x2F;è“å›¾è°ƒç”¨ Lua:\nflowchart TD\n    A([ProcessEvent]) --&gt; B[FLuaOverrider Hook]\n    B --&gt; C&#123;æ˜¯å¦æœ‰&lt;br/&gt;Lua è¦†å†™?&#125;\n    C --&gt;|æ˜¯| D[FFunctionDesc::CallLua]\n    C --&gt;|å¦| E[Super::ProcessEvent]\n    \n    D --&gt; D1[æŸ¥æ‰¾ Lua å‡½æ•°]\n    D1 --&gt; D2[C++ â†’ Lua å‚æ•°è½¬æ¢]\n    D2 --&gt; D3[lua_pcall]\n    D3 --&gt; D4[Lua â†’ C++ è¿”å›å€¼]\n    \n    style A fill:#e1f5ff,stroke:#01579b,stroke-width:2px\n    style C fill:#fff9c4,stroke:#f57f17,stroke-width:2px\n    style D fill:#ffccbc,stroke:#bf360c,stroke-width:2px\n\n\né™æ€å¯¼å‡ºæœºåˆ¶æ ¸å¿ƒåŸç†é™æ€å¯¼å‡ºæ˜¯åœ¨ç¼–è¯‘æœŸé€šè¿‡ C++ æ¨¡æ¿å…ƒç¼–ç¨‹å’Œå…¨å±€æ„é€ å‡½æ•°å®ç°çš„ï¼Œæ— éœ€åå°„ç³»ç»Ÿå‚ä¸ã€‚\nå®ç°æœºåˆ¶// UnLuaEx.h æ ¸å¿ƒå®å®šä¹‰#define BEGIN_EXPORT_CLASS(ClassName)                               \\    struct FExported##ClassName##Helper                             \\    &#123;                                                                \\        static struct FExported##ClassName : public UnLua::FExportedClass&lt;ClassName&gt; \\        &#123;                                                            \\            FExported##ClassName() : FExportedClass(#ClassName)      \\            &#123;                                                        \\                // æ³¨å†Œå‡½æ•°ã€å±æ€§ç­‰            &#125;                                                        \\        &#125; Exported;                                                  \\    &#125;;                                                               \\    FExported##ClassName##Helper::FExported##ClassName     FExported##ClassName##Helper::Exported;\n\nå…³é”®ç‚¹:\n\nå…¨å±€é™æ€å¯¹è±¡: åˆ©ç”¨ C++ å…¨å±€å¯¹è±¡æ„é€ åœ¨ main() å‰æ‰§è¡Œçš„ç‰¹æ€§\næ¨¡æ¿ç‰¹åŒ–: TExportedFunction&lt;RetType, Args...&gt; è‡ªåŠ¨è§£æç±»å‹\né›¶è¿è¡Œæ—¶æˆæœ¬: ç±»å‹ä¿¡æ¯åœ¨ç¼–è¯‘æœŸç¡®å®š\n\nå®å±•å¼€ç¤ºä¾‹:\n// ç”¨æˆ·ä»£ç BEGIN_EXPORT_CLASS(FMyMathLib)    ADD_STATIC_FUNCTION(Add)END_EXPORT_CLASS()// å±•å¼€å (ç®€åŒ–ç‰ˆ):struct FExportedFMyMathLibHelper&#123;    static struct FExportedFMyMathLib : public UnLua::FExportedClass&lt;FMyMathLib&gt;    &#123;        FExportedFMyMathLib() : FExportedClass(&quot;FMyMathLib&quot;)        &#123;            // â˜… æ„é€ å‡½æ•°åœ¨ main() å‰æ‰§è¡Œ            AddFunction(&quot;Add&quot;, &amp;FMyMathLib::Add);        &#125;    &#125; Exported;&#125;;// â˜… å…¨å±€é™æ€å¯¹è±¡å®šä¹‰ (è§¦å‘æ„é€ å‡½æ•°)FExportedFMyMathLibHelper::FExportedFMyMathLib FExportedFMyMathLibHelper::Exported;\n\nå…¨å±€æ„é€ å‡½æ•°è§¦å‘æµç¨‹flowchart TB\n    Start([æ“ä½œç³»ç»ŸåŠ è½½ç¨‹åº]) --&gt; Load[åŠ è½½æ‰€æœ‰åŠ¨æ€åº“ DLL/SO]\n    Load --&gt; Init[åˆå§‹åŒ–å…¨å±€å˜é‡åŒº]\n    Init --&gt; Global[æ‰§è¡Œå…¨å±€å¯¹è±¡æ„é€ å‡½æ•°&lt;br/&gt;æŒ‰ç¼–è¯‘é¡ºåº]\n    \n    Global --&gt; G1[FExportedFMyMathLib::FExportedFMyMathLib]\n    G1 --&gt; G1a[ExportClass this&lt;br/&gt;æ³¨å†Œåˆ°å…¨å±€å®¹å™¨]\n    G1a --&gt; G2[FExportedOtherClass::FExportedOtherClass]\n    G2 --&gt; G2a[ExportClass this]\n    G2a --&gt; G3[... æ‰€æœ‰ BEGIN_EXPORT_CLASS]\n    \n    G3 --&gt; Main[æ‰§è¡Œ main æˆ– UE å¼•æ“å¯åŠ¨]\n    Main --&gt; LuaInit[FLuaEnv::Initialize]\n    LuaInit --&gt; Register[RegisterExportedClasses]\n    Register --&gt; Traverse[éå†å…¨å±€å®¹å™¨,æ³¨å†Œåˆ° Lua]\n    \n    style Start fill:#e1f5ff,stroke:#01579b,stroke-width:2px\n    style Global fill:#fff3e0,stroke:#e65100,stroke-width:2px\n    style LuaInit fill:#f3e5f5,stroke:#4a148c,stroke-width:2px\n    style Traverse fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px\n\næºç å‰–æ:\n// UnLuaBase.cppstatic TArray&lt;FExportedClass*&gt;* GExportedClasses = nullptr;void ExportClass(FExportedClass* Class)&#123;    // â˜… å»¶è¿Ÿåˆå§‹åŒ–å…¨å±€å®¹å™¨    if (!GExportedClasses)        GExportedClasses = new TArray&lt;FExportedClass*&gt;();        // â˜… å­˜å‚¨å¯¼å‡ºç±»æŒ‡é’ˆ    GExportedClasses-&gt;Add(Class);&#125;TArray&lt;FExportedClass*&gt;&amp; GetExportedClasses()&#123;    check(GExportedClasses);    return *GExportedClasses;&#125;// LuaEnv.cpp:125void FLuaEnv::Initialize()&#123;    // ... åˆå§‹åŒ– Lua VM ...        // â˜… æ³¨å†Œæ‰€æœ‰é™æ€å¯¼å‡ºçš„ç±»    auto&amp; ExportedClasses = GetExportedClasses();    for (FExportedClass* Class : ExportedClasses)    &#123;        Class-&gt;Register(MainState);  // æ³¨å†Œåˆ° Lua    &#125;&#125;\n\næ³¨å†Œæµç¨‹flowchart TB\n    subgraph ç¼–è¯‘æœŸ\n        A[å…¨å±€å¯¹è±¡æ„é€ ] --&gt; B[FExportedClass æ„é€ ]\n        B --&gt; C1[ExportClass this&lt;br/&gt;å­˜å…¥å…¨å±€å®¹å™¨]\n        B --&gt; C2[æ³¨å†Œæˆå‘˜å‡½æ•°]\n        B --&gt; C3[æ³¨å†Œå±æ€§]\n    end\n    \n    subgraph è¿è¡ŒæœŸ\n        D[FLuaEnv::Initialize] --&gt; E[RegisterExportedClasses]\n        E --&gt; F[éå†å…¨å±€å®¹å™¨å¹¶æ³¨å†Œåˆ° Lua]\n    end\n    \n    C1 -.-&gt; D\n    \n    style A fill:#fff3e0,stroke:#e65100,stroke-width:2px\n    style D fill:#e1f5ff,stroke:#01579b,stroke-width:2px\n    style F fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px\n\né™æ€å¯¼å‡ºæ³¨å†Œåˆ° Lua çš„å®Œæ•´æµç¨‹FExportedClass::Register æºç å‰–æ:\n// UnLuaEx.cppvoid FExportedClass::Register(lua_State* L)&#123;    // â˜… æ­¥éª¤1: åˆ›å»ºå‘½åå…ƒè¡¨    luaL_newmetatable(L, ClassName.Get());    // æ ˆ: [metatable]        // â˜… æ­¥éª¤2: è®¾ç½®ç»§æ‰¿å…³ç³»    if (!SuperClassName.IsEmpty())    &#123;        lua_pushstring(L, &quot;Super&quot;);        Type = luaL_getmetatable(L, TCHAR_TO_UTF8(*SuperClassName));        check(Type == LUA_TTABLE);        lua_rawset(L, -3);        // metatable.Super = SuperMetatable    &#125;        // â˜… æ­¥éª¤3: è®¾ç½® __index å…ƒæ–¹æ³•    lua_pushstring(L, &quot;__index&quot;);    lua_pushvalue(L, -2);  // å¤åˆ¶ metatable    if (Properties.Num() &gt; 0 || !SuperClassName.IsEmpty())    &#123;        // â˜… æœ‰å±æ€§æˆ–çˆ¶ç±»æ—¶,ä½¿ç”¨é€šç”¨ Index å‡½æ•°        lua_pushcclosure(L, UnLua::Index, 1);    &#125;    lua_rawset(L, -3);    // metatable.__index = Index é—­åŒ… (upvalue=metatable)        // â˜… æ­¥éª¤4: è®¾ç½® __newindex å…ƒæ–¹æ³•    lua_pushstring(L, &quot;__newindex&quot;);    lua_pushvalue(L, -2);    if (Properties.Num() &gt; 0 || !SuperClassName.IsEmpty())    &#123;        lua_pushcclosure(L, UnLua::NewIndex, 1);    &#125;    lua_rawset(L, -3);        // â˜… æ­¥éª¤5: å…ƒè¡¨ä½œä¸ºè‡ªå·±çš„å…ƒè¡¨ (æ”¯æŒç±»æ–¹æ³•è°ƒç”¨)    lua_pushvalue(L, -1);    lua_setmetatable(L, -2);    // metatable.metatable = metatable        // â˜… æ­¥éª¤6: æ³¨å†Œæˆå‘˜å±æ€§    for (const auto&amp; Property : Properties)        Property-&gt;Register(L);    // å°†å±æ€§ Getter/Setter æ·»åŠ åˆ° metatable        // â˜… æ­¥éª¤7: æ³¨å†Œæˆå‘˜å‡½æ•°    for (const auto&amp; MemberFunc : Functions)        MemberFunc-&gt;Register(L);        // â˜… æ­¥éª¤8: æ³¨å†Œå…¨å±€å‡½æ•° (Glue å‡½æ•°)    for (const auto&amp; Func : GlueFunctions)        Func-&gt;Register(L);        // æ ˆ: [metatable]        // â˜… æ­¥éª¤9: å°†å…ƒè¡¨æ³¨å†Œåˆ°å…¨å±€ UE è¡¨    lua_getglobal(L, &quot;UE&quot;);    // æ ˆ: [metatable, UE]        lua_pushstring(L, ClassName.Get());    // æ ˆ: [metatable, UE, &quot;FMyMathLib&quot;]        lua_pushvalue(L, -3);    // æ ˆ: [metatable, UE, &quot;FMyMathLib&quot;, metatable]        lua_rawset(L, -3);    // UE[&quot;FMyMathLib&quot;] = metatable    // æ ˆ: [metatable, UE]        lua_pop(L, 2);    // æ ˆ: []&#125;\n\næˆå‘˜å‡½æ•°æ³¨å†Œç¤ºä¾‹:\n// FExportedFunction::Registervoid FExportedFunction::Register(lua_State* L)&#123;    // â˜… æ ˆ: [metatable]        lua_pushstring(L, TCHAR_TO_UTF8(*Name));      // æ ˆ: [metatable, &quot;Add&quot;]        lua_pushlightuserdata(L, this);      // æ ˆ: [metatable, &quot;Add&quot;, thisæŒ‡é’ˆ]    // â˜… æ³¨æ„: light userdata ä¸å ç”¨é¢å¤–å†…å­˜,ä»…å­˜å‚¨æŒ‡é’ˆå€¼        lua_pushcclosure(L, InvokeFunction, 1);      // æ ˆ: [metatable, &quot;Add&quot;, &lt;Closure&gt;]    // â˜… å…³é”®: InvokeFunction å¯é€šè¿‡ lua_upvalueindex(1) è·å– this        lua_rawset(L, -3);      // metatable[&quot;Add&quot;] = Closure    // æ ˆ: [metatable]&#125;\n\nInvokeFunction è°ƒç”¨å…¥å£:\n// UnLuaEx.cppstatic int InvokeFunction(lua_State* L)&#123;    // â˜… è·å– upvalue (FExportedFunction æŒ‡é’ˆ)    IExportedFunction* Func = (IExportedFunction*)lua_touserdata(L, lua_upvalueindex(1));        // â˜… è°ƒç”¨å®é™…å‡½æ•° (é€šè¿‡æ¨¡æ¿ç‰¹åŒ–)    return Func ? Func-&gt;Invoke(L) : 0;&#125;// æ¨¡æ¿ç‰¹åŒ–ç¤ºä¾‹template &lt;typename Ret, typename... Args&gt;int TExportedFunction&lt;Ret, Args...&gt;::Invoke(lua_State* L)&#123;    // â˜… ä»æ ˆè¯»å–å‚æ•°    auto Params = ReadParams&lt;Args...&gt;(L, 1);        // â˜… è°ƒç”¨ C++ å‡½æ•°    Ret Result = FunctionPtr(Params...);        // â˜… å‹å…¥è¿”å›å€¼    UnLua::Push(L, Result);        return 1;  // è¿”å›1ä¸ªå€¼&#125;\n\nLua è°ƒç”¨æµç¨‹:\n-- Lua ä»£ç local result = UE.FMyMathLib.Add(10, 20)-- æ‰§è¡Œè¿‡ç¨‹:-- 1. UE[&quot;FMyMathLib&quot;][&quot;Add&quot;]  â†’ è§¦å‘ __index,è¿”å› Closure-- 2. Closure(10, 20)          â†’ InvokeFunction-- 3. lua_upvalueindex(1)      â†’ è·å– FExportedFunction*-- 4. FExportedFunction::Invoke â†’ è°ƒç”¨ FMyMathLib::Add-- 5. è¿”å› 30\n\nä»£ç ç¤ºä¾‹ç¤ºä¾‹ 1: å¯¼å‡ºé™æ€å·¥å…·ç±»// MyMathLib.hstruct FMyMathLib&#123;    static float Add(float A, float B) &#123; return A + B; &#125;    static FVector Normalize(const FVector&amp; V) &#123; return V.GetSafeNormal(); &#125;&#125;;// MyMathLib.cppBEGIN_EXPORT_CLASS(FMyMathLib)    ADD_STATIC_FUNCTION(Add)    ADD_STATIC_FUNCTION(Normalize)END_EXPORT_CLASS()\n\nLua è°ƒç”¨:\nlocal result = FMyMathLib.Add(10, 20)  -- è¿”å› 30local vec = FMyMathLib.Normalize(FVector(1, 1, 1))\n\nç¤ºä¾‹ 2: å¯¼å‡ºå…¨å±€å‡½æ•°EXPORT_FUNCTION(float, GetGameTime)&#123;    UWorld* World = GWorld;    return World ? World-&gt;GetTimeSeconds() : 0.0f;&#125;\n\nLua è°ƒç”¨:\nlocal time = GetGameTime()print(&quot;å½“å‰æ¸¸æˆæ—¶é—´: &quot; .. time)\n\næ€§èƒ½ç‰¹æ€§\n\n\nç‰¹æ€§\né™æ€å¯¼å‡º\nåŠ¨æ€ç»‘å®š\nè¯´æ˜\n\n\n\næ³¨å†Œæ—¶æœº\nç¨‹åºå¯åŠ¨å‰\nè¿è¡Œæ—¶\né™æ€å¯¼å‡ºæ— è¿è¡Œæ—¶å¼€é”€\n\n\nç±»å‹å®‰å…¨\nç¼–è¯‘æœŸæ£€æŸ¥\nè¿è¡Œæ—¶æ£€æŸ¥\né™æ€å¯¼å‡ºæ›´å®‰å…¨\n\n\nè°ƒç”¨å¼€é”€\n~1.5Î¼s\n~2.5Î¼s\né™æ€å¯¼å‡ºå°‘ä¸€æ¬¡åå°„æŸ¥è¯¢\n\n\næ”¯æŒåå°„\nå¦\næ˜¯\né™æ€å¯¼å‡ºä¸ä¾èµ– UE åå°„\n\n\nçƒ­æ›´æ–°\nå¦\næ˜¯\né™æ€å¯¼å‡ºéœ€é‡æ–°ç¼–è¯‘\n\n\né€‚ç”¨åœºæ™¯âœ… é€‚åˆé™æ€å¯¼å‡ºçš„åœºæ™¯\næ•°å­¦&#x2F;ç®—æ³•åº“ (æ— çŠ¶æ€ã€çº¯è®¡ç®—)\nå·¥å…·å‡½æ•°é›† (é¢‘ç¹è°ƒç”¨)\nè‡ªå®šä¹‰ Struct (ä¸ç»§æ‰¿ UObject)\nç¬¬ä¸‰æ–¹åº“å°è£…\n\nâŒ ä¸é€‚åˆé™æ€å¯¼å‡ºçš„åœºæ™¯\nActor&#x2F;Component (ä½¿ç”¨åŠ¨æ€ç»‘å®š)\nè“å›¾ç±» (ä½¿ç”¨åå°„å¯¼å‡º)\néœ€è¦çƒ­æ›´æ–°çš„é€»è¾‘\n\n\nåŠ¨æ€å¯¼å‡ºæœºåˆ¶å·¥ä½œæµç¨‹åŠ¨æ€å¯¼å‡ºæ˜¯ UnLua çš„æ ¸å¿ƒç‰¹æ€§ï¼Œå…è®¸åœ¨è¿è¡Œæ—¶å°† Lua æ¨¡å—ç»‘å®šåˆ° UE C++&#x2F;è“å›¾ç±»ã€‚\nå®Œæ•´æµç¨‹å›¾flowchart TB\n    subgraph S1[&quot;1ï¸âƒ£ Actor å®ä¾‹åŒ–&quot;]\n        A1[AActor::BeginPlay] --&gt; A2[FUnLuaManager::OnUObjectBind]\n        A2 --&gt; A3&#123;æ£€æŸ¥ç»‘å®šæ–¹å¼&#125;\n        A3 --&gt;|æ–¹å¼1| A4a[IUnLuaInterface::GetModuleName]\n        A3 --&gt;|æ–¹å¼2-3| A4b[UUnLuaSettings é…ç½®]\n        A4a --&gt; A5[æ‰¾åˆ° Lua æ¨¡å—è·¯å¾„]\n        A4b --&gt; A5\n    end\n    \n    subgraph S2[&quot;2ï¸âƒ£ åŠ è½½ Lua æ¨¡å—&quot;]\n        B1[require Module] --&gt; B2[&quot;GLuaDynamicBinding.Push&lt;br/&gt;Class: BP_MyActor&lt;br/&gt;ModuleName: MyActor&quot;]\n        B2 --&gt; B3[&quot;æ‰§è¡Œ Lua æ–‡ä»¶&lt;br/&gt;return &#123; ... &#125;&quot;]\n    end\n    \n    subgraph S3[&quot;3ï¸âƒ£ åˆ›å»ºç»‘å®šå®ä¾‹&quot;]\n        C1[FObjectRegistry::Bind Object] --&gt; C2[åˆ›å»º INSTANCE Table]\n        C2 --&gt; C3[INSTANCE.Object = Userdata]\n        C3 --&gt; C4[INSTANCE.metatable = MODULE]\n        C4 --&gt; C5[ç¼“å­˜åˆ° ObjectRefs]\n    end\n    \n    subgraph S4[&quot;4ï¸âƒ£ å‡½æ•°è¦†å†™å‡†å¤‡&quot;]\n        D1[éå† Lua Module çš„å‡½æ•°] --&gt; D2[ä¸ºè¦†å†™å‡½æ•°è®¾ç½® Hook]\n        D2 --&gt; D3[ProcessEvent Hook]\n    end\n    \n    A5 --&gt; B1\n    B3 --&gt; C1\n    C5 --&gt; D1\n    \n    style A1 fill:#e1f5ff,stroke:#01579b,stroke-width:2px\n    style B1 fill:#fff3e0,stroke:#e65100,stroke-width:2px\n    style C1 fill:#f3e5f5,stroke:#4a148c,stroke-width:2px\n    style D1 fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px\n\nç»‘å®šè§¦å‘æœºåˆ¶UnLua æ”¯æŒå¤šç§ç»‘å®šæ–¹å¼ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åºï¼š\n\n\n\nä¼˜å…ˆçº§\nç»‘å®šæ–¹å¼\nè§¦å‘æ¡ä»¶\né…ç½®ä½ç½®\n\n\n\n1\nIUnLuaInterface\nç±»å®ç°æ¥å£\nC++ ä»£ç \n\n\n2\nUnLuaBind ç»„ä»¶\næ·»åŠ ç»„ä»¶\nè“å›¾&#x2F;å®ä¾‹\n\n\n3\nå…¨å±€é…ç½®\nåŒ¹é…ç±»åè§„åˆ™\nProject Settings\n\n\n4\næ‰‹åŠ¨ç»‘å®š\nè°ƒç”¨ API\nLua ä»£ç \n\n\nä»£ç ç¤ºä¾‹æ–¹å¼ 1: IUnLuaInterface (æ¨è)\n// MyActor.hclass AMyActor : public AActor, public IUnLuaInterface&#123;    virtual FString GetModuleName_Implementation() const override    &#123;        return TEXT(&quot;MyActor&quot;);  // å¯¹åº” Content/Script/MyActor.lua    &#125;&#125;;\n\næ–¹å¼ 4: æ‰‹åŠ¨ç»‘å®š\n-- InGameLogic.lualocal player = UE.UGameplayStatics.GetPlayerCharacter(self, 0)UnLua.Bind(player, &quot;PlayerController&quot;)  -- è¿è¡Œæ—¶åŠ¨æ€ç»‘å®š\n\næ¨¡å—åŠ è½½æœºåˆ¶è·¯å¾„è§£æè§„åˆ™Lua æ¨¡å—æŸ¥æ‰¾é¡ºåº:1. Content/Script/&lt;ModuleName&gt;.lua2. Plugins/&lt;PluginName&gt;/Content/Script/&lt;ModuleName&gt;.lua3. package.path é…ç½®çš„é¢å¤–è·¯å¾„\n\nçƒ­æ›´æ–°ä¸‹è½½ç›®å½•// LuaCore.cppFString GetFullPathFromRelativePath(const FString&amp; RelativePath)&#123;    FString FullFilePath = GLuaSrcFullPath + RelativePath;    FString DownloadDir = FPaths::ProjectPersistentDownloadDir();    FString HotfixPath = DownloadDir + RelativePath;        // ä¼˜å…ˆä½¿ç”¨çƒ­æ›´æ–°ç›®å½•    if (IFileManager::Get().FileExists(*HotfixPath))        return HotfixPath;        return FullFilePath;&#125;\n\nç§»åŠ¨å¹³å°è·¯å¾„:\n\niOS: Library/Caches/\nAndroid: /sdcard/Android/data/.../cache/\nPC: Saved/DownloadData/\n\nè¿è¡Œæ—¶ç‰¹æ€§\n\n\nç‰¹æ€§\nè¯´æ˜\nä¼˜åŠ¿\n\n\n\nå»¶è¿ŸåŠ è½½\nå¯¹è±¡åˆ›å»ºæ—¶æ‰åŠ è½½æ¨¡å—\nå‡å°‘å¯åŠ¨æ—¶é—´\n\n\nå®ä¾‹éš”ç¦»\næ¯ä¸ªå¯¹è±¡ç‹¬ç«‹ INSTANCE\næ”¯æŒå¤šå®ä¾‹\n\n\næ¨¡å—ç¼“å­˜\npackage.loaded ç¼“å­˜\né¿å…é‡å¤è§£æ\n\n\nçƒ­æ›´æ–°æ”¯æŒ\nå¯æ›¿æ¢ Lua æ–‡ä»¶\næ— éœ€é‡å¯æ¸¸æˆ\n\n\n\nç±»æ³¨å†Œä¸ç»‘å®šç³»ç»ŸåŒå±‚æ³¨å†Œæ¶æ„UnLua é‡‡ç”¨ç±»æ³¨å†Œå’Œå¯¹è±¡ç»‘å®šçš„åŒå±‚æ¶æ„ï¼š\ngraph TB\n    subgraph ClassRegistry[&quot;ğŸ“š ç±»æ³¨å†Œå±‚ ClassRegistry&quot;]\n        CR1[ç®¡ç† UStruct â†’ FClassDesc æ˜ å°„]\n        CR2[åˆ›å»º Lua Metatable]\n        CR3[æ³¨å†Œåå°„å±æ€§å’Œå‡½æ•°]\n    end\n    \n    subgraph ObjectRegistry[&quot;ğŸ”— å¯¹è±¡ç»‘å®šå±‚ ObjectRegistry&quot;]\n        OR1[ç®¡ç† UObject â†’ Lua Table æ˜ å°„]\n        OR2[åˆ›å»ºå¯¹è±¡å®ä¾‹è¡¨ INSTANCE]\n        OR3[ç®¡ç† GC å¼•ç”¨]\n    end\n    \n    ClassRegistry -.ä½¿ç”¨.-&gt; ObjectRegistry\n    \n    style ClassRegistry fill:#e1f5ff,stroke:#01579b,stroke-width:2px\n    style ObjectRegistry fill:#fff3e0,stroke:#e65100,stroke-width:2px\n\nClassRegistry æ ¸å¿ƒæµç¨‹ç±»æ³¨å†Œæ—¶æœºè¡¨\n\n\næ—¶æœº\nè§¦å‘æ¡ä»¶\nä»£ç ä½ç½®\nå¼€é”€\n\n\n\nå¯åŠ¨æ—¶\nFLuaEnv::Initialize()\næ³¨å†Œ UObject &#x2F; UClass\nä¸€æ¬¡æ€§ï¼Œæä½\n\n\né¦–æ¬¡è®¿é—®\nPushMetatable(&quot;AActor&quot;)\nåå°„æŸ¥è¯¢å¹¶æ³¨å†Œ\né¦–æ¬¡æ…¢ï¼Œåç»­å¿«\n\n\næ˜¾å¼æ³¨å†Œ\nClassRegistry::Register()\næ‰‹åŠ¨è§¦å‘\nå¯æ§\n\n\nåŠ¨æ€ç»‘å®š\nrequire(&quot;Module&quot;)\nå®ä¾‹çº§å…ƒè¡¨è®¾ç½®\næ¯ä¸ªå¯¹è±¡ä¸€æ¬¡\n\n\nLua C API: Metatable æ“ä½œè¯¦è§£åœ¨æ·±å…¥æºç å‰,å…ˆç†è§£ Lua Metatable çš„æ ¸å¿ƒ API:\n\n\n\nAPI\nåŠŸèƒ½\næ ˆå˜åŒ–\nç”¨é€”\n\n\n\nluaL_newmetatable(L, name)\nåˆ›å»ºå‘½åå…ƒè¡¨\n[+1] å‹å…¥æ–°è¡¨\nåˆ›å»ºå…¨å±€å”¯ä¸€å…ƒè¡¨\n\n\nluaL_getmetatable(L, name)\nè·å–å‘½åå…ƒè¡¨\n[+1] å‹å…¥è¡¨æˆ–nil\næŸ¥æ‰¾å·²å­˜åœ¨çš„å…ƒè¡¨\n\n\nlua_setmetatable(L, idx)\nè®¾ç½®å¯¹è±¡å…ƒè¡¨\n[-1] å¼¹å‡ºå…ƒè¡¨\nå…³è”å…ƒè¡¨åˆ°å¯¹è±¡\n\n\nlua_getmetatable(L, idx)\nè·å–å¯¹è±¡å…ƒè¡¨\n[+1] å‹å…¥å…ƒè¡¨\nè¯»å–å¯¹è±¡çš„å…ƒè¡¨\n\n\nlua_rawset(L, idx)\nè¡¨èµ‹å€¼(è·³è¿‡å…ƒæ–¹æ³•)\n[-2] å¼¹å‡ºkey+value\nè®¾ç½®å…ƒæ–¹æ³•\n\n\næ ˆæ“ä½œç¤ºä¾‹:\n// åˆ›å»ºåä¸º &quot;AActor&quot; çš„å…ƒè¡¨luaL_newmetatable(L, &quot;AActor&quot;);// æ ˆ: [..., metatable]lua_pushstring(L, &quot;__index&quot;);// æ ˆ: [..., metatable, &quot;__index&quot;]lua_pushcfunction(L, Class_Index);// æ ˆ: [..., metatable, &quot;__index&quot;, Class_Indexå‡½æ•°]lua_rawset(L, -3);// æ ˆ: [..., metatable]// ç­‰ä»·äº: metatable[&quot;__index&quot;] = Class_Index\n\nMetatable åˆ›å»ºå®Œæ•´æµç¨‹// ClassRegistry.cpp:108bool FClassRegistry::PushMetatable(lua_State* L, const char* MetatableName)&#123;    // â˜… APIè®²è§£: luaL_getmetatable    // åŠŸèƒ½: ä»æ³¨å†Œè¡¨è·å–åä¸º MetatableName çš„å…ƒè¡¨    // è¿”å›å€¼: LUA_TTABLE(å·²å­˜åœ¨) æˆ– LUA_TNIL(ä¸å­˜åœ¨)    // æ ˆå˜åŒ–: [+1, å‹å…¥å…ƒè¡¨æˆ–nil]    if (luaL_getmetatable(L, MetatableName) == LUA_TTABLE)        return true;  // å…ƒè¡¨å·²å­˜åœ¨,ç›´æ¥è¿”å›        lua_pop(L, 1);  // å¼¹å‡º nil        // æ³¨å†Œåå°„ç±»å‹    FClassDesc* ClassDesc = RegisterReflectedType(MetatableName);        // â˜… APIè®²è§£: luaL_newmetatable    // åŠŸèƒ½: åˆ›å»ºæ–°è¡¨å¹¶å­˜å…¥ registry[MetatableName]    // æ ˆå˜åŒ–: [+1, å‹å…¥æ–°åˆ›å»ºçš„å…ƒè¡¨]    // å†…éƒ¨å®ç°:    //   lua_newtable(L);    //   lua_pushvalue(L, -1);    //   lua_setfield(L, LUA_REGISTRYINDEX, MetatableName);    luaL_newmetatable(L, MetatableName);    // æ ˆ: [metatable]        // â˜… è®¾ç½® __index å…ƒæ–¹æ³•    lua_pushstring(L, &quot;__index&quot;);       // æ ˆ: [metatable, &quot;__index&quot;]    lua_pushcfunction(L, Class_Index);  // æ ˆ: [metatable, &quot;__index&quot;, func]        // â˜… APIè®²è§£: lua_rawset    // åŠŸèƒ½: ç­‰ä»·äº t[k]=v, ä½†è·³è¿‡å…ƒæ–¹æ³•    // å‚æ•°: idx = -3 æŒ‡å‘ metatable    // æ ˆå˜åŒ–: [-2, å¼¹å‡ºkeyå’Œvalue]    // ç»“æœ: metatable[&quot;__index&quot;] = Class_Index    lua_rawset(L, -3);      // æ ˆ: [metatable]        // åŒç†è®¾ç½® __newindex    lua_pushstring(L, &quot;__newindex&quot;);    lua_pushcfunction(L, Class_NewIndex);    lua_rawset(L, -3);        // â˜… ç‰¹æ®Šå¤„ç†: UScriptStruct éœ€è¦ __gc å’Œ __call    if (UScriptStruct* ScriptStruct = ClassDesc-&gt;AsScriptStruct())    &#123;        // â˜… APIè®²è§£: lua_pushcclosure        // åŠŸèƒ½: åˆ›å»ºé—­åŒ…,å°†æ ˆé¡¶ n ä¸ªå€¼ä½œä¸º upvalue        // å‚æ•°: n=1 è¡¨ç¤ºä½¿ç”¨ 1 ä¸ª upvalue        // ç”¨é€”: è®© ScriptStruct_Delete èƒ½è®¿é—® ClassDesc        lua_pushstring(L, &quot;__gc&quot;);        lua_pushlightuserdata(L, ClassDesc);  // upvalue        lua_pushcclosure(L, ScriptStruct_Delete, 1);        lua_rawset(L, -3);                lua_pushstring(L, &quot;__call&quot;);        lua_pushlightuserdata(L, ClassDesc);        lua_pushcclosure(L, ScriptStruct_New, 1);        lua_rawset(L, -3);    &#125;        return true;&#125;\n\nLua å…ƒæ–¹æ³•è§¦å‘æ—¶æœº:\nlocal vec = UE.FVector()  -- è§¦å‘ __call (æ„é€ )local x = vec.X           -- è§¦å‘ __index (è¯»å–)vec.Y = 100               -- è§¦å‘ __newindex (å†™å…¥)vec = nil                 -- GCæ—¶è§¦å‘ __gc (ææ„)\n\nObjectRegistry æ ¸å¿ƒæµç¨‹Lua C API: å¼•ç”¨ç³»ç»Ÿè¯¦è§£UnLua ä½¿ç”¨ Lua çš„å¼•ç”¨ç³»ç»Ÿæ¥æŒä¹…åŒ– Lua å¯¹è±¡,é¿å…è¢« GC å›æ”¶:\n\n\n\nAPI\nåŠŸèƒ½\nè¿”å›å€¼\nç”¨é€”\n\n\n\nluaL_ref(L, LUA_REGISTRYINDEX)\nåˆ›å»ºå¼•ç”¨\næ•´æ•°ID\nå¼¹å‡ºæ ˆé¡¶å€¼å¹¶å­˜å…¥registry,è¿”å›ID\n\n\nlua_rawgeti(L, LUA_REGISTRYINDEX, ref)\nè·å–å¼•ç”¨\nå‹æ ˆ\næ ¹æ®IDä»registryå–å‡ºå€¼\n\n\nluaL_unref(L, LUA_REGISTRYINDEX, ref)\né‡Šæ”¾å¼•ç”¨\næ— \nä»registryç§»é™¤,å…è®¸GCå›æ”¶\n\n\nå¼•ç”¨ç³»ç»ŸåŸç†:\n-- Lua registry å†…éƒ¨ç»“æ„ (ä¸å¯ç›´æ¥è®¿é—®)registry = &#123;    [1] = &#123; ... &#125;,  -- ref=1 æŒ‡å‘çš„å¯¹è±¡    [2] = function() ... end,  -- ref=2 æŒ‡å‘çš„å‡½æ•°    -- ...&#125;\n\nC API ç¤ºä¾‹:\n// åˆ›å»ºå¼•ç”¨lua_newtable(L);  // æ ˆ: [table]int ref = luaL_ref(L, LUA_REGISTRYINDEX);  // æ ˆ: [] (tableè¢«å¼¹å‡ºå¹¶å­˜å…¥registry)// ref = 1 (å‡è®¾)// ä½¿ç”¨å¼•ç”¨lua_rawgeti(L, LUA_REGISTRYINDEX, ref);  // æ ˆ: [table] (ä»registryå–å›)// é‡Šæ”¾å¼•ç”¨luaL_unref(L, LUA_REGISTRYINDEX, ref);// registry[ref] = nil (å¯è¢«GCå›æ”¶)\n\nå¯¹è±¡ç»‘å®šå®Œæ•´æµç¨‹// ObjectRegistry.cpp:113int FObjectRegistry::Bind(UObject* Object)&#123;    const auto L = Env-&gt;GetMainState();        // â˜… æ­¥éª¤1: è·å–å¼±å¼•ç”¨è¡¨ UnLua_ObjectMap    // API: lua_getfield(L, idx, key)    // åŠŸèƒ½: ç­‰ä»·äº lua_pushstring + lua_gettable    // ç»“æœ: å‹å…¥ registry[&quot;UnLua_ObjectMap&quot;]    lua_getfield(L, LUA_REGISTRYINDEX, &quot;UnLua_ObjectMap&quot;);    lua_pushlightuserdata(L, Object);  // ä½¿ç”¨å¯¹è±¡æŒ‡é’ˆä½œä¸ºkey        // â˜… æ­¥éª¤2: åˆ›å»º INSTANCE è¡¨    // API: lua_newtable(L)    // åŠŸèƒ½: åˆ›å»ºç©ºè¡¨å¹¶å‹æ ˆ    // æ ˆå˜åŒ–: [+1]    lua_newtable(L);     // æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE]        // â˜… æ­¥éª¤3: åˆ›å»º Userdata ç»‘å®š UObject    PushObjectCore(L, Object);    // æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE, Userdata]        // â˜… æ­¥éª¤4: INSTANCE.Object = Userdata    lua_pushstring(L, &quot;Object&quot;);    // æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE, Userdata, &quot;Object&quot;]        // â˜… APIè®²è§£: lua_pushvalue    // åŠŸèƒ½: å¤åˆ¶æ ˆä¸Šç´¢å¼•å¤„çš„å€¼åˆ°æ ˆé¡¶    // å‚æ•°: -2 è¡¨ç¤ºå€’æ•°ç¬¬2ä¸ª(Userdata)    lua_pushvalue(L, -2);    // æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE, Userdata, &quot;Object&quot;, Userdata]        lua_rawset(L, -4);  // INSTANCE[&quot;Object&quot;] = Userdata    // æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE, Userdata]        // â˜… æ­¥éª¤5: è·å– Lua Module è¡¨    UClass* Class = Object-&gt;GetClass();    int32 ClassBoundRef = Env-&gt;GetManager()-&gt;GetBoundRef(Class);        // â˜… APIè®²è§£: lua_rawgeti    // åŠŸèƒ½: ä»è¡¨ä¸­æŒ‰æ•´æ•°ç´¢å¼•è·å–å€¼    // ç­‰ä»·äº: lua_pushinteger + lua_rawget    int32 TypeModule = lua_rawgeti(L, LUA_REGISTRYINDEX, ClassBoundRef);    // æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE, Userdata, MODULE]        // â˜… æ­¥éª¤6: è·å– Userdata çš„ Metatable    int32 TypeMetatable = lua_getmetatable(L, -2);    // æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE, Userdata, MODULE, METATABLE_UOBJECT]        // â˜… æ­¥éª¤7: è®¾ç½®å…ƒè¡¨ç»§æ‰¿é“¾    // MODULE.metatable = METATABLE_UOBJECT    lua_setmetatable(L, -2);    // æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE, Userdata, MODULE]        // INSTANCE.metatable = MODULE    lua_setmetatable(L, -3);    // æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE, Userdata]        lua_pop(L, 1);  // å¼¹å‡º Userdata    // æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE]        // â˜… æ­¥éª¤8: å¤åˆ¶ INSTANCE å¹¶åˆ›å»ºå¼•ç”¨    lua_pushvalue(L, -1);    // æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE, INSTANCE]        // â˜… APIè®²è§£: luaL_ref    // åŠŸèƒ½: å¼¹å‡ºæ ˆé¡¶å€¼,å­˜å…¥ registry[idx],è¿”å›æ•´æ•°ID    // ç”¨é€”: è®©C++èƒ½éšæ—¶é€šè¿‡IDè®¿é—®è¿™ä¸ªLuaè¡¨    const auto Ref = luaL_ref(L, LUA_REGISTRYINDEX);    ObjectRefs.Add(Object, Ref);  // C++ ç«¯ä¿å­˜æ˜ å°„    // æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ, INSTANCE]        // â˜… æ­¥éª¤9: ç¼“å­˜åˆ°å¼±å¼•ç”¨è¡¨    // ObjectMap[ObjectæŒ‡é’ˆ] = INSTANCE    lua_rawset(L, -3);    lua_pop(L, 1);        return Ref;&#125;\n\nå…ƒè¡¨ç»§æ‰¿é“¾ç»“æœ:\nINSTANCE &#123;    Object = &lt;Userdata&gt;,    metatable = MODULE &#123;        ReceiveBeginPlay = function(...) end,        metatable = METATABLE_UOBJECT &#123;            __index = Class_Index,            __newindex = Class_NewIndex,            __gc = UObject_Delete,            ...        &#125;    &#125;&#125;\n\nè®¿é—®æµç¨‹ç¤ºä¾‹:\n-- Lua ä»£ç instance:GetName()-- æŸ¥æ‰¾è¿‡ç¨‹:-- 1. instance[&quot;GetName&quot;]      â†’ nil-- 2. MODULE[&quot;GetName&quot;]        â†’ nil  -- 3. METATABLE_UOBJECT.__index(instance, &quot;GetName&quot;)--    â†’ Class_Index é€šè¿‡åå°„æ‰¾åˆ° UFunction--    â†’ è¿”å› C closure\n\nå…ƒè¡¨ç»§æ‰¿é“¾ç¤ºæ„å›¾graph TB\n    INSTANCE[&quot;INSTANCE&lt;br/&gt;å¯¹è±¡å®ä¾‹ Table&lt;br/&gt;â”â”â”â”â”â”â”â”â”â”&lt;br/&gt;Object: &amp;lt;Userdata&amp;gt;&quot;]\n    MODULE[&quot;MODULE Lua&lt;br/&gt;â”â”â”â”â”â”â”â”â”â”&lt;br/&gt;ReceiveBeginPlay&lt;br/&gt;ReceiveTick&quot;]\n    UACTOR[&quot;UActor&lt;br/&gt;C++ åå°„&lt;br/&gt;â”â”â”â”â”â”â”â”â”â”&lt;br/&gt;BeginPlay&lt;br/&gt;Tick&quot;]\n    UOBJECT[&quot;UObject&lt;br/&gt;â”â”â”â”â”â”â”â”â”â”&lt;br/&gt;åŸºç±»&quot;]\n    \n    INSTANCE --&gt;|metatable| MODULE\n    MODULE --&gt;|metatable| UACTOR\n    UACTOR --&gt;|Super| UOBJECT\n    \n    style INSTANCE fill:#e1f5ff,stroke:#01579b,stroke-width:2px\n    style MODULE fill:#fff3e0,stroke:#e65100,stroke-width:2px\n    style UACTOR fill:#f3e5f5,stroke:#4a148c,stroke-width:2px\n    style UOBJECT fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px\n\nåŠ¨æ€ç»‘å®š vs é™æ€ç»‘å®š\n\n\nç»´åº¦\nåŠ¨æ€ç»‘å®š\né™æ€ç»‘å®š (åå°„)\n\n\n\næ³¨å†Œæ—¶æœº\nLua æ¨¡å—åŠ è½½æ—¶\né¦–æ¬¡è®¿é—®ç±»å‹æ—¶\n\n\nå…ƒè¡¨ç»“æ„\nINSTANCE.metatable = MODULE\nINSTANCE.metatable = UClass\n\n\nå‡½æ•°æŸ¥æ‰¾\nå…ˆæŸ¥ MODULEï¼Œå†æŸ¥çˆ¶ç±»\nå…ˆæŸ¥ Metatable ç¼“å­˜ï¼Œå†åå°„\n\n\nè¦†å†™æœºåˆ¶\nLua å‡½æ•°ç›´æ¥è¦†ç›–\néœ€è¦ Hook ProcessEvent\n\n\næ€§èƒ½\nå‡½æ•°æŸ¥æ‰¾å¿«\né¦–æ¬¡æ…¢ï¼Œåç»­å¿«\n\n\nçµæ´»æ€§\nå¯éšæ—¶ä¿®æ”¹ MODULE\nå›ºå®šç±»å‹\n\n\n\nå‡½æ•°è¦†å†™åŸç†è¦†å†™æœºåˆ¶æ·±åº¦è§£æLua C API: å‡½æ•°è°ƒç”¨è¯¦è§£æ ¸å¿ƒè°ƒç”¨ API:\n\n\n\nAPI\nåŠŸèƒ½\nå‚æ•°\né”™è¯¯å¤„ç†\n\n\n\nlua_call(L, nargs, nresults)\nè°ƒç”¨å‡½æ•°\nå‚æ•°ä¸ªæ•°,è¿”å›å€¼ä¸ªæ•°\né”™è¯¯ä¼šå‘ä¸Šä¼ æ’­\n\n\nlua_pcall(L, nargs, nresults, errfunc)\nä¿æŠ¤è°ƒç”¨\nåŒä¸Š+é”™è¯¯å¤„ç†å‡½æ•°ç´¢å¼•\næ•è·é”™è¯¯ä¸å´©æºƒ\n\n\nlua_pushcfunction(L, func)\nå‹å…¥Cå‡½æ•°\nCå‡½æ•°æŒ‡é’ˆ\næ— \n\n\nlua_pushcclosure(L, func, n)\nå‹å…¥é—­åŒ…\nCå‡½æ•°+upvalueæ•°é‡\nå¯è®¿é—®upvalue\n\n\nlua_pcall è¯¦è§£:\n// å‡½æ•°åŸå‹int lua_pcall(lua_State *L, int nargs, int nresults, int errfunc);// å‚æ•°è¯´æ˜:// nargs:    å‚æ•°ä¸ªæ•° (ä»æ ˆé¡¶å¾€ä¸‹æ•°)// nresults: æœŸæœ›çš„è¿”å›å€¼ä¸ªæ•° (LUA_MULTRET = æ‰€æœ‰è¿”å›å€¼)// errfunc:  é”™è¯¯å¤„ç†å‡½æ•°çš„æ ˆç´¢å¼• (0 = æ— )// è¿”å›å€¼:   LUA_OK(0) æˆåŠŸ, LUA_ERRRUN ç­‰é”™è¯¯ç // æ ˆå¸ƒå±€ (è°ƒç”¨å‰):// [..., function, arg1, arg2, ..., argN]//       ^               ^//       errfunc?        nargs=N// æ ˆå¸ƒå±€ (è°ƒç”¨å,æˆåŠŸ):// [..., result1, result2, ..., resultM]//       nresults=M// æ ˆå¸ƒå±€ (è°ƒç”¨å,å¤±è´¥):// [..., error_message]\n\nç¤ºä¾‹å¯¹æ¯”:\n// âŒ lua_call: é”™è¯¯ä¼šå´©æºƒlua_getglobal(L, &quot;MyFunction&quot;);lua_pushinteger(L, 42);lua_call(L, 1, 1);  // å¦‚æœ MyFunction æŠ›é”™,æ•´ä¸ªè¿›ç¨‹å´©æºƒ// âœ… lua_pcall: å®‰å…¨lua_getglobal(L, &quot;MyFunction&quot;);lua_pushinteger(L, 42);if (lua_pcall(L, 1, 1, 0) != LUA_OK)&#123;    const char* error = lua_tostring(L, -1);    UE_LOG(LogUnLua, Error, TEXT(&quot;%s&quot;), UTF8_TO_TCHAR(error));    lua_pop(L, 1);  // å¼¹å‡ºé”™è¯¯ä¿¡æ¯&#125;\n\nUnLua çš„å‡½æ•°è¦†å†™é€šè¿‡æ‹¦æˆª UObject::ProcessEvent å®ç°ã€‚\nHook æµç¨‹å›¾åŸå§‹è°ƒç”¨é“¾:\nflowchart TD\n    A[AActor::BeginPlay] --&gt; B[UFunction::Invoke]\n    B --&gt; C[UObject::ProcessEvent Function, Params]\n    C --&gt; D[æ‰§è¡Œè“å›¾å­—èŠ‚ç  / C++ åŸç”Ÿå‡½æ•°]\n    \n    style A fill:#e1f5ff,stroke:#01579b,stroke-width:2px\n    style D fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px\n\nUnLua Hook å:\nflowchart TD\n    A[AActor::BeginPlay] --&gt; B[UFunction::Invoke]\n    B --&gt; C[UObject::ProcessEvent Function, Params]\n    C --&gt; D[&quot;FLuaOverrider::ProcessEvent&lt;br/&gt;âš¡ Hook æ‹¦æˆªç‚¹&quot;]\n    D --&gt; E&#123;æ£€æŸ¥æ˜¯å¦æœ‰&lt;br/&gt;Lua è¦†å†™?&#125;\n    E --&gt;|YES| F[FFunctionDesc::CallLua]\n    E --&gt;|NO| G[Super::ProcessEvent]\n    F --&gt; H[lua_pcall LuaFunction]\n    H --&gt; I[è¿”å›å€¼å¤„ç†]\n    G --&gt; I\n    \n    style A fill:#e1f5ff,stroke:#01579b,stroke-width:2px\n    style D fill:#ffccbc,stroke:#bf360c,stroke-width:2px\n    style E fill:#fff9c4,stroke:#f57f17,stroke-width:2px\n    style F fill:#f3e5f5,stroke:#4a148c,stroke-width:2px\n\nCallLua æ ¸å¿ƒæºç å‰–æ// FunctionDesc.cpp:300void FFunctionDesc::CallLua(lua_State* L, lua_Integer FunctionRef,                            lua_Integer SelfRef, FFrame&amp; Stack, RESULT_DECL)&#123;    // â˜… æ­¥éª¤1: åˆ†é…å‚æ•°ç¼“å†²åŒº    void* Params = Buffer-&gt;GetBuffer();        // â˜… æ­¥éª¤2: ä» UE Stack æ‹·è´å‚æ•°åˆ°ç¼“å†²åŒº    for (FProperty* Property = Stack.Function-&gt;PropertyLink; Property;          Property = Property-&gt;PropertyLinkNext)    &#123;        Stack.Step(Stack.Object, Property-&gt;ContainerPtrToValuePtr&lt;void&gt;(Params));    &#125;        // â˜… æ­¥éª¤3: APIè®²è§£ lua_rawgeti    // åŠŸèƒ½: ä» registry ä¸­æ ¹æ®æ•´æ•°ç´¢å¼•è·å–å€¼    // ç”¨é€”: å–å‡ºä¹‹å‰å­˜å‚¨çš„ Lua å‡½æ•°å¼•ç”¨    // ç­‰ä»·äº: lua_pushinteger(L, ref); lua_gettable(L, LUA_REGISTRYINDEX);    lua_rawgeti(L, LUA_REGISTRYINDEX, FunctionRef);      // æ ˆ: [function]        lua_rawgeti(L, LUA_REGISTRYINDEX, SelfRef);    // æ ˆ: [function, self]        // â˜… æ­¥éª¤4: å‚æ•°è½¬æ¢: C++ â†’ Lua    int NumParams = 1;  // ä» self å¼€å§‹    for (int i = 0; i &lt; Properties.Num(); ++i)    &#123;        if (!Properties[i]-&gt;IsReturnParameter())        &#123;            // å°† C++ å‚æ•°å‹æ ˆ            Properties[i]-&gt;ReadValue_InContainer(L, Params, false);            NumParams++;        &#125;    &#125;    // æ ˆ: [function, self, arg1, arg2, ..., argN]        // â˜… æ­¥éª¤5: APIè®²è§£ lua_pcall    // å‚æ•°è§£æ:    //   NumParams:   å‚æ•°ä¸ªæ•° (åŒ…å« self)    //   NumResults:  æœŸæœ›è¿”å›å€¼ä¸ªæ•°    //   ErrorHandler: é”™è¯¯å¤„ç†å‡½æ•°ç´¢å¼•    int32 NumResults = GetNumOutProperties();    if (lua_pcall(L, NumParams, NumResults, ErrorHandler) != LUA_OK)    &#123;        // â˜… é”™è¯¯å¤„ç†        // æ ˆ: [error_message]        const char* ErrorMsg = lua_tostring(L, -1);        UE_LOG(LogUnLua, Error, TEXT(&quot;Lua Error: %s&quot;), UTF8_TO_TCHAR(ErrorMsg));        lua_pop(L, 1);        return;    &#125;    // æ ˆ(æˆåŠŸ): [result1, result2, ..., resultM]        // â˜… æ­¥éª¤6: è¿”å›å€¼å¤„ç†    if (HasReturnProperty())    &#123;        FPropertyDesc* RetProp = Properties[ReturnPropertyIndex].Get();        void* RetAddress = RetProp-&gt;GetUProperty()-&gt;ContainerPtrToValuePtr&lt;void&gt;(Params);                // â˜… APIè®²è§£: è´Ÿç´¢å¼•å–å€¼        // -NumResults è¡¨ç¤ºä»è¿”å›å€¼æœ€åä¸€ä¸ªå¼€å§‹        RetProp-&gt;WriteValue(L, RetAddress, -NumResults);    &#125;        // â˜… æ­¥éª¤7: Out å‚æ•°å›å†™    for (int32 OutIndex : OutPropertyIndices)    &#123;        // ä¾æ¬¡ä»æ ˆé¡¶å–å‡º out å‚æ•°å†™å› C++        Properties[OutIndex]-&gt;WriteValue_InContainer(L, Params, -(--NumResults));    &#125;&#125;\n\nå®é™…è°ƒç”¨ç¤ºä¾‹:\n-- Lua ä»£ç function MyActor:ReceiveBeginPlay()    local pos = self:K2_GetActorLocation()    print(&quot;Actorä½ç½®:&quot;, pos.X, pos.Y, pos.Z)end\n\nC++ è°ƒç”¨æµç¨‹:\nsequenceDiagram\n    participant BP as è“å›¾ BeginPlay\n    participant PE as ProcessEvent Hook\n    participant CL as CallLua\n    participant Lua as Lua å‡½æ•°\n    participant UE as UE å¼•æ“\n    \n    BP-&gt;&gt;PE: 1. è§¦å‘ BeginPlay\n    PE-&gt;&gt;CL: 2. æ‹¦æˆªè°ƒç”¨\n    CL-&gt;&gt;CL: 3. lua_rawgeti æŸ¥æ‰¾å‡½æ•°&lt;br/&gt;å‹å…¥ MyActor:ReceiveBeginPlay\n    CL-&gt;&gt;CL: 4. lua_rawgeti å‹å…¥ self&lt;br/&gt;æ ˆ: [function, self]\n    CL-&gt;&gt;Lua: 5. lua_pcall(L, 1, 0, errfunc)\n    Lua-&gt;&gt;UE: 6. self:K2_GetActorLocation()&lt;br/&gt;è·¨å› C++ (CallUE)\n    UE--&gt;&gt;Lua: è¿”å›ä½ç½®\n    Lua--&gt;&gt;CL: è¿”å›\n    CL--&gt;&gt;BP: 7. è¿”å› UE å¼•æ“ç»§ç»­æ‰§è¡Œ\n    \n    Note over BP,UE: å®Œæ•´çš„åŒå‘è°ƒç”¨æµç¨‹\n\næ­¥éª¤è¯¦è§£:\nflowchart TB\n    A[FindFunctionChecked FName] --&gt; B[Class::FindFunctionByName]\n    B --&gt; C[FuncMap.Find SpawnText]\n    C --&gt; D&#123;æ˜¯å¦è¦†å†™?&#125;\n    D --&gt;|æœªè¦†å†™| E1[è¿”å›åŸå§‹ UFunction]\n    D --&gt;|å·²è¦†å†™| E2[&quot;è¿”å› ULuaFunction&lt;br/&gt;âš¡ Lua è¦†å†™æ—¶æ·»åŠ çš„&quot;]\n    \n    E1 --&gt; F[ProcessEvent Function, Params]\n    E2 --&gt; F\n    \n    F --&gt; G&#123;æ£€æŸ¥ GetNativeFunc&#125;\n    G --&gt;|C++ å‡½æ•°| H1[execSpawnText_Implementation]\n    G --&gt;|è“å›¾å­—èŠ‚ç | H2[ProcessInternal]\n    G --&gt;|Lua è¦†å†™| H3[execCallLua]\n    \n    H3 --&gt; I[ULuaFunction::CallLua]\n    I --&gt; J[lua_pcall L, ...]\n    \n    style D fill:#fff9c4,stroke:#f57f17,stroke-width:2px\n    style E2 fill:#ffccbc,stroke:#bf360c,stroke-width:2px\n    style H3 fill:#f3e5f5,stroke:#4a148c,stroke-width:2px\n\nè¦†å†™æœºåˆ¶æºç å®Œæ•´å‰–æç¬¬ä¸€æ­¥: å‡½æ•°è¦†ç›–æ³¨å†Œ (UUnLuaManager::BindClass)\n// UnLuaManager.cpp:180bool UUnLuaManager::BindClass(UClass* Class, const FString&amp; InModuleName, FString&amp; Error)&#123;    check(Class);        // â˜… æ­¥éª¤1: åŠ è½½ Lua Module åˆ°æ ˆé¡¶    int Ref = LoadModule(InModuleName);    if (Ref == LUA_REFNIL)        return false;        // â˜… æ­¥éª¤2: åˆ›å»ºç»‘å®šä¿¡æ¯    auto&amp; BindInfo = Classes.Add(Class);    BindInfo.Class = Class;    BindInfo.ModuleName = InModuleName;    BindInfo.TableRef = Ref;        // â˜… æ­¥éª¤3: è·å– Lua Module çš„æ‰€æœ‰å‡½æ•°å    // ç­‰ä»·äº: for k, v in pairs(Module) do if type(v) == &quot;function&quot; then ... end end    UnLua::LowLevel::GetFunctionNames(Env-&gt;GetMainState(), Ref, BindInfo.LuaFunctions);    // ç»“æœ: BindInfo.LuaFunctions = &#123;&quot;ReceiveBeginPlay&quot;, &quot;ReceiveTick&quot;, ...&#125;        // â˜… æ­¥éª¤4: è·å– UClass çš„æ‰€æœ‰å¯è¦†å†™å‡½æ•°    ULuaFunction::GetOverridableFunctions(Class, BindInfo.UEFunctions);    // ç»“æœ: BindInfo.UEFunctions = &#123;    //   &quot;ReceiveBeginPlay&quot; -&gt; UFunction*,    //   &quot;ReceiveTick&quot; -&gt; UFunction*,    //   ...    // &#125;        // â˜… æ­¥éª¤5: éå† Lua å‡½æ•°,è¦†å†™åŒå UFunction    for (const auto&amp; LuaFuncName : BindInfo.LuaFunctions)    &#123;        UFunction** Func = BindInfo.UEFunctions.Find(LuaFuncName);        if (Func)        &#123;            UFunction* Function = *Func;            // â˜… å…³é”®: æ‰§è¡Œè¦†å†™é€»è¾‘            ULuaFunction::Override(Function, Class, LuaFuncName);        &#125;    &#125;        return true;&#125;\n\nç¬¬äºŒæ­¥: åˆ›å»º ULuaFunction (FLuaOverrides::Override)\n// LuaOverrides.cpp:66void FLuaOverrides::Override(UFunction* Function, UClass* Class, FName NewName)&#123;    // â˜… æ­¥éª¤1: è·å–æˆ–åˆ›å»ºè¦†å†™ç±»    const auto OverridesClass = GetOrAddOverridesClass(Class);    // è¿™æ˜¯ä¸€ä¸ªä¸´æ—¶ UClass,ç”¨äºå­˜å‚¨æ‰€æœ‰è¦†å†™å‡½æ•°        // â˜… æ­¥éª¤2: åˆ¤æ–­æ˜¯æ–°å¢è¿˜æ˜¯å·²å­˜åœ¨    const auto bAddNew = Function-&gt;GetOuter() != Class;    // bAddNew = true:  C++ åŸç”Ÿå‡½æ•° (Outer æ˜¯çˆ¶ç±»)    // bAddNew = false: è“å›¾å‡½æ•° (Outer å°±æ˜¯å½“å‰ç±»)        ULuaFunction* LuaFunction;        if (!bAddNew)    &#123;        // è“å›¾å‡½æ•°:æ£€æŸ¥æ˜¯å¦å·²è¦†å†™        LuaFunction = Cast&lt;ULuaFunction&gt;(Function);        if (LuaFunction)        &#123;            LuaFunction-&gt;Initialize();            return;  // å·²è¦†å†™,è·³è¿‡        &#125;    &#125;        // â˜… æ­¥éª¤3: æ‹·è´ UFunction å¹¶è½¬æ¢ä¸º ULuaFunction    FObjectDuplicationParameters DuplicationParams(Function, OverridesClass);    DuplicationParams.InternalFlagMask &amp;= ~EInternalObjectFlags::Native;    DuplicationParams.DestName = NewName;    DuplicationParams.DestClass = ULuaFunction::StaticClass();  // â† å…³é”®        LuaFunction = static_cast&lt;ULuaFunction*&gt;(StaticDuplicateObjectEx(DuplicationParams));        // â˜… æ­¥éª¤4: åŠ å…¥åˆ° OverridesClass çš„ Children é“¾è¡¨    LuaFunction-&gt;Next = OverridesClass-&gt;Children;    OverridesClass-&gt;Children = LuaFunction;        LuaFunction-&gt;StaticLink(true);    LuaFunction-&gt;Initialize();        // â˜… æ­¥éª¤5: æ‰§è¡Œè¦†å†™é€»è¾‘    LuaFunction-&gt;Override(Function, Class, bAddNew);    LuaFunction-&gt;Bind();        // â˜… æ­¥éª¤6: é˜²æ­¢ GC å›æ”¶    if (Class-&gt;IsRooted() || GUObjectArray.IsDisregardForGC(Class))        LuaFunction-&gt;AddToRoot();    else        LuaFunction-&gt;AddToCluster(Class);&#125;\n\nç¬¬ä¸‰æ­¥: ç»‘å®š Lua è°ƒç”¨å…¥å£ (ULuaFunction::Override)\n// LuaFunction.cpp:120void ULuaFunction::Override(UFunction* Function, UClass* Class, bool bAddNew)&#123;    check(Function &amp;&amp; Class &amp;&amp; !From.IsValid());    #if WITH_METADATA    UMetaData::CopyMetadata(Function, this);#endif        bActivated = false;    bAdded = bAddNew;    From = Function;  // ä¿å­˜åŸå§‹å‡½æ•°å¼•ç”¨        // â˜… æ­¥éª¤1: æ£€æŸ¥æ˜¯å¦å·²è¢«è¦†å†™è¿‡    if (Function-&gt;GetNativeFunc() == execScriptCallLua)    &#123;        // å·²ç»è¢«è¦†å†™,æå–åŸå§‹å‡½æ•°        const auto LuaFunction = Get(Function);        Overridden = LuaFunction-&gt;GetOverridden();        check(Overridden);    &#125;    else    &#123;        // â˜… æ­¥éª¤2: å¤‡ä»½åŸå§‹å‡½æ•°        const auto DestName = FString::Printf(TEXT(&quot;%s__Overridden&quot;), *Function-&gt;GetName());                if (Function-&gt;HasAnyFunctionFlags(FUNC_Native))        &#123;            // C++ å‡½æ•°: éœ€è¦æ³¨å†ŒåŸç”Ÿå‡½æ•°æŒ‡é’ˆ            GetOuterUClass()-&gt;AddNativeFunction(*DestName, *Function-&gt;GetNativeFunc());        &#125;                // æ‹·è´åŸå§‹å‡½æ•°        Overridden = static_cast&lt;UFunction*&gt;(StaticDuplicateObject(Function, GetOuter(), *DestName));        Overridden-&gt;ClearInternalFlags(EInternalObjectFlags::Native);        Overridden-&gt;StaticLink(true);        Overridden-&gt;SetNativeFunc(Function-&gt;GetNativeFunc());        // ç°åœ¨ Overridden ä¿å­˜äº†åŸå§‹å®ç°,Lua å¯é€šè¿‡ self.Overridden:XXX() è°ƒç”¨    &#125;        // â˜… æ­¥éª¤3: æ¿€æ´»è¦†å†™    SetActive(true);&#125;\n\nç¬¬å››æ­¥: è®¾ç½®è°ƒç”¨å…¥å£ (ULuaFunction::SetActive)\n// LuaFunction.cpp:156void ULuaFunction::SetActive(bool bActive)&#123;    if (bActive == bActivated)        return;        bActivated = bActive;    auto Function = From.Get();    check(Function);        if (bAdded)    &#123;        // â˜… åˆ†æ”¯A: C++ åŸç”Ÿå‡½æ•°è¦†å†™        // å°† ULuaFunction åŠ å…¥åˆ° Class-&gt;FuncMap        check(!Class-&gt;FindFunctionByName(GetFName(), EIncludeSuperFlag::ExcludeSuper));                SetSuperStruct(Function);        FunctionFlags |= FUNC_Native;        ClearInternalFlags(EInternalObjectFlags::Native);                // â˜… å…³é”®: è®¾ç½® NativeFunc ä¸º execCallLua        SetNativeFunc(execCallLua);                // â˜… æ·»åŠ åˆ° FuncMap        Class-&gt;AddFunctionToFunctionMap(this, *GetName());                if (Function-&gt;HasAnyFunctionFlags(FUNC_Native))            Class-&gt;AddNativeFunction(*GetName(), &amp;ULuaFunction::execCallLua);    &#125;    else    &#123;        // â˜… åˆ†æ”¯B: è“å›¾å‡½æ•°è¦†å†™        // ä¿®æ”¹åŸå§‹ UFunction,è®©å®ƒè°ƒç”¨ Lua                SetSuperStruct(Function-&gt;GetSuperStruct());        Script = Function-&gt;Script;        Children = Function-&gt;Children;        ChildProperties = Function-&gt;ChildProperties;        PropertyLink = Function-&gt;PropertyLink;                // â˜… ä¿®æ”¹åŸå§‹å‡½æ•°çš„ NativeFunc        Function-&gt;FunctionFlags |= FUNC_Native;        Function-&gt;SetNativeFunc(&amp;execScriptCallLua);        Function-&gt;GetOuterUClass()-&gt;AddNativeFunction(*Function-&gt;GetName(), &amp;execScriptCallLua);                // â˜… æ¸…ç©ºè“å›¾å­—èŠ‚ç ,æ”¹ä¸ºå­˜å‚¨ ULuaFunction æŒ‡é’ˆ        Function-&gt;Script.Empty();        Function-&gt;Script.AddUninitialized(ScriptMagicHeaderSize + sizeof(ULuaFunction*));                const auto Data = Function-&gt;Script.GetData();        FPlatformMemory::Memcpy(Data, ScriptMagicHeader, ScriptMagicHeaderSize);        FPlatformMemory::WriteUnaligned&lt;ULuaFunction*&gt;(Data + ScriptMagicHeaderSize, this);        // ç°åœ¨ Function-&gt;Script å­˜å‚¨çš„æ˜¯ ULuaFunction* è€Œéå­—èŠ‚ç     &#125;&#125;\n\nexecScriptCallLua å®ç°:\n// LuaFunction.cpp:280DEFINE_FUNCTION(ULuaFunction::execScriptCallLua)&#123;    // â˜… ä» Script ä¸­æå– ULuaFunction æŒ‡é’ˆ    const auto Data = Stack.Node-&gt;Script.GetData();    auto LuaFunction = FPlatformMemory::ReadUnaligned&lt;ULuaFunction*&gt;(Data + ScriptMagicHeaderSize);        // â˜… è°ƒç”¨ Lua å‡½æ•°    LuaFunction-&gt;CallLua(Context, Stack, RESULT_PARAM);&#125;\n\nè°ƒç”¨æµç¨‹æ€»ç»“:\nflowchart TD\n    Start([C++ è°ƒç”¨: actor-&gt;SpawnText]) --&gt; A[FindFunctionChecked SpawnText]\n    A --&gt; B&#123;åœ¨ FuncMap æŸ¥æ‰¾&#125;\n    B --&gt;|æ‰¾åˆ°| C[ULuaFunction]\n    C --&gt; D[ProcessEvent ULuaFunction, Params]\n    D --&gt; E&#123;bAddNew?&#125;\n    E --&gt;|true| F[execCallLua]\n    E --&gt;|false| G[execScriptCallLua]\n    F --&gt; H[ULuaFunction::CallLua]\n    G --&gt; H\n    H --&gt; I[lua_pcall L, ReceiveSpawnText, ...]\n    I --&gt; J[æ‰§è¡Œ Lua ä»£ç ]\n    J --&gt; K&#123;éœ€è¦è°ƒç”¨åŸå§‹å®ç°?&#125;\n    K --&gt;|æ˜¯| L[self.Overridden:SpawnText_Implementation&lt;br/&gt;è°ƒç”¨ C++ åŸå§‹å®ç°]\n    K --&gt;|å¦| M([è¿”å›])\n    L --&gt; M\n    \n    style Start fill:#e1f5ff,stroke:#01579b,stroke-width:2px\n    style E fill:#fff9c4,stroke:#f57f17,stroke-width:2px\n    style H fill:#ffccbc,stroke:#bf360c,stroke-width:2px\n    style J fill:#f3e5f5,stroke:#4a148c,stroke-width:2px\n    style M fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px\n\næŸ¥æ‰¾ä¼˜å…ˆçº§-- å‡è®¾ç»§æ‰¿å…³ç³»: UObject -&gt; AActor -&gt; ACharacter -&gt; AMyPlayer-- Lua Module: MyPlayer.luafunction MyPlayer:ReceiveTick(DeltaSeconds)    -- Lua è¦†å†™end-- æŸ¥æ‰¾é¡ºåº:1. MyPlayer.ReceiveTick       â† ä¼˜å…ˆçº§æœ€é«˜ (Lua è¦†å†™)2. AMyPlayer.Tick             â† C++ åŸç”Ÿå‡½æ•°3. ACharacter.Tick            â† çˆ¶ç±» C++ å‡½æ•°4. AActor.Tick                â† åŸºç±» C++ å‡½æ•°\n\nSuper è°ƒç”¨æœºåˆ¶function MyPlayer:ReceiveTick(DeltaSeconds)    -- è°ƒç”¨çˆ¶ç±» Lua å®ç° (å¦‚æœå­˜åœ¨)    self.Super:ReceiveTick(DeltaSeconds)        -- æˆ–è€…è°ƒç”¨ C++ åŸå§‹å®ç°    self.Overridden.Tick(self, DeltaSeconds)        -- è‡ªå®šä¹‰é€»è¾‘    print(&quot;Lua Tick: &quot; .. DeltaSeconds)end\n\nå®ç°åŸç†:\nINSTANCE çš„ metatable ç»“æ„:INSTANCE = &#123;    metatable = MODULE,    Overridden = METATABLE_UOBJECT  â† æŒ‡å‘ C++ åŸå§‹ Metatable&#125;\n\nè¦†å†™æ£€æµ‹ä¸å±æ€§è®¿é—®æµç¨‹Lua C API: æ ˆæ“ä½œåŸºç¡€åœ¨ç†è§£ Class_Index å‰,å¿…é¡»æŒæ¡ Lua æ ˆçš„æ ¸å¿ƒæ¦‚å¿µ:\næ ˆç´¢å¼•è§„åˆ™:\nLua æ ˆç»“æ„ (ä»åº•åˆ°é¡¶):â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  4  (-1)       â”‚ â† æ ˆé¡¶ (æœ€è¿‘å‹å…¥)â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚  3  (-2)       â”‚â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚  2  (-3)       â”‚â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚  1  (-4)       â”‚ â† æ ˆåº• (æœ€æ—©å‹å…¥)â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜æ­£æ•°ç´¢å¼•: ä»æ ˆåº•å¼€å§‹ (1-based)è´Ÿæ•°ç´¢å¼•: ä»æ ˆé¡¶å¼€å§‹ (-1 è¡¨ç¤ºæ ˆé¡¶)\n\næ ¸å¿ƒæ ˆæ“ä½œ API:\n\n\n\nAPI\nåŠŸèƒ½\næ ˆå˜åŒ–\nç¤ºä¾‹\n\n\n\nlua_gettop(L)\nè·å–æ ˆé¡¶ç´¢å¼•\næ— \nint n = lua_gettop(L);\n\n\nlua_settop(L, n)\nè®¾ç½®æ ˆå¤§å°\næˆªæ–­æˆ–å¡«å……nil\nlua_settop(L, 0); æ¸…ç©ºæ ˆ\n\n\nlua_pushvalue(L, idx)\nå¤åˆ¶å€¼åˆ°æ ˆé¡¶\n[+1]\nå¤åˆ¶æ ˆä¸Šä»»æ„ä½ç½®\n\n\nlua_remove(L, idx)\nç§»é™¤æŒ‡å®šä½ç½®\n[-1]\næ ˆä¸Šæ‰€æœ‰å€¼ä¸Šç§»\n\n\nlua_pop(L, n)\nå¼¹å‡ºnä¸ªå€¼\n[-n]\nç­‰ä»·äº lua_settop(L, -n-1)\n\n\nlua_touserdata(L, idx)\nè·å–userdata\næ— \nè¿”å›void*æŒ‡é’ˆ\n\n\nClass_Index å®Œæ•´æºç å‰–æ// LuaCore.cpp:1196int32 Class_Index(lua_State *L)&#123;    // â˜… åˆå§‹æ ˆçŠ¶æ€    // æ ˆ: [1]=userdata(self), [2]=string(key)]    // Luaè°ƒç”¨: obj.GetName æˆ– obj[&quot;GetName&quot;]    // è§¦å‘ __index å…ƒæ–¹æ³•,ä¼ å…¥ (obj, &quot;GetName&quot;)        // â˜… æ­¥éª¤1: æŸ¥æ‰¾å­—æ®µæè¿°ç¬¦    // GetField ä¼šä» ClassRegistry æŸ¥æ‰¾å±æ€§æˆ–å‡½æ•°    GetField(L);    // æ ˆ: [userdata(self), string(key), field_descriptoræˆ–nil]        // â˜… æ­¥éª¤2: APIè®²è§£ lua_touserdata    // åŠŸèƒ½: è·å–userdataçš„æŒ‡é’ˆ,å¦‚æœä¸æ˜¯userdataè¿”å›NULL    // å‚æ•°: -1 è¡¨ç¤ºæ ˆé¡¶    auto Ptr = lua_touserdata(L, -1);    if (!Ptr)        return 1;  // éuserdata,ç›´æ¥è¿”å›æ ˆé¡¶å€¼(å‡½æ•°/nil)        // â˜… æ­¥éª¤3: è§£æå±æ€§æè¿°ç¬¦    auto Property = static_cast&lt;TSharedPtr&lt;UnLua::ITypeOps&gt;*&gt;(Ptr);    if (!Property-&gt;IsValid())        return 0;        // â˜… æ­¥éª¤4: è·å– C++ å®ä¾‹æŒ‡é’ˆ    // GetCppInstance ä» userdata æå–äºŒçº§æŒ‡é’ˆ    auto Self = GetCppInstance(L, 1);    if (!Self)        return 1;        // â˜… æ­¥éª¤5: æ‚¬ç©ºæŒ‡é’ˆæ£€æµ‹    // é˜²æ­¢è®¿é—®å·²é”€æ¯çš„ UObject    if (UnLua::LowLevel::IsReleasedPtr(Self))    &#123;        // â˜… APIè®²è§£: luaL_error        // åŠŸèƒ½: æŠ›å‡ºLuaé”™è¯¯å¹¶ç»ˆæ­¢å½“å‰è°ƒç”¨        // è¿”å›å€¼: æ°¸ä¸è¿”å› (long jump)        return luaL_error(L,             TCHAR_TO_UTF8(*FString::Printf(                TEXT(&quot;attempt to read property &#x27;%s&#x27; on released object&quot;),                 *(*Property)-&gt;GetName())));    &#125;        // â˜… æ­¥éª¤6: è¯»å–å±æ€§å€¼    // ReadValue_InContainer ä¼šæ ¹æ®ç±»å‹è½¬æ¢å¹¶å‹æ ˆ    (*Property)-&gt;ReadValue_InContainer(L, Self, false);    // æ ˆ: [userdata(self), string(key), field_descriptor, property_value]        // â˜… æ­¥éª¤7: APIè®²è§£ lua_remove    // åŠŸèƒ½: ç§»é™¤æŒ‡å®šç´¢å¼•å¤„çš„å€¼,åé¢çš„å€¼å‰ç§»    // å‚æ•°: -2 è¡¨ç¤ºå€’æ•°ç¬¬2ä¸ª(field_descriptor)    lua_remove(L, -2);    // æ ˆ: [userdata(self), string(key), property_value]        return 1;  // è¿”å›1ä¸ªå€¼(property_value)&#125;\n\næ ˆå˜åŒ–å¯è§†åŒ–:\nåˆå§‹:     [userdata, &quot;GetName&quot;]GetField: [userdata, &quot;GetName&quot;, property_desc]touserdata: æ£€æŸ¥ property_desc æ˜¯å¦ä¸ºuserdataReadValue:  [userdata, &quot;GetName&quot;, property_desc, &quot;ActorName&quot;]remove:     [userdata, &quot;GetName&quot;, &quot;ActorName&quot;]return 1:   Lua æ¥æ”¶åˆ° &quot;ActorName&quot;\n\nGetField æ ˆæ“ä½œå®Œæ•´å¯è§†åŒ–åˆå§‹æ ˆçŠ¶æ€ (Lua è°ƒç”¨ actor:GetActorLocation())\næ ˆé¡¶ â†“â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ [2] &quot;GetActorLocation&quot; â”‚  â† å‡½æ•°åâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚ [1] &lt;Userdata: AActor&gt; â”‚  â† selfâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜æ ˆåº• â†‘\n\næ‰§è¡Œ GetField(L) ç¬¬ä¸€æ­¥: è·å–å…ƒè¡¨\nFORCEINLINE static int32 GetField(lua_State* L)&#123;    lua_getmetatable(L, 1); // è·å–æ ˆç´¢å¼•1çš„å…ƒè¡¨    // æ ˆ: [userdata, key, metatable]&#125;\n\næ ˆå˜åŒ–:\næ ˆé¡¶ â†“â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ [3] &lt;Metatable: AActor&gt;â”‚  â† æ–°å¢â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚ [2] &quot;GetActorLocation&quot; â”‚â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚ [1] &lt;Userdata: AActor&gt; â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\nç¬¬äºŒæ­¥: å¤åˆ¶ key åˆ°æ ˆé¡¶\n    lua_pushvalue(L, 2);  // å¤åˆ¶æ ˆç´¢å¼•2çš„å€¼    // æ ˆ: [userdata, key, metatable, key]&#125;\n\næ ˆå˜åŒ–:\næ ˆé¡¶ â†“â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ [4] &quot;GetActorLocation&quot; â”‚  â† key çš„å‰¯æœ¬â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚ [3] &lt;Metatable: AActor&gt;â”‚â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚ [2] &quot;GetActorLocation&quot; â”‚â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚ [1] &lt;Userdata: AActor&gt; â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\nç¬¬ä¸‰æ­¥: åœ¨å…ƒè¡¨ä¸­æŸ¥æ‰¾ key\n    int32 Type = lua_rawget(L, -2);     // åŠŸèƒ½: ä»ç´¢å¼•-2(metatable)æŸ¥æ‰¾æ ˆé¡¶çš„key    // ç»“æœ: å¼¹å‡ºæ ˆé¡¶,å‹å…¥ metatable[key]    // æ ˆ: [userdata, key, metatable, valueæˆ–nil]&#125;\n\næ ˆå˜åŒ– (å‡è®¾ metatable ä¸­æ²¡æœ‰ç¼“å­˜):\næ ˆé¡¶ â†“â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ [4] nil                â”‚  â† metatable[&quot;GetActorLocation&quot;]â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚ [3] &lt;Metatable: AActor&gt;â”‚â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚ [2] &quot;GetActorLocation&quot; â”‚â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚ [1] &lt;Userdata: AActor&gt; â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\nç¬¬å››æ­¥: è§¦å‘ GetFieldInternal (å› ä¸º Type &#x3D;&#x3D; LUA_TNIL)\n    if (Type == LUA_TNIL)        GetFieldInternal(L);    // è¿›å…¥ GetFieldInternal&#125;static void GetFieldInternal(lua_State* L) &#123;    lua_pop(L, 1);  // å¼¹å‡º nil    // æ ˆ: [userdata, key, metatable]\n\næ ˆå˜åŒ–:\næ ˆé¡¶ â†“â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ [3] &lt;Metatable: AActor&gt;â”‚â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚ [2] &quot;GetActorLocation&quot; â”‚â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚ [1] &lt;Userdata: AActor&gt; â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\nç¬¬äº”æ­¥: è·å–ç±»å\nlua_pushstring(L, &quot;__name&quot;);  // æ ˆ: [userdata, key, metatable, &quot;__name&quot;]auto Type = lua_rawget(L, -2);  // ä» metatable è·å– &quot;__name&quot;// æ ˆ: [userdata, key, metatable, &quot;AActor&quot;]check(Type == LUA_TSTRING);const char* ClassName = lua_tostring(L, -1);  // &quot;AActor&quot;const char* FieldName = lua_tostring(L, 2);   // &quot;GetActorLocation&quot;lua_pop(L, 1); // å¼¹å‡ºç±»å// æ ˆ: [userdata, key, metatable]\n\nç¬¬å…­æ­¥: æ³¨å†Œå­—æ®µå¹¶ç”Ÿæˆ Closure\nconst auto Registry = UnLua::FLuaEnv::FindEnv(L)-&gt;GetClassRegistry();FClassDesc* ClassDesc = Registry-&gt;Register(ClassName);TSharedPtr&lt;FFieldDesc&gt; Field = ClassDesc-&gt;RegisterField(FieldName, ClassDesc);// å‡è®¾æ‰¾åˆ°äº† UFunction: GetActorLocationif (Field &amp;&amp; Field-&gt;IsValid()) &#123;    PushField(L, Field);  // å‹å…¥ Closure    // æ ˆ: [userdata, key, metatable, &lt;TSharedPtr userdata&gt;]\n\nPushField å†…éƒ¨æ ˆå˜åŒ–:\ntemplate &lt;typename T&gt;void FObjectRegistry::Push(lua_State* L, TSharedPtr&lt;T&gt; Ptr)&#123;    const auto Userdata = lua_newuserdata(L, sizeof(TSharedPtr&lt;T&gt;));    // æ ˆ: [userdata, key, metatable, &lt;TSharedPtr userdata&gt;]        luaL_getmetatable(L, &quot;TSharedPtr&quot;);    // æ ˆ: [userdata, key, metatable, &lt;TSharedPtr userdata&gt;, &lt;TSharedPtr metatable&gt;]        lua_setmetatable(L, -2);    // æ ˆ: [userdata, key, metatable, &lt;TSharedPtr userdata&gt;]        new(Userdata) TSharedPtr&lt;T&gt;(Ptr);&#125;// è¿”å› PushFieldif (Function-&gt;IsLatentFunction())    lua_pushcclosure(L, Class_CallLatentFunction, 1);else    lua_pushcclosure(L, Class_CallUFunction, 1);// â˜… å…³é”®: lua_pushcclosure ä¼šå¼¹å‡º 1 ä¸ª upvalue// æ ˆ: [userdata, key, metatable, &lt;Closure&gt;]\n\næ ˆå˜åŒ–:\næ ˆé¡¶ â†“â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ [4] &lt;Closure&gt;          â”‚  â† C å‡½æ•° + upvalue(FFunctionDesc)â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚ [3] &lt;Metatable: AActor&gt;â”‚â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚ [2] &quot;GetActorLocation&quot; â”‚â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚ [1] &lt;Userdata: AActor&gt; â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\nç¬¬ä¸ƒæ­¥: ç¼“å­˜ Closure åˆ° metatable\n        lua_pushvalue(L, 2);     // å¤åˆ¶ key        // æ ˆ: [userdata, key, metatable, Closure, key]                lua_pushvalue(L, -2);    // å¤åˆ¶ Closure        // æ ˆ: [userdata, key, metatable, Closure, key, Closure]                lua_rawset(L, -4);       // metatable[key] = Closure        // å¼¹å‡º key å’Œ Closure,è®¾ç½®åˆ° metatable        // æ ˆ: [userdata, key, metatable, Closure]    &#125;&#125;// å›åˆ° GetFieldlua_remove(L, -2);  // ç§»é™¤ metatable// æ ˆ: [userdata, key, Closure]return 1;&#125;\n\næœ€ç»ˆæ ˆçŠ¶æ€:\næ ˆé¡¶ â†“â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ [3] &lt;Closure&gt;          â”‚  â† è¿”å›ç»™ Luaâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚ [2] &quot;GetActorLocation&quot; â”‚â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚ [1] &lt;Userdata: AActor&gt; â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\nLua æ¥æ”¶åˆ° Closure åè°ƒç”¨:\n-- Lua ä»£ç local location = actor:GetActorLocation()-- ç­‰ä»·äº: --   local func = actor[&quot;GetActorLocation&quot;]  â† è§¦å‘ __index,è·å– Closure--   local location = func(actor)            â† è°ƒç”¨ Closure\n\nClosure è°ƒç”¨æµç¨‹:\nint32 Class_CallUFunction(lua_State *L)&#123;    // â˜… æ ˆ: [self, arg1, arg2, ...]        // â˜… è·å– upvalue (FFunctionDesc)    auto&amp; Env = UnLua::FLuaEnv::FindEnvChecked(L);    auto Function = Env.GetObjectRegistry()-&gt;Get&lt;FFunctionDesc&gt;(L, lua_upvalueindex(1));    // lua_upvalueindex(1) æ˜¯ç‰¹æ®Šä¼ªç´¢å¼•,ä¸æ”¹å˜æ ˆ        int32 NumParams = lua_gettop(L);    int32 NumResults = Function-&gt;CallUE(L, NumParams);        return NumResults;  // è¿”å›å€¼å·²åœ¨æ ˆé¡¶&#125;\n\nå®Œæ•´æµç¨‹æ€»ç»“:\nflowchart TD\n    Start([Lua: actor:GetActorLocation]) --&gt; A[&quot;è§¦å‘ __index actor, GetActorLocation&quot;]\n    A --&gt; B[Class_Index]\n    B --&gt; C[GetField]\n    C --&gt; D[GetFieldInternal]\n    D --&gt; E[&quot;RegisterField GetActorLocation&quot;]\n    E --&gt; F[PushField]\n    F --&gt; G[&quot;lua_pushcclosure Class_CallUFunction, 1&quot;]\n    G --&gt; H[ç¼“å­˜ Closure åˆ° metatable]\n    H --&gt; I[è¿”å› Closure ç»™ Lua]\n    I --&gt; J[Lua è°ƒç”¨ Closure]\n    J --&gt; K[Class_CallUFunction]\n    K --&gt; L[CallUE]\n    L --&gt; M[UObject::ProcessEvent]\n    M --&gt; N[æ‰§è¡Œ C++ å‡½æ•°]\n    N --&gt; End([è¿”å›ç»“æœ])\n    \n    style Start fill:#e1f5ff,stroke:#01579b,stroke-width:2px\n    style A fill:#fff3e0,stroke:#e65100,stroke-width:2px\n    style E fill:#f3e5f5,stroke:#4a148c,stroke-width:2px\n    style M fill:#ffccbc,stroke:#bf360c,stroke-width:2px\n    style End fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px\n\nClass_NewIndex å±æ€§å†™å…¥// LuaCore.cpp:1226int32 Class_NewIndex(lua_State *L)&#123;    // â˜… åˆå§‹æ ˆçŠ¶æ€    // æ ˆ: [1]=userdata(self), [2]=string(key), [3]=new_value    // Luaè°ƒç”¨: obj.Health = 100        GetField(L);    // æ ˆ: [userdata, key, value, field_descriptor]        auto Ptr = lua_touserdata(L, -1);    if (Ptr)    &#123;        auto Property = static_cast&lt;TSharedPtr&lt;UnLua::ITypeOps&gt;*&gt;(Ptr);        if (Property-&gt;IsValid())        &#123;            void* Self = GetCppInstance(L, 1);            if (Self)            &#123;                if (UnLua::LowLevel::IsReleasedPtr(Self))                    return luaL_error(L, &quot;...&quot;);                                // â˜… APIè®²è§£: WriteValue_InContainer                // å‚æ•°: 3 è¡¨ç¤ºä»æ ˆç´¢å¼•3å–å€¼(new_value)                (*Property)-&gt;WriteValue_InContainer(L, Self, 3);            &#125;        &#125;    &#125;    else    &#123;        // éå±æ€§,å¯èƒ½æ˜¯ç›´æ¥ä¿®æ”¹è¡¨        int32 Type = lua_type(L, 1);        if (Type == LUA_TTABLE)        &#123;            // â˜… APIè®²è§£: lua_rawset            // åŠŸèƒ½: ç»•è¿‡å…ƒæ–¹æ³•ç›´æ¥è®¾ç½®è¡¨            // ç”¨äºåŠ¨æ€æ·»åŠ å­—æ®µåˆ°å®ä¾‹è¡¨            lua_pushvalue(L, 2);  // å¤åˆ¶ key            lua_pushvalue(L, 3);  // å¤åˆ¶ value            lua_rawset(L, 1);     // table[key] = value        &#125;    &#125;    lua_pop(L, 1);    return 0;&#125;\n\nå®é™…è°ƒç”¨ç¤ºä¾‹:\n-- Lua ä»£ç local actor = UE.UGameplayStatics.GetPlayerPawn(self, 0)-- è¯»å–å±æ€§ (è§¦å‘ Class_Index)local name = actor.Name  -- C++: GetFieldæ‰¾åˆ° FNameProperty--      ReadValue_InContainer å°† FName è½¬ä¸º lua string-- å†™å…¥å±æ€§ (è§¦å‘ Class_NewIndex)  actor.bHidden = true-- C++: GetFieldæ‰¾åˆ° FBoolProperty--      WriteValue_InContainer ä»æ ˆç´¢å¼•3å– lua boolean--      è½¬æ¢å¹¶å†™å…¥ C++ bool\n\næ€§èƒ½ä¼˜åŒ–è¦ç‚¹\n\n\nä¼˜åŒ–ç‚¹\nè¯´æ˜\næ€§èƒ½æå‡\n\n\n\nå‡½æ•°å¼•ç”¨ç¼“å­˜\nFunctionRef å­˜å‚¨åœ¨ ObjectRefs\n~30%\n\n\nå‚æ•°ç¼“å†²åŒºå¤ç”¨\nFParamBufferAllocator æ± åŒ–ç®¡ç†\n~20%\n\n\næ‡’åŠ è½½ FFunctionDesc\né¦–æ¬¡è°ƒç”¨æ—¶æ‰åˆ›å»º\nå‡å°‘å¯åŠ¨ 50%\n\n\né¿å…ç±»å‹è½¬æ¢\nç›´æ¥ä¼ é€’ Userdata\n~15%\n\n\n\nå‚æ•°ä¼ é€’æœºåˆ¶ç±»å‹æ˜ å°„è¡¨åŸºç¡€ç±»å‹æ˜ å°„\n\n\nUE ç±»å‹\nLua ç±»å‹\nä¼ é€’æ–¹å¼\næ€§èƒ½å¼€é”€\n\n\n\nbool\nboolean\nå€¼ä¼ é€’\næä½\n\n\nint32/uint32\ninteger\nå€¼ä¼ é€’\næä½\n\n\nfloat/double\nnumber\nå€¼ä¼ é€’\næä½\n\n\nFString\nstring\næ‹·è´ (UTF8 è½¬æ¢)\nä¸­ç­‰\n\n\nFName\nstring\næ‹·è´\nä½\n\n\nFText\nstring\næ‹·è´\né«˜ (æœ¬åœ°åŒ–)\n\n\nå¤æ‚ç±»å‹æ˜ å°„\n\n\nUE ç±»å‹\nLua è¡¨ç¤º\nä¼ é€’ç­–ç•¥\nå†…å­˜ç®¡ç†\n\n\n\nUObject*\nUserdata (äºŒçº§æŒ‡é’ˆ)\nå¼•ç”¨ä¼ é€’\nGC ç®¡ç†\n\n\nUStruct\nUserdata (å€¼ç±»å‹)\næ‹·è´&#x2F;å¼•ç”¨å¯é€‰\nLua GC\n\n\nTArray\nUserdata (å®¹å™¨)\nå¼•ç”¨ä¼ é€’\nä¸ C++ å…±äº«\n\n\nTMap\nUserdata (å®¹å™¨)\nå¼•ç”¨ä¼ é€’\nä¸ C++ å…±äº«\n\n\nTSubclassOf\nUClass Userdata\nå¼•ç”¨ä¼ é€’\nGC ç®¡ç†\n\n\nFDelegate\nUserdata (å§”æ‰˜)\nå¼•ç”¨ä¼ é€’\nåŒå‘ç»‘å®š\n\n\nå‚æ•°ä¼ é€’æµç¨‹è¯¦è§£Lua â†’ C++ å‚æ•°ä¼ é€’// FunctionDesc.cpp:171int32 FFunctionDesc::CallUE(lua_State *L, int32 NumParams, void *Userdata)&#123;    void* Params = Buffer-&gt;GetBuffer();  // åˆ†é…å‚æ•°ç¼“å†²åŒº    FFlagArray CleanupFlags;        // PreCall: å‚æ•°è½¬æ¢    for (int32 i = 0; i &lt; Properties.Num(); ++i)    &#123;        FPropertyDesc* Property = Properties[i].Get();                if (Property-&gt;IsOutParameter())        &#123;            // Out å‚æ•°: åˆ†é…ä¸´æ—¶å†…å­˜            Property-&gt;Initialize(Property-&gt;GetValuePtr(Params));        &#125;        else        &#123;            // In å‚æ•°: ä» Lua è¯»å–å€¼            Property-&gt;WriteValue_InContainer(L, Params, FirstParamIndex + i);        &#125;    &#125;        // æ‰§è¡Œ UE å‡½æ•°    Object-&gt;UObject::ProcessEvent(FinalFunction, Params);        // PostCall: è¿”å›å€¼å¤„ç†    int32 NumReturnValues = 0;    if (HasReturnProperty())    &#123;        FPropertyDesc* RetProp = Properties[ReturnPropertyIndex].Get();        RetProp-&gt;ReadValue_InContainer(L, Params, false);        NumReturnValues++;    &#125;        // Out å‚æ•°å†™å› Lua    for (int32 OutIndex : OutPropertyIndices)    &#123;        Properties[OutIndex]-&gt;ReadValue_InContainer(L, Params, false);        NumReturnValues++;    &#125;        return NumReturnValues;&#125;\n\nC++ â†’ Lua å‚æ•°ä¼ é€’// FunctionDesc.cpp:300void FFunctionDesc::CallLua(lua_State* L, lua_Integer FunctionRef,                            lua_Integer SelfRef, FFrame&amp; Stack, RESULT_DECL)&#123;    // 1. æ¨é€å‡½æ•°å’Œ self    lua_rawgeti(L, LUA_REGISTRYINDEX, FunctionRef);  // function    lua_rawgeti(L, LUA_REGISTRYINDEX, SelfRef);      // self        // 2. å‚æ•°è½¬æ¢: C++ â†’ Lua    for (int i = 0; i &lt; Properties.Num(); ++i)    &#123;        if (!Properties[i]-&gt;IsReturnParameter())        &#123;            // å°† C++ å‚æ•°å€¼è½¬æ¢ä¸º Lua å€¼            Properties[i]-&gt;ReadValue_InContainer(L, Params, false);        &#125;    &#125;        // 3. æ‰§è¡Œ Lua è°ƒç”¨    lua_pcall(L, NumParams, NumResults, ErrorHandler);        // 4. è¿”å›å€¼å’Œ Out å‚æ•°å†™å› C++    if (HasReturnProperty())    &#123;        RetProp-&gt;WriteValue(L, RetValueAddress, -NumResults);    &#125;&#125;\n\nå®¹å™¨ç±»å‹æ·±åº¦è§£æTArray å†…å­˜å…±äº«æœºåˆ¶// PropertyDesc.cpp:550void FArrayPropertyDesc::ReadValue_InContainer(lua_State* L,                                                const void* ContainerPtr,                                                bool bCreateCopy) const&#123;    FScriptArray* Array = Property-&gt;GetPropertyValuePtr(ContainerPtr);        if (bCreateCopy)    &#123;        // æ·±æ‹·è´: Lua å®Œå…¨æ‹¥æœ‰        UnLua::PushArray(L, Array, InnerProperty, true);    &#125;    else    &#123;        // å¼•ç”¨ä¼ é€’: ä¸ C++ å…±äº«å†…å­˜ (é›¶æ‹·è´)        const auto Registry = FLuaEnv::FindEnvChecked(L).GetContainerRegistry();        Registry-&gt;FindOrAdd(L, Array, InnerProperty);    &#125;&#125;\n\nå†…å­˜å¸ƒå±€:\nC++ TArray:â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ FScriptArray &#123;                   â”‚â”‚   void* Data;     â† å…ƒç´ æ•°æ®æŒ‡é’ˆâ”‚â”‚   int32 ArrayNum;                â”‚â”‚   int32 ArrayMax;                â”‚â”‚ &#125;                                â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚         â–¼ ç›´æ¥è®¿é—® (é›¶æ‹·è´)â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ Lua Userdata (FLuaArray)         â”‚â”‚  â””â”€â–º ScriptArray*  â† æŒ‡å‘åŒä¸€å†…å­˜â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\nTArray æ“ä½œ API å®Œæ•´å®ç°Lua ç«¯ä½¿ç”¨ç¤ºä¾‹:\n-- â˜… åˆ›å»º TArraylocal actors = UE.TArray(UE.AActor)-- â˜… æ·»åŠ å…ƒç´ actors:Add(actor1)actors:Add(actor2)-- â˜… è®¿é—®å…ƒç´  (1-based ç´¢å¼•)local first = actors:Get(1)  -- Lua ä¹ æƒ¯-- â˜… è®¾ç½®å…ƒç´ actors:Set(2, newActor)-- â˜… éå†æ–¹å¼1: ipairsfor i, actor in ipairs(actors) do    print(i, actor:GetName())end-- â˜… éå†æ–¹å¼2: æ‰‹åŠ¨å¾ªç¯for i = 1, actors:Length() do    local actor = actors:Get(i)    print(actor:GetName())end-- â˜… å…¶ä»–æ“ä½œlocal count = actors:Length()actors:Remove(2)        -- ç§»é™¤ç´¢å¼•2actors:Insert(1, actor) -- åœ¨ç´¢å¼•1æ’å…¥actors:Clear()          -- æ¸…ç©º\n\nåº•å±‚ C++ å®ç°æºç :\n// Containers/LuaArray.cpp// â˜… APIè®²è§£: GetCppInstanceFast// åŠŸèƒ½: å¿«é€Ÿè·å– userdata çš„ C++ æŒ‡é’ˆ (è·³è¿‡æ£€æŸ¥)// ç”¨é€”: é«˜é¢‘è°ƒç”¨ä¼˜åŒ–,å‰ææ˜¯å·²çŸ¥ç±»å‹æ­£ç¡®static int32 LuaArray_Add(lua_State* L)&#123;    // â˜… æ­¥éª¤1: è·å– FLuaArray æŒ‡é’ˆ    // å‚æ•°1: æ ˆç´¢å¼•1 (self,å³ array)    FLuaArray* Array = (FLuaArray*)GetCppInstanceFast(L, 1);        // â˜… æ­¥éª¤2: åœ¨ C++ TArray æœ«å°¾æ·»åŠ å…ƒç´     void* ElementPtr = Array-&gt;AddElement();        // â˜… æ­¥éª¤3: ä» Lua è¯»å–å€¼å¹¶å†™å…¥ C++ å†…å­˜    // å‚æ•°2: æ ˆç´¢å¼•2 (è¦æ·»åŠ çš„å…ƒç´ )    Array-&gt;Inner-&gt;WriteValue(L, ElementPtr, 2);        return 0;  // æ— è¿”å›å€¼&#125;static int32 LuaArray_Get(lua_State* L)&#123;    FLuaArray* Array = (FLuaArray*)GetCppInstanceFast(L, 1);        // â˜… APIè®²è§£: lua_tointeger    // åŠŸèƒ½: å°†æ ˆä¸ŠæŒ‡å®šç´¢å¼•çš„å€¼è½¬ä¸ºæ•´æ•°    // è¿”å›: lua_Integer (é€šå¸¸æ˜¯ int64)    int32 Index = (int32)lua_tointeger(L, 2);        // â˜… Lua â†’ C++ ç´¢å¼•è½¬æ¢ (1-based â†’ 0-based)    if (Index &lt; 1 || Index &gt; Array-&gt;Num())        return luaL_error(L, &quot;index out of range&quot;);        void* ElementPtr = Array-&gt;GetData(Index - 1);        // â˜… è¯»å–å…ƒç´ å¹¶å‹æ ˆ    Array-&gt;Inner-&gt;ReadValue(L, ElementPtr, false);    return 1;  // è¿”å›1ä¸ªå€¼&#125;static int32 LuaArray_Set(lua_State* L)&#123;    FLuaArray* Array = (FLuaArray*)GetCppInstanceFast(L, 1);    int32 Index = (int32)lua_tointeger(L, 2) - 1;        if (Index &lt; 0 || Index &gt;= Array-&gt;Num())        return luaL_error(L, &quot;index out of range&quot;);        void* ElementPtr = Array-&gt;GetData(Index);        // â˜… ä»æ ˆç´¢å¼•3è¯»å–æ–°å€¼    Array-&gt;Inner-&gt;WriteValue(L, ElementPtr, 3);    return 0;&#125;static int32 LuaArray_Length(lua_State* L)&#123;    FLuaArray* Array = (FLuaArray*)GetCppInstanceFast(L, 1);        // â˜… APIè®²è§£: lua_pushinteger    // åŠŸèƒ½: å‹å…¥æ•´æ•°åˆ°æ ˆé¡¶    // æ ˆå˜åŒ–: [+1]    lua_pushinteger(L, Array-&gt;Num());    return 1;&#125;static int32 LuaArray_Remove(lua_State* L)&#123;    FLuaArray* Array = (FLuaArray*)GetCppInstanceFast(L, 1);    int32 Index = (int32)lua_tointeger(L, 2) - 1;        if (Index &lt; 0 || Index &gt;= Array-&gt;Num())        return 0;        // â˜… ç›´æ¥ä¿®æ”¹ C++ TArray    Array-&gt;Remove(Index);    return 0;&#125;// â˜… æ”¯æŒ ipairs éå†static int32 TArray_Enumerable(lua_State* L)&#123;    // â˜… è¿”å›è¿­ä»£å™¨ä¸‰å…ƒç»„: (è¿­ä»£å‡½æ•°, çŠ¶æ€, åˆå§‹å€¼)    lua_pushcfunction(L, TArray_Enumerable_Next);  // è¿­ä»£å‡½æ•°    lua_pushvalue(L, 1);   // çŠ¶æ€ = array è‡ªèº«    lua_pushinteger(L, 0); // åˆå§‹å€¼ = 0    return 3;&#125;static int TArray_Enumerable_Next(lua_State* L)&#123;    // â˜… è¿­ä»£å™¨å‡½æ•°ç­¾å: (state, index) -&gt; (next_index, value)    FLuaArray* Array = (FLuaArray*)GetCppInstanceFast(L, 1);    int32 Index = (int32)lua_tointeger(L, 2);        if (Index &gt;= Array-&gt;Num())        return 0;  // è¿­ä»£ç»“æŸ        // â˜… è¿”å›ä¸‹ä¸€ä¸ªç´¢å¼•å’Œå€¼    lua_pushinteger(L, Index + 1);    void* ElementPtr = Array-&gt;GetData(Index);    Array-&gt;Inner-&gt;ReadValue(L, ElementPtr, false);    return 2;&#125;// â˜… æ³¨å†Œå…ƒè¡¨static const luaL_Reg TArrayLib[] = &#123;    &#123;&quot;Add&quot;, LuaArray_Add&#125;,    &#123;&quot;Get&quot;, LuaArray_Get&#125;,    &#123;&quot;Set&quot;, LuaArray_Set&#125;,    &#123;&quot;Length&quot;, LuaArray_Length&#125;,    &#123;&quot;Remove&quot;, LuaArray_Remove&#125;,    &#123;&quot;Insert&quot;, LuaArray_Insert&#125;,    &#123;&quot;Clear&quot;, LuaArray_Clear&#125;,    &#123;&quot;__len&quot;, LuaArray_Length&#125;,      // æ”¯æŒ #array    &#123;&quot;__pairs&quot;, TArray_Enumerable&#125;,  // æ”¯æŒ ipairs(array)    &#123;NULL, NULL&#125;&#125;;\n\né›¶æ‹·è´åŸç†:\nC++ TArray&lt;AActor*&gt;:â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ FScriptArray &#123;          â”‚â”‚   AActor** Data;  â”€â”€â”€â”  â”‚â”‚   int32 ArrayNum;    â”‚  â”‚â”‚   int32 ArrayMax;    â”‚  â”‚â”‚ &#125;                    â”‚  â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”˜                       â”‚        ç›´æ¥è®¿é—® (æ— æ‹·è´) â”‚                       â”‚Lua Userdata:          â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”â”‚ FLuaArray &#123;             â”‚â”‚   FScriptArray* Array; â—„â”¼â”€â”€ æŒ‡å‘åŒä¸€å†…å­˜â”‚   Inner: FPropertyDesc  â”‚â”‚ &#125;                       â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜// ä¿®æ”¹ç«‹å³ç”Ÿæ•ˆarray:Add(actor)  â†’ ç›´æ¥ä¿®æ”¹ C++ TArray::Dataâ†’ UE ç«¯ç«‹å³å¯è§,æ— åŒæ­¥å¼€é”€\n\næ€§èƒ½å¯¹æ¯”:\n// âŒ æ‹·è´æ–¹å¼ (å‡è®¾)TArray&lt;int32&gt; data = GetData();  // 1000ä¸ªå…ƒç´ lua_newtable(L);for (int i = 0; i &lt; data.Num(); i++) &#123;    lua_pushinteger(L, i + 1);    lua_pushinteger(L, data[i]);    lua_settable(L, -3);&#125;// è€—æ—¶: ~450Î¼s (éœ€è¦1000æ¬¡Lua tableæ“ä½œ)// âœ… é›¶æ‹·è´æ–¹å¼ (UnLua)UnLua::PushArray(L, &amp;data, Inner, false);// è€—æ—¶: ~1.2Î¼s (ä»…åˆ›å»ºuserdata)// è®¿é—®: array:Get(i) ç›´æ¥è¯»å†…å­˜,~0.3Î¼s\n\nStruct æ‹·è´ vs å¼•ç”¨-- ç¤ºä¾‹: FVector ä¼ é€’-- âœ… æ‹·è´ä¼ é€’ (å®‰å…¨ä½†æ…¢)local function SetLocation(actor, location)    actor:SetActorLocation(location)  -- FVector è¢«æ‹·è´end-- âœ… å¼•ç”¨ä¼ é€’ (å¿«ä½†éœ€æ³¨æ„ç”Ÿå‘½å‘¨æœŸ)local function GetLocation(actor)    return actor:K2_GetActorLocation()  -- è¿”å›ä¸´æ—¶å¼•ç”¨end-- âŒ å±é™©: å¼•ç”¨å¤±æ•ˆlocal loc = actor:K2_GetActorLocation()actor:Destroy()print(loc.X)  -- â† æ‚¬ç©ºå¼•ç”¨ï¼Œæœªå®šä¹‰è¡Œä¸º!\n\nå‚æ•°ä¼ é€’æ€§èƒ½å¯¹æ¯”\n\n\nç±»å‹\næ‹·è´ä¼ é€’ (Î¼s)\nå¼•ç”¨ä¼ é€’ (Î¼s)\nå€æ•°\n\n\n\nFVector\n0.8\n0.3\n2.7x\n\n\nFString\n2.5\n0.5\n5x\n\n\nTArray (1000)\n450\n1.2\n375x\n\n\nTMap&lt;int32,FString&gt; (100)\n850\n1.5\n567x\n\n\nç»“è®º: å®¹å™¨ç±»å‹åŠ¡å¿…ä½¿ç”¨å¼•ç”¨ä¼ é€’ï¼ˆé»˜è®¤è¡Œä¸ºï¼‰ã€‚\n\nåƒåœ¾å›æ”¶ä¸å¯¹è±¡ç”Ÿå‘½å‘¨æœŸåŒé‡ GC ç³»ç»ŸUnLua éœ€è¦åŒæ—¶ç®¡ç† UE GC å’Œ Lua GCï¼Œç¡®ä¿å¯¹è±¡ç”Ÿå‘½å‘¨æœŸåŒæ­¥ã€‚\næ¶æ„å›¾â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                    åŒé‡ GC ååŒæœºåˆ¶                            â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜UE ç«¯ â†â†’ Lua ç«¯:â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  UObject         â”‚                  â”‚  Userdata        â”‚â”‚  â”œâ”€ RefCount     â”‚                  â”‚  â”œâ”€ void** Ptr   â”‚ â”€â”€â”€â”â”‚  â””â”€ RF_Flags     â”‚                  â”‚  â””â”€ BIT_FLAGS    â”‚    â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚         â”‚                                     â”‚               â”‚         â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚         â”‚           (åŒå‘å¼•ç”¨)                                â”‚         â–¼                                                     â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚â”‚     FObjectReferencer                â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  (é˜²æ­¢ UE GC è¯¯å›æ”¶è¢« Lua å¼•ç”¨çš„å¯¹è±¡) â”‚â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚â”‚  â”‚ TSet&lt;UObject*&gt;              â”‚    â”‚â”‚  â”‚  AutoObjectReference        â”‚    â”‚â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚         â–¼â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  UE GC System                        â”‚â”‚  â”œâ”€ MarkAsGarbage                   â”‚â”‚  â”œâ”€ NotifyObjectDestroyed  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â–º FObjectRegistry::Unbind()â”‚  â””â”€ ...                             â”‚     â””â”€â–º æ ‡è®° Userdata ä¸º 0xDEADâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\nå¯¹è±¡å¼•ç”¨ç®¡ç†ç­–ç•¥Lua C API: Userdata æ·±åº¦å‰–æUserdata æ˜¯ä»€ä¹ˆ?\n\nLua ä¸­å”¯ä¸€èƒ½å­˜å‚¨ä»»æ„ C æ•°æ®çš„ç±»å‹\nç”± Lua GC ç®¡ç†ç”Ÿå‘½å‘¨æœŸ\nå¯ä»¥è®¾ç½®å…ƒè¡¨å®ç°é¢å‘å¯¹è±¡\n\næ ¸å¿ƒ API:\n\n\n\nAPI\nåŠŸèƒ½\nè¿”å›å€¼\nç”¨é€”\n\n\n\nlua_newuserdata(L, size)\nåˆ†é…userdata\nvoid*æŒ‡é’ˆ\nåˆ›å»ºsizeå­—èŠ‚çš„å†…å­˜å—\n\n\nlua_touserdata(L, idx)\nè·å–æŒ‡é’ˆ\nvoid*\nè¯»å–userdataçš„æ•°æ®\n\n\nluaL_setmetatable(L, name)\nè®¾ç½®å…ƒè¡¨\næ— \nå…³è”ç±»å‹å…ƒè¡¨\n\n\nUnLua çš„äºŒçº§æŒ‡é’ˆæœºåˆ¶ä¸ºä»€ä¹ˆä½¿ç”¨äºŒçº§æŒ‡é’ˆ?\n// é—®é¢˜: UObject ç”± UE GC ç®¡ç†,å¯èƒ½éšæ—¶é”€æ¯// è§£å†³: Userdata å­˜å‚¨æŒ‡é’ˆçš„æŒ‡é’ˆ,é”€æ¯æ—¶æ”¹å†™ä¸º 0xDEAD// Userdata å†…å­˜å¸ƒå±€struct UserdataLayout &#123;    FUserdataDesc desc;  // 4 bytes (é­”æ•° + æ ‡å¿—)    void** ptr;          // 8 bytes (äºŒçº§æŒ‡é’ˆ)&#125;;\n\nåˆ›å»º Userdata æºç :\n// LuaCore.cpp:345void* NewUserdataWithPadding(lua_State* L, int32 Size, int32 Alignment)&#123;    // â˜… è®¡ç®—éœ€è¦çš„å†…å­˜å¤§å°    const int32 PaddingSize = (Alignment - sizeof(FUserdataDesc) % Alignment) % Alignment;    const int32 TotalSize = sizeof(FUserdataDesc) + PaddingSize + Size;        // â˜… APIè®²è§£: lua_newuserdata    // åŠŸèƒ½: åˆ†é…æŒ‡å®šå¤§å°çš„å†…å­˜å¹¶å‹æ ˆ    // æ ˆå˜åŒ–: [+1, å‹å…¥userdata]    // è¿”å›å€¼: æŒ‡å‘åˆ†é…å†…å­˜çš„æŒ‡é’ˆ    void* Userdata = lua_newuserdata(L, TotalSize);        // â˜… åˆå§‹åŒ–æè¿°ç¬¦    FUserdataDesc* Desc = (FUserdataDesc*)Userdata;    Desc-&gt;magic = 0x1688;  // é­”æ•°éªŒè¯    Desc-&gt;tag = 0;    Desc-&gt;padding = PaddingSize;        // â˜… è¿”å›æ•°æ®åŒºæŒ‡é’ˆ (è·³è¿‡æè¿°ç¬¦å’Œå¡«å……)    return (uint8*)Userdata + sizeof(FUserdataDesc) + PaddingSize;&#125;// ObjectRegistry.cpp:87void FObjectRegistry::PushObjectCore(lua_State* L, UObject* Object)&#123;    // â˜… æ­¥éª¤1: åˆ†é… Userdata (å­˜å‚¨äºŒçº§æŒ‡é’ˆ)    void** Userdata = (void**)NewUserdataWithPadding(L, sizeof(void*), 8);        // â˜… æ­¥éª¤2: å­˜å‚¨ UObject æŒ‡é’ˆ    *Userdata = Object;  // userdata å†…å®¹ = Objectçš„åœ°å€        // â˜… æ­¥éª¤3: è®¾ç½®å…ƒè¡¨    // API: luaL_setmetatable(L, name)    // åŠŸèƒ½: ä»registryè·å–å…ƒè¡¨å¹¶è®¾ç½®ç»™æ ˆé¡¶userdata    // ç­‰ä»·äº: luaL_getmetatable(L, name); lua_setmetatable(L, -2);    luaL_setmetatable(L, &quot;UObject&quot;);        // æ ˆ: [userdata] (å·²å…³è”UObjectå…ƒè¡¨)&#125;\n\nè‡ªåŠ¨å¼•ç”¨æœºåˆ¶æºç // ObjectRegistry.cpp:87void FObjectRegistry::Push(lua_State* L, UObject* Object)&#123;    if (!Object)    &#123;        lua_pushnil(L);        return;    &#125;        // â˜… æœ‰æ•ˆæ€§æ£€æŸ¥    if (!UnLua::IsUObjectValid(Object))    &#123;        // â˜… APIè®²è§£: luaL_error        // åŠŸèƒ½: æŠ›å‡ºLuaé”™è¯¯,æ°¸ä¸è¿”å›        // ç‰¹æ€§: è‡ªåŠ¨æ¸…ç†Luaæ ˆå¹¶æ‰§è¡Œlong jump        luaL_error(L, &quot;attempt to read invalid uobject ptr&quot;);        return;    &#125;        // â˜… æ­¥éª¤1: è·å–å¼±å¼•ç”¨ç¼“å­˜è¡¨    lua_getfield(L, LUA_REGISTRYINDEX, &quot;UnLua_ObjectMap&quot;);    // æ ˆ: [ObjectMap]        // â˜… APIè®²è§£: lua_pushlightuserdata    // åŠŸèƒ½: å‹å…¥CæŒ‡é’ˆä½œä¸ºluaå€¼ (ä¸åˆ†é…å†…å­˜)    // ç”¨é€”: ä½œä¸ºè¡¨çš„key (å¿«é€ŸæŸ¥æ‰¾)    // åŒºåˆ«: light userdata æ— å…ƒè¡¨,æ— GCå›è°ƒ    lua_pushlightuserdata(L, Object);    // æ ˆ: [ObjectMap, ObjectæŒ‡é’ˆ]        // â˜… æ­¥éª¤2: APIè®²è§£ lua_rawget    // åŠŸèƒ½: ä»è¡¨ä¸­è·å–å€¼ (è·³è¿‡å…ƒæ–¹æ³•)    // å‚æ•°: -2 æŒ‡å‘ ObjectMap    // æ ˆå˜åŒ–: å¼¹å‡ºkey,å‹å…¥ ObjectMap[key]    const auto Type = lua_rawget(L, -2);    // æ ˆ: [ObjectMap, cached_userdataæˆ–nil]        if (Type == LUA_TNIL)    &#123;        // â˜… ç¼“å­˜æœªå‘½ä¸­,åˆ›å»ºæ–° Userdata        lua_pop(L, 1);  // å¼¹å‡º nil                PushObjectCore(L, Object);        // æ ˆ: [ObjectMap, userdata]                // â˜… ç¼“å­˜åˆ° ObjectMap        lua_pushlightuserdata(L, Object);        lua_pushvalue(L, -2);  // å¤åˆ¶ userdata        lua_rawset(L, -4);     // ObjectMap[Object] = userdata        // æ ˆ: [ObjectMap, userdata]                ObjectRefs.Add(Object, LUA_NOREF);                // â˜… æ·»åŠ åˆ°è‡ªåŠ¨å¼•ç”¨é›†åˆ        // é˜²æ­¢ UE GC å›æ”¶è¿™ä¸ªå¯¹è±¡        Env-&gt;AutoObjectReference.Add(Object);    &#125;        lua_remove(L, -2);  // ç§»é™¤ ObjectMap    // æ ˆ: [userdata]&#125;\n\nUserdata GC å›è°ƒæºç // BaseLib/LuaLib_Object.cpp:240static int32 UObject_Delete(lua_State* L)&#123;    // â˜… å½“ Lua GC å›æ”¶ userdata æ—¶è‡ªåŠ¨è°ƒç”¨    // æ ˆ: [1]=userdata (å¾…å›æ”¶çš„å¯¹è±¡)        // â˜… æ­¥éª¤1: æå– UObject æŒ‡é’ˆ    // API: lua_touserdata è¿”å› userdata çš„æ•°æ®æŒ‡é’ˆ    void** UserdataPtr = (void**)lua_touserdata(L, 1);    UObject* Object = (UObject*)*UserdataPtr;        // â˜… æ­¥éª¤2: æ£€æŸ¥æ˜¯å¦å·²æ ‡è®°ä¸ºé‡Šæ”¾    if (!UnLua::LowLevel::IsReleasedPtr(Object))    &#123;        // â˜… é€šçŸ¥ ObjectRegistry        auto&amp; Env = UnLua::FLuaEnv::FindEnvChecked(L);        Env.GetObjectRegistry()-&gt;NotifyUObjectLuaGC(Object);                // â˜… ä»è‡ªåŠ¨å¼•ç”¨ç§»é™¤        // ç°åœ¨ UE GC å¯ä»¥å®‰å…¨å›æ”¶è¿™ä¸ª UObject        Env.AutoObjectReference.Remove(Object);    &#125;        return 0;  // __gc å…ƒæ–¹æ³•ä¸éœ€è¦è¿”å›å€¼&#125;\n\nå¼•ç”¨ç±»å‹å¯¹æ¯”:\n\n\n\nå¼•ç”¨ç±»å‹\nç®¡ç†æ–¹å¼\nGC è¡Œä¸º\nä½¿ç”¨åœºæ™¯\n\n\n\nè‡ªåŠ¨å¼•ç”¨\nAutoObjectReference\nUE GCä¸å›æ”¶\né»˜è®¤,LuaæŒæœ‰UObject\n\n\næ‰‹åŠ¨å¼•ç”¨\nAddManualRef()\næ˜¾å¼é‡Šæ”¾å‰ä¸å›æ”¶\né•¿æœŸæŒæœ‰\n\n\nå¼±å¼•ç”¨\nç›´æ¥userdata\nå¯¹è±¡é”€æ¯åå˜0xDEAD\nä¸´æ—¶è®¿é—®\n\n\nå®Œæ•´ç”Ÿå‘½å‘¨æœŸç¤ºä¾‹:\n-- 1. åˆ›å»ºå¼•ç”¨local actor = UE.UGameplayStatics.SpawnActor(...)-- C++: Push() åˆ›å»º userdata--      AutoObjectReference.Add(actor) â† UE GC è·³è¿‡-- 2. ä½¿ç”¨ä¸­actor:SetActorLocation(...)  -- æ­£å¸¸è®¿é—®-- 3. Lua é‡Šæ”¾å¼•ç”¨actor = nilcollectgarbage()-- C++: UObject_Delete è§¦å‘--      AutoObjectReference.Remove(actor) â† UE ç°åœ¨å¯ä»¥GC-- 4. UE é”€æ¯å¯¹è±¡-- C++: NotifyUObjectDeleted()--      *userdata = 0xDEAD â† æ ‡è®°ä¸ºå·²é‡Šæ”¾-- 5. å†æ¬¡è®¿é—® (å¦‚æœè¿˜æœ‰å…¶ä»–å¼•ç”¨)-- C++: Class_Index æ£€æµ‹åˆ° IsReleasedPtr--      luaL_error(&quot;released object&quot;) â† å®‰å…¨æŠ¥é”™\n\nå¯¹è±¡ç”Ÿå‘½å‘¨æœŸå®Œæ•´æµç¨‹å¯¹è±¡åˆ›å»º:UE åˆ›å»º Actor  â””â”€â–º BeginPlay() è§¦å‘      â””â”€â–º UnLua.Bind(Object, &quot;Module&quot;)          â””â”€â–º FObjectRegistry::Push()              â”œâ”€â–º åˆ›å»º Userdata              â”œâ”€â–º ç¼“å­˜åˆ° ObjectMap              â””â”€â–º AutoObjectReference.Add(Object)  â† UE ä¸ä¼šå›æ”¶å¯¹è±¡ä½¿ç”¨ä¸­:Lua æŒæœ‰å¼•ç”¨ â†’ UE GC è·³è¿‡ â†’ Userdata æœ‰æ•ˆLua é‡Šæ”¾å¼•ç”¨:Lua GC è§¦å‘  â””â”€â–º __gc metamethod (UObject_Delete)      â””â”€â–º AutoObjectReference.Remove(Object)  â† UE ç°åœ¨å¯ä»¥å›æ”¶UE ä¸»åŠ¨é”€æ¯:AActor::Destroy()  â””â”€â–º UObjectBaseUtility::MarkPendingKill()      â””â”€â–º FUnLuaModule::NotifyUObjectDeleted()          â””â”€â–º FObjectRegistry::Unbind(Object)              â”œâ”€â–º ObjectRefs.Remove(Object)              â”œâ”€â–º *Userdata = 0xDEAD  â† æ ‡è®°ä¸ºå·²é‡Šæ”¾              â””â”€â–º AutoObjectReference.Remove(Object)Lua è®¿é—®å·²é‡Šæ”¾å¯¹è±¡:obj:GetName()  â””â”€â–º Class_Index()      â””â”€â–º IsReleasedPtr(Self) â†’ true          â””â”€â–º luaL_error(&quot;attempt to read property on released object&quot;)\n\næ‚¬ç©ºæŒ‡é’ˆé˜²æŠ¤æœºåˆ¶ReleasedPtr æ ‡è®°// LowLevel.h:43const static UObject* ReleasedPtr = (UObject*)0xDEAD;FORCEINLINE bool IsReleasedPtr(const void* Ptr) &#123;     return Ptr == ReleasedPtr; &#125;\n\nå¯¹è±¡æœ‰æ•ˆæ€§æ£€æŸ¥å±‚çº§// UnLuaBase.cpp:28bool IsUObjectValid(UObjectBase* ObjPtr)&#123;    // ç¬¬ 1 å±‚: ç©ºæŒ‡é’ˆæ£€æŸ¥    if (!ObjPtr || ObjPtr == LowLevel::ReleasedPtr)        return false;        // ç¬¬ 2 å±‚: UE æ ‡å¿—ä½æ£€æŸ¥    if (ObjPtr-&gt;GetFlags() &amp; (RF_BeginDestroyed | RF_FinishDestroyed))        return false;        // ç¬¬ 3 å±‚: åº•å±‚å†…å­˜æ£€æŸ¥    return ObjPtr-&gt;IsValidLowLevelFast();&#125;\n\nè®¿é—®ä¿æŠ¤ç¤ºä¾‹-- Lua ä»£ç local actor = UE.UGameplayStatics.GetPlayerPawn(self, 0)-- åœ¨ C++ ç«¯é”€æ¯actor:K2_DestroyActor()-- Lua å†æ¬¡è®¿é—® â†’ æŠ›å‡ºé”™è¯¯è€Œéå´©æºƒlocal name = actor:GetName()  -- âœ… Error: &quot;attempt to read property &#x27;GetName&#x27; on released object&quot;\n\nGC æ€§èƒ½ä¼˜åŒ–å»ºè®®\n\n\nä¼˜åŒ–ç‚¹\nè¯´æ˜\næ”¶ç›Š\n\n\n\nåŠæ—¶è§£ç»‘\nä¸ç”¨çš„å¯¹è±¡è°ƒç”¨ UnLua.Unbind()\nå‡å°‘ GC å‹åŠ›\n\n\nä½¿ç”¨å¼±å¼•ç”¨\nä¸´æ—¶å¼•ç”¨ä¸å­˜å…¨å±€ table\nå…è®¸ UE GC å›æ”¶\n\n\nå®¹å™¨å¤ç”¨\né‡å¤ä½¿ç”¨ TArray\nå‡å°‘åˆ†é…æ¬¡æ•°\n\n\nå®šæœŸ collectgarbage\næ‰‹åŠ¨è§¦å‘ Lua GC\né˜²æ­¢å†…å­˜å³°å€¼\n\n\n\nåŒå‘è°ƒç”¨æœºåˆ¶Lua â†’ C++&#x2F;è“å›¾ è°ƒç”¨è°ƒç”¨é“¾è·¯actor:SetActorLocation(FVector(100, 200, 300))â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ 1. Lua å‡½æ•°æŸ¥æ‰¾                                       â”‚â”‚    actor:SetActorLocation                            â”‚â”‚      â””â”€â–º actor çš„ metatable.__index                  â”‚â”‚          â””â”€â–º Class_Index                             â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚             â–¼â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ 2. è·å– FFunctionDesc                                 â”‚â”‚    GetField(L)                                       â”‚â”‚      â””â”€â–º ClassDesc-&gt;RegisterField(&quot;SetActorLocation&quot;)â”‚â”‚          â””â”€â–º åˆ›å»º FFunctionDesc (é¦–æ¬¡) æˆ–ç¼“å­˜        â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚             â–¼â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ 3. æ¨é€ Closure                                       â”‚â”‚    PushField(L, Function)                            â”‚â”‚      â””â”€â–º lua_pushcclosure(L, Class_CallUFunction, 1) â”‚â”‚          â””â”€â–º ç¼“å­˜åˆ° metatable                        â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚             â–¼â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ 4. æ‰§è¡Œ Closure                                       â”‚â”‚    Class_CallUFunction(L)                            â”‚â”‚      â””â”€â–º FFunctionDesc::CallUE(L, NumParams)         â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚             â–¼â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ 5. å‚æ•°è½¬æ¢                                           â”‚â”‚    PreCall(L, NumParams, Params)                     â”‚â”‚      â”œâ”€â–º FVector::WriteValue(L, Params)              â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚             â–¼â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ 6. è°ƒç”¨ UE å‡½æ•°                                       â”‚â”‚    Object-&gt;ProcessEvent(Function, Params)            â”‚â”‚      â””â”€â–º AActor::SetActorLocation(FVector)           â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚             â–¼â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ 7. è¿”å›å€¼å¤„ç†                                         â”‚â”‚    PostCall(L, Params)                               â”‚â”‚      â””â”€â–º æ— è¿”å›å€¼ï¼Œè¿”å› 0                            â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\næ€§èƒ½ä¼˜åŒ–ç‚¹\n\n\nä¼˜åŒ–æŠ€æœ¯\nå®ç°ä½ç½®\næ•ˆæœ\n\n\n\nå‡½æ•°æè¿°ç¬¦ç¼“å­˜\nClassDesc çš„ Fields è¡¨\né¿å…é‡å¤åå°„ï¼Œæå‡ 90%\n\n\nClosure å¤ç”¨\nMetatable ç¼“å­˜\nå‡å°‘ GC å‹åŠ›\n\n\nå‚æ•°ç¼“å†²åŒºæ± åŒ–\nFParamBufferAllocator\né¿å…é¢‘ç¹åˆ†é…\n\n\nå¿«é€Ÿè·¯å¾„ä¼˜åŒ–\nGetCppInstanceFast\nè·³è¿‡æ£€æŸ¥ï¼Œæå‡ 20%\n\n\nC++&#x2F;è“å›¾ â†’ Lua è°ƒç”¨è°ƒç”¨é“¾è·¯è“å›¾èŠ‚ç‚¹: Event BeginPlayâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ 1. è“å›¾è™šæ‹Ÿæœºæ‰§è¡Œ                                     â”‚â”‚    UK2Node_Event::Execute()                          â”‚â”‚      â””â”€â–º UObject::ProcessEvent(BeginPlay, nullptr)   â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚             â–¼â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ 2. æ£€æŸ¥ Lua è¦†å†™                                      â”‚â”‚    FLuaOverrider::ProcessEvent()                     â”‚â”‚      â”œâ”€â–º æŸ¥æ‰¾ ObjectRefs[this]                       â”‚â”‚      â”‚   â””â”€â–º LuaTableRef (Lua å®ä¾‹è¡¨å¼•ç”¨)            â”‚â”‚      â”‚                                                â”‚â”‚      â”œâ”€â–º lua_rawgeti(L, LUA_REGISTRYINDEX, Ref)      â”‚â”‚      â”‚   â””â”€â–º è·å– INSTANCE                           â”‚â”‚      â”‚                                                â”‚â”‚      â””â”€â–º lua_getfield(L, -1, &quot;ReceiveBeginPlay&quot;)     â”‚â”‚          â””â”€â–º æŸ¥æ‰¾ Lua å‡½æ•°                           â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚             â–¼â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ 3. å‡†å¤‡ Lua è°ƒç”¨                                      â”‚â”‚    FFunctionDesc::CallLua(L, FunctionRef, SelfRef, Stack)â”‚â”‚      â”œâ”€â–º lua_rawgeti(L, LUA_REGISTRYINDEX, FunctionRef)â”‚â”‚      â””â”€â–º lua_rawgeti(L, LUA_REGISTRYINDEX, SelfRef)  â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚             â–¼â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ 4. å‚æ•°è½¬æ¢                                           â”‚â”‚    for (Property: Function-&gt;Properties)             â”‚â”‚      Property-&gt;ReadValue(L, Params, false)           â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚             â–¼â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ 5. æ‰§è¡Œ Lua å‡½æ•°                                      â”‚â”‚    lua_pcall(L, NumParams, NumResults, ErrorHandler) â”‚â”‚      â””â”€â–º æ‰§è¡Œ MyActor.lua:ReceiveBeginPlay(self)     â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚             â–¼â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ 6. è¿”å›å€¼å¤„ç†                                         â”‚â”‚    if (HasReturnValue)                               â”‚â”‚      ReturnProperty-&gt;WriteValue(L, RetAddress, -1)   â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚             â–¼â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ 7. Out å‚æ•°å›å†™                                       â”‚â”‚    for (OutProperty: OutProperties)                 â”‚â”‚      OutProperty-&gt;WriteValue(L, Params)              â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\nè¦†å†™æ£€æµ‹æµç¨‹// FunctionDesc.cppvoid FFunctionDesc::CallLua(...)&#123;    // 1. è·å– Lua å‡½æ•°å¼•ç”¨    lua_rawgeti(L, LUA_REGISTRYINDEX, FunctionRef);    if (!lua_isfunction(L, -1))    &#123;        lua_pop(L, 1);        return;  // Lua å‡½æ•°æ— æ•ˆï¼Œè·³è¿‡    &#125;        // 2. æ‰§è¡Œ Lua è¦†å†™é€»è¾‘    // ... (è§ä¸Šæ–‡è°ƒç”¨é“¾è·¯)&#125;\n\nè°ƒç”¨æ€§èƒ½å¯¹æ¯”\n\n\nè°ƒç”¨ç±»å‹\nå¹³å‡è€—æ—¶ (Î¼s)\nç›¸å¯¹æ€§èƒ½\nä¸»è¦å¼€é”€\n\n\n\nC++ â†’ C++\n0.05\n1x\nå‡½æ•°è°ƒç”¨\n\n\nLua â†’ C++\n2.5\n50x\nå‚æ•°è½¬æ¢ã€åå°„\n\n\nC++ â†’ Lua\n3.8\n76x\nLua VMã€å‚æ•°è½¬æ¢\n\n\nLua â†’ Lua\n0.8\n16x\nTable æŸ¥æ‰¾\n\n\nä¼˜åŒ–å»ºè®®:\n\né¢‘ç¹è°ƒç”¨çš„å‡½æ•° (å¦‚ Tick) å°½é‡åœ¨å•ä¾§å®ç°\næ‰¹é‡æ“ä½œä½¿ç”¨å®¹å™¨è€Œéé€ä¸ªä¼ é€’\né¿å…åœ¨å¾ªç¯ä¸­è·¨è¯­è¨€è°ƒç”¨\n\n\næ€§èƒ½ä¼˜åŒ–è¦ç‚¹å…³é”®ä¼˜åŒ–æŠ€æœ¯è¡¨\n\n\nä¼˜åŒ–æŠ€æœ¯\nå®ç°ä½ç½®\næ€§èƒ½æå‡\né€‚ç”¨åœºæ™¯\n\n\n\nUserdata å¿«é€Ÿè·¯å¾„\nGetUserdataFast()\n~30%\næ‰€æœ‰å¯¹è±¡è®¿é—®\n\n\nå‡½æ•°æè¿°ç¬¦ç¼“å­˜\nClassDesc::Fields\n~90%\né‡å¤è°ƒç”¨å‡½æ•°\n\n\nå‚æ•°ç¼“å†²åŒºæ± åŒ–\nFParamBufferAllocator\n~20%\né«˜é¢‘å‡½æ•°è°ƒç”¨\n\n\né›¶æ‹·è´å®¹å™¨\nTArray/TMap å¼•ç”¨ä¼ é€’\n~80%\nå¤§æ•°æ®ä¼ é€’\n\n\næ‡’åŠ è½½åå°„\næŒ‰éœ€åˆ›å»º FPropertyDesc\nå‡å°‘å¯åŠ¨ 50%\nç±»å‹æ³¨å†Œ\n\n\nå¼±å¼•ç”¨è¡¨\nUnLua_ObjectMap\nå‡å°‘ GC å‹åŠ›\nå¯¹è±¡ç¼“å­˜\n\n\nUserdata å†…å­˜å¸ƒå±€ä¼˜åŒ–// LuaCore.cpp:78#pragma pack(push, 1)struct FUserdataDesc&#123;    uint16  magic;      // 2 bytes (é­”æ•°éªŒè¯)    uint8   tag;        // 1 byte  (æ ‡å¿—ä½)    uint8   padding;    // 1 byte  (å¯¹é½å¡«å……)&#125;;#pragma pack(pop)// æ€»å¤§å°: 4 bytesï¼Œç´§å‡‘å¸ƒå±€\n\nä¼˜åŒ–æ•ˆæœ:\n\nåŸå…ˆæ¯ä¸ª Userdata é¢å¤– 16 bytes\nä¼˜åŒ–åä»… 4 bytes\nå‡å°‘å†…å­˜å ç”¨ 75%\n\nå‡½æ•°è°ƒç”¨ä¼˜åŒ–ç­–ç•¥Closure ç¼“å­˜æœºåˆ¶-- æœªä¼˜åŒ–ç‰ˆæœ¬ (æ¯æ¬¡åˆ›å»ºæ–° Closure)for i = 1, 1000 do    actor:SetActorLocation(FVector(i * 100, 0, 0))end-- âœ… ä¼˜åŒ–ç‰ˆæœ¬ (Closure è‡ªåŠ¨ç¼“å­˜)for i = 1, 1000 do    actor:SetActorLocation(FVector(i * 100, 0, 0))end\n\næ€§èƒ½å¯¹æ¯”:\n\næœªä¼˜åŒ–: ~3000 Î¼s (å« Closure åˆ›å»º)\nä¼˜åŒ–å: ~2500 Î¼s (ä»…è°ƒç”¨å¼€é”€)\næå‡ 16.7%\n\næ‰¹é‡æ“ä½œæœ€ä½³å®è·µ-- âŒ ä½æ•ˆ: é€ä¸ªè·¨è¯­è¨€è°ƒç”¨for i = 1, #actors do    actors[i]:SetActorLocation(FVector(i * 100, 0, 0))end-- âœ… é«˜æ•ˆ: æ‰¹é‡è®¾ç½®local locations = UE.TArray(UE.FVector)for i = 1, #actors do    locations:Add(FVector(i * 100, 0, 0))endBatchSetLocations(actors, locations)  -- C++ æ‰¹å¤„ç†\n\nå†…å­˜ä¼˜åŒ–å»ºè®®\n\n\nä¼˜åŒ–ç‚¹\nè¯´æ˜\næ”¶ç›Š\n\n\n\nåŠæ—¶è§£ç»‘\nä¸ç”¨çš„å¯¹è±¡è°ƒç”¨ UnLua.Unbind()\nå‡å°‘ GC å‹åŠ›\n\n\nä½¿ç”¨å¼±å¼•ç”¨\nä¸´æ—¶å¼•ç”¨ä¸å­˜å…¨å±€ table\nå…è®¸ UE GC å›æ”¶\n\n\nå®¹å™¨å¤ç”¨\né‡å¤ä½¿ç”¨ TArray\nå‡å°‘åˆ†é…æ¬¡æ•°\n\n\né¿å…å­—ç¬¦ä¸²æ‹¼æ¥\nä½¿ç”¨ table.concat\nå‡å°‘ä¸´æ—¶å­—ç¬¦ä¸²\n\n\n\né«˜çº§è¯é¢˜å¤š Lua VM ç¯å¢ƒéš”ç¦»UnLua æ”¯æŒåˆ›å»ºå¤šä¸ªç‹¬ç«‹çš„ Lua ç¯å¢ƒï¼Œç”¨äºéš”ç¦»ä¸åŒçš„æ¸¸æˆæ¨¡å—ã€‚\n// åˆ›å»ºç‹¬ç«‹ç¯å¢ƒFLuaEnv* MainEnv = new FLuaEnv(&quot;Main&quot;);FLuaEnv* PluginEnv = new FLuaEnv(&quot;Plugin&quot;);// ç¯å¢ƒé—´ä¸å…±äº«å…¨å±€å˜é‡MainEnv-&gt;DoString(&quot;GlobalVar = 123&quot;);PluginEnv-&gt;DoString(&quot;print(GlobalVar)&quot;);  -- nil\n\nåç¨‹æ”¯æŒLatent å‡½æ•°function MyActor:TestLatent()    UE.UKismetSystemLibrary.Delay(self, 2.0)  -- ç­‰å¾… 2 ç§’    print(&quot;2 seconds later&quot;)  -- è‡ªåŠ¨æ¢å¤æ‰§è¡Œend\n\nåº•å±‚å®ç°:\n// FunctionDesc.cppint32 Class_CallLatentFunction(lua_State *L)&#123;    auto&amp; Env = UnLua::FLuaEnv::FindEnvChecked(L);    auto ThreadRef = Env.FindOrAddThread(L);  // åˆ›å»º/è·å–åç¨‹        int32 NumResults = Function-&gt;CallUE(L, NumParams, &amp;ThreadRef);        return lua_yield(L, NumResults);  // æŒ‚èµ·åç¨‹&#125;\n\nçƒ­æ›´æ–°æœºåˆ¶çƒ­æ›´æ–°æµç¨‹1. ä¸‹è½½æ–° Lua æ–‡ä»¶åˆ° PersistentDownloadDir/   â””â”€â–º iOS/Android: Library/Caches/       PC: Saved/DownloadData/2. è°ƒç”¨çƒ­æ›´æ–° API   UnLua.HotReload(&quot;ModuleName&quot;)   â””â”€â–º package.loaded[&quot;ModuleName&quot;] = nil       require(&quot;ModuleName&quot;)\n\nçƒ­æ›´æ–°é™åˆ¶\n\n\nå¯çƒ­æ›´\nä¸å¯çƒ­æ›´\nè§£å†³æ–¹æ¡ˆ\n\n\n\nLua é€»è¾‘å‡½æ•°\nC++ ä»£ç \nä»… Lua å®ç°çƒ­æ›´\n\n\nLua Module\nå·²åŠ è½½çš„ UClass\né‡å¯æ¸¸æˆ\n\n\næ–°å¢ Lua å‡½æ•°\nä¿®æ”¹ UFunction ç­¾å\nä¿æŒæ¥å£ç¨³å®š\n\n\næ•°å€¼é…ç½®\nå·²åˆ›å»ºçš„å¯¹è±¡çŠ¶æ€\næä¾›è¿ç§»å‡½æ•°\n\n\nè°ƒè¯•ä¸æ€§èƒ½åˆ†æLua è°ƒè¯•å™¨é›†æˆUnLua æ”¯æŒ VSCode Lua Debugger å’Œ EmmyLua:\n// .vscode/launch.json&#123;    &quot;type&quot;: &quot;lua&quot;,    &quot;request&quot;: &quot;attach&quot;,    &quot;name&quot;: &quot;Attach to UnLua&quot;,    &quot;host&quot;: &quot;localhost&quot;,    &quot;port&quot;: 8818&#125;\n\næ€§èƒ½åˆ†æå·¥å…·-- ä½¿ç”¨å†…ç½® Profilerlocal Profiler = require(&quot;UnLua.Profiler&quot;)Profiler.Start()-- æ‰§è¡Œä¸šåŠ¡é€»è¾‘Profiler.Stop()Profiler.Report()  -- è¾“å‡ºæŠ¥å‘Š\n\n\né™„å½•A. æ ¸å¿ƒæ–‡ä»¶ç´¢å¼•\n\n\næ–‡ä»¶\nè·¯å¾„\nåŠŸèƒ½\n\n\n\nLuaEnv.cpp\nSource/UnLua/Private/\nLua VM ç®¡ç†\n\n\nClassRegistry.cpp\nSource/UnLua/Private/Registries/\nç±»æ³¨å†Œ\n\n\nObjectRegistry.cpp\nSource/UnLua/Private/Registries/\nå¯¹è±¡ç»‘å®š\n\n\nFunctionDesc.cpp\nSource/UnLua/Private/ReflectionUtils/\nå‡½æ•°è°ƒç”¨\n\n\nPropertyDesc.cpp\nSource/UnLua/Private/ReflectionUtils/\nå±æ€§è®¿é—®\n\n\nLuaCore.cpp\nSource/UnLua/Private/\næ ¸å¿ƒç»‘å®šé€»è¾‘\n\n\nB. Lua C API é€ŸæŸ¥æ‰‹å†ŒB.1 æ ˆæ“ä½œ\n\n\nAPI\nåŠŸèƒ½\næ ˆå˜åŒ–\nç¤ºä¾‹\n\n\n\nlua_gettop(L)\nè·å–æ ˆé¡¶ç´¢å¼•\n0\nint n = lua_gettop(L);\n\n\nlua_settop(L, n)\nè®¾ç½®æ ˆå¤§å°\nn\nlua_settop(L, 0); æ¸…ç©ºæ ˆ\n\n\nlua_pushvalue(L, idx)\nå¤åˆ¶å€¼åˆ°æ ˆé¡¶\n+1\nlua_pushvalue(L, -1); å¤åˆ¶æ ˆé¡¶\n\n\nlua_remove(L, idx)\nç§»é™¤æŒ‡å®šç´¢å¼•\n-1\nlua_remove(L, 1); ç§»é™¤æ ˆåº•\n\n\nlua_insert(L, idx)\næ’å…¥æ ˆé¡¶å€¼åˆ°idx\n0\næ ˆé¡¶ç§»åˆ°ä¸­é—´\n\n\nlua_replace(L, idx)\næ›¿æ¢idxå€¼\n-1\nå¼¹å‡ºæ ˆé¡¶æ›¿æ¢idx\n\n\nlua_pop(L, n)\nå¼¹å‡ºnä¸ªå€¼\n-n\nlua_pop(L, 1);\n\n\nlua_rotate(L, idx, n)\næ—‹è½¬æ ˆå…ƒç´ \n0\nLua 5.3+\n\n\nB.2 ç±»å‹æ£€æŸ¥ä¸è½¬æ¢\n\n\nAPI\nåŠŸèƒ½\nè¿”å›å€¼\nå¤±è´¥è¿”å›\n\n\n\nlua_type(L, idx)\nè·å–ç±»å‹\nLUA_TXXX\nLUA_TNONE\n\n\nlua_typename(L, tp)\nç±»å‹åå­—ç¬¦ä¸²\nâ€œtableâ€ç­‰\n-\n\n\nlua_isXXX(L, idx)\nç±»å‹åˆ¤æ–­\nbool\n-\n\n\nlua_toXXX(L, idx)\nç±»å‹è½¬æ¢\nå¯¹åº”ç±»å‹\n0&#x2F;NULL\n\n\nluaL_checkXXX(L, idx)\nå¼ºåˆ¶è½¬æ¢\nå¯¹åº”ç±»å‹\næŠ›é”™\n\n\nlua_toboolean(L, idx)\nè½¬bool\nint\n0&#x3D;false\n\n\nlua_tointeger(L, idx)\nè½¬æ•´æ•°\nlua_Integer\n0\n\n\nlua_tonumber(L, idx)\nè½¬æµ®ç‚¹\nlua_Number\n0.0\n\n\nlua_tostring(L, idx)\nè½¬å­—ç¬¦ä¸²\nconst char*\nNULL\n\n\nlua_touserdata(L, idx)\nè½¬userdata\nvoid*\nNULL\n\n\nlua_topointer(L, idx)\nè½¬é€šç”¨æŒ‡é’ˆ\nconst void*\nNULL\n\n\nç±»å‹å¸¸é‡:\nLUA_TNIL           // nilLUA_TNUMBER        // numberLUA_TBOOLEAN       // booleanLUA_TSTRING        // stringLUA_TTABLE         // tableLUA_TFUNCTION      // functionLUA_TUSERDATA      // userdataLUA_TTHREAD        // threadLUA_TLIGHTUSERDATA // light userdata\n\nB.3 å€¼å‹æ ˆ\n\n\nAPI\nåŠŸèƒ½\nå‹å…¥ç±»å‹\næ ˆå˜åŒ–\n\n\n\nlua_pushnil(L)\nå‹å…¥nil\nnil\n+1\n\n\nlua_pushboolean(L, b)\nå‹å…¥bool\nboolean\n+1\n\n\nlua_pushinteger(L, n)\nå‹å…¥æ•´æ•°\ninteger\n+1\n\n\nlua_pushnumber(L, n)\nå‹å…¥æµ®ç‚¹\nnumber\n+1\n\n\nlua_pushstring(L, s)\nå‹å…¥å­—ç¬¦ä¸²\nstring\n+1\n\n\nlua_pushlstring(L, s, len)\nå‹å…¥å®šé•¿å­—ç¬¦ä¸²\nstring\n+1\n\n\nlua_pushcfunction(L, f)\nå‹å…¥Cå‡½æ•°\nfunction\n+1\n\n\nlua_pushcclosure(L, f, n)\nå‹å…¥é—­åŒ…\nfunction\n+1-n\n\n\nlua_pushlightuserdata(L, p)\nå‹å…¥è½»é‡userdata\nlightuserdata\n+1\n\n\nlua_pushthread(L)\nå‹å…¥çº¿ç¨‹\nthread\n+1\n\n\nB.4 è¡¨æ“ä½œ\n\n\nAPI\nåŠŸèƒ½\næ ˆå˜åŒ–\nè¯´æ˜\n\n\n\nlua_newtable(L)\nåˆ›å»ºç©ºè¡¨\n+1\nç­‰ä»·äº lua_createtable(L,0,0)\n\n\nlua_createtable(L, narr, nrec)\nåˆ›å»ºè¡¨(é¢„åˆ†é…)\n+1\nä¼˜åŒ–æ€§èƒ½\n\n\nlua_gettable(L, idx)\nè·å– t[k]\n0\nå¼¹å‡ºk,å‹å…¥v\n\n\nlua_settable(L, idx)\nè®¾ç½® t[k]&#x3D;v\n-2\nå¼¹å‡ºkå’Œv\n\n\nlua_getfield(L, idx, k)\nè·å– t[k]\n+1\nkæ˜¯Cå­—ç¬¦ä¸²\n\n\nlua_setfield(L, idx, k)\nè®¾ç½® t[k]&#x3D;v\n-1\nå¼¹å‡ºv\n\n\nlua_rawget(L, idx)\nè·å–(æ— å…ƒæ–¹æ³•)\n0\nåŒgettable\n\n\nlua_rawset(L, idx)\nè®¾ç½®(æ— å…ƒæ–¹æ³•)\n-2\nåŒsettable\n\n\nlua_rawgeti(L, idx, n)\nè·å– t[n]\n+1\nnæ˜¯æ•´æ•°\n\n\nlua_rawseti(L, idx, n)\nè®¾ç½® t[n]&#x3D;v\n-1\nnæ˜¯æ•´æ•°\n\n\nlua_next(L, idx)\néå†è¡¨\n+1æˆ–0\nè¿­ä»£å™¨\n\n\nB.5 å…ƒè¡¨æ“ä½œ\n\n\nAPI\nåŠŸèƒ½\næ ˆå˜åŒ–\nè¿”å›å€¼\n\n\n\nlua_getmetatable(L, idx)\nè·å–å…ƒè¡¨\n+1\n1æœ‰å…ƒè¡¨,0æ— \n\n\nlua_setmetatable(L, idx)\nè®¾ç½®å…ƒè¡¨\n-1\n1\n\n\nluaL_getmetatable(L, name)\nè·å–å‘½åå…ƒè¡¨\n+1\nç±»å‹ç \n\n\nluaL_newmetatable(L, name)\nåˆ›å»ºå‘½åå…ƒè¡¨\n+1\n1æ–°å»º,0å·²å­˜åœ¨\n\n\nluaL_setmetatable(L, name)\nè®¾ç½®å‘½åå…ƒè¡¨\n0\nvoid\n\n\nluaL_getmetafield(L, obj, e)\nè·å–å…ƒæ–¹æ³•\n+1æˆ–0\nç±»å‹ç æˆ–0\n\n\nå…ƒæ–¹æ³•åç§°:\n&quot;__index&quot;      // ç´¢å¼•è¯»å–&quot;__newindex&quot;   // ç´¢å¼•å†™å…¥&quot;__gc&quot;         // åƒåœ¾å›æ”¶&quot;__tostring&quot;   // tostring()&quot;__call&quot;       // å‡½æ•°è°ƒç”¨&quot;__eq&quot;         // ==&quot;__lt&quot;         // &lt;&quot;__le&quot;         // &lt;=&quot;__add&quot;        // +&quot;__sub&quot;        // -&quot;__mul&quot;        // *&quot;__div&quot;        // /&quot;__mod&quot;        // %&quot;__pow&quot;        // ^&quot;__unm&quot;        // - (ä¸€å…ƒ)&quot;__concat&quot;     // ..&quot;__len&quot;        // #&quot;__pairs&quot;      // pairs()&quot;__ipairs&quot;     // ipairs()\n\nB.6 å‡½æ•°è°ƒç”¨\n\n\nAPI\nåŠŸèƒ½\næ ˆå˜åŒ–\né”™è¯¯å¤„ç†\n\n\n\nlua_call(L, nargs, nresults)\nè°ƒç”¨å‡½æ•°\n-(nargs+1), +nresults\né”™è¯¯å‘ä¸Šä¼ æ’­\n\n\nlua_pcall(L, nargs, nresults, errfunc)\nä¿æŠ¤è°ƒç”¨\nåŒä¸Š\næ•è·é”™è¯¯\n\n\nlua_callk(...)\nå¯ç»­è°ƒç”¨\nåŒcall\nLua 5.2+\n\n\nlua_pcallk(...)\nå¯ç»­ä¿æŠ¤è°ƒç”¨\nåŒpcall\nLua 5.2+\n\n\nluaL_loadstring(L, s)\nåŠ è½½Luaä»£ç \n+1\nè¿”å›é”™è¯¯ç \n\n\nluaL_dostring(L, s)\nåŠ è½½å¹¶æ‰§è¡Œ\n0\nè¿”å›é”™è¯¯ç \n\n\nlua_pcall é”™è¯¯ç :\nLUA_OK        // 0 - æˆåŠŸLUA_ERRRUN    // è¿è¡Œæ—¶é”™è¯¯LUA_ERRMEM    // å†…å­˜åˆ†é…é”™è¯¯LUA_ERRERR    // é”™è¯¯å¤„ç†å‡½æ•°å‡ºé”™LUA_ERRGCMM   // GCå…ƒæ–¹æ³•é”™è¯¯LUA_ERRSYNTAX // è¯­æ³•é”™è¯¯ (ä»…loadstring)\n\nB.7 å¼•ç”¨ç³»ç»Ÿ\n\n\nAPI\nåŠŸèƒ½\nè¿”å›å€¼\nè¯´æ˜\n\n\n\nluaL_ref(L, idx)\nåˆ›å»ºå¼•ç”¨\nint\nå¼¹å‡ºæ ˆé¡¶,è¿”å›ID\n\n\nluaL_unref(L, idx, ref)\né‡Šæ”¾å¼•ç”¨\nvoid\nå…è®¸GCå›æ”¶\n\n\nlua_rawgeti(L, LUA_REGISTRYINDEX, ref)\nä½¿ç”¨å¼•ç”¨\n+1\nå‹å…¥å¼•ç”¨çš„å€¼\n\n\nç‰¹æ®Šå¼•ç”¨å€¼:\nLUA_NOREF   // æ— æ•ˆå¼•ç”¨ (-2)LUA_REFNIL  // nilå¼•ç”¨ (-1)\n\nB.8 Userdata\n\n\nAPI\nåŠŸèƒ½\næ ˆå˜åŒ–\nè¿”å›å€¼\n\n\n\nlua_newuserdata(L, size)\nåˆ›å»ºuserdata\n+1\nvoid*æŒ‡é’ˆ\n\n\nlua_touserdata(L, idx)\nè·å–æŒ‡é’ˆ\n0\nvoid*æˆ–NULL\n\n\nlua_getuservalue(L, idx)\nè·å–å…³è”å€¼\n+1\nLua 5.2+\n\n\nlua_setuservalue(L, idx)\nè®¾ç½®å…³è”å€¼\n-1\nLua 5.2+\n\n\nB.9 é”™è¯¯å¤„ç†\n\n\nAPI\nåŠŸèƒ½\nè¿”å›å€¼\nè¯´æ˜\n\n\n\nluaL_error(L, fmt, ...)\næŠ›å‡ºé”™è¯¯\næ°¸ä¸è¿”å›\nlong jump\n\n\nluaL_argerror(L, arg, extramsg)\nå‚æ•°é”™è¯¯\næ°¸ä¸è¿”å›\næ ‡å‡†æ ¼å¼\n\n\nluaL_checktype(L, arg, t)\næ£€æŸ¥ç±»å‹\nvoid\né”™è¯¯åˆ™æŠ›å‡º\n\n\nlua_atpanic(L, panicf)\nè®¾ç½®panicå‡½æ•°\næ—§å‡½æ•°\nè‡´å‘½é”™è¯¯\n\n\nB.10 å®ç”¨å·¥å…·\n\n\nAPI\nåŠŸèƒ½\nè¿”å›å€¼\nè¯´æ˜\n\n\n\nluaL_requiref(L, modname, openf, glb)\næ³¨å†Œæ¨¡å—\nvoid\n\n\n\nluaL_getsubtable(L, idx, fname)\nè·å–å­è¡¨\nint\nä¸å­˜åœ¨åˆ™åˆ›å»º\n\n\nluaL_len(L, idx)\nè·å–é•¿åº¦\nlua_Integer\nç­‰ä»·äº #\n\n\nluaL_tolstring(L, idx, len)\nè½¬å­—ç¬¦ä¸²\nconst char*\nå‹æ ˆ\n\n\nluaL_traceback(L, L1, msg, level)\nè·å–æ ˆè·Ÿè¸ª\nvoid\nè°ƒè¯•ç”¨\n\n\nUnLua å¸¸ç”¨å°è£…:\n// UnLua æä¾›çš„ä¾¿åˆ©å‡½æ•°UnLua::GetUObject(L, idx)          // è·å–UObjectUnLua::PushUObject(L, Object)       // å‹å…¥UObjectUnLua::GetCppInstance(L, idx)       // è·å–C++å®ä¾‹UnLua::IsUObjectValid(Object)       // æ£€æŸ¥æœ‰æ•ˆæ€§UnLua::ReportLuaCallError(L)        // æŠ¥å‘ŠLuaé”™è¯¯\n\nB.11 å¸¸ç”¨ä»£ç æ¨¡å¼1. å®‰å…¨çš„å‡½æ•°è°ƒç”¨:\nlua_getglobal(L, &quot;MyFunction&quot;);lua_pushinteger(L, 42);if (lua_pcall(L, 1, 1, 0) != LUA_OK) &#123;    UE_LOG(LogUnLua, Error, TEXT(&quot;%s&quot;), UTF8_TO_TCHAR(lua_tostring(L, -1)));    lua_pop(L, 1);&#125;\n\n2. åˆ›å»ºè¡¨å¹¶è®¾ç½®å­—æ®µ:\nlua_newtable(L);                    // åˆ›å»ºç©ºè¡¨lua_pushstring(L, &quot;name&quot;);          // keylua_pushstring(L, &quot;MyActor&quot;);       // valuelua_rawset(L, -3);                  // table.name = &quot;MyActor&quot;\n\n3. éå†è¡¨:\nlua_pushnil(L);  // é¦–ä¸ªkeywhile (lua_next(L, -2) != 0) &#123;    // æ ˆ: [..., table, key, value]    const char* key = lua_tostring(L, -2);    const char* val = lua_tostring(L, -1);    printf(&quot;%s = %s\\n&quot;, key, val);    lua_pop(L, 1);  // å¼¹å‡ºvalue,ä¿ç•™key&#125;\n\n4. åˆ›å»ºå¼•ç”¨æŒä¹…åŒ–å¯¹è±¡:\nlua_newtable(L);int ref = luaL_ref(L, LUA_REGISTRYINDEX);// ... ç¨åä½¿ç”¨ ...lua_rawgeti(L, LUA_REGISTRYINDEX, ref);// ... ä½¿ç”¨å®Œæ¯• ...luaL_unref(L, LUA_REGISTRYINDEX, ref);\n\n5. åˆ›å»ºå¸¦å…ƒè¡¨çš„ Userdata:\nvoid* udata = lua_newuserdata(L, sizeof(MyData));new(udata) MyData();  // placement newluaL_setmetatable(L, &quot;MyData&quot;);  // è®¾ç½®å…ƒè¡¨\n\nC. æ€§èƒ½åŸºå‡†æµ‹è¯•\n\n\næµ‹è¯•åœºæ™¯\nè€—æ—¶ (Î¼s)\nå¯¹æ¯” C++\nå¤‡æ³¨\n\n\n\nç©ºå‡½æ•°è°ƒç”¨\n0.8\n16x\nLua VM å¼€é”€\n\n\nå±æ€§è¯»å–\n1.2\n24x\nåŒ…å«åå°„æŸ¥æ‰¾\n\n\nå®¹å™¨éå† (1000 å…ƒç´ )\n450\n5x\né›¶æ‹·è´ä¼˜åŒ–å\n\n\nå¯¹è±¡åˆ›å»º (Userdata)\n2.0\n40x\nåŒ…å«å…ƒè¡¨è®¾ç½®\n\n\nD. å¸¸è§é—®é¢˜æ’æŸ¥\n\n\né—®é¢˜\nåŸå› \nè§£å†³æ–¹æ¡ˆ\n\n\n\nâ€œattempt to read property on released objectâ€\nUObject è¢«é”€æ¯å Lua ä»æŒæœ‰å¼•ç”¨\næ£€æŸ¥å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ\n\n\nLua æ ˆæº¢å‡º\né€’å½’è°ƒç”¨è¿‡æ·±\næ£€æŸ¥è°ƒç”¨æ ˆ\n\n\nå†…å­˜æ³„æ¼\nå…¨å±€ table æŒæœ‰å¯¹è±¡å¼•ç”¨\nä½¿ç”¨å¼±å¼•ç”¨\n\n\nçƒ­æ›´æ–°ä¸ç”Ÿæ•ˆ\npackage.loaded æœªæ¸…é™¤\nè°ƒç”¨ UnLua.HotReload()\n\n\n\næ€»ç»“UnLua ä½œä¸ºæˆç†Ÿçš„ UE-Lua ç»‘å®šæ–¹æ¡ˆï¼Œå…¶æ ¸å¿ƒä¼˜åŠ¿åœ¨äºï¼š\n\né›¶ä¾µå…¥æ€§: æ— éœ€ä¿®æ”¹ UE å¼•æ“ä»£ç \né«˜æ€§èƒ½: é€šè¿‡ç¼“å­˜ã€æ± åŒ–ã€é›¶æ‹·è´ç­‰æŠ€æœ¯ä¼˜åŒ–\nå®‰å…¨æ€§: å®Œå–„çš„ GC ååŒå’Œæ‚¬ç©ºæŒ‡é’ˆé˜²æŠ¤\nçµæ´»æ€§: æ”¯æŒé™æ€&#x2F;åŠ¨æ€&#x2F;åå°„å¤šç§å¯¼å‡ºæ–¹å¼\n\næ ¸å¿ƒè®¾è®¡å“²å­¦:\n\næŒ‰éœ€åŠ è½½: åå°„ç±»å‹æ‡’åŠ è½½ï¼Œå‡å°‘å¯åŠ¨å¼€é”€\nåŒå‘é€æ˜: Lua å’Œ C++ ç›¸äº’è°ƒç”¨æ— æ„ŸçŸ¥\nç”Ÿå‘½å‘¨æœŸåŒæ­¥: åŒé‡ GC ååŒï¼Œé˜²æ­¢å†…å­˜æ³„æ¼\n\næ¨èå®è·µ:\n\næ ¸å¿ƒé€»è¾‘ç”¨ C++ï¼Œæ¸¸æˆç©æ³•ç”¨ Lua\né«˜é¢‘è°ƒç”¨å‡½æ•°ä½¿ç”¨é™æ€å¯¼å‡º\nåˆç†ä½¿ç”¨å®¹å™¨å¼•ç”¨ä¼ é€’\nå®šæœŸæ‰§è¡Œ GC å’Œæ€§èƒ½åˆ†æ\n\næœ¬æ–‡æ¡£ç‰¹è‰²:\n\nâœ… æºç çº§åˆ†æ: æ¯ä¸ªæŠ€æœ¯ç‚¹éƒ½é™„å¸¦å®Œæ•´æºç å‰–æ\nâœ… Lua C API è¯¦è§£: åœ¨ä½¿ç”¨å¤„å°±åœ°è®²è§£ç›¸å…³ API ç”¨æ³•\nâœ… æ ˆæ“ä½œå¯è§†åŒ–: æ¸…æ™°å±•ç¤ºæ¯ä¸€æ­¥çš„æ ˆå˜åŒ–è¿‡ç¨‹\nâœ… å®æˆ˜ç¤ºä¾‹ä¸°å¯Œ: åŒ…å« C++ å’Œ Lua åŒå‘ä»£ç å¯¹ç…§\nâœ… æ€§èƒ½æ•°æ®æ”¯æ’‘: æä¾›çœŸå®çš„æ€§èƒ½åŸºå‡†æµ‹è¯•æ•°æ®\n\næ–‡æ¡£æ›´æ–°æ—¥å¿—:\n\nv2.0 (2025-11-29): å…¨é¢ä¼˜åŒ–,å°† Lua C API è®²è§£èå…¥å„ç« èŠ‚\næ–°å¢: Metatable æ“ä½œ API è¯¦è§£ (4.2.2)\næ–°å¢: å¼•ç”¨ç³»ç»Ÿæ·±åº¦å‰–æ (4.3.1)\næ–°å¢: æ ˆæ“ä½œåŸºç¡€ä¸å¯è§†åŒ– (5.3.1)\næ–°å¢: å‡½æ•°è°ƒç”¨ API è¯¦è§£ (5.1.1)\næ–°å¢: Userdata äºŒçº§æŒ‡é’ˆæœºåˆ¶ (7.2.1)\næ–°å¢: TArray å®Œæ•´å®ç°æºç  (6.3.2)\næ–°å¢: Lua C API é€ŸæŸ¥æ‰‹å†Œ (é™„å½•B)\n\n\nv2.2 (2025-11-29): è¡¥å……ç”¨æˆ·ç¬”è®°é‡ç‚¹\næ–°å¢: Lua C API åŸºç¡€æ¦‚å¿µ (ç¬¬ 0 ç« )\næ–°å¢: è¦†å†™å‡½æ•°å®Œæ•´æµç¨‹ (ç¬¬ 5.2.1-5.2.2 èŠ‚)\næ–°å¢: GetField æ ˆæ“ä½œå®Œæ•´å¯è§†åŒ– (ç¬¬ 5.3.3 èŠ‚)\næ–°å¢: é™æ€å¯¼å‡ºå…¨å±€æ„é€ æœºåˆ¶ (ç¬¬ 2.1.2-2.1.4 èŠ‚)\næ–°å¢: è¡¥å……è¯´æ˜ç« èŠ‚ (æ–‡æ¡£æœ«å°¾)\n\n\n\n\nè¡¥å……è¯´æ˜æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æäº† UnLua çš„æ ¸å¿ƒå®ç°æœºåˆ¶ï¼ŒåŒ…å«å®Œæ•´çš„æºç å‰–æå’Œ Lua C API è®²è§£ã€‚\næ ¸å¿ƒæŠ€æœ¯è¦ç‚¹æ€»ç»“1. æ³¨å†Œè¡¨æ˜¯ä¸€åˆ‡çš„åŸºç¡€// æ³¨å†Œè¡¨å­˜å‚¨:LUA_REGISTRYINDEX = &#123;    [&quot;å‘½åå…ƒè¡¨&quot;] = &#123;UObject, AActor, ...&#125;,    [&quot;å¯¹è±¡å¼•ç”¨&quot;] = &#123;[1]=table, [2]=function, ...&#125;,    [&quot;å…¨å±€çŠ¶æ€&quot;] = &#123;UnLua_ObjectMap, ...&#125;&#125;\n\n2. è¦†å†™å‡½æ•°çš„æœ¬è´¨// åŸå§‹è°ƒç”¨é“¾:SpawnText() â†’ FindFunctionChecked â†’ ProcessEvent â†’ æ‰§è¡Œè“å›¾å­—èŠ‚ç // Lua è¦†å†™å:SpawnText() â†’ FindFunctionChecked(è¿”å›ULuaFunction)            â†’ ProcessEvent â†’ execCallLua            â†’ lua_pcall â†’ Lua å‡½æ•°\n\n3. æ ˆæ“ä½œçš„æ ¸å¿ƒæ¨¡å¼1. æŸ¥æ‰¾: lua_getmetatable â†’ lua_rawget2. æ³¨å†Œ: lua_newuserdata â†’ lua_pushcclosure3. ç¼“å­˜: lua_rawset (é¿å…é‡å¤åˆ›å»º)4. æ¸…ç†: lua_remove / lua_pop\n\n4. é™æ€å¯¼å‡ºçš„æ—¶æœºç¼–è¯‘æœŸ: å®å±•å¼€ â†’ å…¨å±€å¯¹è±¡å®šä¹‰é“¾æ¥æœŸ: åˆå¹¶æ‰€æœ‰å…¨å±€å¯¹è±¡åŠ è½½æœŸ: æ‰§è¡Œå…¨å±€æ„é€ å‡½æ•° (main ä¹‹å‰)è¿è¡ŒæœŸ: FLuaEnv::Initialize éå†å®¹å™¨\n\nå…³é”®æ•°æ®ç»“æ„1. ULuaFunction æˆå‘˜å˜é‡class ULuaFunction : public UFunction&#123;    TWeakObjectPtr&lt;UFunction&gt; From;      // åŸå§‹å‡½æ•°å¼•ç”¨    UFunction* Overridden;               // å¤‡ä»½çš„åŸå§‹å®ç°    bool bActivated;                     // æ˜¯å¦å·²æ¿€æ´»    bool bAdded;                         // æ˜¯å¦æ–°å¢åˆ° FuncMap&#125;;\n\n2. FFunctionDesc è°ƒç”¨é“¾Lua â†’ Class_CallUFunction     â†’ FFunctionDesc::CallUE     â†’ PreCall (å‚æ•°è½¬æ¢)     â†’ ProcessEvent     â†’ PostCall (è¿”å›å€¼)\n\n3. Closure ç»“æ„-- Lua è§†è§’function_closure = &#123;    c_function = Class_CallUFunction,  -- C å‡½æ•°å…¥å£    upvalue[1] = FFunctionDesc*        -- å‡½æ•°æè¿°ç¬¦&#125;-- C++ è§†è§’lua_pushcclosure(L, Class_CallUFunction, 1);-- æ ˆé¡¶çš„ 1 ä¸ªå€¼ä½œä¸º upvalue è¢«æ•è·\n\nè°ƒè¯•æŠ€å·§1. æŸ¥çœ‹æ ˆå†…å®¹void PrintStack(lua_State* L)&#123;    int top = lua_gettop(L);    for (int i = 1; i &lt;= top; i++)    &#123;        int t = lua_type(L, i);        UE_LOG(LogUnLua, Log, TEXT(&quot;[%d] %s: %s&quot;),                i,                UTF8_TO_TCHAR(lua_typename(L, t)),               UTF8_TO_TCHAR(luaL_tolstring(L, i, NULL)));        lua_pop(L, 1);  // å¼¹å‡º tolstring çš„ç»“æœ    &#125;&#125;\n\n2. æ£€æŸ¥è¦†å†™çŠ¶æ€UFunction* Func = Class-&gt;FindFunctionByName(&quot;SpawnText&quot;);if (Func)&#123;    ULuaFunction* LuaFunc = Cast&lt;ULuaFunction&gt;(Func);    if (LuaFunc)        UE_LOG(LogUnLua, Log, TEXT(&quot;å‡½æ•°å·²è¢« Lua è¦†å†™&quot;));&#125;\n\n3. è¿½è¸ª Lua è°ƒç”¨-- åœ¨ Lua ä¸­æ‰“å°è°ƒç”¨æ ˆfunction traceback()    print(debug.traceback())end\n\n\næ–‡æ¡£å®Œæˆ | ç‰ˆæœ¬ v2.2 (æœ€ç»ˆä¿®è®¢) | 2025-11-29\næ–‡æ¡£è´¨é‡æ”¹è¿› (æœ€ç»ˆä¿®è®¢)æœ¬æ¬¡ä¿®è®¢ä¿®å¤äº†ä»¥ä¸‹é—®é¢˜ï¼š\n1. æ ¼å¼é—®é¢˜ä¿®å¤\nâœ… ä¿®å¤ç« èŠ‚ç¼–å·å†²çª (5.2.2 é‡å¤)\nâœ… åˆ é™¤é‡å¤çš„ 5.3.2 èŠ‚\nâœ… åˆ é™¤é‡å¤çš„â€æ–‡æ¡£å®Œæˆâ€æ ‡è®°\nâœ… åˆ é™¤é‡å¤çš„ v2.2 æ–°å¢å†…å®¹è¯´æ˜\n\n2. æºç è¡Œå·ä¿®æ­£\nâœ… ClassRegistry.cpp:115 â†’ ClassRegistry.cpp:108\nâœ… ObjectRegistry.cpp:116 â†’ ObjectRegistry.cpp:113\nâœ… LuaCore.cpp:1212 â†’ LuaCore.cpp:1196\nâœ… LuaCore.cpp:1235 â†’ LuaCore.cpp:1226\n\n3. ç« èŠ‚ç¼–å·è§„èŒƒåŒ–\n5.2.1: C++ è°ƒç”¨è¦†å†™å‡½æ•°çš„å®Œæ•´æµç¨‹\n5.2.2: è¦†å†™æœºåˆ¶æºç å®Œæ•´å‰–æ\n5.2.3: æŸ¥æ‰¾ä¼˜å…ˆçº§\n5.2.4: Super è°ƒç”¨æœºåˆ¶\n5.3.1: Lua C API: æ ˆæ“ä½œåŸºç¡€\n5.3.2: Class_Index å®Œæ•´æºç å‰–æ\n5.3.3: GetField æ ˆæ“ä½œå®Œæ•´å¯è§†åŒ–\n5.3.4: Class_NewIndex å±æ€§å†™å…¥\n\næ–‡æ¡£ç‰¹è‰²âœ… æºç çº§åˆ†æ: æ¯ä¸ªæŠ€æœ¯ç‚¹éƒ½é™„å¸¦å®Œæ•´æºç å‰–æï¼Œè¡Œå·å·²ä¸å®é™…æºæ–‡ä»¶æ ¸å¯¹âœ… Lua C API è¯¦è§£: åœ¨ä½¿ç”¨å¤„å°±åœ°è®²è§£ç›¸å…³ API ç”¨æ³•ï¼ŒåŒ…å«æ ˆå˜åŒ–å¯è§†åŒ–âœ… å®Œæ•´æµç¨‹å›¾ç¤º: ä» Lua è°ƒç”¨åˆ° C++ æ‰§è¡Œçš„å®Œæ•´é“¾è·¯è¿½è¸ªâœ… å®æˆ˜ç¤ºä¾‹ä¸°å¯Œ: åŒ…å« C++ å’Œ Lua åŒå‘ä»£ç å¯¹ç…§âœ… æ€§èƒ½æ•°æ®æ”¯æ’‘: æä¾›çœŸå®çš„æ€§èƒ½åŸºå‡†æµ‹è¯•æ•°æ®  \næŠ€æœ¯å‡†ç¡®æ€§ä¿è¯æ‰€æœ‰æºç å¼•ç”¨å·²æ ¸å¯¹ï¼š\n\nClassRegistry.cpp (Registries&#x2F;)\nObjectRegistry.cpp (Registries&#x2F;)\nLuaCore.cpp (Private&#x2F;)\nFunctionDesc.cpp (ReflectionUtils&#x2F;)\nLuaFunction.cpp (Private&#x2F;)\n\næºç åˆ†æåŸºäº UnLua æœ€æ–°ç¨³å®šç‰ˆæœ¬ã€‚\n","tags":["Unlua"]},{"title":"Markdown æ ¼å¼å±•ç¤º","url":"/2023/12/01/Markdown%E6%A0%BC%E5%BC%8F%E5%B1%95%E7%A4%BA/","content":"è¿™æ˜¯ä¸€ä¸ª Markdown æ ¼å¼å±•ç¤ºæ–‡ä»¶ï¼ŒåŒ…å«å„ç§å¸¸ç”¨çš„ Markdown è¯­æ³•ç¤ºä¾‹ã€‚\n\n\n1. æ ‡é¢˜å±‚çº§ä¸€çº§æ ‡é¢˜ H1äºŒçº§æ ‡é¢˜ H2ä¸‰çº§æ ‡é¢˜ H3å››çº§æ ‡é¢˜ H4äº”çº§æ ‡é¢˜ H5å…­çº§æ ‡é¢˜ H6\n2. æ–‡æœ¬æ ·å¼æ•ˆæœå±•ç¤ºè¿™æ˜¯ç²—ä½“æ–‡æœ¬\nè¿™æ˜¯æ–œä½“æ–‡æœ¬\nè¿™æ˜¯ç²—æ–œä½“æ–‡æœ¬\nè¿™æ˜¯åˆ é™¤çº¿æ–‡æœ¬\nè¿™æ˜¯è¡Œå†…ä»£ç \nè¿™æ˜¯ä¸‹åˆ’çº¿æ–‡æœ¬\nè¿™æ˜¯ä¸Šæ ‡ï¼šX2\nè¿™æ˜¯ä¸‹æ ‡ï¼šH2O\næºç è¿™æ˜¯**ç²—ä½“æ–‡æœ¬**è¿™æ˜¯*æ–œä½“æ–‡æœ¬*è¿™æ˜¯***ç²—æ–œä½“æ–‡æœ¬***è¿™æ˜¯~~åˆ é™¤çº¿æ–‡æœ¬~~è¿™æ˜¯`è¡Œå†…ä»£ç `è¿™æ˜¯&lt;u&gt;ä¸‹åˆ’çº¿æ–‡æœ¬&lt;/u&gt;è¿™æ˜¯ä¸Šæ ‡ï¼šX&lt;sup&gt;2&lt;/sup&gt;è¿™æ˜¯ä¸‹æ ‡ï¼šH&lt;sub&gt;2&lt;/sub&gt;O\n\n\n3. åˆ—è¡¨æ— åºåˆ—è¡¨æ•ˆæœå±•ç¤º\nç¬¬ä¸€é¡¹\nç¬¬äºŒé¡¹\nåµŒå¥—é¡¹ 2.1\nåµŒå¥—é¡¹ 2.2\næ·±å±‚åµŒå¥— 2.2.1\n\n\n\n\nç¬¬ä¸‰é¡¹\n\næºç - ç¬¬ä¸€é¡¹- ç¬¬äºŒé¡¹  - åµŒå¥—é¡¹ 2.1  - åµŒå¥—é¡¹ 2.2    - æ·±å±‚åµŒå¥— 2.2.1- ç¬¬ä¸‰é¡¹\n\næœ‰åºåˆ—è¡¨æ•ˆæœå±•ç¤º\nç¬¬ä¸€æ­¥\nç¬¬äºŒæ­¥\nå­æ­¥éª¤ 2.1\nå­æ­¥éª¤ 2.2\n\n\nç¬¬ä¸‰æ­¥\n\næºç 1. ç¬¬ä¸€æ­¥2. ç¬¬äºŒæ­¥   1. å­æ­¥éª¤ 2.1   2. å­æ­¥éª¤ 2.23. ç¬¬ä¸‰æ­¥\n\nä»»åŠ¡åˆ—è¡¨æ•ˆæœå±•ç¤º\n å·²å®Œæˆä»»åŠ¡\n æœªå®Œæˆä»»åŠ¡\n å¾…åŠäº‹é¡¹\n\næºç - [x] å·²å®Œæˆä»»åŠ¡- [ ] æœªå®Œæˆä»»åŠ¡- [ ] å¾…åŠäº‹é¡¹\n\n\n4. é“¾æ¥å’Œå¼•ç”¨é“¾æ¥æ•ˆæœå±•ç¤ºè¿™æ˜¯ä¸€ä¸ªæ™®é€šé“¾æ¥\nè¿™æ˜¯ä¸€ä¸ªå¸¦æ ‡é¢˜çš„é“¾æ¥\nè¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨é“¾æ¥ï¼šhttps://www.example.com\næºç è¿™æ˜¯ä¸€ä¸ª[æ™®é€šé“¾æ¥](https://www.example.com)è¿™æ˜¯ä¸€ä¸ª[å¸¦æ ‡é¢˜çš„é“¾æ¥](https://www.example.com &quot;é“¾æ¥æ ‡é¢˜&quot;)è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨é“¾æ¥ï¼š&lt;https://www.example.com&gt;\n\nå¼•ç”¨æ•ˆæœå±•ç¤º\nè¿™æ˜¯ä¸€çº§å¼•ç”¨\n\nè¿™æ˜¯äºŒçº§å¼•ç”¨\n\nè¿™æ˜¯ä¸‰çº§å¼•ç”¨\n\n\n\n\næ³¨æ„ï¼šè¿™æ˜¯å¸¦æœ‰æ ¼å¼çš„å¼•ç”¨\n\nåˆ—è¡¨é¡¹ 1\nåˆ—è¡¨é¡¹ 2\n\n\næºç &gt; è¿™æ˜¯ä¸€çº§å¼•ç”¨&gt; &gt; &gt; è¿™æ˜¯äºŒçº§å¼•ç”¨&gt; &gt; &gt; &gt; &gt; è¿™æ˜¯ä¸‰çº§å¼•ç”¨&gt; **æ³¨æ„**ï¼šè¿™æ˜¯å¸¦æœ‰æ ¼å¼çš„å¼•ç”¨&gt; - åˆ—è¡¨é¡¹ 1&gt; - åˆ—è¡¨é¡¹ 2\n\n\n5. è¡¨æ ¼å±•ç¤ºæ™®é€šè¡¨æ ¼æ•ˆæœå±•ç¤º\n\n\nå§“å\nå¹´é¾„\nèŒä¸š\n\n\n\nå¼ ä¸‰\n25\nå·¥ç¨‹å¸ˆ\n\n\næå››\n30\nè®¾è®¡å¸ˆ\n\n\nç‹äº”\n28\näº§å“ç»ç†\n\n\næºç | å§“å | å¹´é¾„ | èŒä¸š ||------|------|------|| å¼ ä¸‰ | 25 | å·¥ç¨‹å¸ˆ || æå›› | 30 | è®¾è®¡å¸ˆ || ç‹äº” | 28 | äº§å“ç»ç† |\n\nå¯¹é½æ–¹å¼è¡¨æ ¼æ•ˆæœå±•ç¤º\n\n\nå·¦å¯¹é½\nå±…ä¸­å¯¹é½\nå³å¯¹é½\n\n\n\nå†…å®¹1\nå†…å®¹2\nå†…å®¹3\n\n\nA\nB\nC\n\n\né•¿å†…å®¹æµ‹è¯•\nä¸­ç­‰å†…å®¹\nçŸ­\n\n\næºç | å·¦å¯¹é½ | å±…ä¸­å¯¹é½ | å³å¯¹é½ ||:-------|:--------:|-------:|| å†…å®¹1 | å†…å®¹2 | å†…å®¹3 || A | B | C || é•¿å†…å®¹æµ‹è¯• | ä¸­ç­‰å†…å®¹ | çŸ­ |\n\nå¤æ‚è¡¨æ ¼æ•ˆæœå±•ç¤º\n\n\nåŠŸèƒ½\næè¿°\nçŠ¶æ€\nä¼˜å…ˆçº§\n\n\n\nç”¨æˆ·ç™»å½•\næ”¯æŒé‚®ç®±å’Œæ‰‹æœºå·ç™»å½•\nâœ… å·²å®Œæˆ\né«˜\n\n\næ•°æ®å¯¼å‡º\næ”¯æŒ Excel å’Œ CSV æ ¼å¼\nğŸš§ è¿›è¡Œä¸­\nä¸­\n\n\næ¶ˆæ¯æ¨é€\nå®æ—¶é€šçŸ¥åŠŸèƒ½\nğŸ“ è®¡åˆ’ä¸­\nä½\n\n\nAPI æ¥å£\nRESTful API è®¾è®¡\nâœ… å·²å®Œæˆ\né«˜\n\n\næºç | åŠŸèƒ½ | æè¿° | çŠ¶æ€ | ä¼˜å…ˆçº§ ||------|------|------|--------|| ç”¨æˆ·ç™»å½• | æ”¯æŒé‚®ç®±å’Œæ‰‹æœºå·ç™»å½• | âœ… å·²å®Œæˆ | é«˜ || æ•°æ®å¯¼å‡º | æ”¯æŒ Excel å’Œ CSV æ ¼å¼ | ğŸš§ è¿›è¡Œä¸­ | ä¸­ || æ¶ˆæ¯æ¨é€ | å®æ—¶é€šçŸ¥åŠŸèƒ½ | ğŸ“ è®¡åˆ’ä¸­ | ä½ || API æ¥å£ | RESTful API è®¾è®¡ | âœ… å·²å®Œæˆ | é«˜ |\n\nåŒ…å«ä»£ç çš„è¡¨æ ¼æ•ˆæœå±•ç¤º\n\n\nè¯­è¨€\nä»£ç ç¤ºä¾‹\nè¯´æ˜\n\n\n\nJavaScript\nconsole.log(&#39;Hello&#39;)\næ§åˆ¶å°è¾“å‡º\n\n\nPython\nprint(&quot;Hello&quot;)\næ‰“å°è¾“å‡º\n\n\nJava\nSystem.out.println(&quot;Hello&quot;);\næ ‡å‡†è¾“å‡º\n\n\næºç | è¯­è¨€ | ä»£ç ç¤ºä¾‹ | è¯´æ˜ ||------|----------|------|| JavaScript | `console.log(&#x27;Hello&#x27;)` | æ§åˆ¶å°è¾“å‡º || Python | `print(&quot;Hello&quot;)` | æ‰“å°è¾“å‡º || Java | `System.out.println(&quot;Hello&quot;);` | æ ‡å‡†è¾“å‡º |\n\n\n6. ä»£ç å—è¡Œå†…ä»£ç æ•ˆæœå±•ç¤ºè¿™æ˜¯ inline code ç¤ºä¾‹ï¼Œå¯ä»¥åœ¨æ–‡æœ¬ä¸­ä½¿ç”¨ã€‚\næºç è¿™æ˜¯ `inline code` ç¤ºä¾‹ï¼Œå¯ä»¥åœ¨æ–‡æœ¬ä¸­ä½¿ç”¨ã€‚\n\nä»£ç å—ï¼ˆæ— è¯­è¨€æ ‡è¯†ï¼‰æ•ˆæœå±•ç¤ºè¿™æ˜¯ä¸€ä¸ªæ— è¯­è¨€æ ‡è¯†çš„ä»£ç å—å¯ä»¥åŒ…å«ä»»æ„æ–‡æœ¬æ²¡æœ‰è¯­æ³•é«˜äº®\n\næºç ```è¿™æ˜¯ä¸€ä¸ªæ— è¯­è¨€æ ‡è¯†çš„ä»£ç å—å¯ä»¥åŒ…å«ä»»æ„æ–‡æœ¬æ²¡æœ‰è¯­æ³•é«˜äº®```\n\nJavaScript ä»£ç å—æ•ˆæœå±•ç¤º// JavaScript ç¤ºä¾‹function fibonacci(n) &#123;  if (n &lt;= 1) return n;  return fibonacci(n - 1) + fibonacci(n - 2);&#125;const result = fibonacci(10);console.log(`Fibonacci(10) = $&#123;result&#125;`);// ES6 ç®­å¤´å‡½æ•°const add = (a, b) =&gt; a + b;// Promise ç¤ºä¾‹fetch(&#x27;/api/data&#x27;)  .then(response =&gt; response.json())  .then(data =&gt; console.log(data))  .catch(error =&gt; console.error(&#x27;Error:&#x27;, error));\n\næºç ```javascript// JavaScript ç¤ºä¾‹function fibonacci(n) &#123;  if (n &lt;= 1) return n;  return fibonacci(n - 1) + fibonacci(n - 2);&#125;const result = fibonacci(10);console.log(`Fibonacci(10) = $&#123;result&#125;`);```\n\nPython ä»£ç å—æ•ˆæœå±•ç¤º# Python ç¤ºä¾‹def quick_sort(arr):    if len(arr) &lt;= 1:        return arr    pivot = arr[len(arr) // 2]    left = [x for x in arr if x &lt; pivot]    middle = [x for x in arr if x == pivot]    right = [x for x in arr if x &gt; pivot]    return quick_sort(left) + middle + quick_sort(right)# åˆ—è¡¨æ¨å¯¼å¼squares = [x**2 for x in range(10)]# è£…é¥°å™¨def timer(func):    def wrapper(*args, **kwargs):        import time        start = time.time()        result = func(*args, **kwargs)        print(f&quot;è€—æ—¶: &#123;time.time() - start&#125;ç§’&quot;)        return result    return wrapper\n\næºç ```python# Python ç¤ºä¾‹def quick_sort(arr):    if len(arr) &lt;= 1:        return arr    pivot = arr[len(arr) // 2]    left = [x for x in arr if x &lt; pivot]    middle = [x for x in arr if x == pivot]    right = [x for x in arr if x &gt; pivot]    return quick_sort(left) + middle + quick_sort(right)```\n\nHTML ä»£ç å—&lt;!DOCTYPE html&gt;&lt;html lang=&quot;zh-CN&quot;&gt;&lt;head&gt;    &lt;meta charset=&quot;UTF-8&quot;&gt;    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;    &lt;title&gt;HTML ç¤ºä¾‹&lt;/title&gt;&lt;/head&gt;&lt;body&gt;    &lt;header&gt;        &lt;h1&gt;æ¬¢è¿æ¥åˆ°æˆ‘çš„ç½‘ç«™&lt;/h1&gt;        &lt;nav&gt;            &lt;ul&gt;                &lt;li&gt;&lt;a href=&quot;#home&quot;&gt;é¦–é¡µ&lt;/a&gt;&lt;/li&gt;                &lt;li&gt;&lt;a href=&quot;#about&quot;&gt;å…³äº&lt;/a&gt;&lt;/li&gt;            &lt;/ul&gt;        &lt;/nav&gt;    &lt;/header&gt;    &lt;main&gt;        &lt;p&gt;è¿™æ˜¯ä¸»è¦å†…å®¹åŒºåŸŸã€‚&lt;/p&gt;    &lt;/main&gt;&lt;/body&gt;&lt;/html&gt;\n\nCSS ä»£ç å—/* CSS æ ·å¼ç¤ºä¾‹ */.container &#123;  max-width: 1200px;  margin: 0 auto;  padding: 20px;&#125;.card &#123;  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);  border-radius: 8px;  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);  transition: transform 0.3s ease;&#125;.card:hover &#123;  transform: translateY(-5px);  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);&#125;@media (max-width: 768px) &#123;  .container &#123;    padding: 10px;  &#125;&#125;\n\nSQL ä»£ç å—-- SQL æŸ¥è¯¢ç¤ºä¾‹SELECT     u.id,    u.name,    u.email,    COUNT(o.id) as order_count,    SUM(o.total_amount) as total_spentFROM users uLEFT JOIN orders o ON u.id = o.user_idWHERE u.created_at &gt;= &#x27;2024-01-01&#x27;GROUP BY u.id, u.name, u.emailHAVING COUNT(o.id) &gt; 5ORDER BY total_spent DESCLIMIT 10;-- åˆ›å»ºè¡¨CREATE TABLE products (    id INT PRIMARY KEY AUTO_INCREMENT,    name VARCHAR(255) NOT NULL,    price DECIMAL(10, 2),    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP);\n\nBash ä»£ç å—#!/bin/bash# Bash è„šæœ¬ç¤ºä¾‹echo &quot;å¼€å§‹éƒ¨ç½²...&quot;# å˜é‡å®šä¹‰APP_NAME=&quot;my-app&quot;VERSION=&quot;1.0.0&quot;# å‡½æ•°å®šä¹‰deploy() &#123;    echo &quot;éƒ¨ç½² $APP_NAME v$VERSION&quot;    git pull origin main    npm install    npm run build    pm2 restart $APP_NAME&#125;# æ¡ä»¶åˆ¤æ–­if [ -d &quot;dist&quot; ]; then    echo &quot;æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶...&quot;    rm -rf distfi# æ‰§è¡Œéƒ¨ç½²deployecho &quot;éƒ¨ç½²å®Œæˆï¼&quot;\n\n\n7. å›¾ç‰‡æ™®é€šå›¾ç‰‡\nå¸¦é“¾æ¥çš„å›¾ç‰‡\nå›¾ç‰‡è¯´æ˜\n  \n  å›¾ç‰‡è¯´æ˜æ–‡å­—\n\n\n\n8. åˆ†éš”çº¿é»˜è®¤åˆ†éš”çº¿ï¼ˆæ¸å˜å¸¦ç¬¦å·ï¼‰æ™®é€šçš„ Markdown åˆ†éš”çº¿ä¼šæ˜¾ç¤ºæ¸å˜æ ·å¼ï¼š\n\nè™šçº¿å‹ä½¿ç”¨ HTML è‡ªå®šä¹‰ç±»åå®ç°ä¸åŒæ ·å¼ï¼š\n\n\næ˜Ÿæ˜Ÿè£…é¥°å‹\n\nç‚¹çŠ¶å‹\n\nåŒçº¿å‹\n\næ¸å˜æ³¢æµªå‹\n\nç²—çº¿å‹\n\né˜´å½±å‹\n\næºç è¯´æ˜&lt;!-- é»˜è®¤åˆ†éš”çº¿ --&gt;---&lt;!-- è™šçº¿å‹ --&gt;&lt;hr class=&quot;dashed&quot;&gt;&lt;!-- æ˜Ÿæ˜Ÿè£…é¥°å‹ --&gt;&lt;hr class=&quot;stars&quot;&gt;&lt;!-- ç‚¹çŠ¶å‹ --&gt;&lt;hr class=&quot;dots&quot;&gt;&lt;!-- åŒçº¿å‹ --&gt;&lt;hr class=&quot;double&quot;&gt;&lt;!-- æ¸å˜æ³¢æµªå‹ --&gt;&lt;hr class=&quot;wave&quot;&gt;&lt;!-- ç²—çº¿å‹ --&gt;&lt;hr class=&quot;thick&quot;&gt;&lt;!-- é˜´å½±å‹ --&gt;&lt;hr class=&quot;shadow&quot;&gt;\n\n\n9. æ•°å­¦å…¬å¼è¡Œå†…å…¬å¼è¿™æ˜¯è¡Œå†…å…¬å¼ï¼š(E &#x3D; mc^2)ï¼Œçˆ±å› æ–¯å¦çš„è´¨èƒ½æ–¹ç¨‹ã€‚\nå‹¾è‚¡å®šç†ï¼š(a^2 + b^2 &#x3D; c^2)\nå—çº§å…¬å¼$$\\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}$$\n$$\\sum_{i&#x3D;1}^{n} i &#x3D; \\frac{n(n+1)}{2}$$\n$$\\int_{0}^{\\infty} e^{-x^2} dx &#x3D; \\frac{\\sqrt{\\pi}}{2}$$\n\n10. Mermaid å›¾è¡¨æµç¨‹å›¾æ•ˆæœå±•ç¤ºgraph TD\n    A[å¼€å§‹] --&gt; B&#123;æ˜¯å¦ç™»å½•?&#125;\n    B --&gt;|æ˜¯| C[æ˜¾ç¤ºä¸»é¡µ]\n    B --&gt;|å¦| D[è·³è½¬ç™»å½•é¡µ]\n    D --&gt; E[è¾“å…¥è´¦å·å¯†ç ]\n    E --&gt; F&#123;éªŒè¯æˆåŠŸ?&#125;\n    F --&gt;|æ˜¯| C\n    F --&gt;|å¦| G[æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯]\n    G --&gt; E\n    C --&gt; H[ç»“æŸ]\n\næºç ```mermaidgraph TD    A[å¼€å§‹] --&gt; B&#123;æ˜¯å¦ç™»å½•?&#125;    B --&gt;|æ˜¯| C[æ˜¾ç¤ºä¸»é¡µ]    B --&gt;|å¦| D[è·³è½¬ç™»å½•é¡µ]    D --&gt; E[è¾“å…¥è´¦å·å¯†ç ]    E --&gt; F&#123;éªŒè¯æˆåŠŸ?&#125;    F --&gt;|æ˜¯| C    F --&gt;|å¦| G[æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯]    G --&gt; E    C --&gt; H[ç»“æŸ]```\n\nåºåˆ—å›¾æ•ˆæœå±•ç¤ºsequenceDiagram\n    participant U as ç”¨æˆ·\n    participant C as å®¢æˆ·ç«¯\n    participant S as æœåŠ¡å™¨\n    participant D as æ•°æ®åº“\n    \n    U-&gt;&gt;C: å‘èµ·ç™»å½•è¯·æ±‚\n    C-&gt;&gt;S: å‘é€è®¤è¯ä¿¡æ¯\n    S-&gt;&gt;D: æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯\n    D--&gt;&gt;S: è¿”å›ç”¨æˆ·æ•°æ®\n    S--&gt;&gt;C: è¿”å›è®¤è¯ä»¤ç‰Œ\n    C--&gt;&gt;U: ç™»å½•æˆåŠŸ\n\næºç ```mermaidsequenceDiagram    participant U as ç”¨æˆ·    participant C as å®¢æˆ·ç«¯    participant S as æœåŠ¡å™¨    participant D as æ•°æ®åº“        U-&gt;&gt;C: å‘èµ·ç™»å½•è¯·æ±‚    C-&gt;&gt;S: å‘é€è®¤è¯ä¿¡æ¯    S-&gt;&gt;D: æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯    D--&gt;&gt;S: è¿”å›ç”¨æˆ·æ•°æ®    S--&gt;&gt;C: è¿”å›è®¤è¯ä»¤ç‰Œ    C--&gt;&gt;U: ç™»å½•æˆåŠŸ```\n\nç”˜ç‰¹å›¾gantt\n    title é¡¹ç›®å¼€å‘è®¡åˆ’\n    dateFormat YYYY-MM-DD\n    section éœ€æ±‚åˆ†æ\n    éœ€æ±‚æ”¶é›†           :a1, 2024-01-01, 7d\n    éœ€æ±‚è¯„å®¡           :a2, after a1, 3d\n    section è®¾è®¡é˜¶æ®µ\n    ç³»ç»Ÿè®¾è®¡           :b1, after a2, 10d\n    UIè®¾è®¡             :b2, after a2, 8d\n    section å¼€å‘é˜¶æ®µ\n    å‰ç«¯å¼€å‘           :c1, after b1, 20d\n    åç«¯å¼€å‘           :c2, after b1, 20d\n    section æµ‹è¯•é˜¶æ®µ\n    åŠŸèƒ½æµ‹è¯•           :d1, after c1, 7d\n    æ€§èƒ½æµ‹è¯•           :d2, after c1, 5d\n\n\n11. ç‰¹æ®Šå—æç¤ºæ¡†æ•ˆæœå±•ç¤º\n  æç¤º\n  è¿™æ˜¯ä¸€ä¸ªä¿¡æ¯æç¤ºæ¡†ï¼Œç”¨äºæ˜¾ç¤ºé‡è¦ä¿¡æ¯ã€‚\n\n\n\n  æˆåŠŸ\n  è¿™æ˜¯ä¸€ä¸ªæˆåŠŸæç¤ºæ¡†ï¼Œç”¨äºæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ã€‚\n\n\n\n  è­¦å‘Š\n  è¿™æ˜¯ä¸€ä¸ªè­¦å‘Šæç¤ºæ¡†ï¼Œç”¨äºæ˜¾ç¤ºè­¦å‘Šä¿¡æ¯ã€‚\n\n\n\n  å±é™©\n  è¿™æ˜¯ä¸€ä¸ªå±é™©è­¦å‘Šæ¡†ï¼Œç”¨äºæ˜¾ç¤ºå±é™©æˆ–é”™è¯¯ä¿¡æ¯ã€‚\n\n\næºç &lt;div class=&quot;note info&quot;&gt;  &lt;p&gt;&lt;strong&gt;æç¤º&lt;/strong&gt;&lt;/p&gt;  &lt;p&gt;è¿™æ˜¯ä¸€ä¸ªä¿¡æ¯æç¤ºæ¡†ã€‚&lt;/p&gt;&lt;/div&gt;&lt;div class=&quot;note warning&quot;&gt;  &lt;p&gt;&lt;strong&gt;è­¦å‘Š&lt;/strong&gt;&lt;/p&gt;  &lt;p&gt;è¿™æ˜¯ä¸€ä¸ªè­¦å‘Šæç¤ºæ¡†ã€‚&lt;/p&gt;&lt;/div&gt;&lt;div class=&quot;note danger&quot;&gt;  &lt;p&gt;&lt;strong&gt;å±é™©&lt;/strong&gt;&lt;/p&gt;  &lt;p&gt;è¿™æ˜¯ä¸€ä¸ªå±é™©è­¦å‘Šæ¡†ã€‚&lt;/p&gt;&lt;/div&gt;\n\nHTML å—\n  è‡ªå®šä¹‰ HTML å—\n  è¿™æ˜¯ä½¿ç”¨ HTML è‡ªå®šä¹‰çš„å†…å®¹å—ï¼Œå¯ä»¥æ·»åŠ ä»»æ„æ ·å¼ã€‚\n  ç‚¹å‡»æŒ‰é’®\n\n\n\n12. è„šæ³¨è¿™é‡Œæœ‰ä¸€ä¸ªè„šæ³¨å¼•ç”¨^1ã€‚\nè¿™é‡Œæœ‰å¦ä¸€ä¸ªè„šæ³¨å¼•ç”¨^noteã€‚\n\n13. ç¼©å†™HTML è¡¨ç¤ºè¶…æ–‡æœ¬æ ‡è®°è¯­è¨€ã€‚\n*[HTML]: Hyper Text Markup Language\n\n14. å®šä¹‰åˆ—è¡¨ç¬¬ä¸€ä¸ªæœ¯è¯­è¿™æ˜¯ç¬¬ä¸€ä¸ªæœ¯è¯­çš„å®šä¹‰ç¬¬äºŒä¸ªæœ¯è¯­: è¿™æ˜¯ç¬¬äºŒä¸ªæœ¯è¯­çš„ç¬¬ä¸€ä¸ªå®šä¹‰è¿™æ˜¯ç¬¬äºŒä¸ªæœ¯è¯­çš„ç¬¬äºŒä¸ªå®šä¹‰\n15. Emoji è¡¨æƒ…:smile: :heart: :thumbsup: :rocket: :fire: :star:\nğŸ˜€ ğŸ˜ƒ ğŸ˜„ ğŸ˜ ğŸ˜† ğŸ˜… ğŸ˜‚ ğŸ¤£\nâœ… âŒ âš ï¸ ğŸ“ ğŸ”§ ğŸ‰ ğŸš€ ğŸ’¡\n\n16. é”®ç›˜æŒ‰é”®æŒ‰ Ctrl + C å¤åˆ¶\næŒ‰ Ctrl + V ç²˜è´´\næŒ‰ Ctrl + Shift + Esc æ‰“å¼€ä»»åŠ¡ç®¡ç†å™¨\n\n17. é«˜äº®æ–‡æœ¬è¿™æ˜¯ &#x3D;&#x3D;é«˜äº®æ–‡æœ¬&#x3D;&#x3D; ç¤ºä¾‹ï¼ˆéœ€è¦æ’ä»¶æ”¯æŒï¼‰\n\n18. åµŒå¥—åˆ—è¡¨å’Œä»£ç \nç¬¬ä¸€é¡¹\nconsole.log(&#x27;ç¬¬ä¸€é¡¹çš„ä»£ç &#x27;);\n\nç¬¬äºŒé¡¹\n\nåµŒå¥—æ— åºåˆ—è¡¨\nå¦ä¸€ä¸ªé¡¹ç›®print(&quot;åµŒå¥—ä»£ç å—&quot;)\n\n\nç¬¬ä¸‰é¡¹\n\nå¼•ç”¨å—ä¹Ÿå¯ä»¥åµŒå¥—\nç»§ç»­å¼•ç”¨\n\n\n\n\næ€»ç»“è¿™ä¸ªæ–‡ä»¶å±•ç¤ºäº† Markdown çš„å„ç§å¸¸ç”¨æ ¼å¼ï¼ŒåŒ…æ‹¬ï¼š\nâœ… æ ‡é¢˜å±‚çº§âœ… æ–‡æœ¬æ ·å¼ï¼ˆç²—ä½“ã€æ–œä½“ã€åˆ é™¤çº¿ç­‰ï¼‰âœ… åˆ—è¡¨ï¼ˆæœ‰åºã€æ— åºã€ä»»åŠ¡åˆ—è¡¨ï¼‰âœ… é“¾æ¥å’Œå¼•ç”¨âœ… è¡¨æ ¼ï¼ˆå¤šç§æ ·å¼ï¼‰âœ… ä»£ç å—ï¼ˆå¤šç§è¯­è¨€ï¼‰âœ… å›¾ç‰‡âœ… åˆ†éš”çº¿âœ… æ•°å­¦å…¬å¼âœ… Mermaid å›¾è¡¨âœ… ç‰¹æ®Šå—å’Œ HTMLâœ… å…¶ä»–ç‰¹æ®Šæ ¼å¼\nç°åœ¨å¯ä»¥é€šè¿‡è¿™ä¸ªæ–‡ä»¶æ¥æµ‹è¯•ä½ çš„åšå®¢æ ·å¼æ˜¯å¦æ­£å¸¸æ˜¾ç¤ºï¼ğŸ¨\n","categories":["æµ‹è¯•"],"tags":["Markdown","æ ¼å¼æµ‹è¯•"]}]